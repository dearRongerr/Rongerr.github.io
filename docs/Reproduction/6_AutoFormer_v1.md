# (ç»­) Autoformer

> è®ºæ–‡ã€å…¬å¼ã€å›¾ã€ä»£ç 

**ï¼ˆ0ï¼‰å›é¡¾**

é¦–å…ˆï¼Œè¿›å…¥åŸæ–‡è‡ªç›¸å…³æœºåˆ¶çš„éƒ¨åˆ†ï¼Œä»”ç»†è§‚å¯ŸåŸæ–‡ï¼ŒåŸæ–‡3.1çš„æ ‡é¢˜æ˜¯åˆ†è§£æ¶æ„ï¼Œå¹¶ç”±æ­¤å±•å¼€åºåˆ—åˆ†è§£æ¨¡å—ã€æ¨¡å‹è¾“å…¥ã€ç¼–ç å™¨ã€è§£ç å™¨éƒ¨åˆ†ã€‚è¿™æ˜¯ååˆ†åˆç†çš„ï¼Œå› ä¸ºæœ¬æ–‡çš„ä¸€ä¸ªçªå‡ºäº®ç‚¹å°±æ˜¯å°†æ—¶é—´åºåˆ—åˆ†è§£æˆé«˜é¢‘çš„å­£èŠ‚æˆåˆ†å’Œä½é¢‘çš„è¶‹åŠ¿æˆåˆ†ï¼Œåœ¨ç¼–ç å™¨ä¸­çš„æ¯å±‚ä¸­çš„æ³¨æ„åŠ›å’Œå‰é¦ˆç½‘ä¹‹åéƒ½è¿›è¡Œäº†åºåˆ—åˆ†è§£ï¼Œä½¿å¾—é«˜é¢‘æˆåˆ†é€å±‚æå–ã€‚åœ¨è§£ç å™¨ä¸­ï¼Œæ¯å±‚ä¸­çš„è‡ªæ³¨æ„åŠ›ã€äº¤å‰æ³¨æ„åŠ›ã€å‰é¦ˆç½‘ä»¥åï¼ŒåŒæ ·è¿›è¡Œäº†åºåˆ—åˆ†è§£ï¼Œå±‚å†…ä¼ é€’å­£èŠ‚æˆåˆ†ï¼Œè¶‹åŠ¿æˆåˆ†è¿›è¡Œç´¯åŠ ï¼Œæ‰€ä»¥ç¬¬ä¸€éƒ¨åˆ†çš„æ ‡é¢˜å«åšåºåˆ—åˆ†è§£ã€‚ä¹Ÿæ˜¯ä¸€ä¸ªçªå‡ºåˆ›æ–°ã€‚

**(0-0) Autoformeréƒ¨åˆ†çš„åŸæ–‡ç»„ç»‡å½¢å¼**

![image-20250322161734494](images/image-20250322161734494.png)  

æ¥ä¸‹æ¥è¿›è¡Œç¬¬äºŒä¸ªçªå‡ºåˆ›æ–°ï¼Œæ”¹è¿›åŸå§‹Transformer çš„æ³¨æ„åŠ›æœºåˆ¶çš„è®¡ç®—ã€‚

**ï¼ˆ1ï¼‰è‡ªç›¸å…³æœºåˆ¶**

![image-20250322155433984](images/image-20250322155433984.png)

æœ¬æ–‡æå‡ºäº† é€åºåˆ—è¿æ¥çš„è‡ªç›¸å…³æœºåˆ¶ æ¥è¿›è¡Œä¿¡æ¯èšåˆã€‚

è‡ªç›¸å…³ é€šè¿‡è®¡ç®—åºåˆ—çš„ç›¸å…³å…³ç³» å‘ç° å‘¨æœŸé—´çš„ä¾èµ–å…³ç³»ï¼Œå¹¶ä¸”é€šè¿‡æ—¶é—´å»¶è¿Ÿèšåˆ èšåˆ ç›¸ä¼¼çš„å­åºåˆ—

å…³é”®ç‚¹ï¼šâ‘ è‡ªç›¸å…³æœºåˆ¶å‘ç°å‘¨æœŸæ€§çš„ä¾èµ–å…³ç³» â‘¡ time delay aggregation è¿™é‡Œçš„ aggregate èšåˆçš„æ˜¯ æ¨¡å¼ç›¸åŒçš„å­åºåˆ—ã€‚

**ï¼ˆ2ï¼‰åŸºäºå‘¨æœŸçš„ä¾èµ–å…³ç³»**

![image-20250322160724054](images/image-20250322160724054.png) 

 å‘¨æœŸä¸­ï¼Œç›¸åŒç›¸ä½ä½ç½®æä¾›äº†ç›¸ä¼¼çš„å­è¿‡ç¨‹

å—éšæœºè¿‡ç¨‹ç†è®ºçš„å¯å‘ï¼Œå¯¹äºçœŸå®çš„ç¦»æ•£æ—¶é—´åºåˆ— $\{\mathcal{X}_t\}$ ï¼Œé€šè¿‡ä»¥ä¸‹å…¬å¼è·å¾—è‡ªç›¸å…³å…³ç³» $\mathcal{R}_{\mathcal{XX}}(\mathcal{T})$ ï¼š

$\mathcal{R}_{\mathcal{XX}}(\mathcal{T}) = \lim _{L \rightarrow \infty } \frac{1}{L} \sum_{t=1}^{L} \mathcal{X}_t \mathcal{X}_{t-\mathcal{T}}$

- $\mathcal{R}_{\mathcal{XX}}(\mathcal{T})$ åæ˜ çš„æ˜¯ $\{\mathcal{X}_t \}$  ä¸ å…¶ $\mathcal{T}$ æ»ååºåˆ— $\{\mathcal{X}_{t-\mathcal{T}}\}$ ä¹‹é—´çš„æ—¶é—´å»¶è¿Ÿç›¸ä¼¼æ€§ã€‚ 
-  æˆ‘ï¼š$\mathcal{T}$  è¡¨ç¤ºå»¶è¿Ÿæ—¶é—´æ­¥ï¼›$\mathcal{R}_{\mathcal{XX}}(\mathcal{T})$ å°±æ˜¯è‡ªç›¸å…³ç³»æ•°

å¦‚å›¾ 2 æ‰€ç¤ºï¼Œä½¿ç”¨è‡ªç›¸å…³ç³»æ•° $\mathcal{R}_{\mathcal{XX}}(\mathcal{T})$ ä½œä¸ºä¼°è®¡å‘¨æœŸé•¿åº¦ $\mathcal{T}$çš„ç½®ä¿¡åº¦ã€‚ï¼ˆè¿™é‡Œè¯´å‡†ç¡®çš„è¯´æ³•æ˜¯ æœªå½’ä¸€åŒ–çš„ç½®ä¿¡åº¦ï¼‰

ç„¶åï¼Œé€‰æ‹©$k$ ä¸ªæœ€æœ‰å¯èƒ½çš„å‘¨æœŸé•¿åº¦ $\mathcal{T}_1,.....,\mathcal{T}_k$

åŸºäºå‘¨æœŸçš„ä¾èµ–å…³ç³»å°±æ˜¯ä»è¿™ $k$ ä¸ªæœ€æœ‰å¯èƒ½çš„å‘¨æœŸé•¿åº¦ä¸­å¯¼å‡ºï¼Œå¹¶ä¸”é€šè¿‡ç›¸åº”çš„è‡ªç›¸å…³è¿›è¡ŒåŠ æƒã€‚

ï¼ˆ3ï¼‰åŸæ–‡å›¾ 2 

![image-20250322164521130](images/image-20250322164521130.png)

ï¼ˆ3-1ï¼‰å¤šå¤´æ³¨æ„åŠ›æœºåˆ¶çš„ç»´åº¦è½¬æ¢

```python
BLD->BLHd->BHLd   \

					BHLS

BSD->BSHd->BHSd   /
```

é¦–å…ˆï¼Œè¯´æ˜åŸå§‹å¤šå¤´æ³¨æ„åŠ›æœºåˆ¶ï¼ŒQKV çš„æ„é€ ï¼Œæ ‡å‡†å¤šå¤´æ³¨æ„åŠ›æœºåˆ¶çš„è¾“å…¥æ˜¯ BLDâ†’BLHdâ†’BHLdï¼ˆview ä»¥å permuteï¼‰ï¼ˆpsï¼Œè¿™é‡Œçº¿æ€§å±‚çš„ç›®çš„æ˜¯å°†åŸå§‹ç»´åº¦åµŒå…¥åˆ° H*d?ä¸ç®¡ï¼Œä¸å½±å“ç†è§£ï¼Œåé¢å†è¯´ï¼‰

```python
q = self.q_proj(q).view(batch_size, sequence_length, self.num_heads, self.head_dim).transpose(1, 2)

k = self.k_proj(k).view(batch_size, sequence_length, self.num_heads, self.head_dim).transpose(1, 2)

v = self.v_proj(v).view(batch_size, sequence_length, self.num_heads, self.head_dim).transpose(1, 2)
```

çœ‹åˆ°æˆ‘ä»¬é¡¹ç›®çš„ä»£ç 

**ğŸ–‡ï¸ å½“å‰ä½ç½®ï¼šAutoCorrelation  forward**

é¦–å…ˆæ˜¯è·å–ä¸€äº›ç»´åº¦ä¿¡æ¯

**ğŸ–‡ï¸ æºç ï¼šä¿ç•™æŸ¥è¯¢å‘é‡çš„ Bã€Lã€Hã€E**

- [x] é—®é¢˜ï¼šä¸ºä»€ä¹ˆæ ‡å‡†å¤šå¤´æ³¨æ„åŠ›çš„è¾“å…¥æ˜¯ BHLd çš„ï¼Œè¿™é‡Œç¡®å® BLHd çš„ï¼Œè¿™é‡Œå°‘äº†ä¸€æ­¥å‘€

> æ˜¯çš„ã€‚ç¡®å®å°‘äº†ä¸€æ­¥ï¼Œåªè¿›è¡Œäº† viewï¼Œæ²¡æœ‰ transpose
>
> ç­”æ¡ˆåœ¨ AutoCorrelationLayer çš„ forward ä¸­ï¼Œqkv çš„å¤„ç†ã€‚
>
> ```python
> queries = self.query_projection(queries).view(B, L, H, -1)
> keys = self.key_projection(keys).view(B, S, H, -1)
> values = self.value_projection(values).view(B, S, H, -1)
> ```
>
> è¡¥å……ï¼Œè¿™é‡Œçš„qkv çš„å»ºæ¨¡`nn.Linear`æ˜¯å°† åŸå§‹ `d_model`ï¼ŒåµŒå…¥åˆ° `d_keys * n_heads` 

**ğŸ–‡ï¸ æºç ï¼šä¿ç•™å€¼å‘é‡çš„åºåˆ—é•¿åº¦Så’ŒåµŒå…¥ç»´åº¦D**

> è’½ï¼Œä¸€èˆ¬ Transformer ä¹Ÿæ˜¯åˆ†å¼€æŸ¥è¯¢å‘é‡å’Œå€¼å‘é‡çš„åºåˆ—é•¿åº¦ã€‚Q å’Œ K çš„å‘é‡é•¿åº¦å¯ä»¥ä¸ä¸€è‡´ï¼Œä½†æ˜¯åµŒå…¥ç»´åº¦å¿…é¡»æ˜¯ä¸€è‡´çš„ã€‚å¹¶ä¸”ç”Ÿæˆçš„ attn çš„å½¢çŠ¶æ˜¯ `BHLS` çš„ï¼ˆ`æŸ¥è¯¢å‘é‡é•¿åº¦ Ã— å€¼å‘é‡é•¿åº¦`ï¼‰

- ğŸŸ¢ æºç ï¼š**æ¥ä¸‹æ¥ï¼Œä¸€ä¸ªåºåˆ—å¯¹é½æ“ä½œï¼Œæ ‡å‡†å¯¹å‡†æŸ¥è¯¢åºåˆ—**

â©ï¸ å¦‚æœæŸ¥è¯¢æ—¶é—´æ­¥æ­¥é•¿ > é”®å’Œå€¼çš„æ—¶é—´æ­¥æ­¥é•¿ï¼›å¤„ç†é”®åºåˆ—å’Œå€¼åºåˆ—é•¿åº¦å’ŒæŸ¥è¯¢åºåˆ—é•¿åº¦å¯¹é½ï¼Œé”®åºåˆ—å’Œå€¼åºåˆ—ä¸å¤Ÿé•¿çš„éƒ¨åˆ†ï¼Œå¡«å…… 0

â©ï¸ å¦‚æœæŸ¥è¯¢åºåˆ—æ–­äº†ï¼Œæˆªæ–­é”®åºåˆ—å’Œå€¼åºåˆ—å¤šçš„éƒ¨åˆ†

```python
if L > S: 
    zeros = torch.zeros_like(queries[:, :(L - S), :]).float()
    values = torch.cat([values, zeros], dim=1)
    keys = torch.cat([keys, zeros], dim=1)
else:
    values = values[:, :L, :, :]
    keys = keys[:, :L, :, :]
```

> å¼ºè°ƒï¼Œä¸ºä»€ä¹ˆè¿™é‡Œå¤„ç†çš„æ˜¯ dim1ï¼Œç†ç”±å› ä¸ºä¹‹å‰è¯´è¿‡äº†ï¼Œå¤šå¤´æ³¨æ„åŠ›æœºåˆ¶ä¼ è¿›æ¥çš„ QKVï¼Œæ²¡æœ‰è¿›è¡Œ transposeï¼Œæ‰€ä»¥æ•°æ®æ ¼å¼æ˜¯`[BLHd]`çš„

**æºç è®²è§£ï¼š** 

```python
# period-based dependencies

q_fft = torch.fft.rfft(queries.permute(0, 2, 3, 1).contiguous(), dim=-1)

k_fft = torch.fft.rfft(keys.permute(0, 2, 3, 1).contiguous(), dim=-1)

res = q_fft * torch.conj(k_fft)

corr = torch.fft.irfft(res, n=L, dim=-1)
```

**è¯¥éƒ¨åˆ†æ˜¯åŸè®ºæ–‡ï¼Œå®˜æ–¹æ³¨é‡Šç»™çš„** 

![image-20250322205518793](images/image-20250322205518793.png)

ç°åœ¨çœ‹ä»£ç æ˜¯æ€ä¹ˆå’Œè®ºæ–‡å¯¹åº”çš„



