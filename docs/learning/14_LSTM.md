# LSTM

## RNNCELL

![image-20241221142624552](images/image-20241221142624552.png)

RNNCELLï¼Œå¯ä»¥ç†è§£ä¸º å•æ­¥ çš„è¿­ä»£

å› ä¸ºæ‰€æœ‰çš„å¾ªç¯ç¥ç»ç½‘ç»œ éƒ½æ˜¯æœ‰å¾ˆå¤šæ­¥å»è¿­ä»£ï¼Œæœ€ç»ˆæŠŠæ¯ä¸€æ­¥çš„çŠ¶æ€ å–å‡ºæ¥ä½œä¸ºè¾“å‡º

è¿™é‡Œçš„RNNCELLï¼Œä¹Ÿå°±æ˜¯è¯´ å¤šä¸ªï¼Œæ¯ä¸ªæ—¶åˆ»çš„è®¡ç®— å°±æ˜¯ä¸€ä¸ªRNNCELLï¼Œç„¶åæŠŠ å¤šä¸ªRNNCELL è¿èµ·æ¥ ï¼Œå…¶å®å°±æ„æˆäº† ä¸€ä¸ªRNNï¼Œæ‰€ä»¥ æ— è®ºæ˜¯RNNä¹Ÿå¥½ï¼Œè¿˜æ˜¯ GRUä¹Ÿå¥½ï¼Œè¿˜æ˜¯ LSTMä¹Ÿå¥½ï¼Œå®ƒä»¬ éƒ½æœ‰å„è‡ªçš„CELLï¼Œç„¶åæ¯ä¸ªCELLï¼Œå…¶å®å°±æ˜¯ä¸€ä¸ª å•æ­¥çš„è¿ç®—ï¼Œå¯ä»¥ç†è§£ä¸º å•ä¸ªæ—¶åˆ»çš„è¿ç®—ï¼Œä¸‹é¢ æœ‰ä¸€ä¸ªä¾‹å­

![image-20241221142949694](images/image-20241221142949694.png)

ä»£ç è§£é‡Šï¼š

- é¦–å…ˆå®ä¾‹åŒ– RNNCELL
- RNNCELLçš„ `input size`å’Œ`hidden size`åˆ†åˆ«ä¸º10å’Œ20
- å®šä¹‰ `input` çš„è®­ç»ƒç‰¹å¾ï¼Œ`batch size`æ˜¯3ï¼Œç„¶å `æ—¶é—´é•¿åº¦`æ˜¯6ï¼Œç„¶å`ç‰¹å¾ç»´åº¦`æ˜¯10
- å®šä¹‰åˆå§‹çš„ `hidden state`[`hx`]
- ç”¨RNNCELLåšæ¯ä¸€æ¬¡è¿­ä»£

æ‰€ä»¥å®šä¹‰ä¸€ä¸ª forå¾ªç¯ï¼Œç„¶å æ¯ä¸€æ­¥è°ƒç”¨RNNCELLå®ä¾‹åŒ–çš„æ“ä½œï¼Œç®—å‡ºæ¯ä¸€æ—¶åˆ»çš„éšå«çŠ¶æ€ `hx=rnn(input[i],hx)`  ï¼Œå®šä¹‰ $h_x$æ¥æ”¶è¾“å‡ºç»“æœ

- RNNCELL å°±æ˜¯ å•æ­¥ çš„è®¡ç®—ï¼ŒåŒ…æ‹¬ GRUCELL å’ŒLSTMCELLï¼Œéƒ½æ˜¯å•æ­¥çš„
-  RNN å°±æ˜¯æŠŠå¤šä¸ªRNNCELL è¿èµ·æ¥ ï¼Œæ‰€ä»¥æ˜¯å¤šæ­¥çš„

## LSTM å®˜æ–¹ api

![image-20241222103420706](images/image-20241222103420706.png)

LSTM åŸç†å¯è§[åšå®¢](https://colah.github.io/posts/2015-08-Understanding-LSTMs/)ï¼š

![image-20241222103508512](images/image-20241222103508512.png)

### & RNN

- LSTMæ¯”RNNå¤šäº†å‡ ä¸ªé—¨
- RNNæ¯”è¾ƒç®€å• ï¼š è¾“å…¥ + éšå«çŠ¶æ€ï¼Œåªæœ‰è¿™ä¸¤ä¸ªçŠ¶æ€

![image-20241222103833628](images/image-20241222103833628.png)

åœ¨LSTMä¸­ï¼Œå¤šäº†ä¸€äº›é—¨ï¼š

ï¼ˆ1ï¼‰è¾“å…¥é—¨

ï¼ˆ2ï¼‰è¾“å‡ºé—¨

ï¼ˆ3ï¼‰é—å¿˜é—¨

ï¼ˆ4ï¼‰è®°å¿†å•å…ƒ

### LSTM å›¾ç¤º

![image-20241222103929879](images/image-20241222103929879.png)

å›¾ç‰‡ç†è§£ï¼š

æœ€ä¸Šé¢çš„æ¨ªçº¿ï¼Œé•¿å¾—åƒä¼ é€å¸¦çš„ä¸œè¥¿ï¼Œæ˜¯ä¸€ä¸ªç»†èƒå•å…ƒï¼Œæˆ–è€…è¯´ç»†èƒçŠ¶æ€

æ•´ä¸ªLSTMå°±æ˜¯é è¿™ä¸ªç»†èƒçŠ¶æ€ï¼Œæ¥ä¸æ–­çš„ æ›´æ–° å†å²ä¿¡æ¯çš„

### LSTM æœ‰å“ªäº›é—¨ï¼Ÿ

å¯¹ç…§å®˜æ–¹ apiï¼š

![image-20241222104047966](images/image-20241222104047966.png)

1. `i`å°±æ˜¯ è¾“å…¥é—¨
2. `f`å°±æ˜¯é—å¿˜é—¨
3. `g`å°±æ˜¯ç»†èƒ
4. `o`å°±æ˜¯è¾“å‡ºé—¨
5. `c`æˆä¸º`cell`ï¼Œå«ç»†èƒå•å…ƒï¼Œæˆ–è€…å« ç»†èƒçŠ¶æ€
6. `h`å°±æ˜¯`LSTM`çš„éšå«çŠ¶æ€ï¼Œæˆ–è€…è¯´ è¾“å‡ºã€‚å› ä¸ºæ¨¡å‹æœ€ç»ˆè¾“å‡ºçš„æ˜¯ $h_t$

### `api` å¯¹åº”åˆ°å›¾ã€æ•°å­¦å…¬å¼

å›¾ç¤ºï¼š

![image-20241222104333555](images/image-20241222104333555.png)

å›¾ç¤º & ç¬¦å·ï¼š

![image-20241222110332335](images/image-20241222110332335.png)

ï¼ˆ1ï¼‰é—å¿˜é—¨ï¼š$f_t \odot c_{t-1}$ 

![image-20241222110553728](images/image-20241222110553728.png)

 `step1ï¼š`é—å¿˜é—¨çš„è¾“å‡º(å¾—åˆ°ç»è¿‡é—å¿˜é—¨çš„ç­›é€‰ä¿¡æ¯ ) $f_t$ 

**é—å¿˜é—¨çš„è¾“å‡º $f_t$ æ€ä¹ˆè®¡ç®—çš„ï¼Ÿ**

> $x_t$ è·Ÿå†å²çš„è¾“å‡ºè¿›è¡Œäº¤äº’ï¼Œç„¶åç»è¿‡ $\sigma$çº¿æ€§å‡½æ•°ï¼Œå¾—åˆ° $f_t$

`step2ï¼š`é—å¿˜é—¨çš„è¾“å‡ºè·Ÿä¸Šä¸€æ—¶åˆ»çš„  $c_{t-1}$ ç›¸ä¹˜ï¼Œå¯¹åº”çš„æ•°å­¦å…¬å¼ï¼š

$$f_t \odot c_{t-1}$$

ï¼ˆ2ï¼‰è¾“å…¥é—¨ $i_t$ ã€ç»†èƒ $g_t$

![image-20241222105344599](images/image-20241222105344599.png)

å¦‚å›¾æ¡†ï¼š

1. åŒæ · $x_t$è·Ÿè¿‡å¾€çš„ $x_{t-1}$è¿›è¡Œäº¤äº’ï¼Œç„¶åç»è¿‡ä¸€ä¸ª $\sigma$å‡½æ•°ï¼Œå¾—åˆ°è¾“å…¥é—¨ $i_t$
2. ç„¶å $x_t$ è·Ÿä¸Šä¸€æ—¶åˆ»çš„ $x_{t-1}$ï¼Œç»è¿‡  $\tanh$æ¿€æ´»å‡½æ•° ï¼Œå¾—åˆ°çš„æ˜¯ $g_t$ï¼Œç§°ä½œç»†èƒ
3. $g_t$ è·Ÿè¾“å…¥é—¨ç›¸ä¹˜ï¼Œç›¸å½“äºå¯¹å½“å‰çš„è¾“å…¥ä¿¡æ¯è¿›è¡Œç­›é€‰

å…¬å¼ï¼š

$$g_t \odot i_t$$

ï¼ˆ3ï¼‰æœ€æ–°ç»†èƒçŠ¶æ€çš„ $c_t$ 

â‘  æŠŠä¿¡æ¯$g_t \odot i_t$åŠ åˆ°ç›®å‰æœ€æ–°çš„ $c_t$ ä¸Š

â‘¡ æœ€æ–°çš„ $c_t$æ˜¯ä¸Šä¸€æ—¶åˆ» $c_t$ä¹˜é—å¿˜é—¨$f_t$ï¼Œå¾—åˆ°æ–°çš„ $c_t$

ä¹Ÿå°±æ˜¯è¯´è¯¥ä¸¢æ‰çš„ä¿¡æ¯ä¸¢æ‰äº†å†åŠ ä¸Šè¾“å…¥é—¨ ï¼Œæ›´æ–°ç»†èƒçŠ¶æ€ï¼Œè¿™ä¸ªè¿‡ç¨‹å¯¹åº”çš„å…¬å¼è¡¨ç¤ºï¼š

$$c_t = f_t \odot c_{t-1} + i_t \odot g_t$$

ï¼ˆ4ï¼‰è¾“å‡ºé—¨ $\ o_t$

![image-20241222114310668](images/image-20241222114310668.png)

æœ€åä¸€æ ¹çº¿å«åš è¾“å‡ºé—¨

åŒæ ·æ˜¯ $x_t$è·Ÿ$h_{t-1}$ï¼Œè¿›è¡Œäº¤äº’ï¼Œç»è¿‡sigmoidå‡½æ•°ï¼Œå¾—åˆ°$o_t$ï¼Œå°±æ˜¯è¾“å‡ºé—¨ï¼Œæœ€ç»ˆçš„è¾“å‡º ï¼š $o_t Ã— \tanh (c_t)$ï¼Œæ•°å­¦å…¬å¼è¡¨è¾¾ï¼š

$$h_t = o_t \odot \tanh(c_t)$$

![image-20241222114824264](images/image-20241222114824264.png)

$h_t$ è·Ÿæ¯ä¸€æ—¶åˆ»çš„è¾“å…¥è¿›è¡Œäº¤äº’çš„ï¼Œä¹Ÿå°±æ˜¯çº¿æ€§ç»„åˆ

$c_t$ä¸æ–­å¯¹ å†å²ä¿¡æ¯è¿›è¡Œä¸€ä¸ª æ›´æ–°

é€šè¿‡é—å¿˜é—¨ã€è¾“å…¥é—¨ï¼Œä¸æ–­å¯¹ $c_t$è¿›è¡Œä¸€ä¸ª æ›´æ–°

ä»¥ä¸Šæ˜¯LSTMçš„å…¬å¼ å’Œ ç»“æ„ï¼Œå†æ¥çœ‹ä¸€éæ•°å­¦å…¬å¼ï¼š

$$i_t = \sigma(W_{ii}x_t+b_{ii}+W_{hi}h_{t-1}+b_{hi})$$

$$f_t = \sigma(W_{if}x_t + b_{if}+W_{hf}h_{t-1}+b_{hf})$$

$$g_t = \tanh(W_{ig}x_t + b_{ig}+W_{hg}h_{t-1}+b_{hg})$$

$$o_t = \sigma(W_{io}x_t+b_{io}+W_{ho}h_{t-1}+b_{ho})$$

$$c_t = f_t \odot c_{t-1}+i_t \odot g_t$$

$$h_t = o_t \odot \tanh(c_t)$$

è¡¥å……ï¼š

ï¼ˆ1ï¼‰ä½†ä»å…¬å¼æ¥è¯´ï¼Œ$iã€fã€gã€o$ éœ€è¦çš„å°±æ˜¯ $x_t$ å’Œ $h_{t-1}$å½“å‰æ—¶åˆ»çš„è¾“å…¥å’Œå†å²ä¿¡æ¯

ï¼ˆ2ï¼‰å¯¹æ¯” RNN çš„å…¬å¼ï¼š

$$h_t = \tanh(x_tW_{ih}^T+b_{ih}+h_{t-1}W_{hh}^T+b_{hh})$$

![image-20241222115833715](images/image-20241222115833715.png)

å•ä»å…¬å¼æ¥è¯´ï¼ŒRNN å†å²ä¿¡æ¯çš„ä¿å­˜ä»…é€šè¿‡ å½“å‰æ—¶åˆ»çš„è¾“å…¥ $x_t$ å’Œ ä¸Šä¸€æ—¶åˆ»çš„å†å²ä¿¡æ¯ $h_{t-1}$

ï¼ˆ3ï¼‰å†æ”¾ä¸€éå…¬å¼ï¼Œä½“ä¼šï¼š

![image-20241222120129870](images/image-20241222120129870.png)

ï¼ˆ4ï¼‰LSTM å¤šäº†ä¸€ä¸ªç»†èƒçŠ¶æ€ï¼Œé—®é¢˜ï¼šä¸ºä»€ä¹ˆ LSTM è¦è®¾ç½®ç»†èƒçŠ¶æ€ï¼Œä¸ºä»€ä¹ˆè¦è¿™ä¹ˆè®¾è®¡å…¬å¼æ›´æ–°ç»†èƒçŠ¶æ€å’Œéšè—çŠ¶æ€ï¼Ÿ

ï¼ˆ5ï¼‰æŸ¥é˜…èµ„æ–™

[ref](https://blog.csdn.net/qq_29053993/article/details/90547382)ï¼šLSTM

> 0ã€æ ¸å¿ƒæ˜¯ ç»†èƒé—¨ï¼ˆå¯¹æ¯” RNN è¿™ä¸ªæ˜¯æ¯”è¾ƒå¥½ç†è§£çš„ã€‚å¯æ˜¯ä¸ºä»€ä¹ˆè¦æœ‰ç»†èƒé—¨å‘¢ï¼Ÿï¼‰
>
> ![image-20241222120741375](images/image-20241222120741375.png)
>
> 1ã€å¿˜è®°ä¸€äº›ä¿¡æ¯
>
> é—å¿˜é—¨çš„ä½œç”¨æ˜¯ **å†³å®šä¸¢å¼ƒä»€ä¹ˆä¿¡æ¯**
>
> ![image-20241222120554133](images/image-20241222120554133.png)
>
> 2ã€æ–°ä¸œè¥¿åŠ å…¥ ç»†èƒçŠ¶æ€
>
> è¾“å…¥é—¨ & ä¸çŸ¥é“æ€ä¹ˆç§°å‘¼åˆé€‚çš„ä¸œè¥¿ï¼ˆå­¦åï¼š$\tilde{C}_t$ï¼‰
>
> ![image-20241222120915557](images/image-20241222120915557.png)
>
> $\sigma$ å‡½æ•° å’Œ $\tanh$ å‡½æ•°æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿä¸ºä»€ä¹ˆ $\sigma$å‡½æ•°å°±èµ·äº†é‚£æ ·çš„ä½œç”¨ï¼Œ$\tanh$å‡½æ•°åˆèµ·äº†è¿™æ ·çš„ä½œç”¨ï¼Ÿ
>
> 3ã€
>
> ![image-20241222122153770](images/image-20241222122153770.png)
>
> 

ï¼ˆ6ï¼‰RNNã€LSTMã€GRUé€šç”¨ç½‘ç»œæ¡†æ¶

![image-20241222122542650](images/image-20241222122542650.png)

ï¼ˆ7ï¼‰RNN & LSTM çš„åº”ç”¨ä¾‹å­ï¼ˆå¸®åŠ©ç†è§£ï¼‰ï¼š

RNN å°±è¶³å¤Ÿï¼š

![image-20241222122611855](images/image-20241222122611855.png)

LSTM æ‰å¯ä»¥ï¼ˆé—´éš”å¤ªå¤§ï¼‰ï¼š

![image-20241222122629295](images/image-20241222122629295.png)

ï¼ˆ9ï¼‰[LSTM çš„ç†è§£](https://www.jianshu.com/p/4b4701beba92)ï¼š

è¾“å…¥ï¼š$x_t$ ã€$h_{t-1}$ã€$c_{t-1}$

ä¸­é—´ï¼š$iã€fã€gã€o$

è¾“å‡ºï¼š$c_t$ã€$h_t$

**ä¸€ã€å¿˜è®°é—¨** $f$

- è¦ä¸¢å¼ƒä»€ä¹ˆä¿¡æ¯

LSTMçš„ç¬¬ä¸€æ­¥æ˜¯å†³å®šæˆ‘ä»¬è¦ä»ç»†èƒçŠ¶æ€ä¸­ä¸¢å¼ƒä»€ä¹ˆä¿¡æ¯ã€‚

<u>æ€ä¹ˆå®ç°çš„ï¼Ÿ</u>

è¯¥å†³å®šç”±è¢«ç§°ä¸º"å¿˜è®°é—¨"çš„$\ Sigmoid$å±‚å®ç°

<u>å…·ä½“æ€ä¹ˆå®ç°ï¼Ÿ</u> 

æŸ¥çœ‹`ht-1(å‰ä¸€ä¸ªè¾“å‡º)`å’Œ`xt(å½“å‰è¾“å…¥)`ï¼Œå¹¶ä¸ºå•å…ƒæ ¼çŠ¶æ€`Ct-1(ä¸Šä¸€ä¸ªçŠ¶æ€)`ä¸­çš„æ¯ä¸ªæ•°å­—è¾“å‡º`0`å’Œ`1`ä¹‹é—´çš„æ•°å­—ã€‚

<u>ä¸ºä»€ä¹ˆç”¨ sigmoid å‡½æ•°ï¼Œè¾“å‡ºä»£è¡¨ä»€ä¹ˆæ„æ€ï¼Ÿ</u>

`1`ä»£è¡¨å®Œå…¨ä¿ç•™ï¼Œè€Œ`0`ä»£è¡¨å½»åº•åˆ é™¤ï¼Œæ‰€ä»¥ç”¨ `sigmoid å‡½æ•°`

<u>å›¾ç¤º</u>

![image-20241222123222077](images/image-20241222123222077.png)

äºŒã€$i_t$ã€$g_t$

- è¦ä¿ç•™ä»€ä¹ˆä¿¡æ¯ï¼Ÿ

å°±æ˜¯å†³å®šæˆ‘ä»¬è¦åœ¨ç»†èƒçŠ¶æ€ä¸­å­˜å‚¨ä»€ä¹ˆä¿¡æ¯

è¿™éƒ¨åˆ†åˆ†ä¸ºä¸¤æ­¥ï¼š

1ã€é¦–å…ˆï¼Œç§°ä¸º"è¾“å…¥é—¨å±‚"çš„Sigmoidå±‚å†³å®šäº†å°†æ›´æ–°å“ªäº›å€¼

2ã€æ¥ä¸‹æ¥ä¸€ä¸ªtanhå±‚åˆ›å»ºå€™é€‰å‘é‡Ctï¼Œè¯¥å‘é‡å°†ä¼šè¢«åŠ åˆ°ç»†èƒçš„çŠ¶æ€ä¸­

åœ¨ä¸‹ä¸€æ­¥ä¸­ï¼Œæˆ‘ä»¬å°†ç»“åˆè¿™ä¸¤ä¸ªå‘é‡æ¥åˆ›å»ºæ›´æ–°å€¼ã€‚

![image-20241222124500600](images/image-20241222124500600.png)

å›¾ç¤ºï¼š

![image-20241222124625253](images/image-20241222124625253.png)

è¿™é‡Œçš„ $\tilde{C}_t$ å’Œ $g_t$  æ˜¯ä¸€ä¸ªä¸œè¥¿ï¼Œå­¦åï¼šå€™é€‰å‘é‡

é—®é¢˜ï¼š$\tanh$ è¾“å‡ºçš„å«ä¹‰æ˜¯ä»€ä¹ˆï¼Ÿ

ç±»ä¼¼ sigmoid çš„è¾“å‡º `0 è¡¨ç¤ºé—å¿˜ï¼Œ1 è¡¨ç¤ºè®°ä½`

ä¸‰ã€æ›´æ–°ç»†èƒçŠ¶æ€å¾—åˆ° $c_t$

æ›´æ–°ä¸Šä¸€ä¸ªçŠ¶æ€å€¼$C_{tâˆ’1}$äº†ï¼Œå°†å…¶æ›´æ–°ä¸º$C_t$

å°†ä¸Šä¸€ä¸ªçŠ¶æ€å€¼ä¹˜ä»¥$f_t$ï¼Œä»¥æ­¤è¡¨è¾¾æœŸå¾…å¿˜è®°çš„éƒ¨åˆ† $ \iff f_t \odot c_{t-1}$

ä¹‹åå°†å¾—åˆ°çš„å€¼åŠ ä¸Š $i_tâˆ—\tilde{C}_t$  $\iff + i_t \odot \tilde{C}_t$

è¿™ä¸ªå¾—åˆ°çš„æ˜¯æ–°çš„å€™é€‰å€¼ $C_t$ï¼Œ æŒ‰ç…§æˆ‘ä»¬å†³å®šæ›´æ–°æ¯ä¸ªçŠ¶æ€å€¼çš„å¤šå°‘æ¥è¡¡é‡ï¼Œæœ€ç»ˆçš„å…¬å¼ï¼š

$$c_t = f_t \odot c_{t-1} + i_t \odot g_t $$

ä»¥ä¸Šå¾—åˆ°äº† ç¬¬ä¸€ä¸ª è¾“å‡º $c_t$ï¼Œç°åœ¨å¼€å§‹ç¬¬äºŒä¸ªè¾“å‡º $h_t$

å››ã€è¾“å‡ºä»€ä¹ˆ

æœ€åéœ€è¦å†³å®šè¦è¾“å‡ºä»€ä¹ˆ

æ­¤è¾“å‡ºå°†åŸºäºç»†èƒçŠ¶æ€ï¼Œä½† æ˜¯ä¸€ä¸ªè¿‡æ»¤ç‰ˆæœ¬ã€‚  $tanh(C_t)$

- é¦–å…ˆï¼Œç»è¿‡ä¸€ä¸ªsigmoidå±‚ï¼Œå†³å®šäº†è¦è¾“å‡ºçš„ç»†èƒçŠ¶æ€çš„å“ªäº›éƒ¨åˆ†  $o_t = \sigma(f(h_{t-1},x_t))$
- ç„¶åï¼Œå°†å•å…ƒæ ¼çŠ¶æ€é€šè¿‡tanhï¼ˆå°†å€¼è§„èŒƒåŒ–åˆ°-1å’Œ1ä¹‹é—´ï¼‰ï¼Œå¹¶å°†å…¶ä¹˜ä»¥Sigmoidé—¨çš„è¾“å‡º   $h_t = o_t \odot \tanh(c_t)$

è‡³æ­¤å°±è¾“å‡ºäº†å†³å®šçš„é‚£äº›éƒ¨åˆ†

![image-20241222133636506](images/image-20241222133636506.png)



æŠŠå…¬å¼ç²¾ç®€ä¸€ä¸‹ï¼š

![image-20241222133918408](images/image-20241222133918408.png)

è¾“å…¥ï¼š$x_t$ã€$h_{t-1}$

æ“ä½œï¼š(è¿™é‡Œçš„ç¬¦å·æ˜¯å‚ç…§å®˜ç½‘ api çš„)

$f_t = \sigma(f(x_t,h_{t-1})) \iff \sigma(W_f[x_t,h_{t-1}]+b_f)$

$i_t = \sigma(f(x_t,h_{t-1})) \iff \sigma(W_i[x_t,h_{t-1}]+b_i)$

$g_t = \sigma(f(x_t,h_{t-1})) \iff \sigma(W_g[x_t,h_{t-1}]+b_g)$

$o_t = \sigma(f(x_t,h_{t-1})) \iff \sigma(W_o[x_t,h_{t-1}]+b_o)$

$f$ ä»£è¡¨ä»¿å°„å˜æ¢ $Wx+b$

è¾“å‡ºï¼š$c_tã€h_t$ï¼ˆè¿™ä¸ªå›¾ç¤ºï¼Œç”»å¾—å¤ªç»†ï¼Œåè€Œæ™•ä¹ï¼‰

$c_t = f_t \odot c_{t-1} + i_t \odot g_t$

ç†è§£ï¼š

1ã€$f_t$ æŒ‡ç¤º è¦å¿˜è®°çš„å†å²ä¿¡æ¯ï¼ˆç™½è¯ï¼š$æ›´æ–°å†å²ä¿¡æ¯$ï¼Œè¯¥è®°ä½çš„è®°ä½ï¼Œè¯¥å¿˜è®°çš„å¿˜è®°ï¼Œå¿˜è®°å¤šå°‘ä¹Ÿè¡¨è¾¾äº†è®°ä½å¤šå°‘ï¼Œéœ€è¦çœ‹å‚ç…§ï¼‰

2ã€$i_t$ ä¿ç•™å¤šå°‘è¾“å…¥ä¿¡æ¯ï¼Œä¸ºè¾“å…¥ä¿¡æ¯åŠ æƒï¼›

$g_t$ è¡¨ç¤ºè¾“å…¥ä¿¡æ¯ï¼Œæœ€åå¾—åˆ°çš„æ˜¯è¦è®°ä½å¤šå°‘è¾“å…¥ä¿¡æ¯

3ã€æœ€ååŒæ—¶å­˜åˆ° $c_t$ ä¸­

$h_t = \tanh({c_t}) \odot o_t$

ç†è§£ï¼š

æœ€åï¼Œéœ€è¦å†³å®šè¾“å‡ºä»€ä¹ˆ

è¾“å‡ºåŸºäºç»†èƒçŠ¶æ€ï¼Œæ˜¯è¿‡æ»¤ç‰ˆæœ¬

step1ï¼šé¦–å…ˆï¼Œé€šè¿‡sigmoidå±‚ï¼Œå†³å®šè¦è¾“å‡ºçš„ç»†èƒçŠ¶æ€çš„å“ªäº›éƒ¨åˆ†

step2ï¼šç„¶åï¼Œå°†å•å…ƒæ ¼çŠ¶æ€é€šè¿‡tanhï¼ˆå°†å€¼è§„èŒƒåŒ–åˆ°-1å’Œ1ä¹‹é—´ï¼‰

step3ï¼šå¹¶å°†å…¶ä¹˜ä»¥Sigmoidé—¨çš„è¾“å‡ºï¼Œè‡³æ­¤è¾“å‡ºå†³å®šçš„é‚£äº›éƒ¨åˆ†

ä»¥ä¸Šæ˜¯å…³äº LSTM å†…éƒ¨çš„è®¡ç®—ç†è§£

### 	torch.nn.LSTM

ä¸ RNN å¯¹æ¯”ï¼š

> åœ¨å‚æ•°ç›¸åŒçš„æ¡ä»¶ä¸‹ï¼ŒLSTMçš„åºåˆ—å»ºæ¨¡èƒ½åŠ›æ˜¯å¼ºäºRNNçš„ï¼Œæ‰€ä»¥æ¯”è¾ƒå¤§çš„åºåˆ—å»ºæ¨¡ä»»åŠ¡éƒ½æ˜¯ç”¨ LSTMåš

pytorch çš„å®˜æ–¹ apiï¼š`torch.nn.LSTM`

![image-20241222180446830](images/image-20241222180446830.png)

- è¿™æ˜¯ä¸€ä¸ªclassï¼Œæ˜¯ä¸€ä¸ªç±»
- è¦ç”¨çš„è¯

ï¼ˆ1ï¼‰é¦–å…ˆè¿›è¡Œå®ä¾‹åŒ–ï¼Œå¾—åˆ°ä¸€ä¸ªç®—å­

ï¼ˆ2ï¼‰å–‚å…¥è¾“å…¥åºåˆ—ï¼Œè¾“å…¥åºåˆ—ç»è¿‡LSTMç½‘ç»œï¼Œå¾—åˆ°çš„ æ¯ä¸ªè¾“å…¥çŠ¶æ€çš„è¾“å‡ºï¼Œæœ€åå°†å¾—åˆ°çŠ¶æ€çš„è¾“å‡ºï¼š $h_t$

ï¼ˆ3ï¼‰æ¯ä¸€æ—¶åˆ»çš„ $h_t$ ç»„åˆèµ·æ¥çš„è¾“å‡ºåºåˆ—

**<u>æ˜ç¡® LSTM çš„å…¬å¼ï¼š</u>**

é¦–å…ˆï¼Œ` LSTMæ ¸å¿ƒï¼šç»†èƒçŠ¶æ€`

ä¸€å…±æ¶‰åŠçš„ä¸œè¥¿ï¼š$fã€iã€gã€oã€hã€c$

è¾“å…¥ï¼š$x_tã€h_{t-1}$

å…¬å¼ï¼š

![image-20241222181758637](images/image-20241222181758637.png)

$f_t=\sigma(w_f[x_t,h_{t-1}]+b_f)$ 

$i_t = \sigma(w_i[x_t,h_{t-1}]+b_i)$

$g_t = \tanh(w_g[x_t,h_{t-1}]+b_g)$

$o_t = \sigma(w_o[x_t,h_{t-1}]+b_o) $

$c_t = f_t \odot c_{t-1} + i_t \odot g_t$

$h_t = o_t \odot \tanh(c_t)$

å››ä¸ªé—¨ï¼Œåˆ†åˆ«æ˜¯$iã€fã€gã€o$

è¿™é‡Œæœ‰å››ä¸ªé—¨ï¼š

ï¼ˆ1ï¼‰å…¶ä¸­æœ‰ä¸‰ä¸ªé—¨éçº¿æ€§æ¿€æ´»å‡½æ•°éƒ½æ˜¯ `sigmoid`

ï¼ˆ2ï¼‰$g_t$çš„æ¿€æ´»å‡½æ•°æ˜¯ tanhå‡½æ•°

<u>å…¶å®è¿™å››ä¸ªé—¨çš„è¿ç®—æœ‰å¾ˆå¤§çš„ç›¸ä¼¼æ€§</u>

> æœ‰ å››ä¸ª $W$
>
> å¹¶ä¸”å››ä¸ª$W$éƒ½æ˜¯è·Ÿ$x_t$è¿›è¡Œä¸€ä¸ªçŸ©é˜µç›¸ä¹˜
>
> åŒæ ·çš„ $W_{hi} ã€W_{hf}$å³è¾¹çš„å››ä¸ª$W$ï¼Œä¹Ÿæ˜¯è·Ÿ $h_{t-1}$ï¼Œè¿›è¡ŒçŸ©é˜µç›¸ä¹˜
>
> æ‰€ä»¥è™½ç„¶çœ‹ä¸Šå»æœ‰4ä¸ª$W_i$ï¼Œä½†æ˜¯å¯ä»¥æŠŠ è¿™ä¸ª å››ä¸ª $W_i$å èµ·æ¥
>
> æ¯”æ–¹è¯´ æ¯ä¸ª$W_i$æ˜¯$2$è¡Œï¼Œé‚£ä¹ˆ$4$ä¸ª$W_i$ï¼Œå°±å¯ä»¥ å æˆ$8$è¡Œ

![image-20241222182249464](images/image-20241222182249464.png)

ç„¶åå†è·Ÿ $x_t$ è¿›è¡Œä¸€ä¸ªç›¸ä¹˜ï¼Œå°±æ˜¯æŠŠ è¿™ä¸ª $å››ä¸ª Wä¹˜ä»¥x$

$WÃ—x$ ç»„åˆèµ·æ¥ï¼Œä¸€èµ·ç®—

åŒæ ·è¿™é‡Œçš„$Wä¹˜ä»¥h(WÃ—h)$ä¹Ÿæ˜¯ä¸€æ ·çš„

ç”±äºéƒ½æ˜¯ ä¹˜ä»¥ åŒä¸€ä¸ª$h$

åŒæ ·æŠŠ å››ä¸ª $W$å †å èµ·æ¥ï¼Œ$stack$å †å æ¥ï¼Œç®—å®Œäº† å†$split$

![image-20241222182908199](images/image-20241222182908199.png)

å¦‚å›¾ï¼Œè¿˜æœ‰$4$ä¸ª$b_i$å’Œ$b_h$ï¼Œè¾“å…¥ $linear$çš„åç½® å’Œä¸Šä¸€æ—¶åˆ» éšå«çŠ¶æ€çº¿æ€§å±‚çš„åç½®

åŒæ ·è¿™é‡Œ $4$ä¸ªåç½®ï¼Œ$4$ä¸ª$b_i$ å°±æ˜¯ç›´æ¥åŠ ï¼Œä¸éœ€è¦è”åˆç®—

åŒæ ·è¿™é‡Œçš„$b_h$ï¼Œä¹Ÿæ˜¯$4$ä¸ªåç½®

ç»´åº¦éƒ½æ˜¯è·Ÿ$i_tã€ f_t$ ç»´åº¦æ˜¯ä¸€æ ·çš„ï¼Œå¾—åˆ°çš„ $iã€fã€gã€o$ä»¥åï¼Œå°±å¯ä»¥ç®—å‡ºå½“å‰æ—¶åˆ»ç»†èƒçš„çŠ¶æ€ $c_t$

![image-20241222183148665](images/image-20241222183148665.png)

About $c_t$ ï¼š

ï¼ˆ1ï¼‰$c_t= f_tÃ—c_{t-1}$ï¼Œä¸­é—´çš„ä¹˜æ˜¯é€å…ƒç´ çš„ä¹˜ï¼Œä¸æ˜¯çŸ©é˜µä¹˜æ³•

ï¼ˆ2ï¼‰é»˜è®¤$f_t$è·Ÿ$c_{t-1}$ç»´åº¦æ˜¯ä¸€æ ·çš„ï¼ŒåŒä¸€ä½ç½®ä¸Šçš„å…ƒç´ ä¸¤ä¸¤ç›¸ä¹˜

ï¼ˆ3ï¼‰åŒæ · $i_t$å’Œ$g_t$ä¹Ÿæ˜¯ä¸€æ ·ï¼ŒåŒä¸€ä½ç½®çš„ä¸¤ä¸¤å…ƒç´  ç›¸ä¹˜

ï¼ˆ4ï¼‰ä¹˜å®Œä»¥åå…ƒç´ å†åŠ èµ·æ¥ï¼Œå¾—åˆ°$c_t$

$c_t$ æ˜¯å½“å‰æ—¶åˆ»çš„ç»†èƒçŠ¶æ€ï¼Œå°±æ˜¯ä¸Šé¢çš„é»‘çº¿ï¼Œè¿™é»‘çº¿æ˜¯ LSTM çš„åˆ›æ–°

??? question "ï¼ˆä½œè€…å’‹æƒ³çš„ï¼Œè¦åŠ æ¡é»‘çº¿ï¼Œè¿˜æœ‰è¿™äº›é—¨çš„è®¾è®¡ï¼Œwhyï¼Ÿï¼‰"

![image-20241222183514356](images/image-20241222183514356.png)

æ•´ä¸ªLSTMå°±æ˜¯é é»‘çº¿ï¼Œæ¥ä¸æ–­å¯¹å†å²ä¿¡æ¯ è¿›è¡Œç­›é€‰å’Œæ›´æ–°ï¼Œå¾—åˆ°$c_t$ä»¥åï¼Œæœ€ç»ˆ å¾—åˆ° $h_t$

$c_t=f_t \odot c_{t-1} + i_t \odot g_t $

$h_t = o_t \odot \tanh{c_t}$

> $c_t = f_t \odot c_{t-1} + i_t \odot g_t$
>
> $= \sigma{(W_f{[x_t,h_{t-1}]}+b_f)} \odot c_{t-1} + \sigma(W_i[x_t,h_{t-1}]+b_i) \odot \tanh(W_g[x_t,h_{t-1}]+b_g)$
>
> 
>
> $h_t = o_t \odot \tanh{c_t}$
>
> $h_t = \sigma (W_o[x_t,h_{t-1}]+b_o) \odot \tanh{c_t}$
>
> 
>
> **å¯¹æ¯”RNN çš„å…¬å¼ï¼š**
>
> $h_t = \tanh(W_h[x_t,h_{t-1}]+b_h)$
>
> $=\tanh(x_tW_{ih}^T+b_{ih}+h_{t-1}W_{hh}^T+b_{hh})$
>
> 

$c_t$ ä¹Ÿæ˜¯ä¸ºäº†æœ€ç»ˆ $h_t$ çš„è¾“å‡º

æ•´ä¸ªLSTMçš„è¾“å‡ºå°±æ˜¯ $h_t$

htï¼šç”±$è¾“å‡ºé—¨Ã—ç»†èƒçŠ¶æ€ (ç»è¿‡ æ¿€æ´»å‡½æ•° \tanhå‡½æ•°)$ï¼Œæ‰€å¾—åˆ°çš„å€¼ï¼Œå°±æ˜¯$h_t$ï¼Œ$h_t$å°±æ˜¯LSTMçš„è¾“å‡º

**<u>åˆå§‹çŠ¶æ€</u>**

**ï¼ˆ1ï¼‰LSTMä¸­çš„åˆå§‹çŠ¶æ€æœ‰ 2 ä¸ª**

RNNæœ‰åˆå§‹çŠ¶æ€ï¼ŒåŒæ ·åœ¨LSTMç½‘ç»œä¸­ï¼Œä¹Ÿæœ‰åˆå§‹çŠ¶æ€ï¼Œä½†æ˜¯LSTM ä¸­çš„åˆå§‹çŠ¶æ€ï¼Œæœ‰ä¸¤ä¸ªã€‚

<u>**ï¼ˆ2ï¼‰éœ€è¦æä¾›ä»€ä¹ˆåˆå§‹çŠ¶æ€ï¼Ÿ**</u> 

> ä»å…¬å¼é‡Œæ‰¾åˆå§‹çŠ¶æ€ï¼Œå“ªäº›ç¬¦å·ä»¥ $t-1$ä¸ºä¸‹æ ‡çš„ï¼Œåªè¦ä»¥$t-1$ä¸ºä¸‹æ ‡çš„å°±æ˜¯è¯´éœ€è¦æä¾›åˆå§‹çŠ¶æ€ï¼Œä¹Ÿå°±æ˜¯è¯´éœ€è¦æä¾›è¿™äº›é‡çš„åˆå§‹å€¼
>
>  ä»$t$ä»$1$å¼€å§‹ï¼Œå¸¦$t-1$ä¸‹æ ‡çš„ï¼Œéœ€è¦æä¾›$t_0$ï¼Œæ‰€ä»¥ä¸€å®šæœ‰åˆå§‹çŠ¶æ€
>
> ä»å…¬å¼æ¥çœ‹ ä¸€å…±æœ‰ä¸¤ä¸ªå¸¦ $t-1$ ä¸‹æ ‡çš„

$f_t,i_t,o_t = \sigma(W[x_t,h_{t-1}]+b)$

$g_t = \tanh(W[x_t,h_{t-1}]+b)$

$c_t = f_t \odot c_{t-1} + i_t \odot g_t$

$h_t = o_t \odot \tanh{c_t}$

> åˆ†åˆ«æ˜¯$h_{t-1}$ï¼Œ$c_{t-1}$
>
> ä¹Ÿå°±æ˜¯è¯´ åœ¨$t=1$æ—¶åˆ»çš„æ—¶å€™ï¼Œéœ€è¦æä¾›$h_0$ã€$c_0$ï¼Œæ¥ç®—å‡º$t=1$æ—¶åˆ»çš„$h_1$å’Œ$c_1$
>
> LSTMç½‘ç»œï¼Œç›¸æ¯”äºç®€å•çš„RNNç½‘ç»œï¼Œåˆå§‹çŠ¶æ€å°±å¤šäº† $c_0$

**<u>ReCall RNN</u>**

![image-20241223123235044](images/image-20241223123235044.png)

<u>(1) RNNçš„å…¬å¼æ›´ç®€å•ï¼Œ$h_t$æ˜¯$x_t$è·Ÿ$h_{t-1}$çš„çº¿æ€§ç»„åˆ</u>

$h_t = \tanh{(W_h[x_t,h_{t-1}]+b_h)}$

<u>(2)RNNéœ€è¦çš„åˆå§‹çŠ¶æ€åªæœ‰ $h_0$</u> 

> ä»RNNçš„å…¬å¼ä¸­å¯ä»¥çœ‹å‡ºæ¥ï¼Œåªæœ‰ä¸€ä¸ªç¬¦å·ï¼Œå°±æ˜¯$h$ä¸‹æ ‡æ˜¯$t-1$ï¼Œä¹Ÿå°±æ˜¯è¯´ å»ç®—RNNçš„ç½‘ç»œçš„æ—¶å€™ï¼Œéœ€è¦æä¾› $h_0$ä½œä¸ºåˆå§‹çŠ¶æ€ï¼Œå› ä¸ºå¦‚æœè¦ç®—$h_1$çš„è¯ï¼Œæˆ‘ä»¬å¿…é¡»è¦æœ‰$h_0$ï¼Œæ‰€ä»¥å¿…é¡»è¦æä¾›$h_0$ï¼Œå½“ç„¶æ¡†æ¶å·²ç»é»˜è®¤æä¾›äº†$h_0$ç­‰äºä¸€ä¸ªå…¨0çš„å‘é‡

**<u>VS LSTM</u>**

![image-20241223123917725](images/image-20241223123917725.png)

$i_t,f_t,o_t = \sigma(W[x_t,h_{t-1}]+b)$

$g_t = \tanh(W[x_t,h_{t-1}]+b)$

$c_t = f_t \odot c_{t-1} + i_t \odot g_t$

$h_t = o_t \odot \tanh{c_t}$

- åœ¨LSTMä¸­ï¼Œæ ¹æ®å…¬å¼å¯ä»¥çœ‹åˆ°å¿…é¡»è¦æä¾›$h_0$å’Œ$c_0$
- LSTMç›¸æ¯”äºRNNåˆå¤šäº†ä¸€ä¸ªåˆå§‹çŠ¶æ€ï¼Œä¸ä»…æœ‰$h_0$ï¼Œè¿˜æœ‰$c_0$
- åœ¨æ¡†æ¶ä¸­ï¼ŒåŒæ ·æä¾›äº† é»˜è®¤çš„å€¼ï¼šå…¨0

> **<u>è¡¥å……ï¼š</u>**
>
> æˆ‘ä»¬ä¹Ÿå¯ä»¥ä¸ç”¨å…¨$0$ çš„é»˜è®¤å€¼ï¼Œä¹Ÿå¯ä»¥ç”¨å…¶ä»–çš„å€¼ï¼Œè‡ªå·±æ„é€ $h_0$å’Œ$c_0$
>
> æ­¤æ—¶ï¼Œ$h_0$å’Œ$c_0$ï¼Œå¯èƒ½æ˜¯ä»æŸä¸€ä¸ªè¾“å…¥æ˜ å°„æ¥çš„ï¼Œè¿™ç§åˆå§‹åŒ–æ–¹æ³•ä¹Ÿå«`Meta learning`ï¼Œå³æˆ‘ä»¬çš„åˆå§‹å€¼ éƒ½æ˜¯é å­¦æ¥çš„
>
> å¯ä»¥è®©åˆå§‹çŠ¶æ€ï¼Œä¸æ˜¯å®Œå…¨éšæœºçš„ï¼Œå¯ä»¥è®¾ç½®ä¸ºä¸è¾“å…¥æœ‰å…³ï¼Œæˆ–è€…è·Ÿ conditionæœ‰å…³
>

**LSTM åˆå§‹åŒ–éœ€è¦çš„å‚æ•°**

![image-20241223124902475](images/image-20241223124902475.png)

éœ€è¦å®ä¾‹åŒ–LSTMçš„å‚æ•°ï¼š

- `input_size`ï¼šè¾“å…¥åºåˆ—ç‰¹å¾çš„å¤§å°
- `hidden_size` ï¼š  â‘  LSTMç½‘ç»œ $h$çš„å¤§å° â‘¡ `hidden_size` ä¹Ÿæ˜¯$c$çš„å¤§å°
-  `num_layers` ï¼šå±‚æ•°ï¼Œæ„å»ºå¤šå±‚çš„LSTMï¼Œå¤šå±‚å †å èµ·æ¥ï¼Œå‰ä¸€å±‚çš„è¾“å‡º$h_t$ï¼Œæ˜¯ä½œä¸ºä¸‹ä¸€å±‚LSTMçš„è¾“å…¥$x_t$
- `bias`ï¼šå†³å®šäº†$b_i$å’Œ$b_h$æ˜¯å¦å¯ä»¥ä¸¢å¼ƒ
- `batch_first`ï¼šâ‘  åœ¨pytorchä¸­ï¼Œé»˜è®¤çš„æ˜¯`batch`æ˜¯æ”¾åœ¨ä¸­é—´ä¸€ç»´çš„  â‘¡ å¯ä»¥æŠŠ`batch_firs`tè®¾ç½®æˆ`true`ï¼Œæ­¤æ—¶ `batch` å°±åœ¨ ç¬¬ä¸€ç»´
- `dropout` ä»¥åŠ åŒå‘  `bidirectional` 

â‘  å¦‚æœè¦æ„å»ºåŒå‘çš„è¯ï¼Œæœ‰`forward layer`å’Œ`backward layer`

â‘¡ æœ€åçš„çŠ¶æ€æ˜¯ç”±`forward layer`å’Œ`backward layer`æ‹¼æ¥èµ·æ¥çš„çŠ¶æ€

-  `proj_size`  ï¼šæœ€åä¸€ä¸ªå‚æ•°ï¼Œè¿™ä¸ªå‚æ•°ç›¸å½“äºLSTMç½‘ç»œçš„å˜ä½“ï¼šLSTMP

## LSTMå’ŒLSTMPçš„åŸç†ä¸æºç å®ç°

**<u>LSTM & LSTMP</u>**

ä½œç”¨ï¼šä¸ºäº†å‡å°LSTMçš„å‚æ•°å’Œè®¡ç®—é‡

> å› ä¸ºLSTMçš„è®¡ç®—é‡æ˜¯æ¯”è¾ƒå¤§çš„ï¼ŒLSTMPé€šè¿‡å¯¹$h_t$è¿›è¡Œå‹ç¼©ï¼Œ$h_t$çš„ç»´åº¦ä¼šå˜å°ï¼Œæ•´ä¸ªç½‘ç»œçš„å‚æ•°é‡å’Œè¿ç®—é‡ éƒ½ä¼šå˜å°ï¼Œæœ‰è®ºæ–‡è¡¨æ˜é€šè¿‡å¯¹ $h_t$ è¿›è¡Œå‹ç¼©ï¼Œæ€§èƒ½æŸå¤±ä¸æ˜¯å¾ˆå¤§ï¼Œæ‰€ä»¥åœ¨å…·ä½“åœ°å®éªŒä¸­ï¼Œå¯ä»¥å°è¯•LSTMP

- [x] å®ä¾‹åŒ– LSTM éœ€è¦ä¼ å…¥çš„å‚æ•° $\uparrow$
- [ ] LSTM input parameters $\downarrow$
- [ ] LSTM output $\downarrow$ 

**<u>LSTM input parameters</u>** 

![image-20241223131724301](images/image-20241223131724301.png)

1ï¸âƒ£ `input`

æ ¼å¼ï¼šå¦‚æœæ˜¯ batch first=trueçš„è¯ï¼š `batch sizeÃ—sequence lengthÃ—input size`ã€‚

2ï¸âƒ£ `(h_0ï¼Œc_0)`

æ ¼å¼ï¼šå…ƒç»„

ä¸ºä»€ä¹ˆæ˜¯å…ƒç»„çš„å½¢å¼ï¼Ÿ

> ä¸ºäº†è·ŸRNNçš„apiä¿æŒä¸€è‡´
>
> RNNçš„apiè¾“å…¥å°±æ˜¯ä¸¤ä¸ªé‡ï¼ŒLSTMæ˜¯RNNä¸€ä¸ªç‰¹æ®Šçš„å˜ä½“ï¼Œæ‰€ä»¥è™½ç„¶æœ‰ä¸¤ä¸ªåˆå§‹çŠ¶æ€ï¼Œç”¨ä¸¤ä¸ªæ›´åˆä¹å¸¸ç†ï¼Œä½†è¿˜æ˜¯ç”¨å…ƒç»„çš„å½¢å¼ç»„åˆèµ·æ¥
>
> ä¸¤ä¸ªåˆå§‹çŠ¶æ€åˆ†åˆ«æ˜¯ `h_0`å’Œ`c_0`
>
> å°±æ˜¯æ‰€æœ‰å¸¦ t-1 ä¸‹æ ‡çš„ï¼Œè¿™äº›ç¬¦å·éƒ½éœ€è¦æä¾›ä¸€ä¸ªåˆå§‹å€¼

**<u>LSTM output</u>**

![image-20241223135213262](images/image-20241223135213262.png)

è™½ç„¶æ˜¯è¾“å‡º `c_n`ï¼Œä½†æ˜¯ `h_n = o_n Ã— tanh(c_n)`ï¼Œ`h_n` ä¸ `c_n` æ˜¯ç”± `c_n` è®¡ç®—æ¥çš„ï¼Œå³ä½¿è¯´ `c_n` æ˜¯ä¸­é—´ç»“æœä¹Ÿå¯ä»¥ï¼Œä½† `c_n` æ˜¯ LSTM çš„æ ¸å¿ƒ

`Outputsï¼šoutput,(h_n,c_n)`

- `output`ï¼šæ•´ä¸ªæ¨¡å‹åºåˆ—çš„è¾“å‡ºï¼Œ`shape= batch sizeÃ—sequence lengthÃ—hidden size`ï¼Œoutput ååº”æ•´ä¸ªåºåˆ—çš„çŠ¶æ€è¾“å‡ºï¼›

-  `(h_n,c_n)` ï¼šå…ƒç»„å½¢å¼ï¼Œ`h_n`å’Œ`c_n`ï¼Œè¡¨ç¤ºæœ€åä¸€ä¸ªæ—¶åˆ»çš„`éšå«çŠ¶æ€`å’Œ`ç»†èƒçŠ¶æ€`

æ€è€ƒï¼š`output,(h_n,c_n)`æœ‰ä»€ä¹ˆä½œç”¨ï¼Ÿ

> 1ï¸âƒ£ `output`
>
> `output`æ˜¯ä¸€ä¸ª`many to many`çš„å»ºæ¨¡
>
> è¾“å…¥æ˜¯ä¸€ä¸ªåºåˆ—ï¼Œè¾“å‡ºä¹Ÿæ˜¯ä¸€ä¸ªåºåˆ—ï¼Œä¿ç•™åºåˆ—ä¸­çš„æ¯ä¸ªå…ƒç´ ï¼Œæ¯”æ–¹è¯´ï¼Œå¯¹ä¸€ä¸ªæ–‡æœ¬çš„å¤šéŸ³å­—è¿›è¡Œé¢„æµ‹ï¼Œæˆ–è€…è¯´è¯æ€§è¿›è¡Œé¢„æµ‹ï¼Œéƒ½æ˜¯ `many to many`çš„ä»»åŠ¡ï¼Œéœ€è¦æ¯ä¸€æ—¶åˆ»çš„è¾“å‡º
>
> 2ï¸âƒ£ `h_n`
>
> `h_n`æ˜¯ä¸€ä¸ª`many to one`çš„ä»»åŠ¡
>
> æ¯”æ–¹è¯´è¾“å…¥ä¸€æ®µè¯åˆ°LSTMç½‘ç»œä¸­ï¼Œæœ€ç»ˆåªå–æœ€åä¸€ä¸ªæ—¶åˆ»çš„çŠ¶æ€ï¼Œå¹¶ä¸”å¸Œæœ›æœ€åä¸€ä¸ªæ—¶åˆ»çš„çŠ¶æ€ï¼Œå°±èƒ½å»è¡¨å¾æ•´å¥è¯çš„ç‰¹å¾ï¼Œç„¶åå†å¯¹æœ€åä¸€ä¸ªçŠ¶æ€è¿›è¡Œåˆ†ç±»ï¼Œæˆ–è€…è¿›è¡Œ `sequence embedding`ï¼Œè¿™ä¸ªæ˜¯ `many to one`çš„ä»»åŠ¡ï¼Œå°±å¯ä»¥ç”¨åˆ°`h_n`

ä»¥ä¸Šï¼š

- [x] å®ä¾‹åŒ– LSTM éœ€è¦çš„ä¼ å…¥å‚æ•°
- [x] LSTM ç®—å­çš„ input parameters
- [x] LSTM çš„ outputs

**<u>RECall BiRNN</u>** 

```python
# step3 æ‰‹å†™ä¸€ä¸ª bidirectional_rnn_forwardå‡½æ•°ï¼Œå®ç°åŒå‘RNNçš„è®¡ç®—åŸç†
def bidirectional_rnn_forward(input,
                              weight_ih,
                              weight_hh,
                              bias_ih,
                              bias_hh,
                              h_prev,
                              weight_ih_reverse,
                              weight_hh_reverse,
                              bias_ih_reverse,
                              bias_hh_reverse,
                              h_prev_reverse):
    bs,T,input_size = input.shape
    h_dim = weight_ih.shape[0]
    h_out = torch.zeros(bs,T,h_dim*2) # åˆå§‹åŒ–ä¸€ä¸ªè¾“å‡ºï¼ˆçŠ¶æ€ï¼‰çŸ©é˜µï¼Œæ³¨æ„åŒå‘æ˜¯ä¸¤å€çš„ç‰¹å¾å¤§å°

    forward_output = rnn_forward(input,
                                 weight_ih,
                                 weight_hh,
                                 bias_ih,
                                 bias_hh,
                                 h_prev)[0]  # forward layer
    backward_output = rnn_forward(torch.flip(input,[1]),
                                  weight_ih_reverse,
                                  weight_hh_reverse,
                                  bias_ih_reverse, bias_hh_reverse,
                                  h_prev_reverse)[0] # backward layer

    # å°†inputæŒ‰ç…§æ—¶é—´çš„é¡ºåºç¿»è½¬
    h_out[:,:,:h_dim] = forward_output
    h_out[:,:,h_dim:] = torch.flip(backward_output,[1]) #éœ€è¦å†ç¿»è½¬ä¸€ä¸‹ æ‰èƒ½å’Œforward outputæ‹¼æ¥

    
    h_n = torch.zeros(bs,2,h_dim)  # è¦æœ€åçš„çŠ¶æ€è¿æ¥

    h_n[:,0,:] = forward_output[:,-1,:]
    h_n[:,1,:] = backward_output[:,-1,:]

    h_n = h_n.transpose(0,1)

    return h_out,h_n
    # return h_out,h_out[:,-1,:].reshape((bs,2,h_dim)).transpose(0,1)

# éªŒè¯ä¸€ä¸‹ bidirectional_rnn_forwardçš„æ­£ç¡®æ€§
bi_rnn = nn.RNN(input_size,
                hidden_size,
                batch_first=True,
                bidirectional=True)
h_prev = torch.zeros((2,bs,hidden_size))
bi_rnn_output,bi_state_finall = bi_rnn(input,h_prev)

for k,v in bi_rnn.named_parameters():
    print(k,v)
```

- æœ‰`forward layer`è¿˜æœ‰`backward layer`

```python
    forward_output = rnn_forward(input,
                                 weight_ih,
                                 weight_hh,
                                 bias_ih,
                                 bias_hh,
                                 h_prev)[0]  # forward layer
    backward_output = rnn_forward(torch.flip(input,[1]),
                                  weight_ih_reverse,
                                  weight_hh_reverse,
                                  bias_ih_reverse, bias_hh_reverse,
                                  h_prev_reverse)[0] # backward layer
```

ä¸»è¦çœ‹`backward layer`

é¦–å…ˆå¯¹è¾“å…¥è¿›è¡Œä¸€ä¸ªç¿»è½¬ `torch.flip(input,[1])` ï¼ŒæŒ‰ç…§æ—¶é—´ç»´åº¦è¿›è¡Œç¿»è½¬ï¼ŒåŒæ ·å–‚å…¥åˆ°RNN forwardå‡½æ•°ä¸­ï¼Œæœ‰å„ç§ç¿»è½¬

å†æŠŠ`forward output`å’Œ`backward output`æ‹¼èµ·æ¥ï¼Œåœ¨ç‰¹å¾ç»´åº¦ä¸Šæ‹¼èµ·æ¥ å°±æ„æˆäº† `h_out`ï¼Œä¹Ÿå°±æ˜¯åŒå‘RNNç½‘ç»œ

```python
    # å°†inputæŒ‰ç…§æ—¶é—´çš„é¡ºåºç¿»è½¬
    h_out[:,:,:h_dim] = forward_output
    h_out[:,:,h_dim:] = torch.flip(backward_output,[1])
    #éœ€è¦å†ç¿»è½¬ä¸€ä¸‹ æ‰èƒ½å’Œforward outputæ‹¼æ¥

    h_n = torch.zeros(bs,2,h_dim)  # è¦æœ€åçš„çŠ¶æ€è¿æ¥
    h_n[:,0,:] = forward_output[:,-1,:]
    h_n[:,1,:] = backward_output[:,-1,:]
    h_n = h_n.transpose(0,1)
    return h_out,h_n
```

åŒå‘GRUå’Œ åŒå‘ LSTM åŸç†ä¹Ÿæ˜¯ä¸€æ ·çš„

**å®ç° LSTM**

è°ƒç”¨å®˜æ–¹ api

```python
# å®ç°LSTMå’ŒLSTMPçš„æºç 
```

![image-20241223141412807](images/image-20241223141412807.png)

**ç¬¬ 1 æ­¥ï¼šå®šä¹‰å¸¸é‡** 

- batch size
- æ—¶é—´ï¼šT
- è¾“å…¥ç‰¹å¾å¤§å°ï¼ši_size
- h_sizeï¼šhidden sizeç½‘ç»œç»†èƒçŠ¶æ€çš„å¤§å°

```python
# å®šä¹‰å¸¸é‡
bs,T,i_size,h_size = 2,3,4,5
```

`projection size` ä¹Ÿå°±æ˜¯æŠ•å½±çš„å¤§å°ï¼ˆæš‚è·³ï¼‰

```python
# proj_size
```

**ç¬¬ 2 æ­¥ï¼šæ„å»ºè¾“å…¥ input**

å–‚å…¥åˆ°LSTMç½‘ç»œçš„ç‰¹å¾åºåˆ—

ç”¨æ­£æ€åˆ†å¸ƒåˆå§‹åŒ– torch.randn è¾“å…¥

```python
input = torch.randn(bs,T,i_size) #è¾“å…¥åºåˆ—
```

**ç¬¬ 3 æ­¥ï¼šåˆå§‹åŒ–åˆå§‹çŠ¶æ€ï¼š`c_0ã€h_0`**

é™¤äº†è¾“å…¥åºåˆ—ï¼Œè¿˜éœ€è¦åˆå§‹åŒ–ä¸¤ä¸ªåˆå§‹çŠ¶æ€ï¼Œåˆ†åˆ«æ˜¯`c_0`å’Œ`h_0`

**c_0**

å‡è®¾åªè€ƒè™‘ä¸€å±‚ï¼Œ`c_0`çš„åˆå§‹çŠ¶æ€å°±æ˜¯ `batch sizeÃ—hidden size`

```
c0 = torch.randn(bs,h_size)
```

> å› ä¸º`c`æœ¬èº«å°±æ˜¯ä¸€ä¸ªå‘é‡ï¼Œå‘é‡é•¿åº¦å°±æ˜¯ `hidden_size`
>
> è€ƒè™‘åˆ° `batch`ç»´åº¦ï¼Œæ‰€ä»¥å†™æˆ `batch sizeÃ—hidden size`
>
> ä»¥ä¸Šï¼Œåˆå§‹åŒ– `c_0` 
>

```python
c0 = torch.randn(bs,h_size) # åˆå§‹å€¼ ä¸éœ€è¦å‚ä¸è®­ç»ƒ
```



**h_0**

`c_0` ä¸éœ€è¦è®­ç»ƒï¼Œ`h_0`ä¹Ÿæ˜¯ä¸€æ ·çš„ï¼Œå°±æ˜¯æä¾›äº†`h`çš„åˆå§‹å€¼

å†™ `batch_size Ã—hidden_size`

å…ˆå†™ `hidden_size`ï¼Œæš‚æ—¶ä¸è€ƒè™‘è€ƒè™‘`projection size`

```
h0 = torch.randn(bs,h_size)
```

ä»¥ä¸Šï¼Œå®šä¹‰å¥½äº†ä¸‰ä¸ªåŸºæœ¬çš„é‡ï¼šè¾“å…¥ `input` å’Œåˆå§‹å€¼`(c_0,h_0)`

![image-20241223143614510](images/image-20241223143614510.png)

**ç¬¬ 4 æ­¥ï¼šè°ƒç”¨å®˜æ–¹LSTM APIï¼Œå®ä¾‹åŒ–**

```python
# è°ƒç”¨å®˜æ–¹LSTM API
```

å®˜æ–¹apiå°±æ˜¯`nn.LSTM`

```python
nn.LSTM()
```
å®ä¾‹åŒ–éœ€è¦ä¼ å…¥çš„å‚æ•°
![image-20241223143805568](images/image-20241223143805568.png)

ä¼ å…¥çš„å‚æ•°é¡ºåºåˆ†åˆ«æ˜¯ input sizeã€hidden sizeã€batch first

projection sizeæš‚æ—¶ä¸ç”¨

- `input_size` å°±æ˜¯ `i_size`
- `hidden_size`å°±æ˜¯`h_size`
- `batch_first`è®¾ç½®æˆ `true`

ä»¥ä¸Šå®ä¾‹åŒ–äº†ç®€å•çš„LSTM layerï¼Œå®šä¹‰ï¼š`lstm_layer`

```python
lstm_layer = nn.LSTM(i_size,h_size,batch_size=True)
```

**ç¬¬ 5 æ­¥ï¼š`LSTM` ç®—å­ `input parameters`**

åœ¨å®šä¹‰å¥½LSTM layerä»¥åï¼ŒæŠŠ`è¾“å…¥`å’Œ`åˆå§‹çŠ¶æ€`åˆ†åˆ«ä¼ å…¥åˆ°LSTM layerä¸­

**å…·ä½“æ€ä¹ˆä¼ å…¥å‚æ•°?**

å»çœ‹api

![image-20241223144423828](images/image-20241223144423828.png)

ä»`api`å¯ä»¥çœ‹åˆ°ï¼Œ`inputs`æ˜¯ `input`å’Œ`ä¸€ä¸ªå…ƒç»„`

åœ¨å…ƒç»„ä¸­ï¼Œéœ€è¦ä¼ å…¥`h0`å’Œ`c0`

æ‰€ä»¥ä»£ç å†™`input`ï¼Œç„¶åå†å†™`ä¸€ä¸ªå…ƒç»„`

```python
lstm_layer(input,())
```

å…ƒç»„åˆ†åˆ«ä¼ å…¥ `h0` å’Œ`c0`

```python
lstm_layer(input,(h0,c0))
```

é‚£ç»´åº¦æ˜¯å¤šå°‘å‘¢ï¼Ÿå®˜æ–¹æ–‡æ¡£ï¼š

![image-20241223144701143](images/image-20241223144701143.png)

`h0`çš„ç»´åº¦æ˜¯`D*num_layersÃ—NÃ—H_out`

`c0`ä¹Ÿæ˜¯ä¸€æ ·çš„ï¼Œé¦–å…ˆåˆå§‹åŒ– `NÃ—H_out`

```python
output,(h_finall,c_finall) = lstm_layer(input,
                                        (h0.unsqueeze(0),c0.unsqueeze(0)))
```

æ¼”ç¤ºçš„æ˜¯å•å‘çš„LSTMç½‘ç»œï¼Œæ˜¯ä¸€å±‚çš„ï¼Œæ‰€ä»¥å‰é¢çš„æ•°å­—åœ¨åˆå§‹åŒ–æ—¶çœæ‰äº†

ç°åœ¨å…ˆæ‰©ä¸€ä¸‹ï¼Œæ‰©æˆ ä¸‰ç»´

å¯¹`h0`è°ƒç”¨`unsqueeze`å‡½æ•°ï¼Œåœ¨ç¬¬0ç»´æ‰©ä¸€ç»´

`c0`ä¹ŸåŒæ ·æ‰©ç»´ï¼Œå˜æˆä¸‰ç»´å¼ é‡ï¼Œç¬¬0ç»´æ˜¯1

ä»¥ä¸Šæ˜¯å•å±‚å•å‘LSTM ç®—å­ï¼Œå¯ä»¥å¾—åˆ°è¾“å‡º

```python
# å®šä¹‰å¸¸é‡
bs,T,i_size,h_size = 2,3,4,5
# proj_size
input = torch.randn(bs,T,i_size) # è¾“å…¥åºåˆ—
c0 = torch.randn(bs,h_size)  # åˆå§‹å€¼ä¸éœ€è¦è®­ç»ƒ
h0 = torch.randn(bs,h_size)
# è°ƒç”¨å®˜æ–¹LSTM API
lstm_layer = nn.LSTM(i_size,h_size,batch_first=True)
output,(h_finall,c_finall) = lstm_layer(input,
                                (h0.unsqueeze(0),c0.unsqueeze(0)))

for k,v in lstm_layer.named_parameters():
    print(k,v.shape)
```

**ç¬¬ 6 æ­¥ï¼šè¾“å‡º `Outputs:output,(h_n,c_n)`**

![image-20241223150732582](images/image-20241223150732582.png)

è¿™é‡Œå†™è¾“å‡ºï¼š

```python
# è°ƒç”¨å®˜æ–¹LSTM api
lstm_layer = nn.LSTM(i_size,
                     h_size,
                     batch_first=True)
output,(hn,cn) = lstm_layer(input,
                            (h0.unsqueeze(0),c0.unsqueeze(0)))
```

ä»¥ä¸Šè°ƒç”¨å¥½äº†apiï¼Œæ¥ä¸‹æ¥æ‰“å°output

```python
print(output)
```

æ”¹åå­—ï¼Œå®šä¹‰`h_finall`å’Œ`c_finall`ï¼Œè¡¨ç¤ºæœ€åä¸€ä¸ªæ—¶åˆ»çš„éšå«çŠ¶æ€å’Œç»†èƒçŠ¶æ€

```python
output,(h_finall,c_finall) = lstm_layer(input,
                                        (h0.unsqueeze(0),c0.unsqueeze(0)))
```

**ç¬¬ 7 æ­¥ï¼šæ‰“å°LSTM æ¨¡å‹å‚æ•°**

å®˜æ–¹ api å®ç° LSTMï¼Œå¯ä»¥è°ƒç”¨ LSTM layer çš„ `named_parameter` å‡½æ•°ï¼Œæ‰“å°æƒé‡å’Œåå­—ï¼ŒæŸ¥çœ‹ LSTM æ¨¡å‹å‚æ•°

```python
for k,v in named_parameters():
    print(k,v)
```

![image-20241223151244370](images/image-20241223151244370.png)

å¯ä»¥çœ‹åˆ°LSTMçš„å‚æ•°åä»¥åŠå…·ä½“çš„å¼ é‡ï¼š

- `weight_ih_l0` å¯¹åº”å…¬å¼é‡Œçš„ $W_{ii}$ $W_{if}$  $W_{ig}$ $W_{io}$  å››ä¸ª $W_i$æ”¾åˆ°äº†ä¸€ä¸ª `weight_ih`é‡Œé¢
- `weight_hh_l0` è¿™ä¸ªå‚æ•°æ˜¯å…¬å¼çš„ å››ä¸ª $W_{hi}$  $W_{hf}$ $W_{hg}$ $W_{ho}$ $W_h$æ‹¼èµ·æ¥çš„
- `bias_ih_l0` 
- `bias_hh_l0`

æœ€åä¸¤ä¸ªåç½®é¡¹ï¼ŒåŒæ ·æ˜¯æ‹¼èµ·æ¥çš„ï¼Œè¿™æ ·ç›´æ¥çœ‹å¼ é‡ä¸æ¸…æ™°ï¼Œæ¥ä¸‹æ¥çœ‹shape

![image-20241223155922046](images/image-20241223155922046.png)

![image-20241223155937493](images/image-20241223155937493.png)

å¯ä»¥çœ‹åˆ°è¿™ä¸ª`LSTM layer`ä¸­ä¸€å…±æœ‰4ä¸ªå‚æ•°ï¼›

<font color="0000FF">ç¬¬ä¸€ä¸ªå‚æ•° </font> æ˜¯ `weight_ih_l0` ï¼š 20Ã—4

**ä¸ºä»€ä¹ˆæ˜¯ 20Ã—4å‘¢ï¼Ÿ** 

> - `20`æ˜¯`hidden_size`ï¼Œå°±æ˜¯`5`è¿™ä¸ªç»´åº¦ï¼Œç„¶åæŠŠ`4`ä¸ª`W`æ‹¼èµ·æ¥
>
> æœ¬æ¥æ¯ä¸€ä¸ªæ˜¯`5`è¡Œï¼Œç°åœ¨æ‹¼æˆäº†`20`è¡Œï¼Œ`20`å°±æ˜¯`5Ã—4`
>
> - `4`æ˜¯ `input_size`ï¼Œå› ä¸ºè¿™ä¸ª`w_ih`æ˜¯è·Ÿ `input` ç›¸ä¹˜çš„ï¼Œæ˜¯å¯¹`input`è¿›è¡Œçº¿æ€§å˜æ¢çš„å‚æ•°

![image-20241223160404063](images/image-20241223160404063.png)

è§£é‡Šè¿™é‡Œçš„æƒé‡ï¼š

$T=3ï¼Œinput\_size = 4ï¼Œhidden\_size = 5$

$4(4Ã—1) \stackrel{5Ã—4}{\rightarrow} 5(5Ã—1)$

$âˆ´ weight\_ih = 5 Ã— 4 å †å  4 ä¸ª â†’ 20Ã—4$



<font color="0000FF">ç¬¬äºŒä¸ªå‚æ•°Â </font>  `weight_hh_l0` å‚æ•°æ˜¯ `20Ã—5`çš„

> - `20` æ˜¯ `4Ã—5` æ¥çš„
> - `5` æ˜¯`weight_hh`æ˜¯è·Ÿ`ä¸Šä¸€æ—¶åˆ»çš„éšå«çŠ¶æ€`è¿›è¡Œçº¿æ€§å˜æ¢çš„ï¼Œç»´åº¦æ˜¯`5`  
> -  $âˆ´ 1 ä¸ª weight\_hh shape = 5 Ã— 5$
>
> > éšè—å±‚æ˜¯`linear`å±‚ï¼š`y=wx+b`
> >
> > `w`çš„ç»´åº¦å°±æ˜¯`hidden sizeÃ—input size`
> >
> > è¿™é‡Œçš„`hidden_size`å°±æ˜¯5ï¼Œ`input_size`æ˜¯4

<font color="0000FF">ç¬¬ä¸‰ä¸ªã€ç¬¬å››ä¸ªå‚æ•°ï¼š</font>ä¸¤ä¸ª`bias`

> `bias_ih`å’Œ`bias_hh` éƒ½æ˜¯`20`ï¼Œ`20`æ˜¯ `4Ã—5`æ¥çš„ï¼Œå°±æ˜¯æœ‰`4`ä¸ª`bias`ï¼ˆ`4`ä¸ª`bi`å’Œ`4`ä¸ª`bh`ï¼‰ï¼ŒæŠŠè¿™å››ä¸ªæ‹¼èµ·æ¥ï¼Œæ¯ä¸€ä¸ªé•¿åº¦éƒ½æ˜¯20çš„

ä»¥ä¸Šæ˜¯LSTMä¸å¸¦projectionçš„å®ç°

```python
import torch
import torch.nn as nn
import torch.nn.functional as F

# å®šä¹‰å¸¸é‡
bs,T,i_size,h_size = 2,3,4,5
input = torch.randn(bs,T,i_size) # è¾“å…¥åºåˆ—
c0 = torch.randn(bs,h_size)  # åˆå§‹å€¼ä¸éœ€è¦è®­ç»ƒ
h0 = torch.randn(bs,h_size)

# è°ƒç”¨å®˜æ–¹LSTM API
lstm_layer = nn.LSTM(i_size,h_size,batch_first=True)
output,(h_finall,c_finall) = lstm_layer(input,(h0.unsqueeze(0),c0.unsqueeze(0)))

for k,v in lstm_layer.named_parameters():
    print(k,v.shape)
```

OUTï¼š

```python
weight_ih_l0 torch.Size([20, 4])
weight_hh_l0 torch.Size([20, 5])
bias_ih_l0 torch.Size([20])
bias_hh_l0 torch.Size([20])
```

å¯ä»¥æ ¹æ®è¿™äº›å‚æ•°ï¼Œæ¥è‡ªå·±å†™ä¸€ä¸ªLSTMæ¨¡å‹

## è‡ªå®šä¹‰ LSTM å®ç°

```python
# è‡ªå·±å†™ä¸€ä¸ªLSTMæ¨¡å‹
```

æ ¹æ®`ä¸Šé¢çš„å‚æ•°ã€h0ã€c0ã€input`ï¼Œå¯ä»¥è‡ªå·±å†™ä¸€ä¸ªLSTM

```python
def lstm_forward():
	pass
```

**<u>ç¬¬ 1 æ­¥ï¼šå‡½æ•°ç­¾å</u>** 

**é¦–å…ˆæ€è€ƒè¿™ä¸ª LSTM æ¨¡å‹ï¼Œéœ€è¦å“ªäº›è¾“å…¥å‘¢ï¼Ÿ**

ç¬¬ä¸€ä¸ªï¼šéœ€è¦ä¼ å…¥çš„ `input`

ç¬¬äºŒä¸ªï¼š å…ƒç»„å½¢å¼çš„ `initial states`

ç¬¬ä¸‰ä¸ªï¼š æƒé‡å’Œåç½®ï¼ŒåŒ…æ‹¬`W_ihã€W_hhã€b_ihã€b_hh`

ä»¥ä¸Šæ˜¯`LSTM forward`çš„ç­¾å

```python
def lstm_forward(input,
                 initial_states,
                 w_ih,
                 w_hh,
                 b_ih,
                 b_hh):
```

å¦‚æœå¸¦ projectionçš„è¯ï¼Œåé¢è¿˜éœ€è¦å†åŠ å‚æ•°

**ç¬¬ 2 æ­¥ï¼šæ‹†è§£`initial states`ï¼š `h0`å’Œ`c0`**

```python
h0,c0 = initial_states  # åˆå§‹çŠ¶æ€
```

**ç¬¬ 3 æ­¥ï¼šæ‹†è§£  `input.shape`**

é€šè¿‡`input shape`å¾—åˆ°`batch sizeã€æ—¶é—´Tï¼Œinput size`

å¾—åˆ°`æ—¶é—´T`ï¼Œè¿›è¡Œ`forå¾ªç¯`ï¼Œä¸æ–­çš„è¿­ä»£ï¼Œä¸æ–­çš„è¿ç®—

```python
bs,T,i_size = input.shape
```

ä»¥ä¸Šæ˜¯`input_size` 

è¿˜æœ‰`h_size`

**`h_size`æ€ä¹ˆå¾—åˆ°å‘¢ï¼Ÿ**

> `h_size`æ ¹æ® `W` çš„ç»´åº¦ æ¥ç¡®å®š
>
> æ¯”å¦‚`weight_ih`ï¼Œé™¤ä»¥`4`å°±å¥½äº†ï¼Œå› ä¸ºæ˜¯`4`ä¸ª `W` æ‹¼èµ·æ¥çš„

```python
h_size = w_ih.shape[0]//4
```

ç¬¬`0`ç»´é™¤ä»¥`4`ï¼Œå°±æ˜¯æ¯ä¸€ç»´çš„`hidden_size`

**ç¬¬ 4 æ­¥ï¼šfor å¾ªç¯åˆå§‹åŒ–**

æŠŠ`h0`å’Œ`c0`æ¢åå­—ï¼š`prev_h` å’Œ `prev_c`

å› ä¸ºä¼šåœ¨ `for`å¾ªç¯ä¸­ï¼Œä¸æ–­çš„æ›´æ–° `prev_h`å’Œ`prev_c`

```python
prev_h = h0
prev_c = c0
```

æŠŠæ¯ä¸€æ—¶åˆ»çš„`h`å’Œ`c`å½“åšä¸‹ä¸€æ—¶åˆ»çš„ `prev_h`å’Œ`prev_c`

**ç¬¬ 5 æ­¥ï¼šoutput size**

å¦å¤–è¿˜æœ‰ä¸€ä¸ª `size` å«åš `output size`ï¼Œä¹Ÿå°±æ˜¯ `è¾“å‡ºçš„çŠ¶æ€å¤§å°` å°±æ˜¯ `hidden size`

```python
output_size = h_size
```

ä»¥ä¸Šæ˜¯åˆå§‹åŒ–output

åœ¨å†™ç¥ç»ç½‘ç»œæˆ–è€…å¾ªç¯ç¥ç»ç½‘ç»œï¼š

ï¼ˆ1ï¼‰é¦–å…ˆåˆå§‹åŒ–çŸ©é˜µï¼›

ï¼ˆ2ï¼‰ç„¶åå¯¹çŸ©é˜µè¿›è¡Œå¡«å……ï¼Œ`çŸ©é˜µçš„å¤§å°`è·Ÿ`è¾“å…¥ç‰¹å¾å¤§å°`æ˜¯ä¸€æ ·çš„

è¾“å…¥åºåˆ—å¤§å°ï¼š`bsÃ—TÃ—input_size`

- `batch size`å’Œ `T` ç»´åº¦æ˜¯ä¸å˜
- ç„¶åç‰¹å¾ç»´åº¦ `input size` æ”¹æˆ `output size` 

ä»¥ä¸Šå®Œæˆ `output` çš„åˆå§‹åŒ–

```python
output = torch.zeros(bs,T,output_size) # è¾“å‡ºåºåˆ—
```

**ç¬¬ 6 æ­¥ï¼šfor å¾ªç¯**

å®Œæˆåˆå§‹åŒ–ä»¥åï¼Œæ¥ä¸‹æ¥å¯¹æ—¶é—´è¿›è¡Œéå†

LSTMå°±æ˜¯`æ¯ä¸€æ—¶åˆ»`éƒ½åœ¨å¯¹`ä¸Šä¸€æ—¶åˆ»`çš„$c$å’Œ $h$è¿›è¡Œæ›´æ–°ï¼Œ`forå¾ªç¯`å®ç°è¿™ä¸ªè¿‡ç¨‹ï¼Œå¯¹æ¯ä¸€æ—¶åˆ»è¿›è¡Œè¿ç®—ï¼Œå¾ªç¯çš„æ­¥æ•°å°±æ˜¯å¤§`T`æ­¥

```python
for t in range(T):
```

åœ¨æ¯ä¸€ä¸ªå¾ªç¯çš„å¼€å§‹ï¼š

- éœ€è¦æ‹¿åˆ°å½“å‰è¿™ä¸€æ—¶åˆ»çš„$x$ï¼Œå¯ä»¥é€šè¿‡$input$æ‹¿

> å› ä¸º$input$è¿™ä¸ªç»´åº¦å°±æ˜¯ `batch sizeÃ—TÃ—input size`ï¼Œå½“å‰æ—¶åˆ»çš„è¾“å…¥æ‹¿åˆ° `t` è¿™ä¸€ç»´åº¦å°±å¥½ï¼Œå°±æ˜¯å½“å‰æ—¶åˆ»çš„è¾“å…¥å‘é‡

```python
x = input[:,t,:]  # å½“å‰æ—¶åˆ»çš„è¾“å…¥å‘é‡
```

æ¥ä¸‹æ¥ï¼Œæ ¹æ®å…¬å¼è¿›è¡Œè®¡ç®—ï¼š

![image-20241223173629201](images/image-20241223173629201.png)

$weight_{ih} = [w_{ii},w_{if},w_{ig},w_{io}]'$

- $\mathrm{w_{ii}}$ ï¼š 5 Ã— 4 
- $\mathrm{weight_{ih}}$ ï¼š20Ã—4

**<u>å…¬å¼çš„ä»£ç å®ç°é€»è¾‘ï¼š</u>**

- é¦–å…ˆè®¡ç®— $W Ã— x$ï¼Œå†è®¡ç®— $W Ã— h$

å…ˆæŠŠ `å¤§çš„ä¸€å—` ç®—å‡ºæ¥

> æ‹¼èµ·æ¥çš„`W`åˆ†åˆ«ä¸`x`å’Œ`h`è¿›è¡Œä¸€ä¸ªç›¸ä¹˜ï¼Œè€ƒè™‘åˆ° `batch`ï¼Œéœ€è¦è¿ç”¨çš„å¸¦batchçš„çŸ©é˜µç›¸ä¹˜ï¼›

- æ˜ç¡® `W_ih`å’Œ`W_hh`çš„ç»´åº¦æ˜¯ä»€ä¹ˆï¼š

```python
w_ih #  
w_hh
```

- `w ih` æ˜¯ **`4å€çš„hidden size`Ã— `input size`**

- `w hh` æ˜¯ **`4å€çš„hidden sizeÃ— hidden size`**

ä»¥ä¸Š æ˜¯ä¸¤ä¸ªæƒé‡çš„ç»´åº¦

```python
w_ih  # [4*h_size,i_size]
w_hh  # [4*h_size,h_size]
```

- è®¡ç®— $w_{ih} \cdot x$


**æ€è€ƒï¼š**  $x$çš„ç»´åº¦æ˜¯å¤šå°‘å‘¢ï¼Ÿ `batch sizeÃ—input size`

```python
x = input[:,t,:]  # å½“å‰æ—¶åˆ»çš„è¾“å…¥å‘é‡ï¼Œ[bs,i_size]
```

åˆ†æï¼š

ğŸ¾ $x$ æ˜¯`å¸¦ batch`çš„ï¼Œä½†æ˜¯$w$æ˜¯`ä¸å¸¦batch`çš„

ğŸ¾  æ‰€ä»¥é¦–å…ˆè¦å¯¹ `w` æ‰©ç»´åº¦ï¼ŒæŠŠ `batch` ç»´åº¦æ‰©å‡ºæ¥ï¼Œ`batch`ç»´æ”¾åœ¨å¼€å§‹ï¼Œæ‰€ä»¥æ‰© 0ç»´

```python
w_ih.unsqueeze(0)  # [4*h_size,i_size]
w_hh  # [4*h_size,h_size]
```

éœ€è¦`batch size(bs)`ä¸ªï¼Œæ‰€ä»¥ç”¨`.tileå‡½æ•°`å¯¹ç¬¬`0`ç»´å¤åˆ¶`bså€`ï¼Œåé¢ä¸¤ä¸ªç»´åº¦`ä¸å˜`ï¼ŒæŠŠè¿™ä¸ªå˜é‡å«åš `batch_w_ih`

```python
batch_w_ih = w_ih.unsqueeze(0).tile(bs,1,1) # [bs,4*h_size,i_size]
```

ä»¥ä¸Šå®ç°äº†æƒé‡çš„æ‰©ç»´ï¼Œå˜æˆäº† ä¸‰ç»´

åŒæ ·`w hh`ä¹Ÿæ˜¯ ä¸€æ ·çš„ï¼Œå…ˆæ‰©ä¸€ä¸ª `batchç»´åº¦`ï¼Œç„¶å`tileå¤åˆ¶`ä¸€ä¸‹ï¼Œå®šä¹‰ä¸º`batch_w_hh`

```python
batch_w_hh = w_hh.unsqueeze(0).tile(bs,1,1)
```

ç»´åº¦å˜æˆäº† $\mathrm{bs Ã— 4å€çš„hidden\_size Ã— hidden\_size}$

```python
batch_w_ih = w_ih.unsqueeze(0).tile(bs,1,1) # [bs,4*h_size,i_size]
batch_w_hh = w_hh.unsqueeze(0).tile(bs,1,1) # [bs,4*h_size,h_size]
```

ä»¥ä¸Šå¯¹æƒé‡è¿›è¡Œ æ‰©ç»´ï¼Œæ‰©ç»´ä»¥åï¼š

- å½“å‰çš„ `batch_w_ihå½¢çŠ¶`æ˜¯ $\mathrm{bs Ã— 4å€çš„hidden\ sizeÃ—input\ size}$
- å½“å‰çš„ `è¾“å…¥å‘é‡ x` çš„å½¢çŠ¶æ˜¯ ï¼š $\mathrm{batch\  sizeÃ—input\ size}$

è®©è¿™ä¸¤ä¸ªçŸ©é˜µè¿›è¡Œ `bmm` çš„ç›¸ä¹˜ï¼Œä¹Ÿå°±æ˜¯`batch matrix multiplication`

- é‚£å°±è¦ä¿æŒ `batch` è¿™ä¸ªç»´åº¦æ˜¯ç›¸åŒçš„
- åé¢çš„ä¸¤ä¸ªç»´åº¦ è¦æ»¡è¶³ çŸ©é˜µä¹˜æ³•çš„åŸºæœ¬è§„åˆ™ï¼š`ç¬¬ä¸€ä¸ªçŸ©é˜µçš„åˆ—æ•° ï¼ ç¬¬äºŒä¸ªçŸ©é˜µçš„ è¡Œæ•°`

æ‰€ä»¥è¦å¯¹ `x`  è¿›è¡Œæ‰©ç»´ï¼ŒåŒæ ·å¯¹`x`çš„ `ç¬¬ä¸‰ç»´` å¢åŠ ä¸€ä¸ªç»´åº¦

```python
x.unsqueeze(-1)
```

è®¡ç®— `w_times_x`ï¼šè°ƒç”¨ä¸€ä¸‹ `torch.bmmå‡½æ•°`ï¼š

- é¦–å…ˆä¼ å…¥ `batch w ih`

```python
w_times_x = torch.bmm(batch_w_ih,)
```

- ç„¶åä¼ å…¥ `x`ï¼Œå¹¶å¯¹ `x`è¿›è¡Œæ‰©ç»´

> åœ¨`-1ç»´` æ‰©ä¸€ç»´ ï¼Œå˜æˆ $\mathrm{batch\ size Ã— input\ size Ã—1}$

- å¾—åˆ°ä¹˜æ³•çš„ç»“æœ `w_times_x` ï¼š 

```python
w_times_x = torch.bmm(batch_w_ih,x.unsqueeze(-1))  # [bs,4*h_size,1]
```

**ç›¸ä¹˜ ä»¥åçš„ç»´åº¦æ˜¯å¤šå°‘å‘¢ï¼Ÿ** 

- ç›¸ä¹˜ä»¥åçš„ç»´åº¦ï¼š $\mathrm{batch\ sizeÃ— 4å€çš„hidden\ size Ã— 1}$
-  æœ€åçš„`1`ç»´åº¦ ä¸è¦ï¼ŒæŠŠ `1` è¿™ä¸ªç»´åº¦å»æ‰ï¼š

```python
w_times_x = w_times_x.squeeze(-1) # [bs,4*h_size]
```

ä»¥ä¸Š æŠŠ `1` è¿™ä¸ªç»´åº¦å»æ‰äº†ï¼Œå½¢çŠ¶æ˜¯ `batch size Ã— 4å€çš„hidden size`

ä»¥ä¸Šæ˜¯ `w times x` çš„è®¡ç®—è¿‡ç¨‹

![image-20241223180800659](images/image-20241223180800659.png)

å®ç°å®Œ `w_times_x`ï¼Œå…·ä½“æ¥è¯´å°±æ˜¯ $W_{ii}x_t$ ã€ $W_{if}x_t$ ã€ $W_{ig}x_t$ ã€ $W_{io}x_t$

è¿˜æœ‰ `w_times_h`ï¼Œå°±æ˜¯LSTMç½‘ç»œä¸­åå››é¡¹

![image-20241223181032820](images/image-20241223181032820.png)

å®ç°æ€è·¯æ˜¯ä¸€æ ·çš„ï¼Œå¤åˆ¶ä¸‹æ¥æ”¹æˆ

-  `w_hh`

- `prev_h`

- å› ä¸ºæ˜¯è·Ÿ `h_{t-1}` è¿›è¡Œ çº¿æ€§ç»„åˆï¼Œæ‰€ä»¥ä¹Ÿè¦å†™æˆ  `h_prev`
- åŒæ ·ä¹Ÿè¦æŠŠ `ç»´åº¦` å˜æˆ `äºŒç»´`çš„

```python
w_times_h = torch.bmm(batch_w_hh,h_prev.unsqueeze(-1))  
# [bs,4*h_size,1]
w_times_h = w_times_h.squeeze(-1) # [bs,4*h_size]
```

ä»¥ä¸Šç®—å‡º `w_times_h`

æœ€åæŠŠåç§°æ”¹æˆ `h_prev`æ›´å¥½ï¼Œå› ä¸ºæ˜¯è·Ÿä¸Šä¸€æ—¶åˆ»çš„ `hidden state` è¿›è¡Œçº¿æ€§ç»„åˆ

```python
w_times_h_prev = torch.bmm(batch_w_hh,h_prev.unsqueeze(-1))  
# [bs,4*h_size,1]
w_times_h_prev = w_times_h.squeeze(-1) # [bs,4*h_size]
```

**<u>æ¥ä¸‹æ¥ï¼Œåˆ†åˆ«ç®—å‡º è¾“å…¥é—¨ã€é—å¿˜é—¨ã€cellå’Œè¾“å‡ºé—¨</u>**

ä¹Ÿå°±æ˜¯ `iã€fã€gã€o`

![image-20241223181513560](images/image-20241223181513560.png)

```
# åˆ†åˆ«è®¡ç®—è¾“å…¥é—¨(i)ã€é—å¿˜é—¨(f)ã€cellé—¨(g)ã€è¾“å‡ºé—¨(o)
```

<u>é¦–å…ˆè®¡ç®—$i_t$ï¼Œæ ¹æ®å…¬å¼ï¼š</u>

$i_t = \sigma(W_{ii}x_t + b_{ii} + W_{hi}h_{t-1}+b_{ii})$

`i_t` æ˜¯  $Wx$çš„ç¬¬ä¸€éƒ¨åˆ†ç»“æœ+$b$+$Wh$çš„ç¬¬ä¸€éƒ¨åˆ†ç»“æœ+$b$

ï¼ˆ1ï¼‰é¦–å…ˆ `w_times_x`çš„ç¬¬ä¸€éƒ¨åˆ†ç»“æœå–å‡ºæ¥

ï¼ˆ2ï¼‰ `w_times_x`çš„ç»“æœæ˜¯ `batch size Ã—4å€çš„hidden size`

-  `batch size`è¿™ä¸€ç»´åº¦å…¨éƒ¨æ‹¿å‡ºæ¥
- `hidden size`è¿™ä¸€ç»´ åªæ‹¿ç¬¬ä¸€éƒ¨åˆ†çš„ `hidden size`

 `w_times_x` æ˜¯ä¸€ä¸ªå¤§çš„æ‹¼èµ·æ¥çš„ç»“æœï¼Œç›®å‰åªéœ€è¦å–å‰ $\frac{1}{4}$ï¼š

```python
i_t = w_times_x[:,:h_size]+
```

åé¢ `w_times_h_prev`ä¹Ÿæ˜¯å–å‰ $\frac{1}{4}$ ï¼š

```python
i_t = w_times_x[:,:h_size]+w_times_h_prev[:,:h_size]+
```

è¿˜æœ‰ä¸¤ä¸ªåç½®$b_{ih}$å’Œ$b_{hh}$ä¹Ÿæ˜¯ä¸€æ ·çš„ï¼Œåªå– å‰  $\frac{1}{4}$ ï¼š

```python
i_t = w_times_x[:,:h_size]+w_times_h_prev[:,:h_size]+b_ih[:h_size]+b_hh[:h_size]
```

æœ€åè¿˜æœ‰éçº¿æ€§æ¿€æ´»å‡½æ•°  $\sigma$ï¼Œåœ¨å‰é¢åŠ ä¸Š `torch.sigmoid`

![image-20241223193918820](images/image-20241223193918820.png)

ä»¥ä¸Šæ˜¯ $i_t$

è¾“å…¥é—¨çš„è®¡ç®—= `wä¹˜ä»¥xçš„å‰å››åˆ†ä¹‹ä¸€éƒ¨åˆ†`ï¼Œ `wä¹˜ä»¥h prevä¹Ÿæ˜¯å‰å››åˆ†ä¹‹ä¸€éƒ¨åˆ†`ï¼Œç„¶å`ä¸¤ä¸ªbias`åŠ èµ·æ¥ï¼Œç»è¿‡ä¸€ä¸ª `éçº¿æ€§æ¿€æ´»å‡½æ•° sigmoid` å°±å¾—åˆ° è¾“å…¥é—¨

![image-20241223194131625](images/image-20241223194131625.png)

<u>æ¥ä¸‹æ¥ é—å¿˜é—¨</u> 

é—å¿˜é—¨ä¹Ÿæ˜¯ç±»ä¼¼çš„ï¼ŒåŒæ ·ä¹Ÿæ˜¯ sigmoidï¼Œç›´æ¥å¤åˆ¶

ä½†æ˜¯é—å¿˜é—¨ä¸æ˜¯å‰å››åˆ†ä¹‹ä¸€

```python
i_t = torch.sigmoid(w_times_x[:,:h_size]+w_times_h_prev[:,:h_size]+b_ih[:h_size]+b_hh[:h_size])

i_t = torch.sigmoid(w_times_x[:,:h_size]+w_times_h_prev[:,:h_size]+b_ih[:h_size]+b_hh[:h_size])
```

è€Œæ˜¯`å‰å››åˆ†ä¹‹ä¸€` åˆ°`äºŒåˆ†ä¹‹ä¸€`çš„éƒ¨åˆ†ï¼š

```python
w_times_x[:,h_size:2*h_size]
```

å³ï¼Œ

```python
f_t = torch.sigmoid(w_times_x[:,h_size:2*h_size]+w_times_h_prev[:,h_size:2*h_size]+b_ih[h_size:2*h_size]+b_hh[h_size:2*h_size])
```

`hidden  size` åˆ° `2å€çš„hidden size`

ä»¥ä¸Šæ˜¯é—å¿˜é—¨

![image-20241223194432988](images/image-20241223194432988.png)

<u>æ¥ä¸‹æ¥ï¼Œç»†èƒé—¨ $g_t $ï¼š</u> 

ç»†èƒé—¨$g_t$ä¹Ÿæ˜¯ç±»ä¼¼çš„ï¼Œåªä¸è¿‡å½“å‰ `sigmoid` æ›¿æ¢æˆäº†`tanhå‡½æ•°`

![image-20241223194644285](images/image-20241223194644285.png)

æ‰€ä»¥ç»§ç»­å¤åˆ¶ä¸‹æ¥ ï¼Œå†æ”¹ï¼Œå°±å¯ä»¥è®¡ç®—å‡ºç»†èƒçŠ¶æ€ $g_t$ ï¼š

```python
g_t = torch.tanh(w_times_x[:,2*h_size:3*h_size]+w_times_h_prev[:,2*h_size:3*h_size]+b_ih[2*h_size:3*h_size]+b_hh[2*h_size:3*h_size])
```

gtæ˜¯`äºŒå€çš„hidden size` åˆ° `ä¸‰å€çš„ hidden size`è¿™ä¸ªåŒºé—´

åŒæ ·åé¢çš„åç½®ä¹Ÿæ˜¯ä¸€æ ·çš„

æ¢ä¸€ä¸ªåŒºé—´ï¼Œç„¶å éçº¿æ€§æ¿€æ´»å‡½æ•°æ”¹æˆ `tanhå‡½æ•°`

<u>æœ€åæ˜¯$o_t$ï¼Œ è¾“å‡ºé—¨ï¼š</u>

- `tanhå‡½æ•°` æ¢æˆ `sigmoidå‡½æ•°`

- æœ€ååŒºé—´æ˜¯æœ€åçš„å››åˆ†ä¹‹ä¸€ï¼Œå¯ä»¥å†™æˆ `3å€çš„hidden size`åˆ°`4å€çš„hidden size`

```python
o_t = torch.sigmoid(w_times_x[:,3*h_size:4*h_size]+w_times_h_prev[:,3*h_size:4*h_size]+b_ih[3*h_size:4*h_size]+b_hh[3*h_size:4*h_size])
```

- æˆ–è€…ç›´æ¥ `w_times_x[:,3*h_size:]`  ï¼š`3`å€çš„ `hidden size`ï¼Œ`4`å¯ä»¥çœç•¥

ä»¥ä¸Šæ˜¯æ‰€æœ‰çš„ `iã€fã€gã€o`

![image-20241223195148713](images/image-20241223195148713.png)

![image-20241223195205750](images/image-20241223195205750.png)

å†™å®Œäº† $iã€fã€gã€o$ï¼Œæ¥ä¸‹æ¥å†™ç»†èƒçŠ¶æ€ $c_tã€ h_t$

$c_t$æ€ä¹ˆå†™å‘¢ï¼Ÿ

> $c_t$ ç›´æ¥æ˜¯å…ƒç´ ç›¸ä¹˜ï¼Œå®ç°çš„æ—¶å€™ä¸ç”¨ $c_t$ï¼Œç”¨$\mathrm{prev_c}$
>
> å› ä¸ºç°åœ¨ç”¨ `forå¾ªç¯`è¿­ä»£
>
> è¦ä¿è¯ä¸‹ä¸€æ—¶åˆ»$\mathrm{prev_c}$çš„é‡æ˜¯å­˜åœ¨çš„ï¼Œç”¨$\mathrm{prev_c}$è¡¨ç¤º$c_t$
>
> é‚£$prev_c$= $f_tÃ— c_{t-1}åŠ ä¸Š i_tÃ—g_t \iff f_tÃ—prev_ c + i_tÃ— g_t$
>
> ä»¥ä¸Šæ˜¯å¯¹ $prev_c$ çš„æ›´æ–°

```python
prev_c = f_t * prev_c + i_t * g_t
```

æœ‰äº† `prev_c`ä»¥åå°±èƒ½è®¡ç®— `prev_h`

![image-20241223200900790](images/image-20241223200900790.png)

- $prev_h$ å°±æ˜¯å½“å‰æ—¶åˆ» LSTMçš„è¾“å‡º 

- æŒ‰ç…§å…¬å¼ å°±æ˜¯ $è¾“å‡ºé—¨ Ã— tanh ç»†èƒçŠ¶æ€$

```python
prev_h = o_t * torch.tanh(prev_c)
```

ä»¥ä¸Šæ˜¯å¯¹ $c$å’Œ $h$ çš„æ›´æ–°

æœ‰äº† $h$ä»¥åï¼Œå°±å¯ä»¥å¯¹`è¾“å‡ºçŸ©é˜µ`ä¹Ÿæ›´æ–°ä¸€ä¸‹ï¼ŒæŠŠæ¯ä¸€æ—¶åˆ»çš„éšè—å±‚çŠ¶æ€å­˜å‚¨ï¼Œå­˜åˆ° `output çŸ©é˜µ`ä¸­ï¼š

```python
output[:,t,:] = prev_h
```

ä»¥ä¸Šæ˜¯æ‰€æœ‰è‡ªå®šä¹‰ LSTM å‡½æ•°çš„å®ç°

ç°åœ¨è¿”å›ï¼š

- ç¬¬ä¸€ä¸ªè¿”å›å€¼æ˜¯ è¾“å‡ºåºåˆ—
- ç¬¬äºŒä¸ªè¿”å›å€¼æ˜¯ä¸¤ä¸ªçŠ¶æ€ æ„æˆçš„å…ƒç»„ï¼Œè¿™ä¸¤ä¸ªçŠ¶æ€åˆ†åˆ«æ˜¯ `æœ€åä¸€ä¸ªæ—¶åˆ»çš„è¾“å‡º` å’Œ  `æœ€åä¸€ä¸ªæ—¶åˆ»çš„ç»†èƒçŠ¶æ€`

```python
return output,(prev_h,prev_c)
```

![image-20241223201325328](images/image-20241223201325328.png)

ä»¥ä¸Šæ˜¯ä¸å¸¦ projectionçš„è‡ªå®šä¹‰LSTM

æ¥ä¸‹æ¥æµ‹è¯•

æµ‹è¯•å°±æ˜¯æŠŠ `LSTM layer`çš„`4`ä¸ªå‚æ•°å–å‡ºæ¥ï¼Œç„¶åå–‚å…¥åˆ°è‡ªå®šä¹‰ LSTMå‡½æ•°ä¸­ï¼Œç„¶åå¯¹æ¯”ç»“æœ

ï¼ˆ1ï¼‰å®ä¾‹åŒ–LSTM ç®—å­ï¼Œä¼ å…¥`input parameters`

é¦–å…ˆæŠŠå‡½æ•°ç­¾åå¤åˆ¶ä¸‹æ¥ï¼š

![image-20241223201444538](images/image-20241223201444538.png)

- `input`è¿˜æ˜¯`input`
- `initial state`å°±æ˜¯`h0`å’Œ`c0`ï¼Œå°±æ˜¯ä¹‹å‰åˆå§‹åŒ–çš„`h0`å’Œ`c0`

```python
lstm_forward(input,(h0,c0),w_ih,w_hh,b_ih,b_hh)
```

- `w_ih`å°±ç”¨ä¹‹å‰pytorchä¸­å®ä¾‹åŒ–çš„`lstm layer`çš„å‚æ•°æ‹¿å‡ºæ¥

![image-20241223201802045](images/image-20241223201802045.png)

å°±æ˜¯`lstm_layer.å‚æ•°`

![image-20241223201834394](images/image-20241223201834394.png)

å³ï¼Œ

```
lstm_forward(input,(h0,c0),lstm_layer.weight_ih_l0,w_hh,b_ih,b_hh)
```

`w_hh`ä¹Ÿæ˜¯ä¸€æ ·çš„ï¼Œåé¢è¿˜æœ‰ä¸¤ä¸ªåç½®ï¼Œæœ€åå®ä¾‹åŒ–çš„è‡ªå®šä¹‰ LSTM å‡½æ•°ï¼š

```python
lstm_forward(input,
             (h0,c0),
             lstm_layer.weight_ih_l0,
             lstm_layer.weight_hh_l0,
             lstm_layer.bias_ih_l0,
             lstm_layer.bias_hh_l0)
```

å®ä¾‹åŒ–å¥½è‡ªå®šä¹‰ LSTM ç®—å­ä»¥åï¼Œå®šä¹‰å˜é‡æ¥æ”¶è¾“å‡º

å¤åˆ¶å‰é¢çš„å˜é‡åï¼ŒåŠ åç¼€ custom

![image-20241223202302089](images/image-20241223202302089.png)

åŠ åç¼€ customï¼Œè¡¨ç¤ºè‡ªå®šä¹‰çš„LSTM

```python
output_custom,(h_finall_custom,c_finall_custom) = lstm_forward(
    input,
    (h0,c0),      
    lstm_layer.weight_ih_l0,
    lstm_layer.weight_hh_l0,
    lstm_layer.bias_ih_l0,
    lstm_layer.bias_hh_l0)
```

æ¥ä¸‹æ¥å¯¹æ¯”å‰é¢çš„ `output` å’Œè‡ªå®šä¹‰å®ç°çš„ `output_custom`ï¼ŒæŸ¥çœ‹æ˜¯ä¸æ˜¯ä¸€è‡´ç”¨`torch.allclose()`

```python
print(torch.allclose(output,output_custom))
print(torch.allclose(h_finall,h_finall_custom))
print(torch.allclose(c_finall,c_finall_custom))
```

è¾“å‡ºä¸‰ä¸ªTrue

## LSTM å…¨éƒ¨ä»£ç 

```python
import torch
import torch.nn as nn
import torch.nn.functional as F
```

```python
# å®šä¹‰å¸¸é‡
bs,T,i_size,h_size = 2,3,4,5
# proj_size
input = torch.randn(bs,T,i_size) # è¾“å…¥åºåˆ—
c0 = torch.randn(bs,h_size)  # åˆå§‹å€¼ä¸éœ€è¦è®­ç»ƒ
h0 = torch.randn(bs,h_size)
```

```python
# è°ƒç”¨å®˜æ–¹LSTM API
lstm_layer = nn.LSTM(i_size,h_size,batch_first=True)
output,(h_finall,c_finall) = lstm_layer(input,(h0.unsqueeze(0),c0.unsqueeze(0)))

for k,v in lstm_layer.named_parameters():
    print(k,v.shape)
```

OUTï¼š

```
weight_ih_l0 torch.Size([20, 4])
weight_hh_l0 torch.Size([20, 5])
bias_ih_l0 torch.Size([20])
bias_hh_l0 torch.Size([20])
```



```python
# è‡ªå·±å†™ä¸€ä¸ªLSTM
def lstm_forward(input,initial_states,w_ih,w_hh,b_ih,b_hh):
    # ä»¥ä¸Šå†™å¥½äº† å‡½æ•°ç­¾å
    h0,c0 = initial_states #åˆå§‹çŠ¶æ€
    bs,T,i_size = input.shape
    h_size = w_ih.shape[0] // 4

    prev_h = h0
    prev_c = c0
    batch_w_ih = w_ih.unsqueeze(0).tile(bs,1,1)
    batch_w_hh = w_hh.unsqueeze(0).tile(bs,1,1)

    output_size = h_size
    output = torch.zeros(bs,T,output_size) # è¾“å‡ºåºåˆ—

    for t in range(T):
        x = input[:,t,:]  # å½“å‰æ—¶åˆ»çš„è¾“å…¥å‘é‡ï¼Œ[bs,i_size]

        w_times_x = torch.bmm(batch_w_ih,x.unsqueeze(-1))  #[bs,4*h_size,1]
        w_times_x = w_times_x.squeeze(-1)  # [bs,4*h_size]

        w_times_h_prev = torch.bmm(batch_w_hh,prev_h.unsqueeze(-1))  #[bs,4*h_size,1]
        w_times_h_prev = w_times_h_prev.squeeze(-1)  # [bs,4*h_size]

        # åˆ†åˆ«è®¡ç®— è¾“å…¥é—¨(i)ï¼Œé—å¿˜é—¨(f)ï¼Œcellé—¨(g)ï¼Œè¾“å‡ºé—¨(o)
        i_t = torch.sigmoid(w_times_x[:,:h_size] + w_times_h_prev[:,:h_size]+b_ih[:h_size]+b_hh[:h_size])
        f_t = torch.sigmoid(w_times_x[:,h_size:2*h_size] + w_times_h_prev[:,h_size:2*h_size]+
                            b_ih[h_size:2*h_size]+b_hh[h_size:2*h_size])
        g_t = torch.tanh(w_times_x[:,2*h_size:3*h_size] + w_times_h_prev[:,2*h_size:3*h_size]+
                            b_ih[2*h_size:3*h_size]+b_hh[2*h_size:3*h_size])
        o_t = torch.sigmoid(w_times_x[:,3*h_size:4*h_size] + w_times_h_prev[:,3*h_size:4*h_size]+
                            b_ih[3*h_size:4*h_size]+b_hh[3*h_size:4*h_size])


        prev_c = f_t * prev_c + i_t * g_t
        prev_h = o_t * torch.tanh(prev_c)

        output[:,t,:] = prev_h

    return output,(prev_h,prev_c)

output_custom,(h_finall_custom,c_finall_custom) = lstm_forward(input,(h0,c0),lstm_layer.weight_ih_l0,
                                                               lstm_layer.weight_hh_l0,
                                                               lstm_layer.bias_ih_l0,lstm_layer.bias_hh_l0)

```

```python
print(torch.allclose(output,output_custom))
print(torch.allclose(h_finall,h_finall_custom))
print(torch.allclose(c_finall,c_finall_custom))
```

OUTï¼š

```
True
True
True
```

## LSTMP

è¦è§£å†³çš„é—®é¢˜ï¼š

- ä»€ä¹ˆæ˜¯ `projection`å‘¢
- å¦‚æœè¦å†™ `projection`ï¼Œéœ€è¦æ€ä¹ˆæ”¹é€ ï¼Ÿ

### å®˜æ–¹ apiå®ç° LSTMP

æ³¨æ„çœ‹å‚æ•°å˜åŒ–

è°ƒç”¨å®˜æ–¹ api éœ€è¦åŠ ä¸€ä¸ªé‡ `proj_size`

`proj size` ç­‰äºå¤šå°‘å‘¢ï¼Ÿ

![image-20241223203456104](images/image-20241223203456104.png)

ä¸€èˆ¬ `projection size`æ¯”`hidden size`å°

å³è¦å¯¹`hidden state`è¿›è¡Œå‹ç¼©ï¼Œ å‹ç¼©è‚¯å®šæ˜¯è¦å¾€å°çš„ç»´åº¦å‹ç¼©

å¦‚æœ`hidden size`ç­‰äº`5`çš„è¯ï¼Œé‚£`projection size`å°±è®¾ç½®æˆ`3`ï¼Œæ¯”`hidden size`å°ä¸€ç‚¹å°±å¥½ï¼Œä»¥ä¸Šå®ç°äº† `projection layer`

![image-20241223203946682](images/image-20241223203946682.png)

ç°åœ¨å†æ¥çœ‹ `lstm layer`çš„å‚æ•°è¾“å‡º

ä¼ å…¥`proj size`ä»¥åï¼Œè¿˜è¦æ”¹å˜`h0`

> å› ä¸ºå¦‚æœ`LSTM`å¸¦äº†`projection`çš„è¯
>
> åˆ™`h`å®é™…ä¸Šæ˜¯è¦å‹ç¼©çš„ï¼Œç»´åº¦ä¸å†æ˜¯`h_size`ï¼›è€Œæ˜¯`projection_size`ï¼Œæ‰€ä»¥ `h_0`ä¹Ÿè¦æ”¹ä¸€ä¸‹	

`projection`çš„ä½œç”¨å®é™…ä¸Šå°±æ˜¯å¯¹ `h0`è¿›è¡Œä¸€ä¸ªå‹ç¼©ï¼Œæ¥ä¸‹æ¥æŸ¥çœ‹æ¨¡å‹å‚æ•°ï¼š

![image-20241223204214687](images/image-20241223204214687.png)

ç›¸æ¯”äº`lstm`ï¼Œ`lstmp`å¤šäº†ä¸€ä¸ªç»“æœï¼š`weight_hr_l0` ï¼Œ è¿™ä¸ªå‚æ•°å°±æ˜¯å¯¹ `hidden state` è¿›è¡Œå‹ç¼©

`hidden state`çš„å¤§å°å®é™…å˜æˆäº†`3`ï¼Œä¸å†æ˜¯`5`

æ¥ä¸‹æ¥ï¼Œæ‰“å°`output.shape`å’Œ`h_finall.shape`ã€`c_finall.shape`

![image-20241223211851063](images/image-20241223211851063.png)

å¯ä»¥çœ‹åˆ°`lstmp`çš„`output shape`æ˜¯`2Ã—2Ã—3`çš„ï¼Œä¸æ˜¯ `2Ã—3Ã—5` ï¼Œå› ä¸ºå¯¹è¾“å‡ºè¿›è¡Œäº†å‹ç¼©

`h_finall`å’Œ`c_finall`åˆ†åˆ«æ˜¯ `1Ã—2Ã—3` å’Œ `1Ã—2Ã—5`çš„

å¯ä»¥çœ‹åˆ° `h_finall`çš„å¤§å°ä¹Ÿå˜æˆäº†`3`ï¼Œä½†æ˜¯`c`çš„å¤§å°ä»ç„¶æ˜¯`5`

> ç†ç”±ï¼šåªå¯¹è¾“å‡ºè¿›è¡Œäº†å‹ç¼©ï¼Œä¸ä¼šå¯¹ç»†èƒçŠ¶æ€è¿›è¡Œå‹ç¼©

ä»¥ä¸Šæ˜¯projectionçš„åŸç†ï¼Œ

### è‡ªå®šä¹‰ LSTMP ä»£ç å®ç°

æ¥ä¸‹æ¥ä¿®æ”¹è‡ªå®šä¹‰å‡½æ•°ï¼š

å¤šäº†ä¸€ä¸ª`projection`å‚æ•°ï¼Œæ‰€ä»¥ç­¾åä¸­åŠ å…¥`w_hr` å¹¶ä¸”è®¾ç½®é»˜è®¤ä¸º`None`

![image-20241223212238200](images/image-20241223212238200.png)

- å¦‚æœæ˜¯`None`çš„è¯ï¼Œå°±æ˜¯ä¸€ä¸ªæ™®é€šçš„`lstm`
- å¦‚æœä¸æ˜¯`None` å°±æ˜¯å¸¦æœ‰`projection`çš„

æ–°åŠ å…¥å‚æ•°ä»¥åï¼Œåç»­éœ€è¦åšå“ªäº›ä¿®æ”¹å‘¢ï¼Ÿ

é¦–å…ˆå¯¹`output size`åšä¸€ä¸ªåˆ¤æ–­ï¼Œå¦‚æœæœ‰`projection size`ï¼Œ`output size` å°±ä¸æ˜¯ `h size`

```python
if w_hr is not None:
```

è¦åˆ¤æ–­ï¼Œé¦–å…ˆéœ€è¦æ‰¾åˆ°`projection size`ï¼Œç®€å†™ä¸º`p_size`ï¼š

```python
p_size,_ = w_hr.shape[0]
```

å®ƒæ˜¯`w_hr`çš„ç¬¬`0`ç»´

![image-20241223212615227](images/image-20241223212615227.png)

çº¢æ¡†å°±æ˜¯`projection size`ï¼Œç„¶å `output size`ç­‰äº `p_size`

```python
output_size = p_size
```

å¦‚æœ `else`çš„è¯ï¼Œ`output size`å°±ç­‰äº `h size`

```python
else:
    output_size = h_size
```

å…¨éƒ¨çš„ä»£ç ï¼š

![image-20241223213045775](images/image-20241223213045775.png)

ä»¥ä¸Šæ˜¯å¼•å…¥`projection`ä»¥ååšçš„æ”¹å˜

å¦å¤– `w_hr`ï¼ŒåŒæ ·è¦å¼•å…¥`batch`çš„ç»´åº¦ 

![image-20241223213136060](images/image-20241223213136060.png)

åŒæ ·å¼•å…¥`batch`çš„ç»´åº¦ï¼Œä½†æ˜¯è¿™æ—¶å€™ï¼Œå½¢çŠ¶å°±æ˜¯ `bsÃ—p_size Ã—h_size`

![image-20241223213221322](images/image-20241223213221322.png)

è¿™æ˜¯å¯¹`output size`åšçš„å˜æ›´

> å› ä¸ºå¼•å…¥äº†`projection`ï¼Œæ‰€ä»¥`output`å¤§å°æ˜¯å˜å°äº†

é‚£ä¹ˆæ¥ä¸‹æ¥è¦å˜æ›´å“ªé‡Œå‘¢ï¼Ÿ

- ç°åœ¨å¼•å…¥äº†`projection`ä¹‹åï¼Œè¿™é‡Œçš„`hidden_size`æ˜¯å˜å°çš„ï¼Œå·²ç»å˜æˆäº† `projection_size`
- ä¹Ÿå°±æ˜¯è¯´ `w_times_h_prev`å¤§å°ä»ç„¶æ˜¯ï¼š`bsÃ—4å€çš„hidden size`

<u>ä½†å®ƒæ˜¯æ€ä¹ˆå¾—åˆ°å‘¢ï¼Ÿ</u>

- å®ƒæ˜¯ $batch\_w\_hh$ (`bsÃ—4å€çš„hidden sizeå†ä¹˜ä»¥p size`)ï¼Œå†è·Ÿ $prev\_h$ `(p_size`)è¿›è¡Œç›¸ä¹˜ï¼Œç„¶å`p_size`è¿™ä¸ªç»´åº¦å°±æ¶ˆæ‰äº†
- æœ€ç»ˆï¼Œå¾—åˆ° $\mathrm{batch\_size Ã— 4*hidden\_size}$ 

![image-20241223213609048](images/image-20241223213609048.png)

- `batch_w_hh.shape = torch.Size([2, 20, 3])`
- `prev_h.shape = torch.Size([2, 3])`
- `w_times_h_prev.shape = torch.Size([2, 20, 1])` 

- `h_size = 5`
- `bs = 2`
- `proj_size = 3`

å¦‚æœå¼•å…¥äº† `projection`ï¼Œéœ€è¦åœ¨å¾—åˆ°çš„`prev_h`è¿™é‡Œï¼Œè¿›è¡Œå‹ç¼©

![image-20241223214445361](images/image-20241223214445361.png)

ç°åœ¨ `prev_h`è¿™é‡Œï¼Œå¤§å°æ˜¯ `bsÃ—h_size`

ä½†è¾“å‡ºçš„`h` è¦æ˜¯ `p_size`çš„ï¼Œæ‰€ä»¥ è¦è¿›è¡Œä¸€ä¸ªå‹ç¼©

![image-20241223215157085](images/image-20241223215157085.png)

åŒæ ·ï¼Œå¦‚æœ `w_hr`ä¸æ˜¯`None`çš„è¯ï¼Œå°±è¦åš`projection`ï¼Œè¦å¯¹ `prev_h`è¿›è¡Œä¸€ä¸ªå‹ç¼©

å‹ç¼©åŸç†ä»ç„¶æ˜¯ç”¨ï¼ŒçŸ©é˜µç›¸ä¹˜çš„ç®—æ³•

ç”¨å‹ç¼©çŸ©é˜µ `w_hr`è·Ÿ`prev_h`ç›¸ä¹˜ï¼Œéœ€è¦å¯¹ `prev_h`è¿›è¡Œæ‰©ä¸€ç»´ï¼Œæœ€åä¸€ä¸ªç»´åº¦æ‰©ä¸€ç»´

```python
if w_hr is not None:# åšprojection
    prev_h = torch.bmm(batch_w_hr,prev_h.unsqueeze(-1))
```

è¿™æ · `prev_h`çš„ç»´åº¦å°±å˜æˆäº† `bsÃ—p_sizeÃ—1`

æŠŠè¿™ä¸ª`1`ï¼Œæœ€åå†å»æ‰

```python
if w_hr is not None:# åšprojection
    prev_h = torch.bmm(batch_w_hr,prev_h.unsqueeze(-1)) 
    # [bs,p_size,1]
    prev_h = prev_h.squeeze(-1) # bsÃ— p_size
```

ä»¥ä¸Šå®ç°äº†`projection`

 `lstm projection`çš„åŸç†ï¼Œä¼šå¯¹è¾“å‡ºçŠ¶æ€è¿›è¡Œä¸€ä¸ªå‹ç¼©ï¼Œç„¶åæ•´ä¸ª `output`çš„ç»´åº¦å°±å˜å°äº†ï¼Œå¦å¤–å¼•å…¥`projection`ï¼Œæ•´ä¸ªè®¡ç®—é‡éƒ½æ˜¯å˜å°çš„

![image-20241223215756507](images/image-20241223215756507.png)

- batch_w_hhï¼š`batch sizeÃ— 4å€çš„hidden sizeÃ— hidden size`

   â†’ å˜æˆäº† `4å€çš„hidden_size Ã— p_size`

- æ‰€ä»¥å®ƒçš„å‚æ•°æ•°ç›®æ˜¯é™ä½çš„ï¼Œè¿ç®—é‡æ˜¯é™ä½çš„

- å¦å¤–  `prev_c`çš„ç»´åº¦æ˜¯`æ²¡æœ‰å˜`å¾—ï¼Œä»ç„¶æ˜¯ `hidden_size`

- ä½†æ˜¯`prev_h`çš„ç»´åº¦æ˜¯`é™ä½`çš„

ä»¥ä¸Šåœ¨è‡ªå®šä¹‰çš„ `lstm forward` å¼•å…¥äº† `projection`

æ¥ä¸‹æ¥ç»§ç»­æµ‹è¯•ï¼Œå¹¶ä¸”æŠŠ `weight_hr_l0`ä¼ å…¥è¿›æ¥ï¼Œå¾—åˆ°`å¸¦æœ‰projectionçš„è‡ªå®šä¹‰å‡½æ•°`

æ¥ä¸‹æ¥è¿›è¡Œæµ‹è¯•ï¼ŒæŸ¥çœ‹ç»“æœæ˜¯å¦ä¸€è‡´ã€‚

`lstmp` ç®€å•æ¥è¯´ï¼š

> - å¯¹è¾“å‡ºçš„çŠ¶æ€ï¼Œä¹Ÿå°±æ˜¯`prev_h`è¿›è¡Œå‹ç¼©ï¼Œä½¿å¾—æ•´ä¸ªLSTMç½‘ç»œï¼Œè¿ç®—é‡å’Œå‚æ•°é‡éƒ½æœ‰å‡å°
> - ä¸»è¦æ˜¯`w_hh` æƒé‡çš„ç»´åº¦æ˜¯æœ‰é™ä½çš„ï¼Œè¿ç®—é‡ä¹Ÿæ˜¯å‡å°‘çš„

### LSTMPçš„å…¨éƒ¨ä»£ç 

```python
# å®šä¹‰å¸¸é‡
bs,T,i_size,h_size = 2,3,4,5
proj_size = 3
input = torch.randn(bs,T,i_size) # è¾“å…¥åºåˆ—
c0 = torch.randn(bs,h_size)  # åˆå§‹å€¼ä¸éœ€è¦è®­ç»ƒ
h0 = torch.randn(bs,proj_size)
```

```python
# è°ƒç”¨å®˜æ–¹LSTM API
lstm_layer = nn.LSTM(i_size,h_size,batch_first=True,proj_size = proj_size)
output,(h_finall,c_finall) = lstm_layer(input,(h0.unsqueeze(0),c0.unsqueeze(0)))

print(output.shape,h_finall.shape,c_finall.shape)

for k,v in lstm_layer.named_parameters():
    print(k,v.shape)
```

```
torch.Size([2, 3, 3]) torch.Size([1, 2, 3]) torch.Size([1, 2, 5])
weight_ih_l0 torch.Size([20, 4])
weight_hh_l0 torch.Size([20, 3])
bias_ih_l0 torch.Size([20])
bias_hh_l0 torch.Size([20])
weight_hr_l0 torch.Size([3, 5])
```

```python
# è‡ªå·±å†™ä¸€ä¸ªLSTM
def lstm_forward(input,initial_states,w_ih,w_hh,b_ih,b_hh,w_hr=None):
    # ä»¥ä¸Šå†™å¥½äº† å‡½æ•°ç­¾å
    h0,c0 = initial_states #åˆå§‹çŠ¶æ€
    bs,T,i_size = input.shape
    h_size = w_ih.shape[0] // 4

    prev_h = h0
    prev_c = c0
    batch_w_ih = w_ih.unsqueeze(0).tile(bs,1,1)
    batch_w_hh = w_hh.unsqueeze(0).tile(bs,1,1)

    if w_hr is not None:
        p_size = w_hr.shape[0]
        output_size = p_size
        batch_w_hr = w_hr.unsqueeze(0).tile(bs,1,1)  # [bs,p_size,h_size]
    else:
        output_size = h_size

    output = torch.zeros(bs,T,output_size) # è¾“å‡ºåºåˆ—

    for t in range(T):
        x = input[:,t,:]  # å½“å‰æ—¶åˆ»çš„è¾“å…¥å‘é‡ï¼Œ[bs,i_size]

        w_times_x = torch.bmm(batch_w_ih,x.unsqueeze(-1))  #[bs,4*h_size,1]
        w_times_x = w_times_x.squeeze(-1)  # [bs,4*h_size]

        w_times_h_prev = torch.bmm(batch_w_hh,prev_h.unsqueeze(-1))  #[bs,4*h_size,1]
        w_times_h_prev = w_times_h_prev.squeeze(-1)  # [bs,4*h_size]

        # åˆ†åˆ«è®¡ç®— è¾“å…¥é—¨(i)ï¼Œé—å¿˜é—¨(f)ï¼Œcellé—¨(g)ï¼Œè¾“å‡ºé—¨(o)
        i_t = torch.sigmoid(w_times_x[:,:h_size] + w_times_h_prev[:,:h_size]+b_ih[:h_size]+b_hh[:h_size])
        f_t = torch.sigmoid(w_times_x[:,h_size:2*h_size] + w_times_h_prev[:,h_size:2*h_size]+
                            b_ih[h_size:2*h_size]+b_hh[h_size:2*h_size])
        g_t = torch.tanh(w_times_x[:,2*h_size:3*h_size] + w_times_h_prev[:,2*h_size:3*h_size]+
                            b_ih[2*h_size:3*h_size]+b_hh[2*h_size:3*h_size])
        o_t = torch.sigmoid(w_times_x[:,3*h_size:4*h_size] + w_times_h_prev[:,3*h_size:4*h_size]+
                            b_ih[3*h_size:4*h_size]+b_hh[3*h_size:4*h_size])


        prev_c = f_t * prev_c + i_t * g_t
        prev_h = o_t * torch.tanh(prev_c)

        if w_hr is not None: # åšprojection
            prev_h = torch.bmm(batch_w_hr,prev_h.unsqueeze(-1)) # [bs,p_size,1]
            prev_h = prev_h.squeeze(-1) # bsÃ— p_size
             

        output[:,t,:] = prev_h

    return output,(prev_h,prev_c)

output_custom,(h_finall_custom,c_finall_custom) = lstm_forward(input,(h0,c0),lstm_layer.weight_ih_l0,
                                                               lstm_layer.weight_hh_l0,
                                                               lstm_layer.bias_ih_l0,lstm_layer.bias_hh_l0,
                                                               lstm_layer.weight_hr_l0)

```

```python
print(torch.allclose(output,output_custom))
print(torch.allclose(h_finall,h_finall_custom))
print(torch.allclose(c_finall,c_finall_custom))
```

```
True
True
True
```

