
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
        <link rel="canonical" href="https://mydomain.org/mysite/Reproduction/1/">
      
      
        <link rel="prev" href="../CodeRepo/">
      
      
        <link rel="next" href="../2/">
      
      
      <link rel="icon" href="../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.6.9">
    
    
      
        <title>‰∏Ä‰∫õÊ®°Âùó - Ê∫∂err</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.4af4bdda.min.css">
      
        
        <link rel="stylesheet" href="../../assets/stylesheets/palette.06af60db.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../../css/timeago.css">
    
      <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.7/katex.min.css">
    
      <link rel="stylesheet" href="../../mkdocs/css/no-footer.css">
    
      <link rel="stylesheet" href="../../mkdocs/css/unordered-list-symbols.css">
    
    <script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="light-blue" data-md-color-accent="light-blue">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#_1" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow md-header--lifted" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../.." title="Ê∫∂err" class="md-header__button md-logo" aria-label="Ê∫∂err" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Ê∫∂err
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              ‰∏Ä‰∫õÊ®°Âùó
            
          </span>
        </div>
      </div>
    </div>
    
      
        <form class="md-header__option" data-md-component="palette">
  
    
    
    
    <input class="md-option" data-md-color-media="" data-md-color-scheme="default" data-md-color-primary="light-blue" data-md-color-accent="light-blue"  aria-label="Switch to dark mode"  type="radio" name="__palette" id="__palette_0">
    
      <label class="md-header__button md-icon" title="Switch to dark mode" for="__palette_1" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a4 4 0 0 0-4 4 4 4 0 0 0 4 4 4 4 0 0 0 4-4 4 4 0 0 0-4-4m0 10a6 6 0 0 1-6-6 6 6 0 0 1 6-6 6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"/></svg>
      </label>
    
  
    
    
    
    <input class="md-option" data-md-color-media="" data-md-color-scheme="slate" data-md-color-primary="indigo" data-md-color-accent="indigo"  aria-label="Switch to light mode"  type="radio" name="__palette" id="__palette_1">
    
      <label class="md-header__button md-icon" title="Switch to light mode" for="__palette_0" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 18c-.89 0-1.74-.2-2.5-.55C11.56 16.5 13 14.42 13 12s-1.44-4.5-3.5-5.45C10.26 6.2 11.11 6 12 6a6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"/></svg>
      </label>
    
  
</form>
      
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
        <div class="md-search__suggest" data-md-component="search-suggest"></div>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
  </nav>
  
    
      
<nav class="md-tabs" aria-label="Tabs" data-md-component="tabs">
  <div class="md-grid">
    <ul class="md-tabs__list">
      
        
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../sticks/mkdocs_learn/" class="md-tabs__link">
          
  
    
  
  ‰æøÁ≠æ

        </a>
      </li>
    
  

      
        
  
  
  
    
    
      
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../bagu/questions/1_questions/" class="md-tabs__link">
          
  
    
  
  Èù¢ËØï

        </a>
      </li>
    
  

    
  

      
        
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../Error/github/" class="md-tabs__link">
          
  
    
  
  Êçâ‰∏™Ëô´

        </a>
      </li>
    
  

      
        
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../learning/0_pdfNotes/" class="md-tabs__link">
          
  
    
  
  Á¨îËÆ∞

        </a>
      </li>
    
  

      
        
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../literature/" class="md-tabs__link">
          
  
    
  
  ÊñáÁåÆ

        </a>
      </li>
    
  

      
        
  
  
    
  
  
    
    
      <li class="md-tabs__item md-tabs__item--active">
        <a href="../" class="md-tabs__link">
          
  
    
  
  Â§çÁé∞&‰ª£Á†Å

        </a>
      </li>
    
  

      
        
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../Statistics/" class="md-tabs__link">
          
  
    
  
  ÁªüËÆ°Â≠¶

        </a>
      </li>
    
  

      
        
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../logs/" class="md-tabs__link">
          
  
    
  
  ÊùÇ

        </a>
      </li>
    
  

      
    </ul>
  </div>
</nav>
    
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


  


<nav class="md-nav md-nav--primary md-nav--lifted" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="Ê∫∂err" class="md-nav__button md-logo" aria-label="Ê∫∂err" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    Ê∫∂err
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_1" >
        
          
          <label class="md-nav__link" for="__nav_1" id="__nav_1_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    ‰æøÁ≠æ
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_1_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_1">
            <span class="md-nav__icon md-icon"></span>
            ‰æøÁ≠æ
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../sticks/mkdocs_learn/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    MkDocs
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../sticks/markdwon_learn/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    markdown
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../sticks/latex/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    LaTex
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../sticks/GitHub/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    GitHub
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../sticks/MacOS/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    MacOS
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../sticks/shell/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Shell
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../sticks/linux/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    linux
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../sticks/screen/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    screen
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../sticks/docker/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Docker
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../sticks/writting/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    ÂÜô‰Ωú
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../sticks/1_github_v1/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    github v1.0
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../sticks/2_python/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    python
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../sticks/3_vscode/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    VSCode
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_2" >
        
          
          <label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Èù¢ËØï
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2">
            <span class="md-nav__icon md-icon"></span>
            Èù¢ËØï
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    
    
      
        
      
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_2_1" >
        
          
          <label class="md-nav__link" for="__nav_2_1" id="__nav_2_1_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    È¢òÁõÆ
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_2_1_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_1">
            <span class="md-nav__icon md-icon"></span>
            È¢òÁõÆ
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../bagu/questions/1_questions/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Èù¢ËØïÈóÆÈ¢ò
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
          
        
      
        
      
        
      
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_2_2" >
        
          
          
          <div class="md-nav__link md-nav__container">
            <a href="../../bagu/leetcode/" class="md-nav__link ">
              
  
  <span class="md-ellipsis">
    ÂäõÊâ£
    
  </span>
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_2_2" id="__nav_2_2_label" tabindex="0">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_2_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_2">
            <span class="md-nav__icon md-icon"></span>
            ÂäõÊâ£
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../bagu/leetcode/1/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    1 ‰∏§Êï∞‰πãÂíå
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../bagu/leetcode/2/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    2 ‰∏§Êï∞Áõ∏Âä†
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
          
        
      
        
      
        
      
        
      
        
      
        
      
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_2_3" >
        
          
          
          <div class="md-nav__link md-nav__container">
            <a href="../../bagu/deeplearning/" class="md-nav__link ">
              
  
  <span class="md-ellipsis">
    Ê∑±Â∫¶Â≠¶‰π†
    
  </span>
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_2_3" id="__nav_2_3_label" tabindex="0">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_2_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_3">
            <span class="md-nav__icon md-icon"></span>
            Ê∑±Â∫¶Â≠¶‰π†
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../bagu/deeplearning/transformer/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    ÊâãÊíïTransformer‰ª£Á†Å
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../bagu/deeplearning/former1/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Á©∫
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../bagu/deeplearning/former2/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Á©∫
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../bagu/deeplearning/pytorch_shape_function/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    pytorchÁöÑÁª¥Â∫¶ÂèòÊç¢ÂáΩÊï∞
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../bagu/deeplearning/1/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    visionTransformer‰ª£Á†Å
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
        
      
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_2_4" >
        
          
          <label class="md-nav__link" for="__nav_2_4" id="__nav_2_4_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Êú∫Âô®Â≠¶‰π†
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_2_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_4">
            <span class="md-nav__icon md-icon"></span>
            Êú∫Âô®Â≠¶‰π†
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../bagu/machinelearning/kmeans/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    ÊâãÊíïkmeans
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../bagu/machinelearning/2/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    ÊâãÊíïÂèçÂêë‰º†Êí≠
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_3" >
        
          
          <label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Êçâ‰∏™Ëô´
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3">
            <span class="md-nav__icon md-icon"></span>
            Êçâ‰∏™Ëô´
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../Error/github/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    github
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../Error/latex/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Latex
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../Error/python/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    python
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../Error/macos/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    macOS
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../Error/docker/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    docker
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_4" >
        
          
          <label class="md-nav__link" for="__nav_4" id="__nav_4_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Á¨îËÆ∞
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4">
            <span class="md-nav__icon md-icon"></span>
            Á¨îËÆ∞
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../learning/0_pdfNotes/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    üìí
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../learning/3_ViT/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    ViT
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../learning/1_clip/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    CLIP
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../learning/2_MOCO/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    MOCO
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../learning/2/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    ÂõæËß£LayerNorm &amp; BatchNorm
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../learning/1/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    5ÁßçÂΩí‰∏ÄÂåñÊñπÊ≥ï
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../learning/vit/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    vision TransformerÁöÑÂéüÁêÜ‰∏éÈöæÁÇπÊ∫êÁ†ÅÂÆûÁé∞
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../learning/swintransformer/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    SwinTransformer Â≠¶‰π†Á¨îËÆ∞
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../learning/pe/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    4Áßç‰ΩçÁΩÆÁºñÁ†Å
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../learning/convs/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Âç∑ÁßØ
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../learning/3/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    ÊùéÊ≤ê ÁõÆÊ†áÊ£ÄÊµãÈÉ®ÂàÜ
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../learning/4_GAN/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    GAN
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../learning/5_Bert/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    BERT‰ªéÈõ∂ËØ¶ÁªÜËß£ËØª
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../learning/6_Diffusion/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    DDPM
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../learning/6_Diffusion1/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    VDM
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../learning/7_Clip/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Á©∫
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../learning/8_WeightNorm/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    WeightNorm
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../learning/9_cGAN/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    GAN Âèò‰Ωì
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../learning/10_ResNet/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    È°πÁõÆÂÆûÊàòÔºöResNetÊûúËî¨ÂàÜÁ±ª
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../learning/11_excelcsvtensor/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Âü∫Á°ÄÔºöexcel\csvÊñá‰ª∂‚Üítensor
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../learning/12_KLdivergence/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    KL divergence
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../learning/13_RNN/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    RNN
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../learning/14_LSTM/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    LSTM
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../learning/15_ContrastiveLearning/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    ÂØπÊØîÂ≠¶‰π†
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../learning/16_YOLO/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    YOLO
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../learning/17_DETR/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    DETR
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../learning/18_DINO/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    DINO
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../learning/19_GPT/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    GPT
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../learning/20_distill/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Áü•ËØÜËí∏È¶è
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../learning/21_FastRCNN/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    21 FastRCNN
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
          
        
      
        
      
        
      
        
      
        
      
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_5" >
        
          
          
          <div class="md-nav__link md-nav__container">
            <a href="../../literature/" class="md-nav__link ">
              
  
  <span class="md-ellipsis">
    ÊñáÁåÆ
    
  </span>
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_5" id="__nav_5_label" tabindex="0">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_5_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5">
            <span class="md-nav__icon md-icon"></span>
            ÊñáÁåÆ
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
              
                
  
  
  
  
    
    
      
        
          
        
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_5_2" >
        
          
          
          <div class="md-nav__link md-nav__container">
            <a href="../../literature/TSP/" class="md-nav__link ">
              
  
  <span class="md-ellipsis">
    Êó∂Èó¥Â∫èÂàóÈ¢ÑÊµã
    
  </span>
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_5_2" id="__nav_5_2_label" tabindex="0">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_5_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5_2">
            <span class="md-nav__icon md-icon"></span>
            Êó∂Èó¥Â∫èÂàóÈ¢ÑÊµã
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../literature/TSP/0_note/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    NOTE
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../literature/TSP/1_SegRNN/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    2023„ÄÅSegRNN
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../literature/TSP/2_DLinear/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    2022„ÄÅDLinear
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../literature/TSP/3_TimesNet/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    2023„ÄÅTimesNet
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../literature/TSP/4_Informer/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    2021„ÄÅ Informer
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../literature/TSP/5_Autoformer/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    2021„ÄÅAutoformer
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
          
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_5_3" >
        
          
          
          <div class="md-nav__link md-nav__container">
            <a href="../../literature/ObejectCounting/" class="md-nav__link ">
              
  
  <span class="md-ellipsis">
    ÁõÆÊ†áËÆ°Êï∞
    
  </span>
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_5_3" id="__nav_5_3_label" tabindex="0">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_5_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5_3">
            <span class="md-nav__icon md-icon"></span>
            ÁõÆÊ†áËÆ°Êï∞
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../literature/ObejectCounting/rank1%20CountGD/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    rank1 CountGD
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../literature/ObejectCounting/rank2%20GeCo/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    rank2 GeCo
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../literature/ObejectCounting/rank3%20DAVE/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    rank3 DAVE
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../literature/ObejectCounting/rank4%20CACViT/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    rank4 CACViT
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../literature/ObejectCounting/rank5%20SSD/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    rank5 SSD
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../literature/ObejectCounting/rank6%20LOCA/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    rank6 LOCA
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../literature/ObejectCounting/rank7%20SemAug_CountTR/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    rank7 SemAug CountTR
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../literature/ObejectCounting/rank8%20CounTR/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    rank8 CounTR
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../literature/ObejectCounting/rank9%20SemAug_SAFECount/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    rank9 SemAug SAFECount
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../literature/ObejectCounting/rank10%20SPDCN/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    rank10 SPDCN
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../literature/ObejectCounting/rank11%20GCA_SUN/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    rank11 GCA SUN
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../literature/ObejectCounting/rank12%20SAFECount/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    rank12 SAFECount
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../literature/ObejectCounting/rank13%20BMNet/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    rank13 BMNet
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../literature/ObejectCounting/rank14%20LaoNet/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    rank14 LaoNet
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../literature/ObejectCounting/rank15%20CounTX/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    rank15 CounTX
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../literature/ObejectCounting/rank16%20Counting_DETR/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    rank16 Counting DETR
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../literature/ObejectCounting/rank17%20RCC/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    rank17 RCC
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../literature/ObejectCounting/rank18%20Omnicount/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    rank18 Omnicount
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../literature/ObejectCounting/rank19%20FamNet/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    rank19 FamNet
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
        
          
        
      
        
      
        
      
        
      
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_5_4" >
        
          
          
          <div class="md-nav__link md-nav__container">
            <a href="../../literature/ObjectDetection/" class="md-nav__link ">
              
  
  <span class="md-ellipsis">
    ÁõÆÊ†áÊ£ÄÊµã
    
  </span>
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_5_4" id="__nav_5_4_label" tabindex="0">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_5_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5_4">
            <span class="md-nav__icon md-icon"></span>
            ÁõÆÊ†áÊ£ÄÊµã
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../literature/ObjectDetection/2/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    ÁõÆÊ†áÊ£ÄÊµãÂü∫Á°ÄÁü•ËØÜ
    
  </span>
  

      </a>
    </li>
  

              
            
              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../literature/ObjectDetection/1/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    DETRËÆ∫ÊñáÁ≥ªÂàó
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../literature/ObjectDetection/3/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    ÔºàDETRÔºâEnd-to-End Object Detection with Transformer
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../literature/ObjectDetection/4/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    4
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
          
        
      
        
      
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_5_5" >
        
          
          
          <div class="md-nav__link md-nav__container">
            <a href="../../literature/MultiModal/" class="md-nav__link ">
              
  
  <span class="md-ellipsis">
    Â§öÊ®°ÊÄÅ
    
  </span>
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_5_5" id="__nav_5_5_label" tabindex="0">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_5_5_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5_5">
            <span class="md-nav__icon md-icon"></span>
            Â§öÊ®°ÊÄÅ
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../literature/MultiModal/1/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    1
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
    
  
  
  
    
    
      
        
          
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
      
        
        
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_6" checked>
        
          
          
          <div class="md-nav__link md-nav__container">
            <a href="../" class="md-nav__link ">
              
  
  <span class="md-ellipsis">
    Â§çÁé∞&‰ª£Á†Å
    
  </span>
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_6" id="__nav_6_label" tabindex="">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_6_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_6">
            <span class="md-nav__icon md-icon"></span>
            Â§çÁé∞&‰ª£Á†Å
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../7_summary/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Ê±áÊÄªÂ§çÁé∞Ë∞ÉÁî®Âõæ
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../DAVE/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    DAVEÂ§çÁé∞
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../5_SegRNN_index/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    SegRNN
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../5_SegRNN_v1/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Â§çÁé∞SegRNN
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../5_SegRNN_v2/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    ÔºàË°•ÂÖÖÔºâÂ§çÁé∞ SegRNN
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../5_SegRNN_v3/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    (ÊâãÂÜôÁ¨îËÆ∞)SegRNN
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../6_AutoFormer/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Autoformer
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../6_AutoFormer_v1/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    (Áª≠) Autoformer
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
    
  
  
  
    
    
      
        
          
        
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
      
      
        
          
          
        
      
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_6_10" checked>
        
          
          
          <div class="md-nav__link md-nav__container">
            <a href="../CodeRepo/" class="md-nav__link ">
              
  
  <span class="md-ellipsis">
    ‰∏Ä‰∫õ‰ª£Á†Å
    
  </span>
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_6_10" id="__nav_6_10_label" tabindex="">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_6_10_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_6_10">
            <span class="md-nav__icon md-icon"></span>
            ‰∏Ä‰∫õ‰ª£Á†Å
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
              
                
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  <span class="md-ellipsis">
    ‰∏Ä‰∫õÊ®°Âùó
    
  </span>
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  <span class="md-ellipsis">
    ‰∏Ä‰∫õÊ®°Âùó
    
  </span>
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#_2" class="md-nav__link">
    <span class="md-ellipsis">
      ÈÄöÈÅìÊ≥®ÊÑèÂäõÂèäÂÖ∂Âèò‰Ωì
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#senet" class="md-nav__link">
    <span class="md-ellipsis">
      ‚àö SENet
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#sknet" class="md-nav__link">
    <span class="md-ellipsis">
      ‚àö SKNet
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#cbam" class="md-nav__link">
    <span class="md-ellipsis">
      ‚àö CBAM
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#eca" class="md-nav__link">
    <span class="md-ellipsis">
      ‚àöECA
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#coordinate-attention" class="md-nav__link">
    <span class="md-ellipsis">
      ‚àö Coordinate Attention
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#cotattention" class="md-nav__link">
    <span class="md-ellipsis">
      CoTAttention
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#tripletattention" class="md-nav__link">
    <span class="md-ellipsis">
      ‚àö TripletAttention
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#danet" class="md-nav__link">
    <span class="md-ellipsis">
      ‚àöDANet
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_3" class="md-nav__link">
    <span class="md-ellipsis">
      ÁâπÂæÅËûçÂêà
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#asff" class="md-nav__link">
    <span class="md-ellipsis">
      ‚àö‚≠êASFF ‰∏çÂêåÂ∞∫Â∫¶ÁâπÂæÅËûçÂêà
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#fpn" class="md-nav__link">
    <span class="md-ellipsis">
      ‚àö FPN ÁâπÂæÅÈáëÂ≠óÂ°îÁΩëÁªú
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#panet" class="md-nav__link">
    <span class="md-ellipsis">
      PANet
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_4" class="md-nav__link">
    <span class="md-ellipsis">
      Á©∫Èó¥Ê≥®ÊÑèÂäõÂèäÂèò‰Ωì
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#attention" class="md-nav__link">
    <span class="md-ellipsis">
      ‚àöAttention
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#attention_1" class="md-nav__link">
    <span class="md-ellipsis">
      Attention ÊãìÂ±ï
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#cot" class="md-nav__link">
    <span class="md-ellipsis">
      ‰∏ä‰∏ãÊñá CoT
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_5" class="md-nav__link">
    <span class="md-ellipsis">
      
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../2/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    ÁâπÂæÅËûçÂêàÊñπÂºè
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../3/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    ‰∏Ä‰∫õÊÑüÊÇü
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../4/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    È¢ÑËÆ≠ÁªÉÊùÉÈáç
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../CodeRepo/1_MultiHeadAttention/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Â§öÂ§¥Ê≥®ÊÑèÂäõÊú∫Âà∂ÂΩ¢Áä∂ÂèòÂåñ
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../CodeRepo/2_transformer/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    ‰ªéÁé∞ÂÆûÁîüÊ¥ªÁöÑËßíÂ∫¶Áúã Transformer
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
          
        
      
        
      
        
      
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_7" >
        
          
          
          <div class="md-nav__link md-nav__container">
            <a href="../../Statistics/" class="md-nav__link ">
              
  
  <span class="md-ellipsis">
    ÁªüËÆ°Â≠¶
    
  </span>
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_7" id="__nav_7_label" tabindex="0">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_7_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_7">
            <span class="md-nav__icon md-icon"></span>
            ÁªüËÆ°Â≠¶
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../Statistics/1_FFT/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    FFT
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../Statistics/2_FFT/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    FFT Âü∫Á°ÄÁü•ËØÜ
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
          
        
      
        
      
        
      
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_8" >
        
          
          
          <div class="md-nav__link md-nav__container">
            <a href="../../logs/" class="md-nav__link ">
              
  
  <span class="md-ellipsis">
    ÊùÇ
    
  </span>
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_8" id="__nav_8_label" tabindex="0">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_8_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_8">
            <span class="md-nav__icon md-icon"></span>
            ÊùÇ
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../logs/diary/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    ‰πêËßÇ &amp; ÂùöÂº∫
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../logs/1_date/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    ‰∏Ä‰∫õÊó•Êúü
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#_2" class="md-nav__link">
    <span class="md-ellipsis">
      ÈÄöÈÅìÊ≥®ÊÑèÂäõÂèäÂÖ∂Âèò‰Ωì
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#senet" class="md-nav__link">
    <span class="md-ellipsis">
      ‚àö SENet
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#sknet" class="md-nav__link">
    <span class="md-ellipsis">
      ‚àö SKNet
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#cbam" class="md-nav__link">
    <span class="md-ellipsis">
      ‚àö CBAM
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#eca" class="md-nav__link">
    <span class="md-ellipsis">
      ‚àöECA
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#coordinate-attention" class="md-nav__link">
    <span class="md-ellipsis">
      ‚àö Coordinate Attention
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#cotattention" class="md-nav__link">
    <span class="md-ellipsis">
      CoTAttention
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#tripletattention" class="md-nav__link">
    <span class="md-ellipsis">
      ‚àö TripletAttention
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#danet" class="md-nav__link">
    <span class="md-ellipsis">
      ‚àöDANet
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_3" class="md-nav__link">
    <span class="md-ellipsis">
      ÁâπÂæÅËûçÂêà
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#asff" class="md-nav__link">
    <span class="md-ellipsis">
      ‚àö‚≠êASFF ‰∏çÂêåÂ∞∫Â∫¶ÁâπÂæÅËûçÂêà
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#fpn" class="md-nav__link">
    <span class="md-ellipsis">
      ‚àö FPN ÁâπÂæÅÈáëÂ≠óÂ°îÁΩëÁªú
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#panet" class="md-nav__link">
    <span class="md-ellipsis">
      PANet
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_4" class="md-nav__link">
    <span class="md-ellipsis">
      Á©∫Èó¥Ê≥®ÊÑèÂäõÂèäÂèò‰Ωì
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#attention" class="md-nav__link">
    <span class="md-ellipsis">
      ‚àöAttention
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#attention_1" class="md-nav__link">
    <span class="md-ellipsis">
      Attention ÊãìÂ±ï
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#cot" class="md-nav__link">
    <span class="md-ellipsis">
      ‰∏ä‰∏ãÊñá CoT
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_5" class="md-nav__link">
    <span class="md-ellipsis">
      
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  


  
  


<h1 id="_1">‰∏Ä‰∫õÊ®°Âùó<a class="headerlink" href="#_1" title="Permanent link">&para;</a></h1>
<h2 id="_2">ÈÄöÈÅìÊ≥®ÊÑèÂäõÂèäÂÖ∂Âèò‰Ωì<a class="headerlink" href="#_2" title="Permanent link">&para;</a></h2>
<h2 id="senet">‚àö SENet<a class="headerlink" href="#senet" title="Permanent link">&para;</a></h2>
<p><img alt="image-20250216195102911" src="../images/image-20250216195102911.png" /></p>
<p><img alt="image-20250216195120988" src="../images/image-20250216195120988.png" /></p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-0-1"><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
</span><span id="__span-0-2"><a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a><span class="kn">import</span><span class="w"> </span><span class="nn">torch</span>
</span><span id="__span-0-3"><a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a><span class="kn">from</span><span class="w"> </span><span class="nn">torch</span><span class="w"> </span><span class="kn">import</span> <span class="n">nn</span>
</span><span id="__span-0-4"><a id="__codelineno-0-4" name="__codelineno-0-4" href="#__codelineno-0-4"></a><span class="kn">from</span><span class="w"> </span><span class="nn">torch.nn</span><span class="w"> </span><span class="kn">import</span> <span class="n">init</span>
</span><span id="__span-0-5"><a id="__codelineno-0-5" name="__codelineno-0-5" href="#__codelineno-0-5"></a>
</span><span id="__span-0-6"><a id="__codelineno-0-6" name="__codelineno-0-6" href="#__codelineno-0-6"></a><span class="s2">&quot;Squeeze-and-Excitation Networks&quot;</span>
</span><span id="__span-0-7"><a id="__codelineno-0-7" name="__codelineno-0-7" href="#__codelineno-0-7"></a>
</span><span id="__span-0-8"><a id="__codelineno-0-8" name="__codelineno-0-8" href="#__codelineno-0-8"></a><span class="k">class</span><span class="w"> </span><span class="nc">SEAttention</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
</span><span id="__span-0-9"><a id="__codelineno-0-9" name="__codelineno-0-9" href="#__codelineno-0-9"></a>
</span><span id="__span-0-10"><a id="__codelineno-0-10" name="__codelineno-0-10" href="#__codelineno-0-10"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">channel</span><span class="o">=</span><span class="mi">512</span><span class="p">,</span><span class="n">reduction</span><span class="o">=</span><span class="mi">16</span><span class="p">):</span>
</span><span id="__span-0-11"><a id="__codelineno-0-11" name="__codelineno-0-11" href="#__codelineno-0-11"></a>        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
</span><span id="__span-0-12"><a id="__codelineno-0-12" name="__codelineno-0-12" href="#__codelineno-0-12"></a>        <span class="c1"># Âú®Á©∫Èó¥Áª¥Â∫¶‰∏ä,Â∞ÜH√óWÂéãÁº©‰∏∫1√ó1</span>
</span><span id="__span-0-13"><a id="__codelineno-0-13" name="__codelineno-0-13" href="#__codelineno-0-13"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">avg_pool</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">AdaptiveAvgPool2d</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</span><span id="__span-0-14"><a id="__codelineno-0-14" name="__codelineno-0-14" href="#__codelineno-0-14"></a>        <span class="c1"># ÂåÖÂê´‰∏§Â±ÇÂÖ®ËøûÊé•,ÂÖàÈôçÁª¥,ÂêéÂçáÁª¥„ÄÇÊúÄÂêéÊé•‰∏Ä‰∏™sigmoidÂáΩÊï∞</span>
</span><span id="__span-0-15"><a id="__codelineno-0-15" name="__codelineno-0-15" href="#__codelineno-0-15"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">fc</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Sequential</span><span class="p">(</span>
</span><span id="__span-0-16"><a id="__codelineno-0-16" name="__codelineno-0-16" href="#__codelineno-0-16"></a>            <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="n">channel</span><span class="p">,</span> <span class="n">channel</span> <span class="o">//</span> <span class="n">reduction</span><span class="p">,</span> <span class="n">bias</span><span class="o">=</span><span class="kc">False</span><span class="p">),</span>
</span><span id="__span-0-17"><a id="__codelineno-0-17" name="__codelineno-0-17" href="#__codelineno-0-17"></a>            <span class="n">nn</span><span class="o">.</span><span class="n">ReLU</span><span class="p">(</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
</span><span id="__span-0-18"><a id="__codelineno-0-18" name="__codelineno-0-18" href="#__codelineno-0-18"></a>            <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="n">channel</span> <span class="o">//</span> <span class="n">reduction</span><span class="p">,</span> <span class="n">channel</span><span class="p">,</span> <span class="n">bias</span><span class="o">=</span><span class="kc">False</span><span class="p">),</span>
</span><span id="__span-0-19"><a id="__codelineno-0-19" name="__codelineno-0-19" href="#__codelineno-0-19"></a>            <span class="n">nn</span><span class="o">.</span><span class="n">Sigmoid</span><span class="p">()</span>
</span><span id="__span-0-20"><a id="__codelineno-0-20" name="__codelineno-0-20" href="#__codelineno-0-20"></a>        <span class="p">)</span>
</span><span id="__span-0-21"><a id="__codelineno-0-21" name="__codelineno-0-21" href="#__codelineno-0-21"></a>
</span><span id="__span-0-22"><a id="__codelineno-0-22" name="__codelineno-0-22" href="#__codelineno-0-22"></a>
</span><span id="__span-0-23"><a id="__codelineno-0-23" name="__codelineno-0-23" href="#__codelineno-0-23"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">init_weights</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="__span-0-24"><a id="__codelineno-0-24" name="__codelineno-0-24" href="#__codelineno-0-24"></a>        <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">modules</span><span class="p">():</span>
</span><span id="__span-0-25"><a id="__codelineno-0-25" name="__codelineno-0-25" href="#__codelineno-0-25"></a>            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">nn</span><span class="o">.</span><span class="n">Conv2d</span><span class="p">):</span>
</span><span id="__span-0-26"><a id="__codelineno-0-26" name="__codelineno-0-26" href="#__codelineno-0-26"></a>                <span class="n">init</span><span class="o">.</span><span class="n">kaiming_normal_</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">weight</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;fan_out&#39;</span><span class="p">)</span>
</span><span id="__span-0-27"><a id="__codelineno-0-27" name="__codelineno-0-27" href="#__codelineno-0-27"></a>                <span class="k">if</span> <span class="n">m</span><span class="o">.</span><span class="n">bias</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="__span-0-28"><a id="__codelineno-0-28" name="__codelineno-0-28" href="#__codelineno-0-28"></a>                    <span class="n">init</span><span class="o">.</span><span class="n">constant_</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">bias</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
</span><span id="__span-0-29"><a id="__codelineno-0-29" name="__codelineno-0-29" href="#__codelineno-0-29"></a>            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">nn</span><span class="o">.</span><span class="n">BatchNorm2d</span><span class="p">):</span>
</span><span id="__span-0-30"><a id="__codelineno-0-30" name="__codelineno-0-30" href="#__codelineno-0-30"></a>                <span class="n">init</span><span class="o">.</span><span class="n">constant_</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">weight</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
</span><span id="__span-0-31"><a id="__codelineno-0-31" name="__codelineno-0-31" href="#__codelineno-0-31"></a>                <span class="n">init</span><span class="o">.</span><span class="n">constant_</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">bias</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
</span><span id="__span-0-32"><a id="__codelineno-0-32" name="__codelineno-0-32" href="#__codelineno-0-32"></a>            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">):</span>
</span><span id="__span-0-33"><a id="__codelineno-0-33" name="__codelineno-0-33" href="#__codelineno-0-33"></a>                <span class="n">init</span><span class="o">.</span><span class="n">normal_</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">weight</span><span class="p">,</span> <span class="n">std</span><span class="o">=</span><span class="mf">0.001</span><span class="p">)</span>
</span><span id="__span-0-34"><a id="__codelineno-0-34" name="__codelineno-0-34" href="#__codelineno-0-34"></a>                <span class="k">if</span> <span class="n">m</span><span class="o">.</span><span class="n">bias</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="__span-0-35"><a id="__codelineno-0-35" name="__codelineno-0-35" href="#__codelineno-0-35"></a>                    <span class="n">init</span><span class="o">.</span><span class="n">constant_</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">bias</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
</span><span id="__span-0-36"><a id="__codelineno-0-36" name="__codelineno-0-36" href="#__codelineno-0-36"></a>
</span><span id="__span-0-37"><a id="__codelineno-0-37" name="__codelineno-0-37" href="#__codelineno-0-37"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
</span><span id="__span-0-38"><a id="__codelineno-0-38" name="__codelineno-0-38" href="#__codelineno-0-38"></a>        <span class="c1"># (B,C,H,W)</span>
</span><span id="__span-0-39"><a id="__codelineno-0-39" name="__codelineno-0-39" href="#__codelineno-0-39"></a>        <span class="n">B</span><span class="p">,</span> <span class="n">C</span><span class="p">,</span> <span class="n">H</span><span class="p">,</span> <span class="n">W</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">size</span><span class="p">()</span>
</span><span id="__span-0-40"><a id="__codelineno-0-40" name="__codelineno-0-40" href="#__codelineno-0-40"></a>        <span class="c1"># Squeeze: (B,C,H,W)--&gt;avg_pool--&gt;(B,C,1,1)--&gt;view--&gt;(B,C)</span>
</span><span id="__span-0-41"><a id="__codelineno-0-41" name="__codelineno-0-41" href="#__codelineno-0-41"></a>        <span class="n">y</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">avg_pool</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="n">B</span><span class="p">,</span> <span class="n">C</span><span class="p">)</span>
</span><span id="__span-0-42"><a id="__codelineno-0-42" name="__codelineno-0-42" href="#__codelineno-0-42"></a>        <span class="c1"># Excitation: (B,C)--&gt;fc--&gt;(B,C)--&gt;(B, C, 1, 1)</span>
</span><span id="__span-0-43"><a id="__codelineno-0-43" name="__codelineno-0-43" href="#__codelineno-0-43"></a>        <span class="n">y</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fc</span><span class="p">(</span><span class="n">y</span><span class="p">)</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="n">B</span><span class="p">,</span> <span class="n">C</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
</span><span id="__span-0-44"><a id="__codelineno-0-44" name="__codelineno-0-44" href="#__codelineno-0-44"></a>        <span class="c1"># scale: (B,C,H,W) * (B, C, 1, 1) == (B,C,H,W)</span>
</span><span id="__span-0-45"><a id="__codelineno-0-45" name="__codelineno-0-45" href="#__codelineno-0-45"></a>        <span class="n">out</span> <span class="o">=</span> <span class="n">x</span> <span class="o">*</span> <span class="n">y</span>
</span><span id="__span-0-46"><a id="__codelineno-0-46" name="__codelineno-0-46" href="#__codelineno-0-46"></a>        <span class="k">return</span> <span class="n">out</span>
</span><span id="__span-0-47"><a id="__codelineno-0-47" name="__codelineno-0-47" href="#__codelineno-0-47"></a>
</span><span id="__span-0-48"><a id="__codelineno-0-48" name="__codelineno-0-48" href="#__codelineno-0-48"></a>
</span><span id="__span-0-49"><a id="__codelineno-0-49" name="__codelineno-0-49" href="#__codelineno-0-49"></a><span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
</span><span id="__span-0-50"><a id="__codelineno-0-50" name="__codelineno-0-50" href="#__codelineno-0-50"></a>    <span class="c1"># (B,C,H,W)</span>
</span><span id="__span-0-51"><a id="__codelineno-0-51" name="__codelineno-0-51" href="#__codelineno-0-51"></a>    <span class="nb">input</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">512</span><span class="p">,</span><span class="mi">7</span><span class="p">,</span><span class="mi">7</span><span class="p">)</span>
</span><span id="__span-0-52"><a id="__codelineno-0-52" name="__codelineno-0-52" href="#__codelineno-0-52"></a>    <span class="c1"># ÂÆö‰πâÈÄöÈÅìÊ≥®ÊÑèÂäõ</span>
</span><span id="__span-0-53"><a id="__codelineno-0-53" name="__codelineno-0-53" href="#__codelineno-0-53"></a>    <span class="n">Model</span> <span class="o">=</span> <span class="n">SEAttention</span><span class="p">(</span><span class="n">channel</span><span class="o">=</span><span class="mi">512</span><span class="p">,</span><span class="n">reduction</span><span class="o">=</span><span class="mi">8</span><span class="p">)</span>
</span><span id="__span-0-54"><a id="__codelineno-0-54" name="__codelineno-0-54" href="#__codelineno-0-54"></a>    <span class="n">output</span><span class="o">=</span><span class="n">Model</span><span class="p">(</span><span class="nb">input</span><span class="p">)</span>
</span><span id="__span-0-55"><a id="__codelineno-0-55" name="__codelineno-0-55" href="#__codelineno-0-55"></a>    <span class="nb">print</span><span class="p">(</span><span class="n">output</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> 
</span></code></pre></div>
<div class="language-python highlight"><pre><span></span><code><span id="__span-1-1"><a id="__codelineno-1-1" name="__codelineno-1-1" href="#__codelineno-1-1"></a><span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
</span><span id="__span-1-2"><a id="__codelineno-1-2" name="__codelineno-1-2" href="#__codelineno-1-2"></a><span class="kn">import</span><span class="w"> </span><span class="nn">torch</span>
</span><span id="__span-1-3"><a id="__codelineno-1-3" name="__codelineno-1-3" href="#__codelineno-1-3"></a><span class="kn">from</span><span class="w"> </span><span class="nn">torch</span><span class="w"> </span><span class="kn">import</span> <span class="n">nn</span>
</span><span id="__span-1-4"><a id="__codelineno-1-4" name="__codelineno-1-4" href="#__codelineno-1-4"></a><span class="kn">from</span><span class="w"> </span><span class="nn">torch.nn</span><span class="w"> </span><span class="kn">import</span> <span class="n">init</span>
</span><span id="__span-1-5"><a id="__codelineno-1-5" name="__codelineno-1-5" href="#__codelineno-1-5"></a>
</span><span id="__span-1-6"><a id="__codelineno-1-6" name="__codelineno-1-6" href="#__codelineno-1-6"></a><span class="k">class</span><span class="w"> </span><span class="nc">SEAttention</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
</span><span id="__span-1-7"><a id="__codelineno-1-7" name="__codelineno-1-7" href="#__codelineno-1-7"></a>    <span class="c1"># ÂàùÂßãÂåñSEÊ®°ÂùóÔºåchannel‰∏∫ÈÄöÈÅìÊï∞Ôºåreduction‰∏∫ÈôçÁª¥ÊØîÁéá</span>
</span><span id="__span-1-8"><a id="__codelineno-1-8" name="__codelineno-1-8" href="#__codelineno-1-8"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">channel</span><span class="o">=</span><span class="mi">512</span><span class="p">,</span> <span class="n">reduction</span><span class="o">=</span><span class="mi">16</span><span class="p">):</span>
</span><span id="__span-1-9"><a id="__codelineno-1-9" name="__codelineno-1-9" href="#__codelineno-1-9"></a>        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
</span><span id="__span-1-10"><a id="__codelineno-1-10" name="__codelineno-1-10" href="#__codelineno-1-10"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">avg_pool</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">AdaptiveAvgPool2d</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>  <span class="c1"># Ëá™ÈÄÇÂ∫îÂπ≥ÂùáÊ±†ÂåñÂ±ÇÔºåÂ∞ÜÁâπÂæÅÂõæÁöÑÁ©∫Èó¥Áª¥Â∫¶ÂéãÁº©‰∏∫1x1</span>
</span><span id="__span-1-11"><a id="__codelineno-1-11" name="__codelineno-1-11" href="#__codelineno-1-11"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">fc</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Sequential</span><span class="p">(</span>  <span class="c1"># ÂÆö‰πâ‰∏§‰∏™ÂÖ®ËøûÊé•Â±Ç‰Ωú‰∏∫ÊøÄÂä±Êìç‰ΩúÔºåÈÄöËøáÈôçÁª¥ÂíåÂçáÁª¥Ë∞ÉÊï¥ÈÄöÈÅìÈáçË¶ÅÊÄß</span>
</span><span id="__span-1-12"><a id="__codelineno-1-12" name="__codelineno-1-12" href="#__codelineno-1-12"></a>            <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="n">channel</span><span class="p">,</span> <span class="n">channel</span> <span class="o">//</span> <span class="n">reduction</span><span class="p">,</span> <span class="n">bias</span><span class="o">=</span><span class="kc">False</span><span class="p">),</span>  <span class="c1"># ÈôçÁª¥ÔºåÂáèÂ∞ëÂèÇÊï∞Êï∞ÈáèÂíåËÆ°ÁÆóÈáè</span>
</span><span id="__span-1-13"><a id="__codelineno-1-13" name="__codelineno-1-13" href="#__codelineno-1-13"></a>            <span class="n">nn</span><span class="o">.</span><span class="n">ReLU</span><span class="p">(</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>  <span class="c1"># ReLUÊøÄÊ¥ªÂáΩÊï∞ÔºåÂºïÂÖ•ÈùûÁ∫øÊÄß</span>
</span><span id="__span-1-14"><a id="__codelineno-1-14" name="__codelineno-1-14" href="#__codelineno-1-14"></a>            <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="n">channel</span> <span class="o">//</span> <span class="n">reduction</span><span class="p">,</span> <span class="n">channel</span><span class="p">,</span> <span class="n">bias</span><span class="o">=</span><span class="kc">False</span><span class="p">),</span>  <span class="c1"># ÂçáÁª¥ÔºåÊÅ¢Â§çÂà∞ÂéüÂßãÈÄöÈÅìÊï∞</span>
</span><span id="__span-1-15"><a id="__codelineno-1-15" name="__codelineno-1-15" href="#__codelineno-1-15"></a>            <span class="n">nn</span><span class="o">.</span><span class="n">Sigmoid</span><span class="p">()</span>  <span class="c1"># SigmoidÊøÄÊ¥ªÂáΩÊï∞ÔºåËæìÂá∫ÊØè‰∏™ÈÄöÈÅìÁöÑÈáçË¶ÅÊÄßÁ≥ªÊï∞</span>
</span><span id="__span-1-16"><a id="__codelineno-1-16" name="__codelineno-1-16" href="#__codelineno-1-16"></a>        <span class="p">)</span>
</span><span id="__span-1-17"><a id="__codelineno-1-17" name="__codelineno-1-17" href="#__codelineno-1-17"></a>
</span><span id="__span-1-18"><a id="__codelineno-1-18" name="__codelineno-1-18" href="#__codelineno-1-18"></a>    <span class="c1"># ÊùÉÈáçÂàùÂßãÂåñÊñπÊ≥ï</span>
</span><span id="__span-1-19"><a id="__codelineno-1-19" name="__codelineno-1-19" href="#__codelineno-1-19"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">init_weights</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="__span-1-20"><a id="__codelineno-1-20" name="__codelineno-1-20" href="#__codelineno-1-20"></a>        <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">modules</span><span class="p">():</span>  <span class="c1"># ÈÅçÂéÜÊ®°Âùó‰∏≠ÁöÑÊâÄÊúâÂ≠êÊ®°Âùó</span>
</span><span id="__span-1-21"><a id="__codelineno-1-21" name="__codelineno-1-21" href="#__codelineno-1-21"></a>            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">nn</span><span class="o">.</span><span class="n">Conv2d</span><span class="p">):</span>  <span class="c1"># ÂØπ‰∫éÂç∑ÁßØÂ±Ç</span>
</span><span id="__span-1-22"><a id="__codelineno-1-22" name="__codelineno-1-22" href="#__codelineno-1-22"></a>                <span class="n">init</span><span class="o">.</span><span class="n">kaiming_normal_</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">weight</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;fan_out&#39;</span><span class="p">)</span>  <span class="c1"># ‰ΩøÁî®KaimingÂàùÂßãÂåñÊñπÊ≥ïÂàùÂßãÂåñÊùÉÈáç</span>
</span><span id="__span-1-23"><a id="__codelineno-1-23" name="__codelineno-1-23" href="#__codelineno-1-23"></a>                <span class="k">if</span> <span class="n">m</span><span class="o">.</span><span class="n">bias</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="__span-1-24"><a id="__codelineno-1-24" name="__codelineno-1-24" href="#__codelineno-1-24"></a>                    <span class="n">init</span><span class="o">.</span><span class="n">constant_</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">bias</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>  <span class="c1"># Â¶ÇÊûúÊúâÂÅèÁΩÆÈ°πÔºåÂàôÂàùÂßãÂåñ‰∏∫0</span>
</span><span id="__span-1-25"><a id="__codelineno-1-25" name="__codelineno-1-25" href="#__codelineno-1-25"></a>            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">nn</span><span class="o">.</span><span class="n">BatchNorm2d</span><span class="p">):</span>  <span class="c1"># ÂØπ‰∫éÊâπÂΩí‰∏ÄÂåñÂ±Ç</span>
</span><span id="__span-1-26"><a id="__codelineno-1-26" name="__codelineno-1-26" href="#__codelineno-1-26"></a>                <span class="n">init</span><span class="o">.</span><span class="n">constant_</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">weight</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>  <span class="c1"># ÊùÉÈáçÂàùÂßãÂåñ‰∏∫1</span>
</span><span id="__span-1-27"><a id="__codelineno-1-27" name="__codelineno-1-27" href="#__codelineno-1-27"></a>                <span class="n">init</span><span class="o">.</span><span class="n">constant_</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">bias</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>  <span class="c1"># ÂÅèÁΩÆÂàùÂßãÂåñ‰∏∫0</span>
</span><span id="__span-1-28"><a id="__codelineno-1-28" name="__codelineno-1-28" href="#__codelineno-1-28"></a>            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">):</span>  <span class="c1"># ÂØπ‰∫éÂÖ®ËøûÊé•Â±Ç</span>
</span><span id="__span-1-29"><a id="__codelineno-1-29" name="__codelineno-1-29" href="#__codelineno-1-29"></a>                <span class="n">init</span><span class="o">.</span><span class="n">normal_</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">weight</span><span class="p">,</span> <span class="n">std</span><span class="o">=</span><span class="mf">0.001</span><span class="p">)</span>  <span class="c1"># ÊùÉÈáç‰ΩøÁî®Ê≠£ÊÄÅÂàÜÂ∏ÉÂàùÂßãÂåñ</span>
</span><span id="__span-1-30"><a id="__codelineno-1-30" name="__codelineno-1-30" href="#__codelineno-1-30"></a>                <span class="k">if</span> <span class="n">m</span><span class="o">.</span><span class="n">bias</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="__span-1-31"><a id="__codelineno-1-31" name="__codelineno-1-31" href="#__codelineno-1-31"></a>                    <span class="n">init</span><span class="o">.</span><span class="n">constant_</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">bias</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>  <span class="c1"># ÂÅèÁΩÆÂàùÂßãÂåñ‰∏∫0</span>
</span><span id="__span-1-32"><a id="__codelineno-1-32" name="__codelineno-1-32" href="#__codelineno-1-32"></a>
</span><span id="__span-1-33"><a id="__codelineno-1-33" name="__codelineno-1-33" href="#__codelineno-1-33"></a>    <span class="c1"># ÂâçÂêë‰º†Êí≠ÊñπÊ≥ï</span>
</span><span id="__span-1-34"><a id="__codelineno-1-34" name="__codelineno-1-34" href="#__codelineno-1-34"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
</span><span id="__span-1-35"><a id="__codelineno-1-35" name="__codelineno-1-35" href="#__codelineno-1-35"></a>        <span class="n">b</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">size</span><span class="p">()</span>  <span class="c1"># Ëé∑ÂèñËæìÂÖ•xÁöÑÊâπÈáèÂ§ßÂ∞èbÂíåÈÄöÈÅìÊï∞c</span>
</span><span id="__span-1-36"><a id="__codelineno-1-36" name="__codelineno-1-36" href="#__codelineno-1-36"></a>        <span class="n">y</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">avg_pool</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">c</span><span class="p">)</span>  <span class="c1"># ÈÄöËøáËá™ÈÄÇÂ∫îÂπ≥ÂùáÊ±†ÂåñÂ±ÇÂêéÔºåË∞ÉÊï¥ÂΩ¢Áä∂‰ª•ÂåπÈÖçÂÖ®ËøûÊé•Â±ÇÁöÑËæìÂÖ•</span>
</span><span id="__span-1-37"><a id="__codelineno-1-37" name="__codelineno-1-37" href="#__codelineno-1-37"></a>        <span class="n">y</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fc</span><span class="p">(</span><span class="n">y</span><span class="p">)</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>  <span class="c1"># ÈÄöËøáÂÖ®ËøûÊé•Â±ÇËÆ°ÁÆóÈÄöÈÅìÈáçË¶ÅÊÄßÔºåË∞ÉÊï¥ÂΩ¢Áä∂‰ª•ÂåπÈÖçÂéüÂßãÁâπÂæÅÂõæÁöÑÂΩ¢Áä∂</span>
</span><span id="__span-1-38"><a id="__codelineno-1-38" name="__codelineno-1-38" href="#__codelineno-1-38"></a>        <span class="k">return</span> <span class="n">x</span> <span class="o">*</span> <span class="n">y</span><span class="o">.</span><span class="n">expand_as</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>  <span class="c1"># Â∞ÜÈÄöÈÅìÈáçË¶ÅÊÄßÁ≥ªÊï∞Â∫îÁî®Âà∞ÂéüÂßãÁâπÂæÅÂõæ‰∏äÔºåËøõË°åÁâπÂæÅÈáçÊñ∞Ê†°ÂáÜ</span>
</span><span id="__span-1-39"><a id="__codelineno-1-39" name="__codelineno-1-39" href="#__codelineno-1-39"></a>
</span><span id="__span-1-40"><a id="__codelineno-1-40" name="__codelineno-1-40" href="#__codelineno-1-40"></a><span class="c1"># Á§∫‰æã‰ΩøÁî®</span>
</span><span id="__span-1-41"><a id="__codelineno-1-41" name="__codelineno-1-41" href="#__codelineno-1-41"></a><span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
</span><span id="__span-1-42"><a id="__codelineno-1-42" name="__codelineno-1-42" href="#__codelineno-1-42"></a>    <span class="nb">input</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="mi">50</span><span class="p">,</span> <span class="mi">512</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">7</span><span class="p">)</span>  <span class="c1"># ÈöèÊú∫ÁîüÊàê‰∏Ä‰∏™ËæìÂÖ•ÁâπÂæÅÂõæ</span>
</span><span id="__span-1-43"><a id="__codelineno-1-43" name="__codelineno-1-43" href="#__codelineno-1-43"></a>    <span class="n">se</span> <span class="o">=</span> <span class="n">SEAttention</span><span class="p">(</span><span class="n">channel</span><span class="o">=</span><span class="mi">512</span><span class="p">,</span> <span class="n">reduction</span><span class="o">=</span><span class="mi">8</span><span class="p">)</span>  <span class="c1"># ÂÆû‰æãÂåñSEÊ®°ÂùóÔºåËÆæÁΩÆÈôçÁª¥ÊØîÁéá‰∏∫8</span>
</span><span id="__span-1-44"><a id="__codelineno-1-44" name="__codelineno-1-44" href="#__codelineno-1-44"></a>    <span class="n">output</span> <span class="o">=</span> <span class="n">se</span><span class="p">(</span><span class="nb">input</span><span class="p">)</span>  <span class="c1"># Â∞ÜËæìÂÖ•ÁâπÂæÅÂõæÈÄöËøáSEÊ®°ÂùóËøõË°åÂ§ÑÁêÜ</span>
</span><span id="__span-1-45"><a id="__codelineno-1-45" name="__codelineno-1-45" href="#__codelineno-1-45"></a>    <span class="nb">print</span><span class="p">(</span><span class="n">output</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>  <span class="c1"># ÊâìÂç∞Â§ÑÁêÜÂêéÁöÑÁâπÂæÅÂõæÂΩ¢Áä∂ÔºåÈ™åËØÅSEÊ®°ÂùóÁöÑ‰ΩúÁî®</span>
</span></code></pre></div>
<ul>
<li>SEÊ®°ÂùóÈ¶ñÂÖàÈÄöËøáÂÖ®Â±ÄÂπ≥ÂùáÊ±†ÂåñÊìç‰ΩúÂØπËæìÂÖ•ÁâπÂæÅÂõæÁöÑÁ©∫Èó¥Áª¥Â∫¶ÔºàÈ´òÂ∫¶HÂíåÂÆΩÂ∫¶WÔºâËøõË°åËÅöÂêàÔºå‰∏∫ÊØè‰∏™ÈÄöÈÅìÁîüÊàê‰∏Ä‰∏™ÈÄöÈÅìÊèèËø∞Á¨¶„ÄÇËøô‰∏ÄÊ≠•ÊúâÊïàÂú∞Â∞ÜÂÖ®Â±ÄÁ©∫Èó¥‰ø°ÊÅØÂéãÁº©Êàê‰∏Ä‰∏™ÈÄöÈÅìÂêëÈáèÔºåÊçïËé∑‰∫ÜÈÄöÈÅìÁâπÂæÅÂìçÂ∫îÁöÑÂÖ®Â±ÄÂàÜÂ∏É„ÄÇËøô‰∏ÄÂÖ®Â±Ä‰ø°ÊÅØÂØπ‰∫éÊé•‰∏ãÊù•ÁöÑÈáçÊñ∞Ê†°ÂáÜËøáÁ®ãËá≥ÂÖ≥ÈáçË¶Å„ÄÇ</li>
<li>Âú®ÂéãÁº©Ê≠•È™§‰πãÂêéÔºåÂ∫îÁî®‰∏Ä‰∏™ÊøÄÂä±Êú∫Âà∂ÔºåËØ•Êú∫Âà∂Êú¨Ë¥®‰∏äÊòØÁî±‰∏§‰∏™ÂÖ®ËøûÊé•ÔºàFCÔºâÂ±ÇÂíå‰∏Ä‰∏™ÈùûÁ∫øÊÄßÊøÄÊ¥ªÂáΩÊï∞ÔºàÈÄöÂ∏∏ÊòØsigmoidÔºâÁªÑÊàêÁöÑËá™Èó®ÊéßÊú∫Âà∂„ÄÇÁ¨¨‰∏Ä‰∏™FCÂ±ÇÈôç‰Ωé‰∫ÜÈÄöÈÅìÊèèËø∞Á¨¶ÁöÑÁª¥Â∫¶ÔºåÂ∫îÁî®ReLUÈùûÁ∫øÊÄßÊøÄÊ¥ªÔºåÈöèÂêéÁ¨¨‰∫å‰∏™FCÂ±ÇÂ∞ÜÂÖ∂ÊäïÂΩ±ÂõûÂéüÂßãÈÄöÈÅìÁª¥Â∫¶„ÄÇËøô‰∏™ËøáÁ®ãÂª∫Ê®°‰∫ÜÈÄöÈÅìÈó¥ÁöÑÈùûÁ∫øÊÄß‰∫§‰∫íÔºåÂπ∂‰∫ßÁîü‰∫Ü‰∏ÄÁªÑÈÄöÈÅìÊùÉÈáç„ÄÇ</li>
<li>ÊøÄÂä±Êìç‰ΩúÁöÑËæìÂá∫Áî®‰∫éÈáçÊñ∞Ê†°ÂáÜÂéüÂßãËæìÂÖ•ÁâπÂæÅÂõæ„ÄÇËæìÂÖ•ÁâπÂæÅÂõæÁöÑÊØè‰∏™ÈÄöÈÅìÈÉΩÁî±ÊøÄÂä±ËæìÂá∫‰∏≠ÂØπÂ∫îÁöÑÊ†áÈáèËøõË°åÁº©Êîæ„ÄÇËøô‰∏ÄÊ≠•È™§ÊúâÈÄâÊã©Âú∞Âº∫Ë∞É‰ø°ÊÅØ‰∏∞ÂØåÁöÑÁâπÂæÅÔºåÂêåÊó∂ÊäëÂà∂‰∏çÂ§™ÊúâÁî®ÁöÑÁâπÂæÅÔºå‰ΩøÊ®°ÂûãËÉΩÂ§ü‰∏ìÊ≥®‰∫é‰ªªÂä°‰∏≠ÊúÄÁõ∏ÂÖ≥ÁöÑÁâπÂæÅ„ÄÇ</li>
</ul>
<p><strong>SE NetÁöÑÊ†∏ÂøÉË¥°ÁåÆÊòØÈÄöËøáSEÂùóÊòæÂºèÂª∫Ê®°ÈÄöÈÅìÈó¥ÁöÑ‰æùËµñÂÖ≥Á≥ª</strong></p>
<h2 id="sknet">‚àö SKNet<a class="headerlink" href="#sknet" title="Permanent link">&para;</a></h2>
<p><img alt="image-20250216201417591" src="../images/image-20250216201417591.png" /></p>
<p><img alt="image-20250222123945075" src="../images/image-20250222123945075.png" /></p>
<p><img alt="image-20250222124005731" src="../images/image-20250222124005731.png" /></p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-2-1"><a id="__codelineno-2-1" name="__codelineno-2-1" href="#__codelineno-2-1"></a><span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
</span><span id="__span-2-2"><a id="__codelineno-2-2" name="__codelineno-2-2" href="#__codelineno-2-2"></a><span class="kn">import</span><span class="w"> </span><span class="nn">torch</span>
</span><span id="__span-2-3"><a id="__codelineno-2-3" name="__codelineno-2-3" href="#__codelineno-2-3"></a><span class="kn">from</span><span class="w"> </span><span class="nn">torch</span><span class="w"> </span><span class="kn">import</span> <span class="n">nn</span>
</span><span id="__span-2-4"><a id="__codelineno-2-4" name="__codelineno-2-4" href="#__codelineno-2-4"></a><span class="kn">from</span><span class="w"> </span><span class="nn">torch.nn</span><span class="w"> </span><span class="kn">import</span> <span class="n">init</span>
</span><span id="__span-2-5"><a id="__codelineno-2-5" name="__codelineno-2-5" href="#__codelineno-2-5"></a><span class="kn">from</span><span class="w"> </span><span class="nn">collections</span><span class="w"> </span><span class="kn">import</span> <span class="n">OrderedDict</span>
</span><span id="__span-2-6"><a id="__codelineno-2-6" name="__codelineno-2-6" href="#__codelineno-2-6"></a>
</span><span id="__span-2-7"><a id="__codelineno-2-7" name="__codelineno-2-7" href="#__codelineno-2-7"></a><span class="s2">&quot;Selective Kernel Networks&quot;</span>
</span><span id="__span-2-8"><a id="__codelineno-2-8" name="__codelineno-2-8" href="#__codelineno-2-8"></a>
</span><span id="__span-2-9"><a id="__codelineno-2-9" name="__codelineno-2-9" href="#__codelineno-2-9"></a><span class="k">class</span><span class="w"> </span><span class="nc">SKAttention</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
</span><span id="__span-2-10"><a id="__codelineno-2-10" name="__codelineno-2-10" href="#__codelineno-2-10"></a>
</span><span id="__span-2-11"><a id="__codelineno-2-11" name="__codelineno-2-11" href="#__codelineno-2-11"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">channel</span><span class="o">=</span><span class="mi">512</span><span class="p">,</span><span class="n">kernels</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">7</span><span class="p">],</span><span class="n">reduction</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span><span class="n">group</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">L</span><span class="o">=</span><span class="mi">32</span><span class="p">):</span>
</span><span id="__span-2-12"><a id="__codelineno-2-12" name="__codelineno-2-12" href="#__codelineno-2-12"></a>        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
</span><span id="__span-2-13"><a id="__codelineno-2-13" name="__codelineno-2-13" href="#__codelineno-2-13"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">d</span><span class="o">=</span><span class="nb">max</span><span class="p">(</span><span class="n">L</span><span class="p">,</span><span class="n">channel</span><span class="o">//</span><span class="n">reduction</span><span class="p">)</span>
</span><span id="__span-2-14"><a id="__codelineno-2-14" name="__codelineno-2-14" href="#__codelineno-2-14"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">convs</span><span class="o">=</span><span class="n">nn</span><span class="o">.</span><span class="n">ModuleList</span><span class="p">([])</span>
</span><span id="__span-2-15"><a id="__codelineno-2-15" name="__codelineno-2-15" href="#__codelineno-2-15"></a>        <span class="c1"># ÊúâÂá†‰∏™Âç∑ÁßØÊ†∏,Â∞±ÊúâÂá†‰∏™Â∞∫Â∫¶, ÊØè‰∏™Â∞∫Â∫¶ÂØπÂ∫îÁöÑÂç∑ÁßØÂ±ÇÁî±Conv-bn-reluÂÆûÁé∞</span>
</span><span id="__span-2-16"><a id="__codelineno-2-16" name="__codelineno-2-16" href="#__codelineno-2-16"></a>        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">kernels</span><span class="p">:</span>
</span><span id="__span-2-17"><a id="__codelineno-2-17" name="__codelineno-2-17" href="#__codelineno-2-17"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">convs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
</span><span id="__span-2-18"><a id="__codelineno-2-18" name="__codelineno-2-18" href="#__codelineno-2-18"></a>                <span class="n">nn</span><span class="o">.</span><span class="n">Sequential</span><span class="p">(</span><span class="n">OrderedDict</span><span class="p">([</span>
</span><span id="__span-2-19"><a id="__codelineno-2-19" name="__codelineno-2-19" href="#__codelineno-2-19"></a>                    <span class="p">(</span><span class="s1">&#39;conv&#39;</span><span class="p">,</span><span class="n">nn</span><span class="o">.</span><span class="n">Conv2d</span><span class="p">(</span><span class="n">channel</span><span class="p">,</span><span class="n">channel</span><span class="p">,</span><span class="n">kernel_size</span><span class="o">=</span><span class="n">k</span><span class="p">,</span><span class="n">padding</span><span class="o">=</span><span class="n">k</span><span class="o">//</span><span class="mi">2</span><span class="p">,</span><span class="n">groups</span><span class="o">=</span><span class="n">group</span><span class="p">)),</span>
</span><span id="__span-2-20"><a id="__codelineno-2-20" name="__codelineno-2-20" href="#__codelineno-2-20"></a>                    <span class="p">(</span><span class="s1">&#39;bn&#39;</span><span class="p">,</span><span class="n">nn</span><span class="o">.</span><span class="n">BatchNorm2d</span><span class="p">(</span><span class="n">channel</span><span class="p">)),</span>
</span><span id="__span-2-21"><a id="__codelineno-2-21" name="__codelineno-2-21" href="#__codelineno-2-21"></a>                    <span class="p">(</span><span class="s1">&#39;relu&#39;</span><span class="p">,</span><span class="n">nn</span><span class="o">.</span><span class="n">ReLU</span><span class="p">())</span>
</span><span id="__span-2-22"><a id="__codelineno-2-22" name="__codelineno-2-22" href="#__codelineno-2-22"></a>                <span class="p">]))</span>
</span><span id="__span-2-23"><a id="__codelineno-2-23" name="__codelineno-2-23" href="#__codelineno-2-23"></a>            <span class="p">)</span>
</span><span id="__span-2-24"><a id="__codelineno-2-24" name="__codelineno-2-24" href="#__codelineno-2-24"></a>        <span class="c1"># Â∞ÜÂÖ®Â±ÄÂêëÈáèÈôçÁª¥</span>
</span><span id="__span-2-25"><a id="__codelineno-2-25" name="__codelineno-2-25" href="#__codelineno-2-25"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">fc</span><span class="o">=</span><span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="n">channel</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">d</span><span class="p">)</span>
</span><span id="__span-2-26"><a id="__codelineno-2-26" name="__codelineno-2-26" href="#__codelineno-2-26"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">fcs</span><span class="o">=</span><span class="n">nn</span><span class="o">.</span><span class="n">ModuleList</span><span class="p">([])</span>
</span><span id="__span-2-27"><a id="__codelineno-2-27" name="__codelineno-2-27" href="#__codelineno-2-27"></a>        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">kernels</span><span class="p">)):</span>
</span><span id="__span-2-28"><a id="__codelineno-2-28" name="__codelineno-2-28" href="#__codelineno-2-28"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">fcs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">d</span><span class="p">,</span><span class="n">channel</span><span class="p">))</span>
</span><span id="__span-2-29"><a id="__codelineno-2-29" name="__codelineno-2-29" href="#__codelineno-2-29"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">softmax</span><span class="o">=</span><span class="n">nn</span><span class="o">.</span><span class="n">Softmax</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</span><span id="__span-2-30"><a id="__codelineno-2-30" name="__codelineno-2-30" href="#__codelineno-2-30"></a>
</span><span id="__span-2-31"><a id="__codelineno-2-31" name="__codelineno-2-31" href="#__codelineno-2-31"></a>
</span><span id="__span-2-32"><a id="__codelineno-2-32" name="__codelineno-2-32" href="#__codelineno-2-32"></a>
</span><span id="__span-2-33"><a id="__codelineno-2-33" name="__codelineno-2-33" href="#__codelineno-2-33"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
</span><span id="__span-2-34"><a id="__codelineno-2-34" name="__codelineno-2-34" href="#__codelineno-2-34"></a>        <span class="c1"># (B, C, H, W)</span>
</span><span id="__span-2-35"><a id="__codelineno-2-35" name="__codelineno-2-35" href="#__codelineno-2-35"></a>        <span class="n">B</span><span class="p">,</span> <span class="n">C</span><span class="p">,</span> <span class="n">H</span><span class="p">,</span> <span class="n">W</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">size</span><span class="p">()</span>
</span><span id="__span-2-36"><a id="__codelineno-2-36" name="__codelineno-2-36" href="#__codelineno-2-36"></a>        <span class="c1"># Â≠òÊîæÂ§öÂ∞∫Â∫¶ÁöÑËæìÂá∫</span>
</span><span id="__span-2-37"><a id="__codelineno-2-37" name="__codelineno-2-37" href="#__codelineno-2-37"></a>        <span class="n">conv_outs</span><span class="o">=</span><span class="p">[]</span>
</span><span id="__span-2-38"><a id="__codelineno-2-38" name="__codelineno-2-38" href="#__codelineno-2-38"></a>        <span class="c1"># Split: ÊâßË°åK‰∏™Â∞∫Â∫¶ÂØπÂ∫îÁöÑÂç∑ÁßØÊìç‰Ωú</span>
</span><span id="__span-2-39"><a id="__codelineno-2-39" name="__codelineno-2-39" href="#__codelineno-2-39"></a>        <span class="k">for</span> <span class="n">conv</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">convs</span><span class="p">:</span>
</span><span id="__span-2-40"><a id="__codelineno-2-40" name="__codelineno-2-40" href="#__codelineno-2-40"></a>            <span class="n">scale</span> <span class="o">=</span> <span class="n">conv</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>  <span class="c1">#ÊØè‰∏Ä‰∏™Â∞∫Â∫¶ÁöÑËæìÂá∫shapeÈÉΩÊòØ: (B, C, H, W),ÊòØÂõ†‰∏∫‰ΩøÁî®‰∫ÜpaddingÊìç‰Ωú</span>
</span><span id="__span-2-41"><a id="__codelineno-2-41" name="__codelineno-2-41" href="#__codelineno-2-41"></a>            <span class="n">conv_outs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">scale</span><span class="p">)</span>
</span><span id="__span-2-42"><a id="__codelineno-2-42" name="__codelineno-2-42" href="#__codelineno-2-42"></a>        <span class="n">feats</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">conv_outs</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span> <span class="c1"># Â∞ÜK‰∏™Â∞∫Â∫¶ÁöÑËæìÂá∫Âú®Á¨¨0‰∏™Áª¥Â∫¶‰∏äÊãºÊé•: (K,B,C,H,W)</span>
</span><span id="__span-2-43"><a id="__codelineno-2-43" name="__codelineno-2-43" href="#__codelineno-2-43"></a>
</span><span id="__span-2-44"><a id="__codelineno-2-44" name="__codelineno-2-44" href="#__codelineno-2-44"></a>        <span class="c1"># Fuse: È¶ñÂÖàÂ∞ÜÂ§öÂ∞∫Â∫¶ÁöÑ‰ø°ÊÅØËøõË°åÁõ∏Âä†,sum()ÈªòËÆ§Âú®Á¨¨‰∏Ä‰∏™Áª¥Â∫¶ËøõË°åÊ±ÇÂíå</span>
</span><span id="__span-2-45"><a id="__codelineno-2-45" name="__codelineno-2-45" href="#__codelineno-2-45"></a>        <span class="n">U</span><span class="o">=</span><span class="nb">sum</span><span class="p">(</span><span class="n">conv_outs</span><span class="p">)</span> <span class="c1">#(K,B,C,H,W)--&gt;(B,C,H,W)</span>
</span><span id="__span-2-46"><a id="__codelineno-2-46" name="__codelineno-2-46" href="#__codelineno-2-46"></a>        <span class="c1"># ÂÖ®Â±ÄÂπ≥ÂùáÊ±†ÂåñÊìç‰Ωú: (B,C,H,W)--&gt;mean--&gt;(B,C,H)--&gt;mean--&gt;(B,C)  „ÄêmeanÊìç‰ΩúÁ≠â‰ª∑‰∫éÂÖ®Â±ÄÂπ≥ÂùáÊ±†ÂåñÁöÑÊìç‰Ωú„Äë</span>
</span><span id="__span-2-47"><a id="__codelineno-2-47" name="__codelineno-2-47" href="#__codelineno-2-47"></a>        <span class="n">S</span><span class="o">=</span><span class="n">U</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
</span><span id="__span-2-48"><a id="__codelineno-2-48" name="__codelineno-2-48" href="#__codelineno-2-48"></a>        <span class="c1"># Èôç‰ΩéÈÄöÈÅìÊï∞,ÊèêÈ´òËÆ°ÁÆóÊïàÁéá: (B,C)--&gt;(B,d)</span>
</span><span id="__span-2-49"><a id="__codelineno-2-49" name="__codelineno-2-49" href="#__codelineno-2-49"></a>        <span class="n">Z</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">fc</span><span class="p">(</span><span class="n">S</span><span class="p">)</span>
</span><span id="__span-2-50"><a id="__codelineno-2-50" name="__codelineno-2-50" href="#__codelineno-2-50"></a>
</span><span id="__span-2-51"><a id="__codelineno-2-51" name="__codelineno-2-51" href="#__codelineno-2-51"></a>        <span class="c1"># Â∞ÜÁ¥ßÂáëÁâπÂæÅZÈÄöËøáK‰∏™ÂÖ®ËøûÊé•Â±ÇÂæóÂà∞K‰∏™Â∞∫Â∫¶ÂØπÂ∫îÁöÑÈÄöÈÅìÊèèËø∞Á¨¶Ë°®Á§∫, ÁÑ∂ÂêéÂü∫‰∫éK‰∏™ÈÄöÈÅìÊèèËø∞Á¨¶ËÆ°ÁÆóÊ≥®ÊÑèÂäõÊùÉÈáç</span>
</span><span id="__span-2-52"><a id="__codelineno-2-52" name="__codelineno-2-52" href="#__codelineno-2-52"></a>        <span class="n">weights</span><span class="o">=</span><span class="p">[]</span>
</span><span id="__span-2-53"><a id="__codelineno-2-53" name="__codelineno-2-53" href="#__codelineno-2-53"></a>        <span class="k">for</span> <span class="n">fc</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">fcs</span><span class="p">:</span>
</span><span id="__span-2-54"><a id="__codelineno-2-54" name="__codelineno-2-54" href="#__codelineno-2-54"></a>            <span class="n">weight</span><span class="o">=</span><span class="n">fc</span><span class="p">(</span><span class="n">Z</span><span class="p">)</span> <span class="c1">#ÊÅ¢Â§çÈ¢ÑËæìÂÖ•Áõ∏ÂêåÁöÑÈÄöÈÅìÊï∞: (B,d)--&gt;(B,C)</span>
</span><span id="__span-2-55"><a id="__codelineno-2-55" name="__codelineno-2-55" href="#__codelineno-2-55"></a>            <span class="n">weights</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">weight</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="n">B</span><span class="p">,</span><span class="n">C</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span> <span class="c1"># (B,C)--&gt;(B,C,1,1)</span>
</span><span id="__span-2-56"><a id="__codelineno-2-56" name="__codelineno-2-56" href="#__codelineno-2-56"></a>        <span class="n">scale_weight</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">weights</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span> <span class="c1">#Â∞ÜK‰∏™ÈÄöÈÅìÊèèËø∞Á¨¶Âú®0‰∏™Áª¥Â∫¶‰∏äÊãºÊé•: (K,B,C,1,1)</span>
</span><span id="__span-2-57"><a id="__codelineno-2-57" name="__codelineno-2-57" href="#__codelineno-2-57"></a>        <span class="n">scale_weight</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">softmax</span><span class="p">(</span><span class="n">scale_weight</span><span class="p">)</span> <span class="c1">#Âú®Á¨¨0‰∏™Áª¥Â∫¶‰∏äÊâßË°åsoftmax,Ëé∑ÂæóÊØè‰∏™Â∞∫Â∫¶ÁöÑÊùÉÈáç: (K,B,C,1,1)</span>
</span><span id="__span-2-58"><a id="__codelineno-2-58" name="__codelineno-2-58" href="#__codelineno-2-58"></a>
</span><span id="__span-2-59"><a id="__codelineno-2-59" name="__codelineno-2-59" href="#__codelineno-2-59"></a>        <span class="c1"># Select</span>
</span><span id="__span-2-60"><a id="__codelineno-2-60" name="__codelineno-2-60" href="#__codelineno-2-60"></a>        <span class="n">V</span><span class="o">=</span><span class="p">(</span><span class="n">scale_weight</span><span class="o">*</span><span class="n">feats</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="c1"># Â∞ÜÊØè‰∏™Â∞∫Â∫¶ÁöÑÊùÉÈáç‰∏éÂØπÂ∫îÁöÑÁâπÂæÅËøõË°åÂä†ÊùÉÊ±ÇÂíå,Á¨¨‰∏ÄÊ≠•ÊòØÂä†ÊùÉÔºåÁ¨¨‰∫åÊ≠•ÊòØÊ±ÇÂíåÔºö(K,B,C,1,1) * (K,B,C,H,W) = (K,B,C,H,W)--&gt;sum--&gt;(B,C,H,W)</span>
</span><span id="__span-2-61"><a id="__codelineno-2-61" name="__codelineno-2-61" href="#__codelineno-2-61"></a>        <span class="k">return</span> <span class="n">V</span>
</span><span id="__span-2-62"><a id="__codelineno-2-62" name="__codelineno-2-62" href="#__codelineno-2-62"></a>
</span><span id="__span-2-63"><a id="__codelineno-2-63" name="__codelineno-2-63" href="#__codelineno-2-63"></a>
</span><span id="__span-2-64"><a id="__codelineno-2-64" name="__codelineno-2-64" href="#__codelineno-2-64"></a>
</span><span id="__span-2-65"><a id="__codelineno-2-65" name="__codelineno-2-65" href="#__codelineno-2-65"></a><span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
</span><span id="__span-2-66"><a id="__codelineno-2-66" name="__codelineno-2-66" href="#__codelineno-2-66"></a>    <span class="c1"># (B,C,H,W)</span>
</span><span id="__span-2-67"><a id="__codelineno-2-67" name="__codelineno-2-67" href="#__codelineno-2-67"></a>    <span class="nb">input</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">512</span><span class="p">,</span><span class="mi">7</span><span class="p">,</span><span class="mi">7</span><span class="p">)</span>
</span><span id="__span-2-68"><a id="__codelineno-2-68" name="__codelineno-2-68" href="#__codelineno-2-68"></a>    <span class="n">Model</span> <span class="o">=</span> <span class="n">SKAttention</span><span class="p">(</span><span class="n">channel</span><span class="o">=</span><span class="mi">512</span><span class="p">,</span><span class="n">reduction</span><span class="o">=</span><span class="mi">8</span><span class="p">)</span>
</span><span id="__span-2-69"><a id="__codelineno-2-69" name="__codelineno-2-69" href="#__codelineno-2-69"></a>    <span class="n">output</span><span class="o">=</span><span class="n">Model</span><span class="p">(</span><span class="nb">input</span><span class="p">)</span>
</span><span id="__span-2-70"><a id="__codelineno-2-70" name="__codelineno-2-70" href="#__codelineno-2-70"></a>    <span class="nb">print</span><span class="p">(</span><span class="n">output</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
</span></code></pre></div>
<h2 id="cbam">‚àö CBAM<a class="headerlink" href="#cbam" title="Permanent link">&para;</a></h2>
<p>ËÆ∫Êñá„ÄäCBAM: Convolutional Block Attention Module„Äã</p>
<p><img alt="image-20250222123629324" src="../images/image-20250222123629324.png" /></p>
<p><img alt="image-20250222123709287" src="../images/image-20250222123709287.png" /></p>
<p><img alt="image-20250222123740942" src="../images/image-20250222123740942.png" /></p>
<p><strong>‰ΩúÁî®Ôºö</strong></p>
<p>ÊòØ‰∏∫‰∫ÜÊèêÂçáÂâçÈ¶àÂç∑ÁßØÁ•ûÁªèÁΩëÁªúÊÄßËÉΩËÄåÊèêÂá∫ÁöÑ‰∏ÄÁßçÁÆÄÂçïËÄåÊúâÊïàÁöÑÊ≥®ÊÑèÂäõÊ®°Âùó„ÄÇCBAMÈÄöËøáÈ°∫Â∫èÂú∞Êé®Êñ≠‰∏§‰∏™Áª¥Â∫¶‰∏äÁöÑÊ≥®ÊÑèÂäõÂõæÔºàÈÄöÈÅìÂíåÁ©∫Èó¥ÔºâÔºåÁÑ∂ÂêéÂ∞ÜËøô‰∫õÊ≥®ÊÑèÂäõÂõæ‰πò‰ª•ËæìÂÖ•ÁâπÂæÅÂõæËøõË°åËá™ÈÄÇÂ∫îÁâπÂæÅÁ≤æÁÇº„ÄÇ</p>
<p>1„ÄÅ<strong>ÈÄöÈÅìÊ≥®ÊÑèÂäõÊ®°ÂùóÔºàChannel Attention ModuleÔºâ</strong>Ôºö</p>
<p>ÈÄöËøáÂà©Áî®ÁâπÂæÅ‰πãÈó¥ÁöÑÈÄöÈÅìÂÖ≥Á≥ªÊù•ÁîüÊàêÈÄöÈÅìÊ≥®ÊÑèÂäõÂõæ„ÄÇÊØè‰∏™ÈÄöÈÅìÁöÑÁâπÂæÅÂõæË¢´ËßÜ‰∏∫‰∏Ä‰∏™ÁâπÂæÅÊé¢ÊµãÂô®ÔºåÈÄöÈÅìÊ≥®ÊÑèÂäõÂÖ≥Ê≥®‰∫éÁªôÂÆöËæìÂÖ•ÂõæÂÉè‰∏≠‚Äú‰ªÄ‰πà‚ÄùÊòØÊúâÊÑè‰πâÁöÑ„ÄÇ‰∏∫‰∫ÜÊúâÊïàÂú∞ËÆ°ÁÆóÈÄöÈÅìÊ≥®ÊÑèÂäõÔºåCBAMÈ¶ñÂÖàÂØπËæìÂÖ•ÁâπÂæÅÂõæÁöÑÁ©∫Èó¥Áª¥Â∫¶ËøõË°åÂéãÁº©ÔºåÂêåÊó∂‰ΩøÁî®Âπ≥ÂùáÊ±†ÂåñÂíåÊúÄÂ§ßÊ±†ÂåñÊìç‰ΩúÊù•ÊçïËé∑‰∏çÂêåÁöÑÁ©∫Èó¥‰∏ä‰∏ãÊñáÊèèËø∞Á¨¶ÔºåËøô‰∫õË¢´ÈÄÅÂÖ•ÂÖ±‰∫´ÁöÑÂ§öÂ±ÇÊÑüÁü•Êú∫ÔºàMLPÔºâ‰ª•‰∫ßÁîüÈÄöÈÅìÊ≥®ÊÑèÂäõÂõæ„ÄÇ</p>
<p>2„ÄÅ<strong>Á©∫Èó¥Ê≥®ÊÑèÂäõÊ®°ÂùóÔºàSpatial Attention ModuleÔºâ</strong>Ôºö</p>
<p>Âà©Áî®ÁâπÂæÅ‰πãÈó¥ÁöÑÁ©∫Èó¥ÂÖ≥Á≥ªÊù•ÁîüÊàêÁ©∫Èó¥Ê≥®ÊÑèÂäõÂõæ„ÄÇ‰∏éÈÄöÈÅìÊ≥®ÊÑèÂäõ‰∏çÂêåÔºåÁ©∫Èó¥Ê≥®ÊÑèÂäõÂÖ≥Ê≥®‰∫é‚ÄúÂú®Âì™Èáå‚ÄùÊòØ‰∏Ä‰∏™Êúâ‰ø°ÊÅØÁöÑÈÉ®ÂàÜÔºåËøô‰∏éÈÄöÈÅìÊ≥®ÊÑèÂäõÊòØ‰∫íË°•ÁöÑ„ÄÇ‰∏∫‰∫ÜËÆ°ÁÆóÁ©∫Èó¥Ê≥®ÊÑèÂäõÔºåCBAMÈ¶ñÂÖàÊ≤øÁùÄÈÄöÈÅìËΩ¥Â∫îÁî®Âπ≥ÂùáÊ±†ÂåñÂíåÊúÄÂ§ßÊ±†ÂåñÊìç‰ΩúÔºåÁÑ∂ÂêéÂ∞ÜÂÆÉ‰ª¨ËøûÊé•Ëµ∑Êù•ÁîüÊàê‰∏Ä‰∏™È´òÊïàÁöÑÁâπÂæÅÊèèËø∞Á¨¶„ÄÇÂú®ËØ•ÊèèËø∞Á¨¶‰∏äÂ∫îÁî®‰∏Ä‰∏™Âç∑ÁßØÂ±ÇÊù•ÁîüÊàêÁ©∫Èó¥Ê≥®ÊÑèÂäõÂõæ„ÄÇ</p>
<p><strong>Â•ΩÂ§ÑÔºö</strong></p>
<p><strong>ÂèåÈáçÊ≥®ÊÑèÂäõÊú∫Âà∂</strong>Ôºö</p>
<p>CBAMÈ¶ñÊ¨°Â∞Ü <strong>ÈÄöÈÅìÊ≥®ÊÑèÂäõÔºàChannel AttentionÔºâÂíåÁ©∫Èó¥Ê≥®ÊÑèÂäõÔºàSpatial AttentionÔºâÈ°∫Â∫è</strong> ÁªìÂêàËµ∑Êù•ÔºåÂØπËæìÂÖ•ÁâπÂæÅËøõË°å‰∏§Èò∂ÊÆµÁöÑÁ≤æÁÇº„ÄÇËøôÁßçËÆæËÆ°ËÆ©Ê®°ÂûãÂÖàÂÖ≥Ê≥®‰∫é‚ÄúÂì™‰∫õÈÄöÈÅìÊòØÈáçË¶ÅÁöÑ‚ÄùÔºåÁÑ∂ÂêéÂÜçÂÖ≥Ê≥®‰∫é‚ÄúÁ©∫Èó¥‰∏äÂì™‰∫õ‰ΩçÁΩÆÊòØÈáçË¶ÅÁöÑ‚ÄùÔºå‰ªéËÄåÊõ¥Âä†ÂÖ®Èù¢Âú∞ÊçïËé∑ÁâπÂæÅ‰∏≠ÁöÑÂÖ≥ÈîÆ‰ø°ÊÅØ„ÄÇ</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-3-1"><a id="__codelineno-3-1" name="__codelineno-3-1" href="#__codelineno-3-1"></a><span class="kn">import</span><span class="w"> </span><span class="nn">torch</span>
</span><span id="__span-3-2"><a id="__codelineno-3-2" name="__codelineno-3-2" href="#__codelineno-3-2"></a><span class="kn">from</span><span class="w"> </span><span class="nn">torch</span><span class="w"> </span><span class="kn">import</span> <span class="n">nn</span>
</span><span id="__span-3-3"><a id="__codelineno-3-3" name="__codelineno-3-3" href="#__codelineno-3-3"></a>
</span><span id="__span-3-4"><a id="__codelineno-3-4" name="__codelineno-3-4" href="#__codelineno-3-4"></a><span class="c1"># ÈÄöÈÅìÊ≥®ÊÑèÂäõÊ®°Âùó</span>
</span><span id="__span-3-5"><a id="__codelineno-3-5" name="__codelineno-3-5" href="#__codelineno-3-5"></a><span class="k">class</span><span class="w"> </span><span class="nc">ChannelAttention</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
</span><span id="__span-3-6"><a id="__codelineno-3-6" name="__codelineno-3-6" href="#__codelineno-3-6"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">in_planes</span><span class="p">,</span> <span class="n">ratio</span><span class="o">=</span><span class="mi">16</span><span class="p">):</span>
</span><span id="__span-3-7"><a id="__codelineno-3-7" name="__codelineno-3-7" href="#__codelineno-3-7"></a>        <span class="nb">super</span><span class="p">(</span><span class="n">ChannelAttention</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
</span><span id="__span-3-8"><a id="__codelineno-3-8" name="__codelineno-3-8" href="#__codelineno-3-8"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">avg_pool</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">AdaptiveAvgPool2d</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>  <span class="c1"># Ëá™ÈÄÇÂ∫îÂπ≥ÂùáÊ±†Âåñ</span>
</span><span id="__span-3-9"><a id="__codelineno-3-9" name="__codelineno-3-9" href="#__codelineno-3-9"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">max_pool</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">AdaptiveMaxPool2d</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>  <span class="c1"># Ëá™ÈÄÇÂ∫îÊúÄÂ§ßÊ±†Âåñ</span>
</span><span id="__span-3-10"><a id="__codelineno-3-10" name="__codelineno-3-10" href="#__codelineno-3-10"></a>
</span><span id="__span-3-11"><a id="__codelineno-3-11" name="__codelineno-3-11" href="#__codelineno-3-11"></a>        <span class="c1"># ‰∏§‰∏™Âç∑ÁßØÂ±ÇÁî®‰∫é‰ªéÊ±†ÂåñÂêéÁöÑÁâπÂæÅ‰∏≠Â≠¶‰π†Ê≥®ÊÑèÂäõÊùÉÈáç</span>
</span><span id="__span-3-12"><a id="__codelineno-3-12" name="__codelineno-3-12" href="#__codelineno-3-12"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">fc1</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Conv2d</span><span class="p">(</span><span class="n">in_planes</span><span class="p">,</span> <span class="n">in_planes</span> <span class="o">//</span> <span class="n">ratio</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">bias</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>  <span class="c1"># Á¨¨‰∏Ä‰∏™Âç∑ÁßØÂ±ÇÔºåÈôçÁª¥</span>
</span><span id="__span-3-13"><a id="__codelineno-3-13" name="__codelineno-3-13" href="#__codelineno-3-13"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">relu1</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">ReLU</span><span class="p">()</span>  <span class="c1"># ReLUÊøÄÊ¥ªÂáΩÊï∞</span>
</span><span id="__span-3-14"><a id="__codelineno-3-14" name="__codelineno-3-14" href="#__codelineno-3-14"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">fc2</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Conv2d</span><span class="p">(</span><span class="n">in_planes</span> <span class="o">//</span> <span class="n">ratio</span><span class="p">,</span> <span class="n">in_planes</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">bias</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>  <span class="c1"># Á¨¨‰∫å‰∏™Âç∑ÁßØÂ±ÇÔºåÂçáÁª¥</span>
</span><span id="__span-3-15"><a id="__codelineno-3-15" name="__codelineno-3-15" href="#__codelineno-3-15"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">sigmoid</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Sigmoid</span><span class="p">()</span>  <span class="c1"># SigmoidÂáΩÊï∞ÁîüÊàêÊúÄÁªàÁöÑÊ≥®ÊÑèÂäõÊùÉÈáç</span>
</span><span id="__span-3-16"><a id="__codelineno-3-16" name="__codelineno-3-16" href="#__codelineno-3-16"></a>
</span><span id="__span-3-17"><a id="__codelineno-3-17" name="__codelineno-3-17" href="#__codelineno-3-17"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
</span><span id="__span-3-18"><a id="__codelineno-3-18" name="__codelineno-3-18" href="#__codelineno-3-18"></a>        <span class="n">avg_out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fc2</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">relu1</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fc1</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">avg_pool</span><span class="p">(</span><span class="n">x</span><span class="p">))))</span>  <span class="c1"># ÂØπÂπ≥ÂùáÊ±†ÂåñÁöÑÁâπÂæÅËøõË°åÂ§ÑÁêÜ</span>
</span><span id="__span-3-19"><a id="__codelineno-3-19" name="__codelineno-3-19" href="#__codelineno-3-19"></a>        <span class="n">max_out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fc2</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">relu1</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fc1</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">max_pool</span><span class="p">(</span><span class="n">x</span><span class="p">))))</span>  <span class="c1"># ÂØπÊúÄÂ§ßÊ±†ÂåñÁöÑÁâπÂæÅËøõË°åÂ§ÑÁêÜ</span>
</span><span id="__span-3-20"><a id="__codelineno-3-20" name="__codelineno-3-20" href="#__codelineno-3-20"></a>        <span class="n">out</span> <span class="o">=</span> <span class="n">avg_out</span> <span class="o">+</span> <span class="n">max_out</span>  <span class="c1"># Â∞Ü‰∏§ÁßçÊ±†ÂåñÁöÑÁâπÂæÅÂä†ÊùÉÂíå‰Ωú‰∏∫ËæìÂá∫</span>
</span><span id="__span-3-21"><a id="__codelineno-3-21" name="__codelineno-3-21" href="#__codelineno-3-21"></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">sigmoid</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>  <span class="c1"># ‰ΩøÁî®sigmoidÊøÄÊ¥ªÂáΩÊï∞ËÆ°ÁÆóÊ≥®ÊÑèÂäõÊùÉÈáç</span>
</span><span id="__span-3-22"><a id="__codelineno-3-22" name="__codelineno-3-22" href="#__codelineno-3-22"></a>
</span><span id="__span-3-23"><a id="__codelineno-3-23" name="__codelineno-3-23" href="#__codelineno-3-23"></a><span class="c1"># Á©∫Èó¥Ê≥®ÊÑèÂäõÊ®°Âùó</span>
</span><span id="__span-3-24"><a id="__codelineno-3-24" name="__codelineno-3-24" href="#__codelineno-3-24"></a><span class="k">class</span><span class="w"> </span><span class="nc">SpatialAttention</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
</span><span id="__span-3-25"><a id="__codelineno-3-25" name="__codelineno-3-25" href="#__codelineno-3-25"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">kernel_size</span><span class="o">=</span><span class="mi">7</span><span class="p">):</span>
</span><span id="__span-3-26"><a id="__codelineno-3-26" name="__codelineno-3-26" href="#__codelineno-3-26"></a>        <span class="nb">super</span><span class="p">(</span><span class="n">SpatialAttention</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
</span><span id="__span-3-27"><a id="__codelineno-3-27" name="__codelineno-3-27" href="#__codelineno-3-27"></a>
</span><span id="__span-3-28"><a id="__codelineno-3-28" name="__codelineno-3-28" href="#__codelineno-3-28"></a>        <span class="k">assert</span> <span class="n">kernel_size</span> <span class="ow">in</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">7</span><span class="p">),</span> <span class="s1">&#39;kernel size must be 3 or 7&#39;</span>  <span class="c1"># Ê†∏ÂøÉÂ§ßÂ∞èÂè™ËÉΩÊòØ3Êàñ7</span>
</span><span id="__span-3-29"><a id="__codelineno-3-29" name="__codelineno-3-29" href="#__codelineno-3-29"></a>        <span class="n">padding</span> <span class="o">=</span> <span class="mi">3</span> <span class="k">if</span> <span class="n">kernel_size</span> <span class="o">==</span> <span class="mi">7</span> <span class="k">else</span> <span class="mi">1</span>  <span class="c1"># Ê†πÊçÆÊ†∏ÂøÉÂ§ßÂ∞èËÆæÁΩÆÂ°´ÂÖÖ</span>
</span><span id="__span-3-30"><a id="__codelineno-3-30" name="__codelineno-3-30" href="#__codelineno-3-30"></a>
</span><span id="__span-3-31"><a id="__codelineno-3-31" name="__codelineno-3-31" href="#__codelineno-3-31"></a>        <span class="c1"># Âç∑ÁßØÂ±ÇÁî®‰∫é‰ªéËøûÊé•ÁöÑÂπ≥ÂùáÊ±†ÂåñÂíåÊúÄÂ§ßÊ±†ÂåñÁâπÂæÅÂõæ‰∏≠Â≠¶‰π†Á©∫Èó¥Ê≥®ÊÑèÂäõÊùÉÈáç</span>
</span><span id="__span-3-32"><a id="__codelineno-3-32" name="__codelineno-3-32" href="#__codelineno-3-32"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">conv1</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Conv2d</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">kernel_size</span><span class="p">,</span> <span class="n">padding</span><span class="o">=</span><span class="n">padding</span><span class="p">,</span> <span class="n">bias</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>  
</span><span id="__span-3-33"><a id="__codelineno-3-33" name="__codelineno-3-33" href="#__codelineno-3-33"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">sigmoid</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Sigmoid</span><span class="p">()</span>  <span class="c1"># SigmoidÂáΩÊï∞ÁîüÊàêÊúÄÁªàÁöÑÊ≥®ÊÑèÂäõÊùÉÈáç</span>
</span><span id="__span-3-34"><a id="__codelineno-3-34" name="__codelineno-3-34" href="#__codelineno-3-34"></a>
</span><span id="__span-3-35"><a id="__codelineno-3-35" name="__codelineno-3-35" href="#__codelineno-3-35"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
</span><span id="__span-3-36"><a id="__codelineno-3-36" name="__codelineno-3-36" href="#__codelineno-3-36"></a>        <span class="n">avg_out</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">keepdim</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>  <span class="c1"># ÂØπËæìÂÖ•ÁâπÂæÅÂõæÊâßË°åÂπ≥ÂùáÊ±†Âåñ</span>
</span><span id="__span-3-37"><a id="__codelineno-3-37" name="__codelineno-3-37" href="#__codelineno-3-37"></a>        <span class="n">max_out</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">keepdim</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>  <span class="c1"># ÂØπËæìÂÖ•ÁâπÂæÅÂõæÊâßË°åÊúÄÂ§ßÊ±†Âåñ</span>
</span><span id="__span-3-38"><a id="__codelineno-3-38" name="__codelineno-3-38" href="#__codelineno-3-38"></a>        <span class="n">x</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">([</span><span class="n">avg_out</span><span class="p">,</span> <span class="n">max_out</span><span class="p">],</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>  <span class="c1"># Â∞Ü‰∏§ÁßçÊ±†ÂåñÁöÑÁâπÂæÅÂõæËøûÊé•Ëµ∑Êù•</span>
</span><span id="__span-3-39"><a id="__codelineno-3-39" name="__codelineno-3-39" href="#__codelineno-3-39"></a>        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">conv1</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>  <span class="c1"># ÈÄöËøáÂç∑ÁßØÂ±ÇÂ§ÑÁêÜËøûÊé•ÂêéÁöÑÁâπÂæÅÂõæ</span>
</span><span id="__span-3-40"><a id="__codelineno-3-40" name="__codelineno-3-40" href="#__codelineno-3-40"></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">sigmoid</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>  <span class="c1"># ‰ΩøÁî®sigmoidÊøÄÊ¥ªÂáΩÊï∞ËÆ°ÁÆóÊ≥®ÊÑèÂäõÊùÉÈáç</span>
</span><span id="__span-3-41"><a id="__codelineno-3-41" name="__codelineno-3-41" href="#__codelineno-3-41"></a>
</span><span id="__span-3-42"><a id="__codelineno-3-42" name="__codelineno-3-42" href="#__codelineno-3-42"></a><span class="c1"># CBAMÊ®°Âùó</span>
</span><span id="__span-3-43"><a id="__codelineno-3-43" name="__codelineno-3-43" href="#__codelineno-3-43"></a><span class="k">class</span><span class="w"> </span><span class="nc">CBAM</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
</span><span id="__span-3-44"><a id="__codelineno-3-44" name="__codelineno-3-44" href="#__codelineno-3-44"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">in_planes</span><span class="p">,</span> <span class="n">ratio</span><span class="o">=</span><span class="mi">16</span><span class="p">,</span> <span class="n">kernel_size</span><span class="o">=</span><span class="mi">7</span><span class="p">):</span>
</span><span id="__span-3-45"><a id="__codelineno-3-45" name="__codelineno-3-45" href="#__codelineno-3-45"></a>        <span class="nb">super</span><span class="p">(</span><span class="n">CBAM</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
</span><span id="__span-3-46"><a id="__codelineno-3-46" name="__codelineno-3-46" href="#__codelineno-3-46"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">ca</span> <span class="o">=</span> <span class="n">ChannelAttention</span><span class="p">(</span><span class="n">in_planes</span><span class="p">,</span> <span class="n">ratio</span><span class="p">)</span>  <span class="c1"># ÈÄöÈÅìÊ≥®ÊÑèÂäõÂÆû‰æã</span>
</span><span id="__span-3-47"><a id="__codelineno-3-47" name="__codelineno-3-47" href="#__codelineno-3-47"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">sa</span> <span class="o">=</span> <span class="n">SpatialAttention</span><span class="p">(</span><span class="n">kernel_size</span><span class="p">)</span>  <span class="c1"># Á©∫Èó¥Ê≥®ÊÑèÂäõÂÆû‰æã</span>
</span><span id="__span-3-48"><a id="__codelineno-3-48" name="__codelineno-3-48" href="#__codelineno-3-48"></a>
</span><span id="__span-3-49"><a id="__codelineno-3-49" name="__codelineno-3-49" href="#__codelineno-3-49"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
</span><span id="__span-3-50"><a id="__codelineno-3-50" name="__codelineno-3-50" href="#__codelineno-3-50"></a>        <span class="n">out</span> <span class="o">=</span> <span class="n">x</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">ca</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>  <span class="c1"># ‰ΩøÁî®ÈÄöÈÅìÊ≥®ÊÑèÂäõÂä†ÊùÉËæìÂÖ•ÁâπÂæÅÂõæ</span>
</span><span id="__span-3-51"><a id="__codelineno-3-51" name="__codelineno-3-51" href="#__codelineno-3-51"></a>        <span class="n">result</span> <span class="o">=</span> <span class="n">out</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">sa</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>  <span class="c1"># ‰ΩøÁî®Á©∫Èó¥Ê≥®ÊÑèÂäõËøõ‰∏ÄÊ≠•Âä†ÊùÉÁâπÂæÅÂõæ</span>
</span><span id="__span-3-52"><a id="__codelineno-3-52" name="__codelineno-3-52" href="#__codelineno-3-52"></a>        <span class="k">return</span> <span class="n">result</span>  <span class="c1"># ËøîÂõûÊúÄÁªàÁöÑÁâπÂæÅÂõæ</span>
</span><span id="__span-3-53"><a id="__codelineno-3-53" name="__codelineno-3-53" href="#__codelineno-3-53"></a>
</span><span id="__span-3-54"><a id="__codelineno-3-54" name="__codelineno-3-54" href="#__codelineno-3-54"></a><span class="c1"># Á§∫‰æã‰ΩøÁî®</span>
</span><span id="__span-3-55"><a id="__codelineno-3-55" name="__codelineno-3-55" href="#__codelineno-3-55"></a><span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
</span><span id="__span-3-56"><a id="__codelineno-3-56" name="__codelineno-3-56" href="#__codelineno-3-56"></a>    <span class="n">block</span> <span class="o">=</span> <span class="n">CBAM</span><span class="p">(</span><span class="mi">64</span><span class="p">)</span>  <span class="c1"># ÂàõÂª∫‰∏Ä‰∏™CBAMÊ®°ÂùóÔºåËæìÂÖ•ÈÄöÈÅì‰∏∫64</span>
</span><span id="__span-3-57"><a id="__codelineno-3-57" name="__codelineno-3-57" href="#__codelineno-3-57"></a>    <span class="nb">input</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">64</span><span class="p">,</span> <span class="mi">64</span><span class="p">,</span> <span class="mi">64</span><span class="p">)</span>  <span class="c1"># ÈöèÊú∫ÁîüÊàê‰∏Ä‰∏™ËæìÂÖ•ÁâπÂæÅÂõæ</span>
</span><span id="__span-3-58"><a id="__codelineno-3-58" name="__codelineno-3-58" href="#__codelineno-3-58"></a>    <span class="n">output</span> <span class="o">=</span> <span class="n">block</span><span class="p">(</span><span class="nb">input</span><span class="p">)</span>  <span class="c1"># ÈÄöËøáCBAMÊ®°ÂùóÂ§ÑÁêÜËæìÂÖ•ÁâπÂæÅÂõæ</span>
</span><span id="__span-3-59"><a id="__codelineno-3-59" name="__codelineno-3-59" href="#__codelineno-3-59"></a>    <span class="nb">print</span><span class="p">(</span><span class="nb">input</span><span class="o">.</span><span class="n">size</span><span class="p">(),</span> <span class="n">output</span><span class="o">.</span><span class="n">size</span><span class="p">())</span>  <span class="c1"># ÊâìÂç∞ËæìÂÖ•ÂíåËæìÂá∫ÁöÑ</span>
</span></code></pre></div>
<h2 id="eca">‚àöECA<a class="headerlink" href="#eca" title="Permanent link">&para;</a></h2>
<p>ËÆ∫Êñá„ÄäECA-Net: Efficient Channel Attention for Deep Convolutional Neural Networks„Äã</p>
<p><img alt="image-20250222124459369" src="../images/image-20250222124459369.png" /></p>
<p><img alt="image-20250222124515086" src="../images/image-20250222124515086.png" /></p>
<p><strong>‰ΩúÁî®Ôºö</strong></p>
<p>ECAÊ®°ÂùóÊó®Âú®ÈÄöËøáÂºïÂÖ•‰∏ÄÁßçÈ´òÊïàÁöÑÈÄöÈÅìÊ≥®ÊÑèÂäõÊú∫Âà∂Êù•Â¢ûÂº∫Ê∑±Â∫¶Âç∑ÁßØÁ•ûÁªèÁΩëÁªúÁöÑÁâπÂæÅË°®Á§∫ËÉΩÂäõ„ÄÇÂÆÉÁùÄÈáç‰∫éÊçïËé∑ÈÄöÈÅìÈó¥ÁöÑÂä®ÊÄÅ‰æùËµñÂÖ≥Á≥ªÔºå‰ªéËÄå‰ΩøÁΩëÁªúËÉΩÂ§üÊõ¥Âä†Á≤æÁ°ÆÂú∞ÈáçËßÜÂØπÂΩìÂâç‰ªªÂä°Êõ¥ÈáçË¶ÅÁöÑÁâπÂæÅÔºåÊèêÂçáÊ®°ÂûãÂú®ÂêÑÁßçËßÜËßâ‰ªªÂä°‰∏äÁöÑÊÄßËÉΩ„ÄÇ</p>
<p><strong>Êú∫Âà∂Ôºö</strong></p>
<p>ECAÊ®°ÂùóÁöÑÊ†∏ÂøÉÊú∫Âà∂ÊòØÈÄöËøá‰∏Ä‰∏™ÁÆÄÂçïËÄåÈ´òÊïàÁöÑ**‰∏ÄÁª¥Âç∑ÁßØ**Êù•Ëá™ÈÄÇÂ∫îÂú∞ÊçïÊçâÈÄöÈÅì‰πãÈó¥ÁöÑ‰æùËµñÊÄßÔºåËÄå**Êó†ÈúÄÈôçÁª¥ÂíåÂçáÁª¥**ÁöÑËøáÁ®ã„ÄÇËøôÁßçËÆæËÆ°ÈÅøÂÖç‰∫Ü‰º†ÁªüÊ≥®ÊÑèÂäõÊú∫Âà∂‰∏≠Â§çÊùÇÁöÑÂ§öÂ±ÇÊÑüÁü•Êú∫ÔºàMLPÔºâÁªìÊûÑÔºåÂáèÂ∞ë‰∫ÜÊ®°ÂûãÂ§çÊùÇÂ∫¶ÂíåËÆ°ÁÆóË¥üÊãÖ„ÄÇECAÈÄöËøáËÆ°ÁÆó‰∏Ä‰∏™Ëá™ÈÄÇÂ∫îÁöÑÊ†∏Â§ßÂ∞èÔºåÁõ¥Êé•Âú®ÈÄöÈÅìÁâπÂæÅ‰∏äÂ∫îÁî®‰∏ÄÁª¥Âç∑ÁßØÔºå‰ªéËÄåÂ≠¶‰π†Âà∞ÊØè‰∏™ÈÄöÈÅìÁõ∏ÂØπ‰∫éÂÖ∂‰ªñÈÄöÈÅìÁöÑÈáçË¶ÅÊÄß„ÄÇ</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-4-1"><a id="__codelineno-4-1" name="__codelineno-4-1" href="#__codelineno-4-1"></a><span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
</span><span id="__span-4-2"><a id="__codelineno-4-2" name="__codelineno-4-2" href="#__codelineno-4-2"></a><span class="kn">import</span><span class="w"> </span><span class="nn">torch</span>
</span><span id="__span-4-3"><a id="__codelineno-4-3" name="__codelineno-4-3" href="#__codelineno-4-3"></a><span class="kn">from</span><span class="w"> </span><span class="nn">torch</span><span class="w"> </span><span class="kn">import</span> <span class="n">nn</span>
</span><span id="__span-4-4"><a id="__codelineno-4-4" name="__codelineno-4-4" href="#__codelineno-4-4"></a><span class="kn">from</span><span class="w"> </span><span class="nn">torch.nn</span><span class="w"> </span><span class="kn">import</span> <span class="n">init</span>
</span><span id="__span-4-5"><a id="__codelineno-4-5" name="__codelineno-4-5" href="#__codelineno-4-5"></a><span class="kn">from</span><span class="w"> </span><span class="nn">collections</span><span class="w"> </span><span class="kn">import</span> <span class="n">OrderedDict</span>
</span><span id="__span-4-6"><a id="__codelineno-4-6" name="__codelineno-4-6" href="#__codelineno-4-6"></a>
</span><span id="__span-4-7"><a id="__codelineno-4-7" name="__codelineno-4-7" href="#__codelineno-4-7"></a><span class="s2">&quot;ECA-Net: Efficient Channel Attention for Deep Convolutional Neural Networks&quot;</span>
</span><span id="__span-4-8"><a id="__codelineno-4-8" name="__codelineno-4-8" href="#__codelineno-4-8"></a>
</span><span id="__span-4-9"><a id="__codelineno-4-9" name="__codelineno-4-9" href="#__codelineno-4-9"></a><span class="k">class</span><span class="w"> </span><span class="nc">ECAAttention</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
</span><span id="__span-4-10"><a id="__codelineno-4-10" name="__codelineno-4-10" href="#__codelineno-4-10"></a>
</span><span id="__span-4-11"><a id="__codelineno-4-11" name="__codelineno-4-11" href="#__codelineno-4-11"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">kernel_size</span><span class="o">=</span><span class="mi">3</span><span class="p">):</span>
</span><span id="__span-4-12"><a id="__codelineno-4-12" name="__codelineno-4-12" href="#__codelineno-4-12"></a>        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
</span><span id="__span-4-13"><a id="__codelineno-4-13" name="__codelineno-4-13" href="#__codelineno-4-13"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">gap</span><span class="o">=</span><span class="n">nn</span><span class="o">.</span><span class="n">AdaptiveAvgPool2d</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</span><span id="__span-4-14"><a id="__codelineno-4-14" name="__codelineno-4-14" href="#__codelineno-4-14"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">conv</span><span class="o">=</span><span class="n">nn</span><span class="o">.</span><span class="n">Conv1d</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">kernel_size</span><span class="o">=</span><span class="n">kernel_size</span><span class="p">,</span><span class="n">padding</span><span class="o">=</span><span class="p">(</span><span class="n">kernel_size</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">//</span><span class="mi">2</span><span class="p">)</span>
</span><span id="__span-4-15"><a id="__codelineno-4-15" name="__codelineno-4-15" href="#__codelineno-4-15"></a><span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
</span><span id="__span-4-16"><a id="__codelineno-4-16" name="__codelineno-4-16" href="#__codelineno-4-16"></a><span class="sd">            ÂèÇÊï∞ËØ¥ÊòéÔºö</span>
</span><span id="__span-4-17"><a id="__codelineno-4-17" name="__codelineno-4-17" href="#__codelineno-4-17"></a><span class="sd">            in_channels=1ÔºöËæìÂÖ•ÈÄöÈÅìÊï∞‰∏∫1</span>
</span><span id="__span-4-18"><a id="__codelineno-4-18" name="__codelineno-4-18" href="#__codelineno-4-18"></a><span class="sd">            out_channels=1ÔºöËæìÂá∫ÈÄöÈÅìÊï∞‰∏∫1</span>
</span><span id="__span-4-19"><a id="__codelineno-4-19" name="__codelineno-4-19" href="#__codelineno-4-19"></a><span class="sd">            kernel_size=kernel_sizeÔºöÂç∑ÁßØÊ†∏ÁöÑÂ§ßÂ∞èÔºåËøôÈáåÁî±ÊûÑÈÄ†ÂáΩÊï∞ÁöÑÂèÇÊï∞ kernel_size ÊåáÂÆö</span>
</span><span id="__span-4-20"><a id="__codelineno-4-20" name="__codelineno-4-20" href="#__codelineno-4-20"></a><span class="sd">            padding=(kernel_size-1)//2ÔºöÂ°´ÂÖÖÂ§ßÂ∞èÔºåËøôÈáå‰ΩøÁî®‰∫ÜÂØπÁß∞Â°´ÂÖÖÔºå‰ΩøÂæóÂç∑ÁßØÊìç‰ΩúÂêéËæìÂá∫ÁöÑÈïøÂ∫¶‰∏éËæìÂÖ•ÁöÑÈïøÂ∫¶Áõ∏Âêå</span>
</span><span id="__span-4-21"><a id="__codelineno-4-21" name="__codelineno-4-21" href="#__codelineno-4-21"></a><span class="sd">            ÈóÆÈ¢òÔºö1D Âç∑ÁßØÂíå 2DÂç∑ÁßØÁöÑÂå∫Âà´ÊòØ‰ªÄ‰πàÔºü</span>
</span><span id="__span-4-22"><a id="__codelineno-4-22" name="__codelineno-4-22" href="#__codelineno-4-22"></a><span class="sd">            Á≠îÔºö1D Âç∑ÁßØÂíå 2D Âç∑ÁßØÈÉΩÊúâÈÄöÈÅìÁöÑÊ¶ÇÂøµÔºå‰∏çÂêåÁöÑÊòØÔºå1D Âç∑ÁßØÔºåÂç∑ÁßØÁöÑÊòØÂ∫èÂàóÔºå2D Âç∑ÁßØÂç∑ÁßØÁöÑÂõæ</span>
</span><span id="__span-4-23"><a id="__codelineno-4-23" name="__codelineno-4-23" href="#__codelineno-4-23"></a><span class="sd">            Âå∫Âà´Â∞±ÊòØÂç∑ÁßØÁöÑÂØπË±°‰∏çÂêå</span>
</span><span id="__span-4-24"><a id="__codelineno-4-24" name="__codelineno-4-24" href="#__codelineno-4-24"></a>
</span><span id="__span-4-25"><a id="__codelineno-4-25" name="__codelineno-4-25" href="#__codelineno-4-25"></a><span class="sd">            Ëøô‰∏™ padding = Ôºàkernel_size - 1Ôºâ//2 ‰πüÊòØ‰∏çÂèòÂç∑ÁßØ</span>
</span><span id="__span-4-26"><a id="__codelineno-4-26" name="__codelineno-4-26" href="#__codelineno-4-26"></a><span class="sd">        &#39;&#39;&#39;</span>
</span><span id="__span-4-27"><a id="__codelineno-4-27" name="__codelineno-4-27" href="#__codelineno-4-27"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">sigmoid</span><span class="o">=</span><span class="n">nn</span><span class="o">.</span><span class="n">Sigmoid</span><span class="p">()</span>
</span><span id="__span-4-28"><a id="__codelineno-4-28" name="__codelineno-4-28" href="#__codelineno-4-28"></a>
</span><span id="__span-4-29"><a id="__codelineno-4-29" name="__codelineno-4-29" href="#__codelineno-4-29"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">init_weights</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="__span-4-30"><a id="__codelineno-4-30" name="__codelineno-4-30" href="#__codelineno-4-30"></a>        <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">modules</span><span class="p">():</span>
</span><span id="__span-4-31"><a id="__codelineno-4-31" name="__codelineno-4-31" href="#__codelineno-4-31"></a>            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">nn</span><span class="o">.</span><span class="n">Conv2d</span><span class="p">):</span>
</span><span id="__span-4-32"><a id="__codelineno-4-32" name="__codelineno-4-32" href="#__codelineno-4-32"></a>                <span class="n">init</span><span class="o">.</span><span class="n">kaiming_normal_</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">weight</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;fan_out&#39;</span><span class="p">)</span>
</span><span id="__span-4-33"><a id="__codelineno-4-33" name="__codelineno-4-33" href="#__codelineno-4-33"></a>                <span class="k">if</span> <span class="n">m</span><span class="o">.</span><span class="n">bias</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="__span-4-34"><a id="__codelineno-4-34" name="__codelineno-4-34" href="#__codelineno-4-34"></a>                    <span class="n">init</span><span class="o">.</span><span class="n">constant_</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">bias</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
</span><span id="__span-4-35"><a id="__codelineno-4-35" name="__codelineno-4-35" href="#__codelineno-4-35"></a>            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">nn</span><span class="o">.</span><span class="n">BatchNorm2d</span><span class="p">):</span>
</span><span id="__span-4-36"><a id="__codelineno-4-36" name="__codelineno-4-36" href="#__codelineno-4-36"></a>                <span class="n">init</span><span class="o">.</span><span class="n">constant_</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">weight</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
</span><span id="__span-4-37"><a id="__codelineno-4-37" name="__codelineno-4-37" href="#__codelineno-4-37"></a>                <span class="n">init</span><span class="o">.</span><span class="n">constant_</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">bias</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
</span><span id="__span-4-38"><a id="__codelineno-4-38" name="__codelineno-4-38" href="#__codelineno-4-38"></a>            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">):</span>
</span><span id="__span-4-39"><a id="__codelineno-4-39" name="__codelineno-4-39" href="#__codelineno-4-39"></a>                <span class="n">init</span><span class="o">.</span><span class="n">normal_</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">weight</span><span class="p">,</span> <span class="n">std</span><span class="o">=</span><span class="mf">0.001</span><span class="p">)</span>
</span><span id="__span-4-40"><a id="__codelineno-4-40" name="__codelineno-4-40" href="#__codelineno-4-40"></a>                <span class="k">if</span> <span class="n">m</span><span class="o">.</span><span class="n">bias</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="__span-4-41"><a id="__codelineno-4-41" name="__codelineno-4-41" href="#__codelineno-4-41"></a>                    <span class="n">init</span><span class="o">.</span><span class="n">constant_</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">bias</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
</span><span id="__span-4-42"><a id="__codelineno-4-42" name="__codelineno-4-42" href="#__codelineno-4-42"></a>
</span><span id="__span-4-43"><a id="__codelineno-4-43" name="__codelineno-4-43" href="#__codelineno-4-43"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
</span><span id="__span-4-44"><a id="__codelineno-4-44" name="__codelineno-4-44" href="#__codelineno-4-44"></a>        <span class="n">y</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">gap</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>  <span class="c1"># Âú®Á©∫Èó¥ÊñπÂêëÊâßË°åÂÖ®Â±ÄÂπ≥ÂùáÊ±†Âåñ: (B,C,H,W)--&gt;(B,C,1,1)</span>
</span><span id="__span-4-45"><a id="__codelineno-4-45" name="__codelineno-4-45" href="#__codelineno-4-45"></a>        <span class="n">y</span><span class="o">=</span><span class="n">y</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">permute</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>  <span class="c1"># Â∞ÜÈÄöÈÅìÊèèËø∞Á¨¶ÂéªÊéâ‰∏ÄÁª¥,‰æø‰∫éÂú®ÈÄöÈÅì‰∏äÊâßË°åÂç∑ÁßØÊìç‰Ωú:(B,C,1,1)--&gt;(B,C,1)--&gt;(B,1,C)</span>
</span><span id="__span-4-46"><a id="__codelineno-4-46" name="__codelineno-4-46" href="#__codelineno-4-46"></a>        <span class="n">y</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">conv</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>  <span class="c1"># Âú®ÈÄöÈÅìÁª¥Â∫¶‰∏äÊâßË°å1DÂç∑ÁßØÊìç‰Ωú,Âª∫Ê®°Â±ÄÈÉ®ÈÄöÈÅì‰πãÈó¥ÁöÑÁõ∏ÂÖ≥ÊÄß: (B,1,C)--&gt;(B,1,C) 1: Ë°®Á§∫ÂçïÈÄöÈÅìÔºåC : Ë°®Á§∫ÊØè‰∏™ÈÄöÈÅì C ‰∏™ÂÖÉÁ¥†</span>
</span><span id="__span-4-47"><a id="__codelineno-4-47" name="__codelineno-4-47" href="#__codelineno-4-47"></a>        <span class="n">y</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">sigmoid</span><span class="p">(</span><span class="n">y</span><span class="p">)</span> <span class="c1"># ÁîüÊàêÊùÉÈáçË°®Á§∫: (B,1,C) ÂØπÊâÄÊúâÂÖÉÁ¥† sigmoidÔºåÂõ†‰∏∫ sigmoid ÁîüÊàêÁöÑÊòØÁªùÂØπÊùÉÈáç</span>
</span><span id="__span-4-48"><a id="__codelineno-4-48" name="__codelineno-4-48" href="#__codelineno-4-48"></a>        <span class="n">y</span><span class="o">=</span><span class="n">y</span><span class="o">.</span><span class="n">permute</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>  <span class="c1"># ÈáçÂ°ëshape: (B,1,C)--&gt;(B,C,1)--&gt;(B,C,1,1)</span>
</span><span id="__span-4-49"><a id="__codelineno-4-49" name="__codelineno-4-49" href="#__codelineno-4-49"></a>        <span class="k">return</span> <span class="n">x</span><span class="o">*</span><span class="n">y</span><span class="o">.</span><span class="n">expand_as</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>  <span class="c1"># ÊùÉÈáçÂØπËæìÂÖ•ÁöÑÈÄöÈÅìËøõË°åÈáçÊñ∞Âä†ÊùÉ: (B,C,H,W) * (B,C,1,1) = (B,C,H,W)</span>
</span><span id="__span-4-50"><a id="__codelineno-4-50" name="__codelineno-4-50" href="#__codelineno-4-50"></a>
</span><span id="__span-4-51"><a id="__codelineno-4-51" name="__codelineno-4-51" href="#__codelineno-4-51"></a>
</span><span id="__span-4-52"><a id="__codelineno-4-52" name="__codelineno-4-52" href="#__codelineno-4-52"></a>
</span><span id="__span-4-53"><a id="__codelineno-4-53" name="__codelineno-4-53" href="#__codelineno-4-53"></a>
</span><span id="__span-4-54"><a id="__codelineno-4-54" name="__codelineno-4-54" href="#__codelineno-4-54"></a><span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
</span><span id="__span-4-55"><a id="__codelineno-4-55" name="__codelineno-4-55" href="#__codelineno-4-55"></a>    <span class="c1"># (B, C, H, W)</span>
</span><span id="__span-4-56"><a id="__codelineno-4-56" name="__codelineno-4-56" href="#__codelineno-4-56"></a>    <span class="nb">input</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">512</span><span class="p">,</span><span class="mi">7</span><span class="p">,</span><span class="mi">7</span><span class="p">)</span>
</span><span id="__span-4-57"><a id="__codelineno-4-57" name="__codelineno-4-57" href="#__codelineno-4-57"></a>    <span class="n">Model</span> <span class="o">=</span> <span class="n">ECAAttention</span><span class="p">(</span><span class="n">kernel_size</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
</span><span id="__span-4-58"><a id="__codelineno-4-58" name="__codelineno-4-58" href="#__codelineno-4-58"></a>    <span class="n">output</span><span class="o">=</span><span class="n">Model</span><span class="p">(</span><span class="nb">input</span><span class="p">)</span>
</span><span id="__span-4-59"><a id="__codelineno-4-59" name="__codelineno-4-59" href="#__codelineno-4-59"></a>    <span class="nb">print</span><span class="p">(</span><span class="n">output</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
</span></code></pre></div>
<p><strong>‰ºòÂäøÔºö</strong></p>
<p>1„ÄÅ<strong>Êó†ÈúÄÈôçÁª¥ÂçáÁª¥</strong>Ôºö</p>
<p>‰∏é‰º†ÁªüÁöÑÊ≥®ÊÑèÂäõÊú∫Âà∂Áõ∏ÊØîÔºåECAÊ®°ÂùóÊó†ÈúÄËøõË°åÈôçÁª¥ÂíåÂçáÁª¥ÁöÑÊìç‰ΩúÔºåËøôÊ†∑‰∏ç‰ªÖ‰øùÁïô‰∫ÜÂéüÂßãÈÄöÈÅìÁâπÂæÅÁöÑ‰ø°ÊÅØÂÆåÊï¥ÊÄßÔºåËøòËøõ‰∏ÄÊ≠•ÂáèÂ∞ë‰∫ÜÊ®°ÂûãÂ§çÊùÇÂ∫¶„ÄÇ</p>
<p>„ÄÅ<strong>Ëá™ÈÄÇÂ∫îÊ†∏Â§ßÂ∞è</strong>Ôºö</p>
<p>ECAÊ®°ÂùóÊ†πÊçÆÈÄöÈÅìÊï∞Ëá™ÈÄÇÂ∫îÂú∞Ë∞ÉÊï¥‰∏ÄÁª¥Âç∑ÁßØÁöÑÊ†∏Â§ßÂ∞èÔºå‰ΩøÂÖ∂ËÉΩÂ§üÁÅµÊ¥ªÂú∞ÊçïÊçâ‰∏çÂêåËåÉÂõ¥ÂÜÖÁöÑÈÄöÈÅì‰æùËµñÊÄßÔºåËøôÁßçËá™ÈÄÇÂ∫îÊú∫Âà∂‰ΩøÂæóECAÂú®‰∏çÂêåËßÑÊ®°ÁöÑÁΩëÁªúÂíå‰∏çÂêåÊ∑±Â∫¶ÁöÑÂ±ÇÊ¨°‰∏≠ÈÉΩËÉΩÊúâÊïàÂ∑•‰Ωú„ÄÇ</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-5-1"><a id="__codelineno-5-1" name="__codelineno-5-1" href="#__codelineno-5-1"></a><span class="kn">import</span><span class="w"> </span><span class="nn">torch</span>
</span><span id="__span-5-2"><a id="__codelineno-5-2" name="__codelineno-5-2" href="#__codelineno-5-2"></a><span class="kn">from</span><span class="w"> </span><span class="nn">torch</span><span class="w"> </span><span class="kn">import</span> <span class="n">nn</span>
</span><span id="__span-5-3"><a id="__codelineno-5-3" name="__codelineno-5-3" href="#__codelineno-5-3"></a><span class="kn">from</span><span class="w"> </span><span class="nn">torch.nn</span><span class="w"> </span><span class="kn">import</span> <span class="n">init</span>
</span><span id="__span-5-4"><a id="__codelineno-5-4" name="__codelineno-5-4" href="#__codelineno-5-4"></a>
</span><span id="__span-5-5"><a id="__codelineno-5-5" name="__codelineno-5-5" href="#__codelineno-5-5"></a><span class="c1"># ÂÆö‰πâECAÊ≥®ÊÑèÂäõÊ®°ÂùóÁöÑÁ±ª</span>
</span><span id="__span-5-6"><a id="__codelineno-5-6" name="__codelineno-5-6" href="#__codelineno-5-6"></a><span class="k">class</span><span class="w"> </span><span class="nc">ECAAttention</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
</span><span id="__span-5-7"><a id="__codelineno-5-7" name="__codelineno-5-7" href="#__codelineno-5-7"></a>
</span><span id="__span-5-8"><a id="__codelineno-5-8" name="__codelineno-5-8" href="#__codelineno-5-8"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">kernel_size</span><span class="o">=</span><span class="mi">3</span><span class="p">):</span>
</span><span id="__span-5-9"><a id="__codelineno-5-9" name="__codelineno-5-9" href="#__codelineno-5-9"></a>        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
</span><span id="__span-5-10"><a id="__codelineno-5-10" name="__codelineno-5-10" href="#__codelineno-5-10"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">gap</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">AdaptiveAvgPool2d</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>  <span class="c1"># ÂÆö‰πâÂÖ®Â±ÄÂπ≥ÂùáÊ±†ÂåñÂ±ÇÔºåÂ∞ÜÁ©∫Èó¥Áª¥Â∫¶ÂéãÁº©‰∏∫1x1</span>
</span><span id="__span-5-11"><a id="__codelineno-5-11" name="__codelineno-5-11" href="#__codelineno-5-11"></a>        <span class="c1"># ÂÆö‰πâ‰∏Ä‰∏™1DÂç∑ÁßØÔºåÁî®‰∫éÂ§ÑÁêÜÈÄöÈÅìÈó¥ÁöÑÂÖ≥Á≥ªÔºåÊ†∏Â§ßÂ∞èÂèØË∞ÉÔºåpadding‰øùËØÅËæìÂá∫ÈÄöÈÅìÊï∞‰∏çÂèò</span>
</span><span id="__span-5-12"><a id="__codelineno-5-12" name="__codelineno-5-12" href="#__codelineno-5-12"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">conv</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Conv1d</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">kernel_size</span><span class="o">=</span><span class="n">kernel_size</span><span class="p">,</span> <span class="n">padding</span><span class="o">=</span><span class="p">(</span><span class="n">kernel_size</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">//</span> <span class="mi">2</span><span class="p">)</span>
</span><span id="__span-5-13"><a id="__codelineno-5-13" name="__codelineno-5-13" href="#__codelineno-5-13"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">sigmoid</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Sigmoid</span><span class="p">()</span>  <span class="c1"># SigmoidÂáΩÊï∞ÔºåÁî®‰∫éÊøÄÊ¥ªÊúÄÁªàÁöÑÊ≥®ÊÑèÂäõÊùÉÈáç</span>
</span><span id="__span-5-14"><a id="__codelineno-5-14" name="__codelineno-5-14" href="#__codelineno-5-14"></a>
</span><span id="__span-5-15"><a id="__codelineno-5-15" name="__codelineno-5-15" href="#__codelineno-5-15"></a>    <span class="c1"># ÊùÉÈáçÂàùÂßãÂåñÊñπÊ≥ï</span>
</span><span id="__span-5-16"><a id="__codelineno-5-16" name="__codelineno-5-16" href="#__codelineno-5-16"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">init_weights</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="__span-5-17"><a id="__codelineno-5-17" name="__codelineno-5-17" href="#__codelineno-5-17"></a>        <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">modules</span><span class="p">():</span>
</span><span id="__span-5-18"><a id="__codelineno-5-18" name="__codelineno-5-18" href="#__codelineno-5-18"></a>            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">nn</span><span class="o">.</span><span class="n">Conv2d</span><span class="p">):</span>
</span><span id="__span-5-19"><a id="__codelineno-5-19" name="__codelineno-5-19" href="#__codelineno-5-19"></a>                <span class="n">init</span><span class="o">.</span><span class="n">kaiming_normal_</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">weight</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;fan_out&#39;</span><span class="p">)</span>  <span class="c1"># ÂØπConv2dÂ±Ç‰ΩøÁî®KaimingÂàùÂßãÂåñ</span>
</span><span id="__span-5-20"><a id="__codelineno-5-20" name="__codelineno-5-20" href="#__codelineno-5-20"></a>                <span class="k">if</span> <span class="n">m</span><span class="o">.</span><span class="n">bias</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="__span-5-21"><a id="__codelineno-5-21" name="__codelineno-5-21" href="#__codelineno-5-21"></a>                    <span class="n">init</span><span class="o">.</span><span class="n">constant_</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">bias</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>  <span class="c1"># Â¶ÇÊûúÊúâÂÅèÁΩÆÈ°πÔºåÂàôÂàùÂßãÂåñ‰∏∫0</span>
</span><span id="__span-5-22"><a id="__codelineno-5-22" name="__codelineno-5-22" href="#__codelineno-5-22"></a>            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">nn</span><span class="o">.</span><span class="n">BatchNorm2d</span><span class="p">):</span>
</span><span id="__span-5-23"><a id="__codelineno-5-23" name="__codelineno-5-23" href="#__codelineno-5-23"></a>                <span class="n">init</span><span class="o">.</span><span class="n">constant_</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">weight</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>  <span class="c1"># ÊâπÂΩí‰∏ÄÂåñÂ±ÇÊùÉÈáçÂàùÂßãÂåñ‰∏∫1</span>
</span><span id="__span-5-24"><a id="__codelineno-5-24" name="__codelineno-5-24" href="#__codelineno-5-24"></a>                <span class="n">init</span><span class="o">.</span><span class="n">constant_</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">bias</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>  <span class="c1"># ÊâπÂΩí‰∏ÄÂåñÂ±ÇÂÅèÁΩÆÂàùÂßãÂåñ‰∏∫0</span>
</span><span id="__span-5-25"><a id="__codelineno-5-25" name="__codelineno-5-25" href="#__codelineno-5-25"></a>            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">):</span>
</span><span id="__span-5-26"><a id="__codelineno-5-26" name="__codelineno-5-26" href="#__codelineno-5-26"></a>                <span class="n">init</span><span class="o">.</span><span class="n">normal_</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">weight</span><span class="p">,</span> <span class="n">std</span><span class="o">=</span><span class="mf">0.001</span><span class="p">)</span>  <span class="c1"># ÂÖ®ËøûÊé•Â±ÇÊùÉÈáç‰ΩøÁî®Ê≠£ÊÄÅÂàÜÂ∏ÉÂàùÂßãÂåñ</span>
</span><span id="__span-5-27"><a id="__codelineno-5-27" name="__codelineno-5-27" href="#__codelineno-5-27"></a>                <span class="k">if</span> <span class="n">m</span><span class="o">.</span><span class="n">bias</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="__span-5-28"><a id="__codelineno-5-28" name="__codelineno-5-28" href="#__codelineno-5-28"></a>                    <span class="n">init</span><span class="o">.</span><span class="n">constant_</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">bias</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>  <span class="c1"># ÂÖ®ËøûÊé•Â±ÇÂÅèÁΩÆÂàùÂßãÂåñ‰∏∫0</span>
</span><span id="__span-5-29"><a id="__codelineno-5-29" name="__codelineno-5-29" href="#__codelineno-5-29"></a>
</span><span id="__span-5-30"><a id="__codelineno-5-30" name="__codelineno-5-30" href="#__codelineno-5-30"></a>    <span class="c1"># ÂâçÂêë‰º†Êí≠ÊñπÊ≥ï</span>
</span><span id="__span-5-31"><a id="__codelineno-5-31" name="__codelineno-5-31" href="#__codelineno-5-31"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
</span><span id="__span-5-32"><a id="__codelineno-5-32" name="__codelineno-5-32" href="#__codelineno-5-32"></a>        <span class="n">y</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">gap</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>  <span class="c1"># ÂØπËæìÂÖ•xÂ∫îÁî®ÂÖ®Â±ÄÂπ≥ÂùáÊ±†ÂåñÔºåÂæóÂà∞bs,c,1,1Áª¥Â∫¶ÁöÑËæìÂá∫</span>
</span><span id="__span-5-33"><a id="__codelineno-5-33" name="__codelineno-5-33" href="#__codelineno-5-33"></a>        <span class="n">y</span> <span class="o">=</span> <span class="n">y</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">permute</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>  <span class="c1"># ÁßªÈô§ÊúÄÂêé‰∏Ä‰∏™Áª¥Â∫¶Âπ∂ËΩ¨ÁΩÆÔºå‰∏∫1DÂç∑ÁßØÂáÜÂ§áÔºåÂèò‰∏∫bs,1,c</span>
</span><span id="__span-5-34"><a id="__codelineno-5-34" name="__codelineno-5-34" href="#__codelineno-5-34"></a>        <span class="n">y</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">conv</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>  <span class="c1"># ÂØπËΩ¨ÁΩÆÂêéÁöÑyÂ∫îÁî®1DÂç∑ÁßØÔºåÂæóÂà∞bs,1,cÁª¥Â∫¶ÁöÑËæìÂá∫</span>
</span><span id="__span-5-35"><a id="__codelineno-5-35" name="__codelineno-5-35" href="#__codelineno-5-35"></a>        <span class="n">y</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sigmoid</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>  <span class="c1"># Â∫îÁî®SigmoidÂáΩÊï∞ÊøÄÊ¥ªÔºåÂæóÂà∞ÊúÄÁªàÁöÑÊ≥®ÊÑèÂäõÊùÉÈáç</span>
</span><span id="__span-5-36"><a id="__codelineno-5-36" name="__codelineno-5-36" href="#__codelineno-5-36"></a>        <span class="n">y</span> <span class="o">=</span> <span class="n">y</span><span class="o">.</span><span class="n">permute</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>  <span class="c1"># ÂÜçÊ¨°ËΩ¨ÁΩÆÂπ∂Â¢ûÂä†‰∏Ä‰∏™Áª¥Â∫¶Ôºå‰ª•ÂåπÈÖçÂéüÂßãËæìÂÖ•xÁöÑÁª¥Â∫¶</span>
</span><span id="__span-5-37"><a id="__codelineno-5-37" name="__codelineno-5-37" href="#__codelineno-5-37"></a>        <span class="k">return</span> <span class="n">x</span> <span class="o">*</span> <span class="n">y</span><span class="o">.</span><span class="n">expand_as</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>  <span class="c1"># Â∞ÜÊ≥®ÊÑèÂäõÊùÉÈáçÂ∫îÁî®Âà∞ÂéüÂßãËæìÂÖ•x‰∏äÔºåÈÄöËøáÂπøÊí≠Êú∫Âà∂Êâ©Â±ïÁª¥Â∫¶Âπ∂ÊâßË°åÈÄêÂÖÉÁ¥†‰πòÊ≥ï</span>
</span><span id="__span-5-38"><a id="__codelineno-5-38" name="__codelineno-5-38" href="#__codelineno-5-38"></a>
</span><span id="__span-5-39"><a id="__codelineno-5-39" name="__codelineno-5-39" href="#__codelineno-5-39"></a><span class="c1"># Á§∫‰æã‰ΩøÁî®</span>
</span><span id="__span-5-40"><a id="__codelineno-5-40" name="__codelineno-5-40" href="#__codelineno-5-40"></a><span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
</span><span id="__span-5-41"><a id="__codelineno-5-41" name="__codelineno-5-41" href="#__codelineno-5-41"></a>    <span class="n">block</span> <span class="o">=</span> <span class="n">ECAAttention</span><span class="p">(</span><span class="n">kernel_size</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>  <span class="c1"># ÂÆû‰æãÂåñECAÊ≥®ÊÑèÂäõÊ®°ÂùóÔºåÊåáÂÆöÊ†∏Â§ßÂ∞è‰∏∫3</span>
</span><span id="__span-5-42"><a id="__codelineno-5-42" name="__codelineno-5-42" href="#__codelineno-5-42"></a>    <span class="nb">input</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">64</span><span class="p">,</span> <span class="mi">64</span><span class="p">,</span> <span class="mi">64</span><span class="p">)</span>  <span class="c1"># ÁîüÊàê‰∏Ä‰∏™ÈöèÊú∫ËæìÂÖ•</span>
</span><span id="__span-5-43"><a id="__codelineno-5-43" name="__codelineno-5-43" href="#__codelineno-5-43"></a>    <span class="n">output</span> <span class="o">=</span> <span class="n">block</span><span class="p">(</span><span class="nb">input</span><span class="p">)</span>  <span class="c1"># Â∞ÜËæìÂÖ•ÈÄöËøáECAÊ®°ÂùóÂ§ÑÁêÜ</span>
</span><span id="__span-5-44"><a id="__codelineno-5-44" name="__codelineno-5-44" href="#__codelineno-5-44"></a>    <span class="nb">print</span><span class="p">(</span><span class="nb">input</span><span class="o">.</span><span class="n">size</span><span class="p">(),</span> <span class="n">output</span><span class="o">.</span><span class="n">size</span><span class="p">())</span>  <span class="c1"># ÊâìÂç∞ËæìÂÖ•ÂíåËæìÂá∫ÁöÑÂ∞∫ÂØ∏ÔºåÈ™åËØÅECAÊ®°ÂùóÁöÑ‰ΩúÁî®</span>
</span></code></pre></div>
<h2 id="coordinate-attention">‚àö Coordinate Attention<a class="headerlink" href="#coordinate-attention" title="Permanent link">&para;</a></h2>
<p>ËÆ∫Êñá„ÄäCoordinate Attention for Efficient Mobile Network Design„Äã</p>
<p><img alt="image-20250222170038241" src="../images/image-20250222170038241.png" /></p>
<p><img alt="image-20250222170042846" src="../images/image-20250222170042846.png" /></p>
<ul>
<li>Coordinate AttentionÊèêÂá∫‰∫Ü‰∏ÄÁßçÊñ∞ÁöÑÊ≥®ÊÑèÂäõÊú∫Âà∂ÔºåÁî®‰∫éÂú®ÁßªÂä®ÁΩëÁªú‰∏≠ÂµåÂÖ•‰ΩçÁΩÆ‰ø°ÊÅØÂà∞ÈÄöÈÅìÊ≥®ÊÑèÂäõ‰∏≠„ÄÇËøôÁßçÊñπÊ≥ï‰∏ç‰ªÖÂÖ≥Ê≥®‚ÄúÂì™‰∫õÈÄöÈÅìÊòØÈáçË¶ÅÁöÑ‚ÄùÔºåËÄå‰∏îÂÖ≥Ê≥®‚ÄúÂú®Âì™Èáå‚ÄùÂÖ≥Ê≥®ÔºåÈÄöËøáÊõ¥Á≤æÁªÜÂú∞ÊéßÂà∂Á©∫Èó¥ÈÄâÊã©ÊÄßÊ≥®ÊÑèÂäõÂõæÁöÑÁîüÊàêÔºåËøõ‰∏ÄÊ≠•ÊèêÂçáÊ®°ÂûãÊÄßËÉΩ„ÄÇ</li>
</ul>
<p><strong>Êú∫Âà∂Ôºö</strong></p>
<p>1„ÄÅ<strong>ÂùêÊ†á‰ø°ÊÅØÂµåÂÖ•</strong>Ôºö</p>
<p>‰∏é‰º†ÁªüÁöÑÈÄöÈÅìÊ≥®ÊÑèÂäõÈÄöËøá2DÂÖ®Â±ÄÊ±†ÂåñÂ∞ÜÁâπÂæÅÂº†ÈáèËΩ¨Êç¢‰∏∫Âçï‰∏ÄÁâπÂæÅÂêëÈáè‰∏çÂêåÔºåCoordinate AttentionÂ∞ÜÈÄöÈÅìÊ≥®ÊÑèÂäõÂàÜËß£‰∏∫‰∏§‰∏™1DÁâπÂæÅÁºñÁ†ÅËøáÁ®ãÔºåÂàÜÂà´Ê≤ø‰∏§‰∏™Á©∫Èó¥ÊñπÂêëËÅöÂêàÁâπÂæÅ„ÄÇËøôÁßçÊñπÊ≥ïËÉΩÂ§üÊçïÊçâÊ≤ø‰∏Ä‰∏™Á©∫Èó¥ÊñπÂêëÁöÑÈïøÁ®ã‰æùËµñÊÄßÔºåÂêåÊó∂‰øùÁïôÊ≤øÂè¶‰∏Ä‰∏™Á©∫Èó¥ÊñπÂêëÁöÑÁ≤æÁ°Æ‰ΩçÁΩÆ‰ø°ÊÅØ„ÄÇ</p>
<p>2„ÄÅ<strong>ÂùêÊ†áÊ≥®ÊÑèÂäõÁîüÊàê</strong>Ôºö</p>
<p>Â∞ÜÊ≤øÂûÇÁõ¥ÂíåÊ∞¥Âπ≥ÊñπÂêëËÅöÂêàÁöÑÁâπÂæÅÂõæÁºñÁ†ÅÊàê‰∏ÄÂØπÊñπÂêëÊÑüÁü•Âíå‰ΩçÁΩÆÊïèÊÑüÁöÑÊ≥®ÊÑèÂäõÂõæÔºåËøô‰∏§‰∏™Ê≥®ÊÑèÂäõÂõæË¢´‰∫íË°•Âú∞Â∫îÁî®Âà∞ËæìÂÖ•ÁâπÂæÅÂõæ‰∏äÔºåÂ¢ûÂº∫‰∫ÜÂØπÂÖ¥Ë∂£ÂØπË±°ÁöÑË°®Á§∫„ÄÇ</p>
<p><strong>‰ºòÂäøÔºö</strong> </p>
<p>1„ÄÅ<strong>ÊñπÂêëÊÑüÁü•Âíå‰ΩçÁΩÆÊïèÊÑü</strong>Ôºö</p>
<p>Coordinate AttentionÈÄöËøáÁîüÊàêÊñπÂêëÊÑüÁü•Âíå‰ΩçÁΩÆÊïèÊÑüÁöÑÊ≥®ÊÑèÂäõÂõæÔºå‰ΩøÊ®°ÂûãËÉΩÂ§üÊõ¥ÂáÜÁ°ÆÂú∞ÂÆö‰ΩçÂíåËØÜÂà´ÂÖ¥Ë∂£ÂØπË±°„ÄÇËøôÁßçÊ≥®ÊÑèÂäõÂõæËÉΩÂ§üÁ≤æÁ°ÆÂú∞È´ò‰∫ÆÂÖ¥Ë∂£Âå∫ÂüüÔºåÊèêÂçá‰∫ÜÊ®°ÂûãÂØπÁ©∫Èó¥ÁªìÊûÑÁöÑÁêÜËß£ËÉΩÂäõ„ÄÇ</p>
<p>2„ÄÅ<strong>ÁÅµÊ¥ªÊÄßÂíåËΩªÈáèÁ∫ß</strong>Ôºö</p>
<p>Coordinate AttentionÁöÑËÆæËÆ°ÁÆÄÊ¥ÅËÄåÈ´òÊïàÔºåÂèØ‰ª•ËΩªÊùæÂµåÂÖ•Âà∞ÁªèÂÖ∏ÁöÑÁßªÂä®ÁΩëÁªúÁªìÊûÑ‰∏≠ÔºåÂ¶ÇMobileNetV2„ÄÅMobileNeXtÂíåEfficientNetÔºåÂá†‰πé‰∏çÂ¢ûÂä†ËÆ°ÁÆóÂºÄÈîÄÔºåÈÄÇÁî®‰∫éËÆ°ÁÆóËµÑÊ∫êÂèóÈôêÁöÑÁéØÂ¢É„ÄÇ</p>
<p>3„ÄÅ<strong>Ë∑®‰ªªÂä°ÊÄßËÉΩÊèêÂçá</strong>Ôºö</p>
<p>Coordinate Attention‰∏ç‰ªÖÂú®ImageNetÂàÜÁ±ª‰ªªÂä°‰∏äÊúâÊïàÔºåÊõ¥Âú®‰∏ãÊ∏∏‰ªªÂä°Â¶ÇÂØπË±°Ê£ÄÊµãÂíåËØ≠‰πâÂàÜÂâ≤‰∏äÂ±ïÁé∞Âá∫Êõ¥Â•ΩÁöÑÊÄßËÉΩ„ÄÇËøôËØÅÊòé‰∫ÜÂÖ∂ÂØπ‰∫éÊçïÊçâÂÖ≥ÈîÆ‰ø°ÊÅØÁöÑËÉΩÂäõÔºåÂ∞§ÂÖ∂Âú®ÈúÄË¶ÅÂØÜÈõÜÈ¢ÑÊµãÁöÑ‰ªªÂä°‰∏≠Ë°®Áé∞Âá∫Ëâ≤„ÄÇ</p>
<p><strong>‰ºòË¥®Ê≥®Èáä„Äã</strong> ËÆ∞ÂæóÂ≠¶Â≠¶</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-6-1"><a id="__codelineno-6-1" name="__codelineno-6-1" href="#__codelineno-6-1"></a><span class="kn">import</span><span class="w"> </span><span class="nn">torch</span>
</span><span id="__span-6-2"><a id="__codelineno-6-2" name="__codelineno-6-2" href="#__codelineno-6-2"></a><span class="kn">import</span><span class="w"> </span><span class="nn">torch.nn</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">nn</span>
</span><span id="__span-6-3"><a id="__codelineno-6-3" name="__codelineno-6-3" href="#__codelineno-6-3"></a><span class="kn">import</span><span class="w"> </span><span class="nn">torch.nn.functional</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">F</span>
</span><span id="__span-6-4"><a id="__codelineno-6-4" name="__codelineno-6-4" href="#__codelineno-6-4"></a>
</span><span id="__span-6-5"><a id="__codelineno-6-5" name="__codelineno-6-5" href="#__codelineno-6-5"></a><span class="s2">&quot;Coordinate Attention for Efficient Mobile Network Design&quot;</span>
</span><span id="__span-6-6"><a id="__codelineno-6-6" name="__codelineno-6-6" href="#__codelineno-6-6"></a>
</span><span id="__span-6-7"><a id="__codelineno-6-7" name="__codelineno-6-7" href="#__codelineno-6-7"></a><span class="k">class</span><span class="w"> </span><span class="nc">h_sigmoid</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
</span><span id="__span-6-8"><a id="__codelineno-6-8" name="__codelineno-6-8" href="#__codelineno-6-8"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
</span><span id="__span-6-9"><a id="__codelineno-6-9" name="__codelineno-6-9" href="#__codelineno-6-9"></a>        <span class="nb">super</span><span class="p">(</span><span class="n">h_sigmoid</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
</span><span id="__span-6-10"><a id="__codelineno-6-10" name="__codelineno-6-10" href="#__codelineno-6-10"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">relu</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">ReLU6</span><span class="p">(</span><span class="n">inplace</span><span class="o">=</span><span class="n">inplace</span><span class="p">)</span>
</span><span id="__span-6-11"><a id="__codelineno-6-11" name="__codelineno-6-11" href="#__codelineno-6-11"></a>
</span><span id="__span-6-12"><a id="__codelineno-6-12" name="__codelineno-6-12" href="#__codelineno-6-12"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
</span><span id="__span-6-13"><a id="__codelineno-6-13" name="__codelineno-6-13" href="#__codelineno-6-13"></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">relu</span><span class="p">(</span><span class="n">x</span> <span class="o">+</span> <span class="mi">3</span><span class="p">)</span> <span class="o">/</span> <span class="mi">6</span>
</span><span id="__span-6-14"><a id="__codelineno-6-14" name="__codelineno-6-14" href="#__codelineno-6-14"></a>
</span><span id="__span-6-15"><a id="__codelineno-6-15" name="__codelineno-6-15" href="#__codelineno-6-15"></a><span class="k">class</span><span class="w"> </span><span class="nc">h_swish</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
</span><span id="__span-6-16"><a id="__codelineno-6-16" name="__codelineno-6-16" href="#__codelineno-6-16"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
</span><span id="__span-6-17"><a id="__codelineno-6-17" name="__codelineno-6-17" href="#__codelineno-6-17"></a>        <span class="nb">super</span><span class="p">(</span><span class="n">h_swish</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
</span><span id="__span-6-18"><a id="__codelineno-6-18" name="__codelineno-6-18" href="#__codelineno-6-18"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">sigmoid</span> <span class="o">=</span> <span class="n">h_sigmoid</span><span class="p">(</span><span class="n">inplace</span><span class="o">=</span><span class="n">inplace</span><span class="p">)</span>
</span><span id="__span-6-19"><a id="__codelineno-6-19" name="__codelineno-6-19" href="#__codelineno-6-19"></a>
</span><span id="__span-6-20"><a id="__codelineno-6-20" name="__codelineno-6-20" href="#__codelineno-6-20"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
</span><span id="__span-6-21"><a id="__codelineno-6-21" name="__codelineno-6-21" href="#__codelineno-6-21"></a>        <span class="k">return</span> <span class="n">x</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">sigmoid</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
</span><span id="__span-6-22"><a id="__codelineno-6-22" name="__codelineno-6-22" href="#__codelineno-6-22"></a>
</span><span id="__span-6-23"><a id="__codelineno-6-23" name="__codelineno-6-23" href="#__codelineno-6-23"></a><span class="k">class</span><span class="w"> </span><span class="nc">CoordAtt</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
</span><span id="__span-6-24"><a id="__codelineno-6-24" name="__codelineno-6-24" href="#__codelineno-6-24"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">inp</span><span class="p">,</span> <span class="n">oup</span><span class="p">,</span> <span class="n">reduction</span><span class="o">=</span><span class="mi">32</span><span class="p">):</span>
</span><span id="__span-6-25"><a id="__codelineno-6-25" name="__codelineno-6-25" href="#__codelineno-6-25"></a>        <span class="nb">super</span><span class="p">(</span><span class="n">CoordAtt</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
</span><span id="__span-6-26"><a id="__codelineno-6-26" name="__codelineno-6-26" href="#__codelineno-6-26"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">pool_h</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">AdaptiveAvgPool2d</span><span class="p">((</span><span class="kc">None</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
</span><span id="__span-6-27"><a id="__codelineno-6-27" name="__codelineno-6-27" href="#__codelineno-6-27"></a>
</span><span id="__span-6-28"><a id="__codelineno-6-28" name="__codelineno-6-28" href="#__codelineno-6-28"></a><span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
</span><span id="__span-6-29"><a id="__codelineno-6-29" name="__codelineno-6-29" href="#__codelineno-6-29"></a><span class="sd">            Ëá™ÈÄÇÂ∫îÂπ≥ÂùáÊ±†ÂåñÔºö</span>
</span><span id="__span-6-30"><a id="__codelineno-6-30" name="__codelineno-6-30" href="#__codelineno-6-30"></a><span class="sd">            Ëá™ÈÄÇÂ∫îÂπ≥ÂùáÊ±†Âåñ‰∏çÈúÄË¶ÅÊåáÂÆöÊ±†ÂåñÁ™óÂè£ÁöÑÂ§ßÂ∞èÂíåÊ≠•ÂπÖÔºåËÄåÊòØÁõ¥Êé•ÊåáÂÆöËæìÂá∫ÁöÑÁâπÂæÅÂõæÂ§ßÂ∞è</span>
</span><span id="__span-6-31"><a id="__codelineno-6-31" name="__codelineno-6-31" href="#__codelineno-6-31"></a><span class="sd">            (None, 1)</span>
</span><span id="__span-6-32"><a id="__codelineno-6-32" name="__codelineno-6-32" href="#__codelineno-6-32"></a><span class="sd">            None: Âú®Á¨¨‰∏Ä‰∏™Áª¥Â∫¶ÔºàÈÄöÂ∏∏ÊòØÈ´òÂ∫¶Ôºâ‰∏äÔºåËæìÂá∫ÁöÑÂ∞∫ÂØ∏Â∞ÜËá™Âä®Ë∞ÉÊï¥‰ª•ÂåπÈÖçËæìÂÖ•ÁöÑÈ´òÂ∫¶„ÄÇ‰πüÂ∞±ÊòØËØ¥ÔºåËæìÂÖ•ÁöÑÈ´òÂ∫¶ÊòØÂ§öÂ∞ëÔºåËæìÂá∫ÁöÑÈ´òÂ∫¶Â∞±ÊòØÂ§öÂ∞ë</span>
</span><span id="__span-6-33"><a id="__codelineno-6-33" name="__codelineno-6-33" href="#__codelineno-6-33"></a><span class="sd">            1: Âú®Á¨¨‰∫å‰∏™Áª¥Â∫¶ÔºàÈÄöÂ∏∏ÊòØÂÆΩÂ∫¶Ôºâ‰∏äÔºåËæìÂá∫ÁöÑÂÆΩÂ∫¶Â∞ÜË¢´Ë∞ÉÊï¥‰∏∫ 1„ÄÇ</span>
</span><span id="__span-6-34"><a id="__codelineno-6-34" name="__codelineno-6-34" href="#__codelineno-6-34"></a><span class="sd">            ÁªèËøá nn.AdaptiveAvgPool2d((None, 1)) Êìç‰ΩúÂêéÔºåËæìÂá∫ÁöÑÁâπÂæÅÂõæÂ§ßÂ∞èÂ∞ÜÂèò‰∏∫ (C, H, 1)„ÄÇ‰πüÂ∞±ÊòØËØ¥ÔºåÂÆΩÂ∫¶Ë¢´ÂéãÁº©‰∏∫ 1ÔºåËÄåÈ´òÂ∫¶‰øùÊåÅ‰∏çÂèò</span>
</span><span id="__span-6-35"><a id="__codelineno-6-35" name="__codelineno-6-35" href="#__codelineno-6-35"></a><span class="sd">        &#39;&#39;&#39;</span>
</span><span id="__span-6-36"><a id="__codelineno-6-36" name="__codelineno-6-36" href="#__codelineno-6-36"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">pool_w</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">AdaptiveAvgPool2d</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span> <span class="kc">None</span><span class="p">))</span>
</span><span id="__span-6-37"><a id="__codelineno-6-37" name="__codelineno-6-37" href="#__codelineno-6-37"></a>        <span class="n">mip</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="n">inp</span> <span class="o">//</span> <span class="n">reduction</span><span class="p">)</span>
</span><span id="__span-6-38"><a id="__codelineno-6-38" name="__codelineno-6-38" href="#__codelineno-6-38"></a>
</span><span id="__span-6-39"><a id="__codelineno-6-39" name="__codelineno-6-39" href="#__codelineno-6-39"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">conv1</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Conv2d</span><span class="p">(</span><span class="n">inp</span><span class="p">,</span> <span class="n">mip</span><span class="p">,</span> <span class="n">kernel_size</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">stride</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">padding</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</span><span id="__span-6-40"><a id="__codelineno-6-40" name="__codelineno-6-40" href="#__codelineno-6-40"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">bn1</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">BatchNorm2d</span><span class="p">(</span><span class="n">mip</span><span class="p">)</span>
</span><span id="__span-6-41"><a id="__codelineno-6-41" name="__codelineno-6-41" href="#__codelineno-6-41"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">act</span> <span class="o">=</span> <span class="n">h_swish</span><span class="p">()</span>
</span><span id="__span-6-42"><a id="__codelineno-6-42" name="__codelineno-6-42" href="#__codelineno-6-42"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">relu</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">ReLU</span><span class="p">()</span>
</span><span id="__span-6-43"><a id="__codelineno-6-43" name="__codelineno-6-43" href="#__codelineno-6-43"></a>
</span><span id="__span-6-44"><a id="__codelineno-6-44" name="__codelineno-6-44" href="#__codelineno-6-44"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">conv_h</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Conv2d</span><span class="p">(</span><span class="n">mip</span><span class="p">,</span> <span class="n">oup</span><span class="p">,</span> <span class="n">kernel_size</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">stride</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">padding</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</span><span id="__span-6-45"><a id="__codelineno-6-45" name="__codelineno-6-45" href="#__codelineno-6-45"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">conv_w</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Conv2d</span><span class="p">(</span><span class="n">mip</span><span class="p">,</span> <span class="n">oup</span><span class="p">,</span> <span class="n">kernel_size</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">stride</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">padding</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</span><span id="__span-6-46"><a id="__codelineno-6-46" name="__codelineno-6-46" href="#__codelineno-6-46"></a>
</span><span id="__span-6-47"><a id="__codelineno-6-47" name="__codelineno-6-47" href="#__codelineno-6-47"></a>
</span><span id="__span-6-48"><a id="__codelineno-6-48" name="__codelineno-6-48" href="#__codelineno-6-48"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
</span><span id="__span-6-49"><a id="__codelineno-6-49" name="__codelineno-6-49" href="#__codelineno-6-49"></a>        <span class="n">identity</span> <span class="o">=</span> <span class="n">x</span>
</span><span id="__span-6-50"><a id="__codelineno-6-50" name="__codelineno-6-50" href="#__codelineno-6-50"></a>
</span><span id="__span-6-51"><a id="__codelineno-6-51" name="__codelineno-6-51" href="#__codelineno-6-51"></a>        <span class="n">B</span><span class="p">,</span><span class="n">C</span><span class="p">,</span><span class="n">H</span><span class="p">,</span><span class="n">W</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">size</span><span class="p">()</span>
</span><span id="__span-6-52"><a id="__codelineno-6-52" name="__codelineno-6-52" href="#__codelineno-6-52"></a>        <span class="n">x_h</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pool_h</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="c1"># ÂéãÁº©Ê∞¥Âπ≥ÊñπÂêë: (B, C, H, W) --&gt; (B, C, H, 1)</span>
</span><span id="__span-6-53"><a id="__codelineno-6-53" name="__codelineno-6-53" href="#__codelineno-6-53"></a>        <span class="n">x_w</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pool_w</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="o">.</span><span class="n">permute</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="c1"># ÂéãÁº©ÂûÇÁõ¥ÊñπÂêë: (B, C, H, W) --&gt; (B, C, 1, W) --&gt; (B,C,W,1)</span>
</span><span id="__span-6-54"><a id="__codelineno-6-54" name="__codelineno-6-54" href="#__codelineno-6-54"></a>
</span><span id="__span-6-55"><a id="__codelineno-6-55" name="__codelineno-6-55" href="#__codelineno-6-55"></a>        <span class="c1"># ÂùêÊ†áÊ≥®ÊÑèÂäõÁîüÊàê</span>
</span><span id="__span-6-56"><a id="__codelineno-6-56" name="__codelineno-6-56" href="#__codelineno-6-56"></a>        <span class="n">y</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">([</span><span class="n">x_h</span><span class="p">,</span> <span class="n">x_w</span><span class="p">],</span> <span class="n">dim</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span> <span class="c1"># ÊãºÊé•Ê∞¥Âπ≥ÂíåÂûÇÁõ¥ÊñπÂêëÁöÑÂêëÈáè: (B,C,H+W,1)</span>
</span><span id="__span-6-57"><a id="__codelineno-6-57" name="__codelineno-6-57" href="#__codelineno-6-57"></a>        <span class="n">y</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">conv1</span><span class="p">(</span><span class="n">y</span><span class="p">)</span> <span class="c1"># ÈÄöËøáConvËøõË°åÂèòÊç¢,Âπ∂ÈôçÁª¥: (B,C,H+W,1)--&gt; (B,d,H+W,1)</span>
</span><span id="__span-6-58"><a id="__codelineno-6-58" name="__codelineno-6-58" href="#__codelineno-6-58"></a>        <span class="n">y</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bn1</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>   <span class="c1"># BatchNormÊìç‰Ωú: (B,d,H+W,1)</span>
</span><span id="__span-6-59"><a id="__codelineno-6-59" name="__codelineno-6-59" href="#__codelineno-6-59"></a>        <span class="n">y</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">relu</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>  <span class="c1"># ReluÊìç‰Ωú: (B,d,H+W,1)</span>
</span><span id="__span-6-60"><a id="__codelineno-6-60" name="__codelineno-6-60" href="#__codelineno-6-60"></a>
</span><span id="__span-6-61"><a id="__codelineno-6-61" name="__codelineno-6-61" href="#__codelineno-6-61"></a>        <span class="n">x_h</span><span class="p">,</span> <span class="n">x_w</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="p">[</span><span class="n">H</span><span class="p">,</span> <span class="n">W</span><span class="p">],</span> <span class="n">dim</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span> <span class="c1"># Ê≤øÁùÄÁ©∫Èó¥ÊñπÂêëÈáçÊñ∞ÂàÜÂâ≤‰∏∫‰∏§ÈÉ®ÂàÜ: (B,d,H+W,1)--&gt; x_h:(B,d,H,1); x_w:(B,d,W,1)</span>
</span><span id="__span-6-62"><a id="__codelineno-6-62" name="__codelineno-6-62" href="#__codelineno-6-62"></a>        <span class="n">x_w</span> <span class="o">=</span> <span class="n">x_w</span><span class="o">.</span><span class="n">permute</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="c1"># x_w: (B,d,W,1)--&gt; (B,d,1,W)</span>
</span><span id="__span-6-63"><a id="__codelineno-6-63" name="__codelineno-6-63" href="#__codelineno-6-63"></a>
</span><span id="__span-6-64"><a id="__codelineno-6-64" name="__codelineno-6-64" href="#__codelineno-6-64"></a>        <span class="n">a_h</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">conv_h</span><span class="p">(</span><span class="n">x_h</span><span class="p">)</span><span class="o">.</span><span class="n">sigmoid</span><span class="p">()</span> <span class="c1"># ÊÅ¢Â§ç‰∏éËæìÂÖ•Áõ∏ÂêåÁöÑÈÄöÈÅìÊï∞,Âπ∂ÁîüÊàêÂûÇÁõ¥ÊñπÂêëÁöÑÊùÉÈáç: (B,d,H,1)--&gt;(B,C,H,1)</span>
</span><span id="__span-6-65"><a id="__codelineno-6-65" name="__codelineno-6-65" href="#__codelineno-6-65"></a>        <span class="n">a_w</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">conv_w</span><span class="p">(</span><span class="n">x_w</span><span class="p">)</span><span class="o">.</span><span class="n">sigmoid</span><span class="p">()</span> <span class="c1"># ÊÅ¢Â§ç‰∏éËæìÂÖ•Áõ∏ÂêåÁöÑÈÄöÈÅìÊï∞,Âπ∂ÁîüÊàêÊ∞¥Âπ≥ÊñπÂêëÁöÑÊùÉÈáç: (B,d,1,W)--&gt;(B,C,1,W)</span>
</span><span id="__span-6-66"><a id="__codelineno-6-66" name="__codelineno-6-66" href="#__codelineno-6-66"></a><span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
</span><span id="__span-6-67"><a id="__codelineno-6-67" name="__codelineno-6-67" href="#__codelineno-6-67"></a><span class="sd">            ÈóÆÈ¢òÔºösigmoid Âú®Âì™‰∏™ÊñπÂêëËøõË°åÔºü</span>
</span><span id="__span-6-68"><a id="__codelineno-6-68" name="__codelineno-6-68" href="#__codelineno-6-68"></a><span class="sd">            Á≠îÔºö</span>
</span><span id="__span-6-69"><a id="__codelineno-6-69" name="__codelineno-6-69" href="#__codelineno-6-69"></a><span class="sd">                sigmoid ÊòØÈÄêÂÖÉÁ¥†Â∫îÁî®ÁöÑÔºå‰∏ç‰æùËµñ‰∫éÁâπÂÆöÁöÑÊñπÂêë</span>
</span><span id="__span-6-70"><a id="__codelineno-6-70" name="__codelineno-6-70" href="#__codelineno-6-70"></a><span class="sd">                ÂØπÊØè‰∏™ËæìÂÖ•ÂÖÉÁ¥†Áã¨Á´ãÂú∞ËøõË°åËÆ°ÁÆóÔºåËÄå‰∏çÊòØÂú®Êüê‰∏™ÁâπÂÆöÁöÑÊñπÂêë‰∏äËøõË°å</span>
</span><span id="__span-6-71"><a id="__codelineno-6-71" name="__codelineno-6-71" href="#__codelineno-6-71"></a><span class="sd">        &#39;&#39;&#39;</span>
</span><span id="__span-6-72"><a id="__codelineno-6-72" name="__codelineno-6-72" href="#__codelineno-6-72"></a>
</span><span id="__span-6-73"><a id="__codelineno-6-73" name="__codelineno-6-73" href="#__codelineno-6-73"></a>        <span class="n">out</span> <span class="o">=</span> <span class="n">identity</span> <span class="o">*</span> <span class="n">a_w</span> <span class="o">*</span> <span class="n">a_h</span> <span class="c1"># Â∞ÜÂûÇÁõ¥„ÄÅÊ∞¥Âπ≥ÊñπÂêëÊùÉÈáçÂ∫îÁî®‰∫éËæìÂÖ•,‰ªéËÄåÂèçÊò†ÊÑüÂÖ¥Ë∂£ÁöÑÂØπË±°ÊòØÂê¶Â≠òÂú®‰∫éÁõ∏Â∫îÁöÑË°åÂíåÂàó‰∏≠: (B,C,H,W) * (B,C,1,W) * (B,C,H,1) = (B,C,H,W)</span>
</span><span id="__span-6-74"><a id="__codelineno-6-74" name="__codelineno-6-74" href="#__codelineno-6-74"></a><span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
</span><span id="__span-6-75"><a id="__codelineno-6-75" name="__codelineno-6-75" href="#__codelineno-6-75"></a><span class="sd">        ÂπøÊí≠Êú∫Âà∂Ôºö</span>
</span><span id="__span-6-76"><a id="__codelineno-6-76" name="__codelineno-6-76" href="#__codelineno-6-76"></a><span class="sd">            identity ÊòØ‰∏Ä‰∏™ÂΩ¢Áä∂‰∏∫ (M, N) ÁöÑÊï∞ÁªÑ</span>
</span><span id="__span-6-77"><a id="__codelineno-6-77" name="__codelineno-6-77" href="#__codelineno-6-77"></a><span class="sd">            a_w ÊòØ‰∏Ä‰∏™ÂΩ¢Áä∂‰∏∫ (M, 1) ÁöÑÊï∞ÁªÑ ‚Üí a_w ÁöÑÂΩ¢Áä∂‰ºöË¢´ÂπøÊí≠‰∏∫ (M, N)ÔºåÂç≥Âú®ÂàóÊñπÂêë‰∏äÂ§çÂà∂ N Ê¨°</span>
</span><span id="__span-6-78"><a id="__codelineno-6-78" name="__codelineno-6-78" href="#__codelineno-6-78"></a><span class="sd">            a_h ÊòØ‰∏Ä‰∏™ÂΩ¢Áä∂‰∏∫ (1, N) ÁöÑÊï∞ÁªÑ ‚Üí a_h ÁöÑÂΩ¢Áä∂‰ºöË¢´ÂπøÊí≠‰∏∫ (M, N)ÔºåÂç≥Âú®Ë°åÊñπÂêë‰∏äÂ§çÂà∂ M Ê¨°</span>
</span><span id="__span-6-79"><a id="__codelineno-6-79" name="__codelineno-6-79" href="#__codelineno-6-79"></a><span class="sd">            ÊúÄÂêéÔºöÈÄêÂÖÉÁ¥†Áõ∏‰πò„ÄÇidentity„ÄÅa_w Âíå a_h ÁöÑÂΩ¢Áä∂ÈÉΩÂèò‰∏∫ (M, N)ÔºåÂèØ‰ª•ËøõË°åÈÄêÂÖÉÁ¥†Áõ∏‰πò</span>
</span><span id="__span-6-80"><a id="__codelineno-6-80" name="__codelineno-6-80" href="#__codelineno-6-80"></a><span class="sd">        &#39;&#39;&#39;</span>
</span><span id="__span-6-81"><a id="__codelineno-6-81" name="__codelineno-6-81" href="#__codelineno-6-81"></a>
</span><span id="__span-6-82"><a id="__codelineno-6-82" name="__codelineno-6-82" href="#__codelineno-6-82"></a>        <span class="k">return</span> <span class="n">out</span>
</span><span id="__span-6-83"><a id="__codelineno-6-83" name="__codelineno-6-83" href="#__codelineno-6-83"></a>
</span><span id="__span-6-84"><a id="__codelineno-6-84" name="__codelineno-6-84" href="#__codelineno-6-84"></a><span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
</span><span id="__span-6-85"><a id="__codelineno-6-85" name="__codelineno-6-85" href="#__codelineno-6-85"></a>    <span class="c1"># (B, C, H, W)</span>
</span><span id="__span-6-86"><a id="__codelineno-6-86" name="__codelineno-6-86" href="#__codelineno-6-86"></a>    <span class="nb">input</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">512</span><span class="p">,</span><span class="mi">7</span><span class="p">,</span><span class="mi">7</span><span class="p">)</span>
</span><span id="__span-6-87"><a id="__codelineno-6-87" name="__codelineno-6-87" href="#__codelineno-6-87"></a>    <span class="n">Model</span> <span class="o">=</span> <span class="n">CoordAtt</span><span class="p">(</span><span class="n">inp</span><span class="o">=</span><span class="mi">512</span><span class="p">,</span><span class="n">oup</span><span class="o">=</span><span class="mi">512</span><span class="p">)</span> <span class="c1"># input_channel,output_channel</span>
</span><span id="__span-6-88"><a id="__codelineno-6-88" name="__codelineno-6-88" href="#__codelineno-6-88"></a>    <span class="n">output</span><span class="o">=</span><span class="n">Model</span><span class="p">(</span><span class="nb">input</span><span class="p">)</span>
</span><span id="__span-6-89"><a id="__codelineno-6-89" name="__codelineno-6-89" href="#__codelineno-6-89"></a>    <span class="nb">print</span><span class="p">(</span><span class="n">output</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
</span></code></pre></div>
<p>Ê≥®Èáä</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-7-1"><a id="__codelineno-7-1" name="__codelineno-7-1" href="#__codelineno-7-1"></a><span class="kn">import</span><span class="w"> </span><span class="nn">torch</span>
</span><span id="__span-7-2"><a id="__codelineno-7-2" name="__codelineno-7-2" href="#__codelineno-7-2"></a><span class="kn">import</span><span class="w"> </span><span class="nn">torch.nn</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">nn</span>
</span><span id="__span-7-3"><a id="__codelineno-7-3" name="__codelineno-7-3" href="#__codelineno-7-3"></a><span class="kn">import</span><span class="w"> </span><span class="nn">torch.nn.functional</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">F</span>
</span><span id="__span-7-4"><a id="__codelineno-7-4" name="__codelineno-7-4" href="#__codelineno-7-4"></a>
</span><span id="__span-7-5"><a id="__codelineno-7-5" name="__codelineno-7-5" href="#__codelineno-7-5"></a><span class="c1"># ÂÆö‰πâh_sigmoidÊøÄÊ¥ªÂáΩÊï∞ÔºåËøôÊòØ‰∏ÄÁßçÁ°¨SigmoidÂáΩÊï∞</span>
</span><span id="__span-7-6"><a id="__codelineno-7-6" name="__codelineno-7-6" href="#__codelineno-7-6"></a><span class="k">class</span><span class="w"> </span><span class="nc">h_sigmoid</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
</span><span id="__span-7-7"><a id="__codelineno-7-7" name="__codelineno-7-7" href="#__codelineno-7-7"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
</span><span id="__span-7-8"><a id="__codelineno-7-8" name="__codelineno-7-8" href="#__codelineno-7-8"></a>        <span class="nb">super</span><span class="p">(</span><span class="n">h_sigmoid</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
</span><span id="__span-7-9"><a id="__codelineno-7-9" name="__codelineno-7-9" href="#__codelineno-7-9"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">relu</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">ReLU6</span><span class="p">(</span><span class="n">inplace</span><span class="o">=</span><span class="n">inplace</span><span class="p">)</span>  <span class="c1"># ‰ΩøÁî®ReLU6ÂÆûÁé∞</span>
</span><span id="__span-7-10"><a id="__codelineno-7-10" name="__codelineno-7-10" href="#__codelineno-7-10"></a>
</span><span id="__span-7-11"><a id="__codelineno-7-11" name="__codelineno-7-11" href="#__codelineno-7-11"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
</span><span id="__span-7-12"><a id="__codelineno-7-12" name="__codelineno-7-12" href="#__codelineno-7-12"></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">relu</span><span class="p">(</span><span class="n">x</span> <span class="o">+</span> <span class="mi">3</span><span class="p">)</span> <span class="o">/</span> <span class="mi">6</span>  <span class="c1"># ÂÖ¨Âºè‰∏∫ReLU6(x+3)/6ÔºåÊ®°ÊãüSigmoidÊøÄÊ¥ªÂáΩÊï∞</span>
</span><span id="__span-7-13"><a id="__codelineno-7-13" name="__codelineno-7-13" href="#__codelineno-7-13"></a>
</span><span id="__span-7-14"><a id="__codelineno-7-14" name="__codelineno-7-14" href="#__codelineno-7-14"></a><span class="c1"># ÂÆö‰πâh_swishÊøÄÊ¥ªÂáΩÊï∞ÔºåËøôÊòØÂü∫‰∫éh_sigmoidÁöÑSwishÂáΩÊï∞Âèò‰Ωì</span>
</span><span id="__span-7-15"><a id="__codelineno-7-15" name="__codelineno-7-15" href="#__codelineno-7-15"></a><span class="k">class</span><span class="w"> </span><span class="nc">h_swish</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
</span><span id="__span-7-16"><a id="__codelineno-7-16" name="__codelineno-7-16" href="#__codelineno-7-16"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
</span><span id="__span-7-17"><a id="__codelineno-7-17" name="__codelineno-7-17" href="#__codelineno-7-17"></a>        <span class="nb">super</span><span class="p">(</span><span class="n">h_swish</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
</span><span id="__span-7-18"><a id="__codelineno-7-18" name="__codelineno-7-18" href="#__codelineno-7-18"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">sigmoid</span> <span class="o">=</span> <span class="n">h_sigmoid</span><span class="p">(</span><span class="n">inplace</span><span class="o">=</span><span class="n">inplace</span><span class="p">)</span>  <span class="c1"># ‰ΩøÁî®‰∏äÈù¢ÂÆö‰πâÁöÑh_sigmoid</span>
</span><span id="__span-7-19"><a id="__codelineno-7-19" name="__codelineno-7-19" href="#__codelineno-7-19"></a>
</span><span id="__span-7-20"><a id="__codelineno-7-20" name="__codelineno-7-20" href="#__codelineno-7-20"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
</span><span id="__span-7-21"><a id="__codelineno-7-21" name="__codelineno-7-21" href="#__codelineno-7-21"></a>        <span class="k">return</span> <span class="n">x</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">sigmoid</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>  <span class="c1"># ÂÖ¨Âºè‰∏∫x * h_sigmoid(x)</span>
</span><span id="__span-7-22"><a id="__codelineno-7-22" name="__codelineno-7-22" href="#__codelineno-7-22"></a>
</span><span id="__span-7-23"><a id="__codelineno-7-23" name="__codelineno-7-23" href="#__codelineno-7-23"></a><span class="c1"># ÂÆö‰πâCoordinate AttentionÊ®°Âùó</span>
</span><span id="__span-7-24"><a id="__codelineno-7-24" name="__codelineno-7-24" href="#__codelineno-7-24"></a><span class="k">class</span><span class="w"> </span><span class="nc">CoordAtt</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
</span><span id="__span-7-25"><a id="__codelineno-7-25" name="__codelineno-7-25" href="#__codelineno-7-25"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">inp</span><span class="p">,</span> <span class="n">oup</span><span class="p">,</span> <span class="n">reduction</span><span class="o">=</span><span class="mi">32</span><span class="p">):</span>
</span><span id="__span-7-26"><a id="__codelineno-7-26" name="__codelineno-7-26" href="#__codelineno-7-26"></a>        <span class="nb">super</span><span class="p">(</span><span class="n">CoordAtt</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
</span><span id="__span-7-27"><a id="__codelineno-7-27" name="__codelineno-7-27" href="#__codelineno-7-27"></a>        <span class="c1"># ÂÆö‰πâÊ∞¥Âπ≥ÂíåÂûÇÁõ¥ÊñπÂêëÁöÑËá™ÈÄÇÂ∫îÂπ≥ÂùáÊ±†Âåñ</span>
</span><span id="__span-7-28"><a id="__codelineno-7-28" name="__codelineno-7-28" href="#__codelineno-7-28"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">pool_h</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">AdaptiveAvgPool2d</span><span class="p">((</span><span class="kc">None</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>  <span class="c1"># Ê∞¥Âπ≥ÊñπÂêë</span>
</span><span id="__span-7-29"><a id="__codelineno-7-29" name="__codelineno-7-29" href="#__codelineno-7-29"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">pool_w</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">AdaptiveAvgPool2d</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span> <span class="kc">None</span><span class="p">))</span>  <span class="c1"># ÂûÇÁõ¥ÊñπÂêë</span>
</span><span id="__span-7-30"><a id="__codelineno-7-30" name="__codelineno-7-30" href="#__codelineno-7-30"></a>
</span><span id="__span-7-31"><a id="__codelineno-7-31" name="__codelineno-7-31" href="#__codelineno-7-31"></a>        <span class="n">mip</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="n">inp</span> <span class="o">//</span> <span class="n">reduction</span><span class="p">)</span>  <span class="c1"># ËÆ°ÁÆó‰∏≠Èó¥Â±ÇÁöÑÈÄöÈÅìÊï∞</span>
</span><span id="__span-7-32"><a id="__codelineno-7-32" name="__codelineno-7-32" href="#__codelineno-7-32"></a>
</span><span id="__span-7-33"><a id="__codelineno-7-33" name="__codelineno-7-33" href="#__codelineno-7-33"></a>        <span class="c1"># 1x1Âç∑ÁßØÁî®‰∫éÈôçÁª¥</span>
</span><span id="__span-7-34"><a id="__codelineno-7-34" name="__codelineno-7-34" href="#__codelineno-7-34"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">conv1</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Conv2d</span><span class="p">(</span><span class="n">inp</span><span class="p">,</span> <span class="n">mip</span><span class="p">,</span> <span class="n">kernel_size</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">stride</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">padding</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</span><span id="__span-7-35"><a id="__codelineno-7-35" name="__codelineno-7-35" href="#__codelineno-7-35"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">bn1</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">BatchNorm2d</span><span class="p">(</span><span class="n">mip</span><span class="p">)</span>  <span class="c1"># ÊâπÂΩí‰∏ÄÂåñ</span>
</span><span id="__span-7-36"><a id="__codelineno-7-36" name="__codelineno-7-36" href="#__codelineno-7-36"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">act</span> <span class="o">=</span> <span class="n">h_swish</span><span class="p">()</span>  <span class="c1"># ÊøÄÊ¥ªÂáΩÊï∞</span>
</span><span id="__span-7-37"><a id="__codelineno-7-37" name="__codelineno-7-37" href="#__codelineno-7-37"></a>
</span><span id="__span-7-38"><a id="__codelineno-7-38" name="__codelineno-7-38" href="#__codelineno-7-38"></a>        <span class="c1"># ‰∏§‰∏™1x1Âç∑ÁßØÔºåÂàÜÂà´ÂØπÂ∫îÊ∞¥Âπ≥ÂíåÂûÇÁõ¥ÊñπÂêë</span>
</span><span id="__span-7-39"><a id="__codelineno-7-39" name="__codelineno-7-39" href="#__codelineno-7-39"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">conv_h</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Conv2d</span><span class="p">(</span><span class="n">mip</span><span class="p">,</span> <span class="n">oup</span><span class="p">,</span> <span class="n">kernel_size</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">stride</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">padding</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</span><span id="__span-7-40"><a id="__codelineno-7-40" name="__codelineno-7-40" href="#__codelineno-7-40"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">conv_w</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Conv2d</span><span class="p">(</span><span class="n">mip</span><span class="p">,</span> <span class="n">oup</span><span class="p">,</span> <span class="n">kernel_size</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">stride</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">padding</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</span><span id="__span-7-41"><a id="__codelineno-7-41" name="__codelineno-7-41" href="#__codelineno-7-41"></a>
</span><span id="__span-7-42"><a id="__codelineno-7-42" name="__codelineno-7-42" href="#__codelineno-7-42"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
</span><span id="__span-7-43"><a id="__codelineno-7-43" name="__codelineno-7-43" href="#__codelineno-7-43"></a>        <span class="n">identity</span> <span class="o">=</span> <span class="n">x</span>  <span class="c1"># ‰øùÂ≠òËæìÂÖ•‰Ωú‰∏∫ÊÆãÂ∑ÆËøûÊé•</span>
</span><span id="__span-7-44"><a id="__codelineno-7-44" name="__codelineno-7-44" href="#__codelineno-7-44"></a>
</span><span id="__span-7-45"><a id="__codelineno-7-45" name="__codelineno-7-45" href="#__codelineno-7-45"></a>        <span class="n">n</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">h</span><span class="p">,</span> <span class="n">w</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">size</span><span class="p">()</span>  <span class="c1"># Ëé∑ÂèñËæìÂÖ•ÁöÑÂ∞∫ÂØ∏</span>
</span><span id="__span-7-46"><a id="__codelineno-7-46" name="__codelineno-7-46" href="#__codelineno-7-46"></a>        <span class="n">x_h</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pool_h</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>  <span class="c1"># Ê∞¥Âπ≥ÊñπÂêëÊ±†Âåñ</span>
</span><span id="__span-7-47"><a id="__codelineno-7-47" name="__codelineno-7-47" href="#__codelineno-7-47"></a>        <span class="n">x_w</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pool_w</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="o">.</span><span class="n">permute</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>  <span class="c1"># ÂûÇÁõ¥ÊñπÂêëÊ±†ÂåñÂπ∂‰∫§Êç¢Áª¥Â∫¶‰ª•ÈÄÇÂ∫îÊãºÊé•</span>
</span><span id="__span-7-48"><a id="__codelineno-7-48" name="__codelineno-7-48" href="#__codelineno-7-48"></a>
</span><span id="__span-7-49"><a id="__codelineno-7-49" name="__codelineno-7-49" href="#__codelineno-7-49"></a>        <span class="n">y</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">([</span><span class="n">x_h</span><span class="p">,</span> <span class="n">x_w</span><span class="p">],</span> <span class="n">dim</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>  <span class="c1"># ÊãºÊé•Ê∞¥Âπ≥ÂíåÂûÇÁõ¥ÊñπÂêëÁöÑÁâπÂæÅ</span>
</span><span id="__span-7-50"><a id="__codelineno-7-50" name="__codelineno-7-50" href="#__codelineno-7-50"></a>        <span class="n">y</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">conv1</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>  <span class="c1"># ÈÄöËøá1x1Âç∑ÁßØÈôçÁª¥</span>
</span><span id="__span-7-51"><a id="__codelineno-7-51" name="__codelineno-7-51" href="#__codelineno-7-51"></a>        <span class="n">y</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bn1</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>  <span class="c1"># ÊâπÂΩí‰∏ÄÂåñ</span>
</span><span id="__span-7-52"><a id="__codelineno-7-52" name="__codelineno-7-52" href="#__codelineno-7-52"></a>        <span class="n">y</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">act</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>  <span class="c1"># ÊøÄÊ¥ªÂáΩÊï∞</span>
</span><span id="__span-7-53"><a id="__codelineno-7-53" name="__codelineno-7-53" href="#__codelineno-7-53"></a>
</span><span id="__span-7-54"><a id="__codelineno-7-54" name="__codelineno-7-54" href="#__codelineno-7-54"></a>        <span class="n">x_h</span><span class="p">,</span> <span class="n">x_w</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="p">[</span><span class="n">h</span><span class="p">,</span> <span class="n">w</span><span class="p">],</span> <span class="n">dim</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>  <span class="c1"># Â∞ÜÁâπÂæÅÊãÜÂàÜÂõûÊ∞¥Âπ≥ÂíåÂûÇÁõ¥ÊñπÂêë</span>
</span><span id="__span-7-55"><a id="__codelineno-7-55" name="__codelineno-7-55" href="#__codelineno-7-55"></a>        <span class="n">x_w</span> <span class="o">=</span> <span class="n">x_w</span><span class="o">.</span><span class="n">permute</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>  <span class="c1"># ÊÅ¢Â§çx_wÁöÑÂéüÂßãÁª¥Â∫¶</span>
</span><span id="__span-7-56"><a id="__codelineno-7-56" name="__codelineno-7-56" href="#__codelineno-7-56"></a>
</span><span id="__span-7-57"><a id="__codelineno-7-57" name="__codelineno-7-57" href="#__codelineno-7-57"></a>        <span class="n">a_h</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">conv_h</span><span class="p">(</span><span class="n">x_h</span><span class="p">)</span><span class="o">.</span><span class="n">sigmoid</span><span class="p">()</span>  <span class="c1"># ÈÄöËøá1x1Âç∑ÁßØÂπ∂Â∫îÁî®SigmoidËé∑ÂèñÊ∞¥Âπ≥ÊñπÂêëÁöÑÊ≥®ÊÑèÂäõÊùÉÈáç</span>
</span><span id="__span-7-58"><a id="__codelineno-7-58" name="__codelineno-7-58" href="#__codelineno-7-58"></a>        <span class="n">a_w</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">conv_w</span><span class="p">(</span><span class="n">x_w</span><span class="p">)</span><span class="o">.</span><span class="n">sigmoid</span><span class="p">()</span>  <span class="c1"># ÈÄöËøá1x1Âç∑ÁßØÂπ∂Â∫îÁî®SigmoidËé∑ÂèñÂûÇÁõ¥ÊñπÂêëÁöÑÊ≥®ÊÑèÂäõÊùÉÈáç</span>
</span><span id="__span-7-59"><a id="__codelineno-7-59" name="__codelineno-7-59" href="#__codelineno-7-59"></a>
</span><span id="__span-7-60"><a id="__codelineno-7-60" name="__codelineno-7-60" href="#__codelineno-7-60"></a>        <span class="n">out</span> <span class="o">=</span> <span class="n">identity</span> <span class="o">*</span> <span class="n">a_w</span> <span class="o">*</span> <span class="n">a_h</span>  <span class="c1"># Â∫îÁî®Ê≥®ÊÑèÂäõÊùÉÈáçÂà∞ËæìÂÖ•ÁâπÂæÅÔºåÂπ∂‰∏éÊÆãÂ∑ÆËøûÊé•Áõ∏‰πò</span>
</span><span id="__span-7-61"><a id="__codelineno-7-61" name="__codelineno-7-61" href="#__codelineno-7-61"></a>
</span><span id="__span-7-62"><a id="__codelineno-7-62" name="__codelineno-7-62" href="#__codelineno-7-62"></a>        <span class="k">return</span> <span class="n">out</span>  <span class="c1"># ËøîÂõûËæìÂá∫</span>
</span><span id="__span-7-63"><a id="__codelineno-7-63" name="__codelineno-7-63" href="#__codelineno-7-63"></a>
</span><span id="__span-7-64"><a id="__codelineno-7-64" name="__codelineno-7-64" href="#__codelineno-7-64"></a><span class="c1"># Á§∫‰æã‰ΩøÁî®</span>
</span><span id="__span-7-65"><a id="__codelineno-7-65" name="__codelineno-7-65" href="#__codelineno-7-65"></a><span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
</span><span id="__span-7-66"><a id="__codelineno-7-66" name="__codelineno-7-66" href="#__codelineno-7-66"></a>    <span class="n">block</span> <span class="o">=</span> <span class="n">CoordAtt</span><span class="p">(</span><span class="mi">64</span><span class="p">,</span> <span class="mi">64</span><span class="p">)</span>  <span class="c1"># ÂÆû‰æãÂåñCoordinate AttentionÊ®°Âùó</span>
</span><span id="__span-7-67"><a id="__codelineno-7-67" name="__codelineno-7-67" href="#__codelineno-7-67"></a>    <span class="nb">input</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">64</span><span class="p">,</span> <span class="mi">64</span><span class="p">,</span> <span class="mi">64</span><span class="p">)</span>  <span class="c1"># ÂàõÂª∫‰∏Ä‰∏™ÈöèÊú∫ËæìÂÖ•</span>
</span><span id="__span-7-68"><a id="__codelineno-7-68" name="__codelineno-7-68" href="#__codelineno-7-68"></a>    <span class="n">output</span> <span class="o">=</span> <span class="n">block</span><span class="p">(</span><span class="nb">input</span><span class="p">)</span>  <span class="c1"># ÈÄöËøáÊ®°ÂùóÂ§ÑÁêÜËæìÂÖ•</span>
</span><span id="__span-7-69"><a id="__codelineno-7-69" name="__codelineno-7-69" href="#__codelineno-7-69"></a>    <span class="nb">print</span><span class="p">(</span><span class="n">output</span><span class="o">.</span><span class="n">shape</span><span class="p">())</span>  <span class="c1"># ÊâìÂç∞ËæìÂÖ•ÂíåËæìÂá∫ÁöÑÂ∞∫ÂØ∏</span>
</span></code></pre></div>
<h2 id="cotattention">CoTAttention<a class="headerlink" href="#cotattention" title="Permanent link">&para;</a></h2>
<p>ËÆ∫Êñá„ÄäContextual Transformer Networks for Visual Recognition„Äã</p>
<p><img alt="image-20250222124330864" src="../images/image-20250222124330864.png" /></p>
<p><img alt="image-20250222124345663" src="../images/image-20250222124345663.png" /></p>
<p><img alt="image-20250222124401106" src="../images/image-20250222124401106.png" /></p>
<blockquote>
<p>‰ΩúÁî®</p>
</blockquote>
<p>Contextual Transformer (CoT) block ËÆæËÆ°‰∏∫ËßÜËßâËØÜÂà´ÁöÑ‰∏ÄÁßçÊñ∞È¢ñÁöÑ Transformer È£éÊ†ºÊ®°Âùó„ÄÇËØ•ËÆæËÆ°ÂÖÖÂàÜÂà©Áî®ËæìÂÖ•ÈîÆ‰πãÈó¥ÁöÑ‰∏ä‰∏ãÊñá‰ø°ÊÅØÊåáÂØºÂä®ÊÄÅÊ≥®ÊÑèÂäõÁü©ÈòµÁöÑÂ≠¶‰π†Ôºå‰ªéËÄåÂä†Âº∫ËßÜËßâË°®Á§∫ÁöÑËÉΩÂäõ„ÄÇCoT block È¶ñÂÖàÈÄöËøá 3x3 Âç∑ÁßØÂØπËæìÂÖ•ÈîÆËøõË°å‰∏ä‰∏ãÊñáÁºñÁ†ÅÔºåÂæóÂà∞ËæìÂÖ•ÁöÑÈùôÊÄÅ‰∏ä‰∏ãÊñáË°®Á§∫„ÄÇÁÑ∂ÂêéÔºåÂ∞ÜÁºñÁ†ÅÂêéÁöÑÈîÆ‰∏éËæìÂÖ•Êü•ËØ¢ÂêàÂπ∂ÔºåÈÄöËøá‰∏§‰∏™ËøûÁª≠ÁöÑ 1x1 Âç∑ÁßØÂ≠¶‰π†Âä®ÊÄÅÂ§öÂ§¥Ê≥®ÊÑèÂäõÁü©Èòµ„ÄÇÂ≠¶‰π†Âà∞ÁöÑÊ≥®ÊÑèÂäõÁü©Èòµ‰πò‰ª•ËæìÂÖ•ÂÄºÔºåÂÆûÁé∞ËæìÂÖ•ÁöÑÂä®ÊÄÅ‰∏ä‰∏ãÊñáË°®Á§∫„ÄÇÊúÄÁªàÂ∞ÜÈùôÊÄÅÂíåÂä®ÊÄÅ‰∏ä‰∏ãÊñáË°®Á§∫ÁöÑËûçÂêà‰Ωú‰∏∫ËæìÂá∫„ÄÇ</p>
<blockquote>
<p>Êú∫Âà∂</p>
</blockquote>
<p>1„ÄÅ<strong>‰∏ä‰∏ãÊñáÁºñÁ†Å</strong>Ôºö</p>
<p>ÈÄöËøá 3x3 Âç∑ÁßØÂú®ÊâÄÊúâÈÇªÂ±ÖÈîÆÂÜÖÈÉ®Á©∫Èó¥‰∏ä‰∏ãÊñáÂåñÊØè‰∏™ÈîÆË°®Á§∫ÔºåÊçïËé∑ÈîÆ‰πãÈó¥ÁöÑÈùôÊÄÅ‰∏ä‰∏ãÊñá‰ø°ÊÅØ„ÄÇ</p>
<p>2„ÄÅ<strong>Âä®ÊÄÅÊ≥®ÊÑèÂäõÂ≠¶‰π†</strong>Ôºö</p>
<p>Âü∫‰∫éÊü•ËØ¢Âíå‰∏ä‰∏ãÊñáÂåñÁöÑÈîÆÁöÑËøûÊé•ÔºåÈÄöËøá‰∏§‰∏™ËøûÁª≠ÁöÑ 1x1 Âç∑ÁßØ‰∫ßÁîüÊ≥®ÊÑèÂäõÁü©ÈòµÔºåËøô‰∏ÄËøáÁ®ãËá™ÁÑ∂Âú∞Âà©Áî®ÊØè‰∏™Êü•ËØ¢ÂíåÊâÄÊúâÈîÆ‰πãÈó¥ÁöÑÁõ∏‰∫íÂÖ≥Á≥ªËøõË°åËá™ÊàëÊ≥®ÊÑèÂäõÂ≠¶‰π†ÔºåÂπ∂Áî±ÈùôÊÄÅ‰∏ä‰∏ãÊñáÊåáÂØº„ÄÇ</p>
<p>3„ÄÅ<strong>ÈùôÊÄÅÂíåÂä®ÊÄÅ‰∏ä‰∏ãÊñáÁöÑËûçÂêà</strong>Ôºö</p>
<p>Â∞ÜÈùôÊÄÅ‰∏ä‰∏ãÊñáÂíåÈÄöËøá‰∏ä‰∏ãÊñáÂåñËá™Ê≥®ÊÑèÂäõÂæóÂà∞ÁöÑÂä®ÊÄÅ‰∏ä‰∏ãÊñáÁªìÂêàÔºå‰Ωú‰∏∫ CoT block ÁöÑÊúÄÁªàËæìÂá∫„ÄÇ</p>
<blockquote>
<p>‰ºòÂäø</p>
</blockquote>
<p>1„ÄÅ<strong>‰∏ä‰∏ãÊñáÊÑüÁü•</strong>Ôºö</p>
<p>CoT ÈÄöËøáÂú®Ëá™Ê≥®ÊÑèÂäõÂ≠¶‰π†‰∏≠Êé¢Á¥¢ËæìÂÖ•ÈîÆ‰πãÈó¥ÁöÑÂØå‰∏ä‰∏ãÊñá‰ø°ÊÅØÔºå‰ΩøÊ®°ÂûãËÉΩÂ§üÊõ¥ÂáÜÁ°ÆÂú∞ÊçïËé∑ËßÜËßâÂÜÖÂÆπÁöÑÁªÜÂæÆÂ∑ÆÂºÇ„ÄÇ</p>
<p>2„ÄÅ<strong>Âä®ÈùôÊÄÅ‰∏ä‰∏ãÊñáÁöÑÁªü‰∏Ä</strong>Ôºö</p>
<p>CoT ËÆæËÆ°Â∑ßÂ¶ôÂú∞Â∞Ü‰∏ä‰∏ãÊñáÊåñÊéò‰∏éËá™Ê≥®ÊÑèÂäõÂ≠¶‰π†Áªü‰∏ÄÂà∞Âçï‰∏ÄÊû∂ÊûÑ‰∏≠ÔºåÊó¢Âà©Áî®ÈîÆ‰πãÈó¥ÁöÑÈùôÊÄÅÂÖ≥Á≥ªÂèàÊé¢Á¥¢Âä®ÊÄÅÁâπÂæÅ‰∫§‰∫íÔºåÊèêÂçá‰∫ÜÊ®°ÂûãÁöÑË°®ËææËÉΩÂäõ„ÄÇ</p>
<p>3„ÄÅ<strong>ÁÅµÊ¥ªÊõøÊç¢‰∏é‰ºòÂåñ</strong>Ôºö</p>
<p>CoT block ÂèØ‰ª•Áõ¥Êé•ÊõøÊç¢Áé∞Êúâ ResNet Êû∂ÊûÑ‰∏≠ÁöÑÊ†áÂáÜÂç∑ÁßØÔºå‰∏çÂ¢ûÂä†ÂèÇÊï∞Âíå FLOP È¢ÑÁÆóÁöÑÊÉÖÂÜµ‰∏ãÂÆûÁé∞ËΩ¨Êç¢‰∏∫ Transformer È£éÊ†ºÁöÑÈ™®Âπ≤ÁΩëÁªúÔºàCoTNetÔºâÔºåÈÄöËøáÂπøÊ≥õÁöÑÂÆûÈ™åÈ™åËØÅ‰∫ÜÂÖ∂Âú®Â§öÁßçÂ∫îÁî®ÔºàÂ¶ÇÂõæÂÉèËØÜÂà´„ÄÅÁõÆÊ†áÊ£ÄÊµãÂíåÂÆû‰æãÂàÜÂâ≤Ôºâ‰∏≠ÁöÑ‰ºòË∂äÊÄß„ÄÇ</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-8-1"><a id="__codelineno-8-1" name="__codelineno-8-1" href="#__codelineno-8-1"></a><span class="c1"># ÂØºÂÖ•ÂøÖË¶ÅÁöÑPyTorchÊ®°Âùó</span>
</span><span id="__span-8-2"><a id="__codelineno-8-2" name="__codelineno-8-2" href="#__codelineno-8-2"></a><span class="kn">import</span><span class="w"> </span><span class="nn">torch</span>
</span><span id="__span-8-3"><a id="__codelineno-8-3" name="__codelineno-8-3" href="#__codelineno-8-3"></a><span class="kn">from</span><span class="w"> </span><span class="nn">torch</span><span class="w"> </span><span class="kn">import</span> <span class="n">nn</span>
</span><span id="__span-8-4"><a id="__codelineno-8-4" name="__codelineno-8-4" href="#__codelineno-8-4"></a><span class="kn">from</span><span class="w"> </span><span class="nn">torch.nn</span><span class="w"> </span><span class="kn">import</span> <span class="n">functional</span> <span class="k">as</span> <span class="n">F</span>
</span><span id="__span-8-5"><a id="__codelineno-8-5" name="__codelineno-8-5" href="#__codelineno-8-5"></a>
</span><span id="__span-8-6"><a id="__codelineno-8-6" name="__codelineno-8-6" href="#__codelineno-8-6"></a><span class="k">class</span><span class="w"> </span><span class="nc">CoTAttention</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
</span><span id="__span-8-7"><a id="__codelineno-8-7" name="__codelineno-8-7" href="#__codelineno-8-7"></a>    <span class="c1"># ÂàùÂßãÂåñCoTÊ≥®ÊÑèÂäõÊ®°Âùó</span>
</span><span id="__span-8-8"><a id="__codelineno-8-8" name="__codelineno-8-8" href="#__codelineno-8-8"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">512</span><span class="p">,</span> <span class="n">kernel_size</span><span class="o">=</span><span class="mi">3</span><span class="p">):</span>
</span><span id="__span-8-9"><a id="__codelineno-8-9" name="__codelineno-8-9" href="#__codelineno-8-9"></a>        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
</span><span id="__span-8-10"><a id="__codelineno-8-10" name="__codelineno-8-10" href="#__codelineno-8-10"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">dim</span> <span class="o">=</span> <span class="n">dim</span>  <span class="c1"># ËæìÂÖ•ÁöÑÈÄöÈÅìÊï∞</span>
</span><span id="__span-8-11"><a id="__codelineno-8-11" name="__codelineno-8-11" href="#__codelineno-8-11"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">kernel_size</span> <span class="o">=</span> <span class="n">kernel_size</span>  <span class="c1"># Âç∑ÁßØÊ†∏Â§ßÂ∞è</span>
</span><span id="__span-8-12"><a id="__codelineno-8-12" name="__codelineno-8-12" href="#__codelineno-8-12"></a>
</span><span id="__span-8-13"><a id="__codelineno-8-13" name="__codelineno-8-13" href="#__codelineno-8-13"></a>        <span class="c1"># ÂÆö‰πâÁî®‰∫éÈîÆ(key)ÁöÑÂç∑ÁßØÂ±ÇÔºåÂåÖÊã¨‰∏Ä‰∏™ÂàÜÁªÑÂç∑ÁßØÔºåBatchNormÂíåReLUÊøÄÊ¥ª</span>
</span><span id="__span-8-14"><a id="__codelineno-8-14" name="__codelineno-8-14" href="#__codelineno-8-14"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">key_embed</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Sequential</span><span class="p">(</span>
</span><span id="__span-8-15"><a id="__codelineno-8-15" name="__codelineno-8-15" href="#__codelineno-8-15"></a>            <span class="n">nn</span><span class="o">.</span><span class="n">Conv2d</span><span class="p">(</span><span class="n">dim</span><span class="p">,</span> <span class="n">dim</span><span class="p">,</span> <span class="n">kernel_size</span><span class="o">=</span><span class="n">kernel_size</span><span class="p">,</span> <span class="n">padding</span><span class="o">=</span><span class="n">kernel_size</span><span class="o">//</span><span class="mi">2</span><span class="p">,</span> <span class="n">groups</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">bias</span><span class="o">=</span><span class="kc">False</span><span class="p">),</span>
</span><span id="__span-8-16"><a id="__codelineno-8-16" name="__codelineno-8-16" href="#__codelineno-8-16"></a>            <span class="n">nn</span><span class="o">.</span><span class="n">BatchNorm2d</span><span class="p">(</span><span class="n">dim</span><span class="p">),</span>
</span><span id="__span-8-17"><a id="__codelineno-8-17" name="__codelineno-8-17" href="#__codelineno-8-17"></a>            <span class="n">nn</span><span class="o">.</span><span class="n">ReLU</span><span class="p">()</span>
</span><span id="__span-8-18"><a id="__codelineno-8-18" name="__codelineno-8-18" href="#__codelineno-8-18"></a>        <span class="p">)</span>
</span><span id="__span-8-19"><a id="__codelineno-8-19" name="__codelineno-8-19" href="#__codelineno-8-19"></a>
</span><span id="__span-8-20"><a id="__codelineno-8-20" name="__codelineno-8-20" href="#__codelineno-8-20"></a>        <span class="c1"># ÂÆö‰πâÁî®‰∫éÂÄº(value)ÁöÑÂç∑ÁßØÂ±ÇÔºåÂåÖÊã¨‰∏Ä‰∏™1x1Âç∑ÁßØÂíåBatchNorm</span>
</span><span id="__span-8-21"><a id="__codelineno-8-21" name="__codelineno-8-21" href="#__codelineno-8-21"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">value_embed</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Sequential</span><span class="p">(</span>
</span><span id="__span-8-22"><a id="__codelineno-8-22" name="__codelineno-8-22" href="#__codelineno-8-22"></a>            <span class="n">nn</span><span class="o">.</span><span class="n">Conv2d</span><span class="p">(</span><span class="n">dim</span><span class="p">,</span> <span class="n">dim</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">bias</span><span class="o">=</span><span class="kc">False</span><span class="p">),</span>
</span><span id="__span-8-23"><a id="__codelineno-8-23" name="__codelineno-8-23" href="#__codelineno-8-23"></a>            <span class="n">nn</span><span class="o">.</span><span class="n">BatchNorm2d</span><span class="p">(</span><span class="n">dim</span><span class="p">)</span>
</span><span id="__span-8-24"><a id="__codelineno-8-24" name="__codelineno-8-24" href="#__codelineno-8-24"></a>        <span class="p">)</span>
</span><span id="__span-8-25"><a id="__codelineno-8-25" name="__codelineno-8-25" href="#__codelineno-8-25"></a>
</span><span id="__span-8-26"><a id="__codelineno-8-26" name="__codelineno-8-26" href="#__codelineno-8-26"></a>        <span class="c1"># Áº©Â∞èÂõ†Â≠êÔºåÁî®‰∫éÈôç‰ΩéÊ≥®ÊÑèÂäõÂµåÂÖ•ÁöÑÁª¥Â∫¶</span>
</span><span id="__span-8-27"><a id="__codelineno-8-27" name="__codelineno-8-27" href="#__codelineno-8-27"></a>        <span class="n">factor</span> <span class="o">=</span> <span class="mi">4</span>
</span><span id="__span-8-28"><a id="__codelineno-8-28" name="__codelineno-8-28" href="#__codelineno-8-28"></a>        <span class="c1"># ÂÆö‰πâÊ≥®ÊÑèÂäõÂµåÂÖ•Â±ÇÔºåÁî±‰∏§‰∏™Âç∑ÁßØÂ±Ç„ÄÅ‰∏Ä‰∏™BatchNormÂ±ÇÂíåReLUÊøÄÊ¥ªÁªÑÊàê</span>
</span><span id="__span-8-29"><a id="__codelineno-8-29" name="__codelineno-8-29" href="#__codelineno-8-29"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">attention_embed</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Sequential</span><span class="p">(</span>
</span><span id="__span-8-30"><a id="__codelineno-8-30" name="__codelineno-8-30" href="#__codelineno-8-30"></a>            <span class="n">nn</span><span class="o">.</span><span class="n">Conv2d</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">dim</span><span class="p">,</span> <span class="mi">2</span><span class="o">*</span><span class="n">dim</span><span class="o">//</span><span class="n">factor</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">bias</span><span class="o">=</span><span class="kc">False</span><span class="p">),</span>
</span><span id="__span-8-31"><a id="__codelineno-8-31" name="__codelineno-8-31" href="#__codelineno-8-31"></a>            <span class="n">nn</span><span class="o">.</span><span class="n">BatchNorm2d</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">dim</span><span class="o">//</span><span class="n">factor</span><span class="p">),</span>
</span><span id="__span-8-32"><a id="__codelineno-8-32" name="__codelineno-8-32" href="#__codelineno-8-32"></a>            <span class="n">nn</span><span class="o">.</span><span class="n">ReLU</span><span class="p">(),</span>
</span><span id="__span-8-33"><a id="__codelineno-8-33" name="__codelineno-8-33" href="#__codelineno-8-33"></a>            <span class="n">nn</span><span class="o">.</span><span class="n">Conv2d</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">dim</span><span class="o">//</span><span class="n">factor</span><span class="p">,</span> <span class="n">kernel_size</span><span class="o">*</span><span class="n">kernel_size</span><span class="o">*</span><span class="n">dim</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
</span><span id="__span-8-34"><a id="__codelineno-8-34" name="__codelineno-8-34" href="#__codelineno-8-34"></a>        <span class="p">)</span>
</span><span id="__span-8-35"><a id="__codelineno-8-35" name="__codelineno-8-35" href="#__codelineno-8-35"></a>
</span><span id="__span-8-36"><a id="__codelineno-8-36" name="__codelineno-8-36" href="#__codelineno-8-36"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
</span><span id="__span-8-37"><a id="__codelineno-8-37" name="__codelineno-8-37" href="#__codelineno-8-37"></a>        <span class="c1"># ÂâçÂêë‰º†Êí≠ÂáΩÊï∞</span>
</span><span id="__span-8-38"><a id="__codelineno-8-38" name="__codelineno-8-38" href="#__codelineno-8-38"></a>        <span class="n">bs</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">h</span><span class="p">,</span> <span class="n">w</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">shape</span>  <span class="c1"># ËæìÂÖ•ÁâπÂæÅÁöÑÂ∞∫ÂØ∏</span>
</span><span id="__span-8-39"><a id="__codelineno-8-39" name="__codelineno-8-39" href="#__codelineno-8-39"></a>        <span class="n">k1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">key_embed</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>  <span class="c1"># ÁîüÊàêÈîÆÁöÑÈùôÊÄÅË°®Á§∫</span>
</span><span id="__span-8-40"><a id="__codelineno-8-40" name="__codelineno-8-40" href="#__codelineno-8-40"></a>        <span class="n">v</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">value_embed</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="n">bs</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>  <span class="c1"># ÁîüÊàêÂÄºÁöÑË°®Á§∫Âπ∂Ë∞ÉÊï¥ÂΩ¢Áä∂</span>
</span><span id="__span-8-41"><a id="__codelineno-8-41" name="__codelineno-8-41" href="#__codelineno-8-41"></a>
</span><span id="__span-8-42"><a id="__codelineno-8-42" name="__codelineno-8-42" href="#__codelineno-8-42"></a>        <span class="n">y</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">([</span><span class="n">k1</span><span class="p">,</span> <span class="n">x</span><span class="p">],</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>  <span class="c1"># Â∞ÜÈîÆÁöÑÈùôÊÄÅË°®Á§∫ÂíåÂéüÂßãËæìÂÖ•ËøûÊé•</span>
</span><span id="__span-8-43"><a id="__codelineno-8-43" name="__codelineno-8-43" href="#__codelineno-8-43"></a>        <span class="n">att</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">attention_embed</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>  <span class="c1"># ÁîüÊàêÂä®ÊÄÅÊ≥®ÊÑèÂäõÊùÉÈáç</span>
</span><span id="__span-8-44"><a id="__codelineno-8-44" name="__codelineno-8-44" href="#__codelineno-8-44"></a>        <span class="n">att</span> <span class="o">=</span> <span class="n">att</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">bs</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">kernel_size</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">kernel_size</span><span class="p">,</span> <span class="n">h</span><span class="p">,</span> <span class="n">w</span><span class="p">)</span>
</span><span id="__span-8-45"><a id="__codelineno-8-45" name="__codelineno-8-45" href="#__codelineno-8-45"></a>        <span class="n">att</span> <span class="o">=</span> <span class="n">att</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">keepdim</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="n">bs</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>  <span class="c1"># ËÆ°ÁÆóÊ≥®ÊÑèÂäõÊùÉÈáçÁöÑÂùáÂÄºÂπ∂Ë∞ÉÊï¥ÂΩ¢Áä∂</span>
</span><span id="__span-8-46"><a id="__codelineno-8-46" name="__codelineno-8-46" href="#__codelineno-8-46"></a>        <span class="n">k2</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">softmax</span><span class="p">(</span><span class="n">att</span><span class="p">,</span> <span class="n">dim</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">v</span>  <span class="c1"># Â∫îÁî®Ê≥®ÊÑèÂäõÊùÉÈáçÂà∞ÂÄº‰∏ä</span>
</span><span id="__span-8-47"><a id="__codelineno-8-47" name="__codelineno-8-47" href="#__codelineno-8-47"></a>        <span class="n">k2</span> <span class="o">=</span> <span class="n">k2</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="n">bs</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">h</span><span class="p">,</span> <span class="n">w</span><span class="p">)</span>  <span class="c1"># Ë∞ÉÊï¥ÂΩ¢Áä∂‰ª•ÂåπÈÖçËæìÂá∫</span>
</span><span id="__span-8-48"><a id="__codelineno-8-48" name="__codelineno-8-48" href="#__codelineno-8-48"></a>
</span><span id="__span-8-49"><a id="__codelineno-8-49" name="__codelineno-8-49" href="#__codelineno-8-49"></a>        <span class="k">return</span> <span class="n">k1</span> <span class="o">+</span> <span class="n">k2</span>  <span class="c1"># ËøîÂõûÈîÆÁöÑÈùôÊÄÅÂíåÂä®ÊÄÅË°®Á§∫ÁöÑÊÄªÂíå</span>
</span><span id="__span-8-50"><a id="__codelineno-8-50" name="__codelineno-8-50" href="#__codelineno-8-50"></a>
</span><span id="__span-8-51"><a id="__codelineno-8-51" name="__codelineno-8-51" href="#__codelineno-8-51"></a><span class="c1"># ÂÆû‰æãÂåñCoTAttentionÊ®°ÂùóÂπ∂ÊµãËØï</span>
</span><span id="__span-8-52"><a id="__codelineno-8-52" name="__codelineno-8-52" href="#__codelineno-8-52"></a><span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
</span><span id="__span-8-53"><a id="__codelineno-8-53" name="__codelineno-8-53" href="#__codelineno-8-53"></a>    <span class="n">block</span> <span class="o">=</span> <span class="n">CoTAttention</span><span class="p">(</span><span class="mi">64</span><span class="p">)</span>  <span class="c1"># ÂàõÂª∫‰∏Ä‰∏™ËæìÂÖ•ÈÄöÈÅìÊï∞‰∏∫64ÁöÑCoTAttentionÂÆû‰æã</span>
</span><span id="__span-8-54"><a id="__codelineno-8-54" name="__codelineno-8-54" href="#__codelineno-8-54"></a>    <span class="nb">input</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">64</span><span class="p">,</span> <span class="mi">64</span><span class="p">,</span> <span class="mi">64</span><span class="p">)</span>  <span class="c1"># ÂàõÂª∫‰∏Ä‰∏™ÈöèÊú∫ËæìÂÖ•</span>
</span><span id="__span-8-55"><a id="__codelineno-8-55" name="__codelineno-8-55" href="#__codelineno-8-55"></a>    <span class="n">output</span> <span class="o">=</span> <span class="n">block</span><span class="p">(</span><span class="nb">input</span><span class="p">)</span>  <span class="c1"># ÈÄöËøáCoTAttentionÊ®°ÂùóÂ§ÑÁêÜËæìÂÖ•</span>
</span><span id="__span-8-56"><a id="__codelineno-8-56" name="__codelineno-8-56" href="#__codelineno-8-56"></a>    <span class="nb">print</span><span class="p">(</span><span class="n">output</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>  <span class="c1"># ÊâìÂç∞ËæìÂÖ•ÂíåËæìÂá∫ÁöÑÂ∞∫ÂØ∏</span>
</span></code></pre></div>
<h2 id="tripletattention">‚àö TripletAttention<a class="headerlink" href="#tripletattention" title="Permanent link">&para;</a></h2>
<p>ËÆ∫Êñá„ÄäRotate to Attend: Convolutional Triplet Attention Module„Äã‰∏âÂàÜÊîØÊ≥®ÊÑèÂäõ</p>
<p><img alt="image-20250222124137926" src="../images/image-20250222124137926.png" /></p>
<p><img alt="image-20250222124159250" src="../images/image-20250222124159250.png" /></p>
<p><img alt="image-20250222172404187" src="../images/image-20250222172404187.png" /></p>
<p>Triplet AttentionÊòØ‰∏ÄÁßçÊñ∞È¢ñÁöÑÊ≥®ÊÑèÂäõÊú∫Âà∂ÔºåÂÆÉÈÄöËøá**ÊçïËé∑Ë∑®Áª¥Â∫¶‰∫§‰∫í**ÔºåÂà©Áî®**‰∏âÂàÜÊîØÁªìÊûÑ**Êù•ËÆ°ÁÆóÊ≥®ÊÑèÂäõÊùÉÈáç„ÄÇÂØπ‰∫éËæìÂÖ•Âº†ÈáèÔºåTriplet AttentionÈÄöËøá**ÊóãËΩ¨Êìç‰Ωú**Âª∫Á´ãÁª¥Â∫¶Èó¥ÁöÑ‰æùËµñÂÖ≥Á≥ªÔºåÈöèÂêéÈÄöËøáÊÆãÂ∑ÆÂèòÊç¢ÂØπ‰ø°ÈÅìÂíåÁ©∫Èó¥‰ø°ÊÅØËøõË°åÁºñÁ†ÅÔºåÂÆûÁé∞‰∫ÜÂá†‰πé‰∏çÂ¢ûÂä†ËÆ°ÁÆóÊàêÊú¨ÁöÑÊÉÖÂÜµ‰∏ãÔºåÊúâÊïàÂ¢ûÂº∫ËßÜËßâË°®ÂæÅÁöÑËÉΩÂäõ„ÄÇ</p>
<blockquote>
<p>Êú∫Âà∂</p>
</blockquote>
<p>1„ÄÅ<strong>‰∏âÂàÜÊîØÁªìÊûÑ</strong>Ôºö</p>
<p>Triplet AttentionÂåÖÂê´‰∏â‰∏™ÂàÜÊîØÔºåÊØè‰∏™ÂàÜÊîØË¥üË¥£ÊçïËé∑ËæìÂÖ•ÁöÑÁ©∫Èó¥Áª¥Â∫¶HÊàñW‰∏é‰ø°ÈÅìÁª¥Â∫¶C‰πãÈó¥ÁöÑ‰∫§‰∫íÁâπÂæÅ„ÄÇ</p>
<p>2„ÄÅ<strong>Ë∑®Áª¥Â∫¶‰∫§‰∫í</strong>Ôºö</p>
<p>ÈÄöËøáÂú®ÊØè‰∏™ÂàÜÊîØ‰∏≠ÂØπËæìÂÖ•Âº†ÈáèËøõË°åÊéíÂàóÔºàpermuteÔºâÊìç‰ΩúÔºåÂπ∂ÈÄöËøáZ-poolÂíåk√ókÁöÑÂç∑ÁßØÂ±ÇÂ§ÑÁêÜÔºå‰ª•ÊçïËé∑Ë∑®Áª¥Â∫¶ÁöÑ‰∫§‰∫íÁâπÂæÅ„ÄÇ</p>
<p>3„ÄÅ<strong>Ê≥®ÊÑèÂäõÊùÉÈáçÁöÑÁîüÊàê</strong>Ôºö</p>
<p>Âà©Áî®sigmoidÊøÄÊ¥ªÂ±ÇÁîüÊàêÊ≥®ÊÑèÂäõÊùÉÈáçÔºåÂπ∂Â∫îÁî®‰∫éÊéíÂàóÂêéÁöÑËæìÂÖ•Âº†ÈáèÔºåÁÑ∂ÂêéÂ∞ÜÂÖ∂ÊéíÂàóÂõûÂéüÂßãËæìÂÖ•ÂΩ¢Áä∂„ÄÇ</p>
<blockquote>
<p>Áã¨Áâπ‰ºòÂäø</p>
</blockquote>
<p>1„ÄÅ<strong>Ë∑®Áª¥Â∫¶‰∫§‰∫í</strong>Ôºö</p>
<p>Triplet AttentionÈÄöËøáÊçïËé∑ËæìÂÖ•Âº†ÈáèÁöÑË∑®Áª¥Â∫¶‰∫§‰∫íÔºåÊèê‰æõ‰∫Ü‰∏∞ÂØåÁöÑÂà§Âà´ÁâπÂæÅË°®ÂæÅÔºåËæÉ‰πãÂâçÁöÑÊ≥®ÊÑèÂäõÊú∫Âà∂ÔºàÂ¶ÇSENet„ÄÅCBAMÁ≠âÔºâËÉΩÂ§üÊõ¥ÊúâÊïàÂú∞Â¢ûÂº∫ÁΩëÁªúÁöÑÊÄßËÉΩ„ÄÇ</p>
<p>2„ÄÅ<strong>Âá†‰πéÊó†ËÆ°ÁÆóÊàêÊú¨Â¢ûÂä†</strong>Ôºö</p>
<p>Áõ∏ÊØî‰∫é‰º†ÁªüÁöÑÊ≥®ÊÑèÂäõÊú∫Âà∂ÔºåTriplet AttentionÂú®ÊèêÂçáÁΩëÁªúÊÄßËÉΩÁöÑÂêåÊó∂ÔºåÂá†‰πé‰∏çÂ¢ûÂä†È¢ùÂ§ñÁöÑËÆ°ÁÆóÊàêÊú¨ÂíåÂèÇÊï∞Êï∞ÈáèÔºå‰ΩøÂæóÂÆÉÂèØ‰ª•ËΩªÊùæÂú∞ÈõÜÊàêÂà∞ÁªèÂÖ∏ÁöÑÈ™®Âπ≤ÁΩëÁªú‰∏≠„ÄÇ</p>
<p>3„ÄÅ<strong>Êó†ÈúÄÈôçÁª¥</strong>Ôºö</p>
<p>‰∏éÂÖ∂‰ªñÊ≥®ÊÑèÂäõÊú∫Âà∂‰∏çÂêåÔºåTriplet Attention‰∏çËøõË°åÁª¥Â∫¶Èôç‰ΩéÂ§ÑÁêÜÔºåËøôÈÅøÂÖç‰∫ÜÂõ†ÈôçÁª¥ÂèØËÉΩÂØºËá¥ÁöÑ‰ø°ÊÅØ‰∏¢Â§±Ôºå‰øùËØÅ‰∫Ü‰ø°ÈÅì‰∏éÊùÉÈáçÈó¥ÁöÑÁõ¥Êé•ÂØπÂ∫îÂÖ≥Á≥ª„ÄÇ</p>
<p>‰ºòË¥®Ê≥®ÈáäÔºö</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-9-1"><a id="__codelineno-9-1" name="__codelineno-9-1" href="#__codelineno-9-1"></a><span class="kn">import</span><span class="w"> </span><span class="nn">torch</span>
</span><span id="__span-9-2"><a id="__codelineno-9-2" name="__codelineno-9-2" href="#__codelineno-9-2"></a><span class="kn">import</span><span class="w"> </span><span class="nn">torch.nn</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">nn</span>
</span><span id="__span-9-3"><a id="__codelineno-9-3" name="__codelineno-9-3" href="#__codelineno-9-3"></a>
</span><span id="__span-9-4"><a id="__codelineno-9-4" name="__codelineno-9-4" href="#__codelineno-9-4"></a><span class="s2">&quot;Rotate to Attend: Convolutional Triplet Attention Module&quot;</span>
</span><span id="__span-9-5"><a id="__codelineno-9-5" name="__codelineno-9-5" href="#__codelineno-9-5"></a>
</span><span id="__span-9-6"><a id="__codelineno-9-6" name="__codelineno-9-6" href="#__codelineno-9-6"></a><span class="k">class</span><span class="w"> </span><span class="nc">BasicConv</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
</span><span id="__span-9-7"><a id="__codelineno-9-7" name="__codelineno-9-7" href="#__codelineno-9-7"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">in_planes</span><span class="p">,</span> <span class="n">out_planes</span><span class="p">,</span> <span class="n">kernel_size</span><span class="p">,</span> <span class="n">stride</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">padding</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">dilation</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">groups</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">relu</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">bn</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">bias</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
</span><span id="__span-9-8"><a id="__codelineno-9-8" name="__codelineno-9-8" href="#__codelineno-9-8"></a>        <span class="nb">super</span><span class="p">(</span><span class="n">BasicConv</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
</span><span id="__span-9-9"><a id="__codelineno-9-9" name="__codelineno-9-9" href="#__codelineno-9-9"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">out_channels</span> <span class="o">=</span> <span class="n">out_planes</span>
</span><span id="__span-9-10"><a id="__codelineno-9-10" name="__codelineno-9-10" href="#__codelineno-9-10"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">conv</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Conv2d</span><span class="p">(</span><span class="n">in_planes</span><span class="p">,</span> <span class="n">out_planes</span><span class="p">,</span> <span class="n">kernel_size</span><span class="o">=</span><span class="n">kernel_size</span><span class="p">,</span> <span class="n">stride</span><span class="o">=</span><span class="n">stride</span><span class="p">,</span> <span class="n">padding</span><span class="o">=</span><span class="n">padding</span><span class="p">,</span> <span class="n">dilation</span><span class="o">=</span><span class="n">dilation</span><span class="p">,</span> <span class="n">groups</span><span class="o">=</span><span class="n">groups</span><span class="p">,</span> <span class="n">bias</span><span class="o">=</span><span class="n">bias</span><span class="p">)</span>
</span><span id="__span-9-11"><a id="__codelineno-9-11" name="__codelineno-9-11" href="#__codelineno-9-11"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">bn</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">BatchNorm2d</span><span class="p">(</span><span class="n">out_planes</span><span class="p">,</span><span class="n">eps</span><span class="o">=</span><span class="mf">1e-5</span><span class="p">,</span> <span class="n">momentum</span><span class="o">=</span><span class="mf">0.01</span><span class="p">,</span> <span class="n">affine</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="k">if</span> <span class="n">bn</span> <span class="k">else</span> <span class="kc">None</span>
</span><span id="__span-9-12"><a id="__codelineno-9-12" name="__codelineno-9-12" href="#__codelineno-9-12"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">relu</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">ReLU</span><span class="p">()</span> <span class="k">if</span> <span class="n">relu</span> <span class="k">else</span> <span class="kc">None</span>
</span><span id="__span-9-13"><a id="__codelineno-9-13" name="__codelineno-9-13" href="#__codelineno-9-13"></a>
</span><span id="__span-9-14"><a id="__codelineno-9-14" name="__codelineno-9-14" href="#__codelineno-9-14"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
</span><span id="__span-9-15"><a id="__codelineno-9-15" name="__codelineno-9-15" href="#__codelineno-9-15"></a>        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">conv</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
</span><span id="__span-9-16"><a id="__codelineno-9-16" name="__codelineno-9-16" href="#__codelineno-9-16"></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">bn</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="__span-9-17"><a id="__codelineno-9-17" name="__codelineno-9-17" href="#__codelineno-9-17"></a>            <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bn</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
</span><span id="__span-9-18"><a id="__codelineno-9-18" name="__codelineno-9-18" href="#__codelineno-9-18"></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">relu</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="__span-9-19"><a id="__codelineno-9-19" name="__codelineno-9-19" href="#__codelineno-9-19"></a>            <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">relu</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
</span><span id="__span-9-20"><a id="__codelineno-9-20" name="__codelineno-9-20" href="#__codelineno-9-20"></a>        <span class="k">return</span> <span class="n">x</span>
</span><span id="__span-9-21"><a id="__codelineno-9-21" name="__codelineno-9-21" href="#__codelineno-9-21"></a>
</span><span id="__span-9-22"><a id="__codelineno-9-22" name="__codelineno-9-22" href="#__codelineno-9-22"></a><span class="k">class</span><span class="w"> </span><span class="nc">ZPool</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
</span><span id="__span-9-23"><a id="__codelineno-9-23" name="__codelineno-9-23" href="#__codelineno-9-23"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
</span><span id="__span-9-24"><a id="__codelineno-9-24" name="__codelineno-9-24" href="#__codelineno-9-24"></a>        <span class="c1"># ‰ª•Âª∫Á´ãCW‰πãÈó¥ÁöÑ‰∫§‰∫í‰∏∫‰æã, x:(B, H, C, W)</span>
</span><span id="__span-9-25"><a id="__codelineno-9-25" name="__codelineno-9-25" href="#__codelineno-9-25"></a>        <span class="n">a</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="c1"># ÂÖ®Â±ÄÊúÄÂ§ßÊ±†Âåñ: (B, H, C, W)-&gt;(B, 1, C, W);  torch.maxËøîÂõûÁöÑÊòØÊï∞ÁªÑ:[ÊúÄÂ§ßÂÄº,ÂØπÂ∫îÁ¥¢Âºï]</span>
</span><span id="__span-9-26"><a id="__codelineno-9-26" name="__codelineno-9-26" href="#__codelineno-9-26"></a><span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
</span><span id="__span-9-27"><a id="__codelineno-9-27" name="__codelineno-9-27" href="#__codelineno-9-27"></a><span class="sd">            torch.max ËÆ°ÁÆóÂº†ÈáèÁöÑÊúÄÂ§ßÂÄº</span>
</span><span id="__span-9-28"><a id="__codelineno-9-28" name="__codelineno-9-28" href="#__codelineno-9-28"></a><span class="sd">            x ÊòØ ËæìÂÖ•Âº†Èáè</span>
</span><span id="__span-9-29"><a id="__codelineno-9-29" name="__codelineno-9-29" href="#__codelineno-9-29"></a><span class="sd">            1 ÊòØ dim ÂèÇÊï∞ÔºåË°®Á§∫Ê≤øÁùÄÁ¨¨ 1 Áª¥Â∫¶ÔºàÈÄöÂ∏∏ÊòØË°åÊñπÂêëÔºâËÆ°ÁÆóÊúÄÂ§ßÂÄº</span>
</span><span id="__span-9-30"><a id="__codelineno-9-30" name="__codelineno-9-30" href="#__codelineno-9-30"></a><span class="sd">            torch.max(x, 1) ËøîÂõû‰∏Ä‰∏™ÂÖÉÁªÑ (values, indices)ÔºåÂÖ∂‰∏≠ values ÊòØÊØèË°åÁöÑÊúÄÂ§ßÂÄºÔºåindices ÊòØÂØπÂ∫îÁöÑÁ¥¢Âºï</span>
</span><span id="__span-9-31"><a id="__codelineno-9-31" name="__codelineno-9-31" href="#__codelineno-9-31"></a><span class="sd">            [0] : [0] ÂèñÂá∫ÂÖÉÁªÑ‰∏≠ÁöÑÁ¨¨‰∏Ä‰∏™ÂÖÉÁ¥†ÔºåÂç≥ valuesÔºå‰πüÂ∞±ÊòØÊúÄÂ§ßÂÄº</span>
</span><span id="__span-9-32"><a id="__codelineno-9-32" name="__codelineno-9-32" href="#__codelineno-9-32"></a><span class="sd">            .unsqueeze(1) Âú®ÊåáÂÆöÁª¥Â∫¶‰∏äÂ¢ûÂä†‰∏Ä‰∏™Â§ßÂ∞è‰∏∫ 1 ÁöÑÁª¥Â∫¶</span>
</span><span id="__span-9-33"><a id="__codelineno-9-33" name="__codelineno-9-33" href="#__codelineno-9-33"></a><span class="sd">            values ÁöÑÂΩ¢Áä∂ÊòØ (n,)ÔºåÈÇ£‰πà values.unsqueeze(1) ÁöÑÂΩ¢Áä∂Â∞ÜÂèò‰∏∫ (n, 1)</span>
</span><span id="__span-9-34"><a id="__codelineno-9-34" name="__codelineno-9-34" href="#__codelineno-9-34"></a>
</span><span id="__span-9-35"><a id="__codelineno-9-35" name="__codelineno-9-35" href="#__codelineno-9-35"></a><span class="sd">            ÊàëÊáÇ‰∫ÜÔºåÊÉ≥Ë±°ÁöÑÊó∂ÂÄôÔºåË¶ÅÊÉ≥Êàê‰∏ÄÂº†ÂΩ©Ëâ≤ÁöÑ RGB ÂõæÔºå‰∏çË¶ÅÊÉ≥ÊàêÊï∞Ë°®ÔºåÂõ†Ê≠§ torch.max(x,1)[0]ÁöÑÂΩ¢Áä∂ÊòØ (B, 1, C, W)ÔºõÂØπ‰∫é‰∏ÄÂº†ÂõæÁâáÊù•ËØ¥Êúâ W√óC ‰∏™ÊúÄÂ§ßÂÄºÔºåÊú¨Êù•ÊòØÂΩ©Ëâ≤ÁöÑ RGB ÂõæÔºåÂèòÊàê‰∫Ü‰∏ÄÂº†ÁÅ∞Â∫¶ÂõæÔºåÊ≤øÁùÄÈÄöÈÅìÊñπÂêëÂèñÊúÄÂ§ßÂÄº</span>
</span><span id="__span-9-36"><a id="__codelineno-9-36" name="__codelineno-9-36" href="#__codelineno-9-36"></a><span class="sd">        &#39;&#39;&#39;</span>
</span><span id="__span-9-37"><a id="__codelineno-9-37" name="__codelineno-9-37" href="#__codelineno-9-37"></a>        <span class="n">b</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>   <span class="c1"># ÂÖ®Â±ÄÂπ≥ÂùáÊ±†Âåñ: (B, H, C, W)-&gt;(B, 1, C, W);</span>
</span><span id="__span-9-38"><a id="__codelineno-9-38" name="__codelineno-9-38" href="#__codelineno-9-38"></a>        <span class="n">c</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">((</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">),</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>       <span class="c1"># Âú®ÂØπÂ∫îÁª¥Â∫¶ÊãºÊé•ÊúÄÂ§ßÂíåÂπ≥ÂùáÁâπÂæÅ: (B, 2, C, W)</span>
</span><span id="__span-9-39"><a id="__codelineno-9-39" name="__codelineno-9-39" href="#__codelineno-9-39"></a>        <span class="k">return</span> <span class="n">c</span>
</span><span id="__span-9-40"><a id="__codelineno-9-40" name="__codelineno-9-40" href="#__codelineno-9-40"></a>
</span><span id="__span-9-41"><a id="__codelineno-9-41" name="__codelineno-9-41" href="#__codelineno-9-41"></a><span class="k">class</span><span class="w"> </span><span class="nc">AttentionGate</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
</span><span id="__span-9-42"><a id="__codelineno-9-42" name="__codelineno-9-42" href="#__codelineno-9-42"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="__span-9-43"><a id="__codelineno-9-43" name="__codelineno-9-43" href="#__codelineno-9-43"></a>        <span class="nb">super</span><span class="p">(</span><span class="n">AttentionGate</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
</span><span id="__span-9-44"><a id="__codelineno-9-44" name="__codelineno-9-44" href="#__codelineno-9-44"></a>        <span class="n">kernel_size</span> <span class="o">=</span> <span class="mi">7</span>
</span><span id="__span-9-45"><a id="__codelineno-9-45" name="__codelineno-9-45" href="#__codelineno-9-45"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">compress</span> <span class="o">=</span> <span class="n">ZPool</span><span class="p">()</span>
</span><span id="__span-9-46"><a id="__codelineno-9-46" name="__codelineno-9-46" href="#__codelineno-9-46"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">conv</span> <span class="o">=</span> <span class="n">BasicConv</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">kernel_size</span><span class="p">,</span> <span class="n">stride</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">padding</span><span class="o">=</span><span class="p">(</span><span class="n">kernel_size</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">//</span> <span class="mi">2</span><span class="p">,</span> <span class="n">relu</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="__span-9-47"><a id="__codelineno-9-47" name="__codelineno-9-47" href="#__codelineno-9-47"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
</span><span id="__span-9-48"><a id="__codelineno-9-48" name="__codelineno-9-48" href="#__codelineno-9-48"></a>        <span class="c1"># ‰ª•Âª∫Á´ãCW‰πãÈó¥ÁöÑ‰∫§‰∫í‰∏∫‰æã, x:(B, H, C, W)</span>
</span><span id="__span-9-49"><a id="__codelineno-9-49" name="__codelineno-9-49" href="#__codelineno-9-49"></a>        <span class="n">x_compress</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compress</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="c1"># Âú®ÂØπÂ∫îÁª¥Â∫¶‰∏äÊâßË°åÊúÄÂ§ßÊ±†ÂåñÂíåÂπ≥ÂùáÊ±†Âåñ,Âπ∂Â∞ÜÂÖ∂ÊãºÊé•: (B, H, C, W) --&gt; (B, 2, C, W);</span>
</span><span id="__span-9-50"><a id="__codelineno-9-50" name="__codelineno-9-50" href="#__codelineno-9-50"></a>        <span class="n">x_out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">conv</span><span class="p">(</span><span class="n">x_compress</span><span class="p">)</span> <span class="c1"># ÈÄöËøáconvÊìç‰ΩúÂ∞ÜÊúÄÂ§ßÊ±†ÂåñÂíåÂπ≥ÂùáÊ±†ÂåñÁâπÂæÅÊò†Â∞ÑÂà∞‰∏ÄÁª¥: (B, 2, C, W) --&gt; (B, 1, C, W);</span>
</span><span id="__span-9-51"><a id="__codelineno-9-51" name="__codelineno-9-51" href="#__codelineno-9-51"></a>        <span class="n">scale</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">sigmoid_</span><span class="p">(</span><span class="n">x_out</span><span class="p">)</span> <span class="c1"># ÈÄöËøásigmoidÂáΩÊï∞ÁîüÊàêÊùÉÈáç: (B, 1, C, W);</span>
</span><span id="__span-9-52"><a id="__codelineno-9-52" name="__codelineno-9-52" href="#__codelineno-9-52"></a>        <span class="k">return</span> <span class="n">x</span> <span class="o">*</span> <span class="n">scale</span>              <span class="c1"># ÂØπËæìÂÖ•ËøõË°åÈáçÊñ∞Âä†ÊùÉË°®Á§∫: (B, H, C, W) * (B, 1, C, W) = (B, H, C, W) ÂπøÊí≠ÔºåÂ§çÂà∂ÔºåÊ≤øÁùÄÈÄöÈÅìÊñπÂêëÂ§çÂà∂Êàê‰∏ÄÊ†∑ÁöÑ</span>
</span><span id="__span-9-53"><a id="__codelineno-9-53" name="__codelineno-9-53" href="#__codelineno-9-53"></a>
</span><span id="__span-9-54"><a id="__codelineno-9-54" name="__codelineno-9-54" href="#__codelineno-9-54"></a><span class="k">class</span><span class="w"> </span><span class="nc">TripletAttention</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
</span><span id="__span-9-55"><a id="__codelineno-9-55" name="__codelineno-9-55" href="#__codelineno-9-55"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">no_spatial</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
</span><span id="__span-9-56"><a id="__codelineno-9-56" name="__codelineno-9-56" href="#__codelineno-9-56"></a>        <span class="nb">super</span><span class="p">(</span><span class="n">TripletAttention</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
</span><span id="__span-9-57"><a id="__codelineno-9-57" name="__codelineno-9-57" href="#__codelineno-9-57"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">cw</span> <span class="o">=</span> <span class="n">AttentionGate</span><span class="p">()</span>
</span><span id="__span-9-58"><a id="__codelineno-9-58" name="__codelineno-9-58" href="#__codelineno-9-58"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">hc</span> <span class="o">=</span> <span class="n">AttentionGate</span><span class="p">()</span>
</span><span id="__span-9-59"><a id="__codelineno-9-59" name="__codelineno-9-59" href="#__codelineno-9-59"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">no_spatial</span><span class="o">=</span><span class="n">no_spatial</span>
</span><span id="__span-9-60"><a id="__codelineno-9-60" name="__codelineno-9-60" href="#__codelineno-9-60"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">no_spatial</span><span class="p">:</span>
</span><span id="__span-9-61"><a id="__codelineno-9-61" name="__codelineno-9-61" href="#__codelineno-9-61"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">hw</span> <span class="o">=</span> <span class="n">AttentionGate</span><span class="p">()</span>
</span><span id="__span-9-62"><a id="__codelineno-9-62" name="__codelineno-9-62" href="#__codelineno-9-62"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
</span><span id="__span-9-63"><a id="__codelineno-9-63" name="__codelineno-9-63" href="#__codelineno-9-63"></a>        <span class="c1"># Âª∫Á´ãCÂíåW‰πãÈó¥ÁöÑ‰∫§‰∫í:</span>
</span><span id="__span-9-64"><a id="__codelineno-9-64" name="__codelineno-9-64" href="#__codelineno-9-64"></a>        <span class="n">x_perm1</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">permute</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span><span class="o">.</span><span class="n">contiguous</span><span class="p">()</span> <span class="c1"># (B, C, H, W)--&gt; (B, H, C, W);  ÊâßË°å‚ÄúÊóãËΩ¨Êìç‰Ωú‚Äù,Âª∫Á´ãCÂíåW‰πãÈó¥ÁöÑ‰∫§‰∫í,ÊâÄ‰ª•Ë¶ÅÂú®HÁª¥Â∫¶‰∏äÂéãÁº©</span>
</span><span id="__span-9-65"><a id="__codelineno-9-65" name="__codelineno-9-65" href="#__codelineno-9-65"></a>        <span class="n">x_out1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cw</span><span class="p">(</span><span class="n">x_perm1</span><span class="p">)</span> <span class="c1"># (B, H, C, W)--&gt;(B, H, C, W);  Âú®HÁª¥Â∫¶‰∏äËøõË°åÂéãÁº©„ÄÅÊãºÊé•„ÄÅConv„ÄÅsigmoidÊìç‰Ωú, ÁÑ∂ÂêéÈÄöËøáÊùÉÈáçÈáçÊñ∞Âä†ÊùÉ</span>
</span><span id="__span-9-66"><a id="__codelineno-9-66" name="__codelineno-9-66" href="#__codelineno-9-66"></a>        <span class="n">x_out11</span> <span class="o">=</span> <span class="n">x_out1</span><span class="o">.</span><span class="n">permute</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span><span class="o">.</span><span class="n">contiguous</span><span class="p">()</span> <span class="c1"># ÊÅ¢Â§ç‰∏éËæìÂÖ•Áõ∏ÂêåÁöÑshape,‰πüÂ∞±ÊòØÈáçÊñ∞ÊóãËΩ¨ÂõûÊù•: (B, H, C, W)--&gt;(B, C, H, W)</span>
</span><span id="__span-9-67"><a id="__codelineno-9-67" name="__codelineno-9-67" href="#__codelineno-9-67"></a>
</span><span id="__span-9-68"><a id="__codelineno-9-68" name="__codelineno-9-68" href="#__codelineno-9-68"></a>        <span class="c1"># Âª∫Á´ãHÂíåC‰πãÈó¥ÁöÑ‰∫§‰∫í:</span>
</span><span id="__span-9-69"><a id="__codelineno-9-69" name="__codelineno-9-69" href="#__codelineno-9-69"></a>        <span class="n">x_perm2</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">permute</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">contiguous</span><span class="p">()</span> <span class="c1"># (B, C, H, W)--&gt; (B, W, H, C); ÊâßË°å‚ÄúÊóãËΩ¨Êìç‰Ωú‚Äù,Âª∫Á´ãHÂíåC‰πãÈó¥ÁöÑ‰∫§‰∫í,ÊâÄ‰ª•Ë¶ÅÂú®WÁª¥Â∫¶‰∏äÂéãÁº©</span>
</span><span id="__span-9-70"><a id="__codelineno-9-70" name="__codelineno-9-70" href="#__codelineno-9-70"></a>        <span class="n">x_out2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">hc</span><span class="p">(</span><span class="n">x_perm2</span><span class="p">)</span> <span class="c1"># (B, W, H, C)--&gt;(B, W, H, C);  Âú®WÁª¥Â∫¶‰∏äËøõË°åÂéãÁº©„ÄÅÊãºÊé•„ÄÅConv„ÄÅsigmoidÊìç‰Ωú, ÁÑ∂ÂêéÈÄöËøáÊùÉÈáçÈáçÊñ∞Âä†ÊùÉ</span>
</span><span id="__span-9-71"><a id="__codelineno-9-71" name="__codelineno-9-71" href="#__codelineno-9-71"></a>        <span class="n">x_out21</span> <span class="o">=</span> <span class="n">x_out2</span><span class="o">.</span><span class="n">permute</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">contiguous</span><span class="p">()</span> <span class="c1"># ÊÅ¢Â§ç‰∏éËæìÂÖ•Áõ∏ÂêåÁöÑshape,‰πüÂ∞±ÊòØÈáçÊñ∞ÊóãËΩ¨ÂõûÊù•: (B, W, H, C)--&gt;(B, C, H, W)</span>
</span><span id="__span-9-72"><a id="__codelineno-9-72" name="__codelineno-9-72" href="#__codelineno-9-72"></a>
</span><span id="__span-9-73"><a id="__codelineno-9-73" name="__codelineno-9-73" href="#__codelineno-9-73"></a>        <span class="c1"># Âª∫Á´ãHÂíåW‰πãÈó¥ÁöÑ‰∫§‰∫í:</span>
</span><span id="__span-9-74"><a id="__codelineno-9-74" name="__codelineno-9-74" href="#__codelineno-9-74"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">no_spatial</span><span class="p">:</span>
</span><span id="__span-9-75"><a id="__codelineno-9-75" name="__codelineno-9-75" href="#__codelineno-9-75"></a>            <span class="n">x_out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">hw</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="c1"># (B, C, H, W)--&gt;(B, C, H, W);  Âú®CÁª¥Â∫¶‰∏äËøõË°åÂéãÁº©„ÄÅÊãºÊé•„ÄÅConv„ÄÅsigmoidÊìç‰Ωú, ÁÑ∂ÂêéÈÄöËøáÊùÉÈáçÈáçÊñ∞Âä†ÊùÉ</span>
</span><span id="__span-9-76"><a id="__codelineno-9-76" name="__codelineno-9-76" href="#__codelineno-9-76"></a>            <span class="n">x_out</span> <span class="o">=</span> <span class="mi">1</span><span class="o">/</span><span class="mi">3</span> <span class="o">*</span> <span class="p">(</span><span class="n">x_out</span> <span class="o">+</span> <span class="n">x_out11</span> <span class="o">+</span> <span class="n">x_out21</span><span class="p">)</span> <span class="c1"># Âèñ‰∏âÈÉ®ÂàÜÁöÑÂπ≥ÂùáÂÄºËøõË°åËæìÂá∫</span>
</span><span id="__span-9-77"><a id="__codelineno-9-77" name="__codelineno-9-77" href="#__codelineno-9-77"></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="__span-9-78"><a id="__codelineno-9-78" name="__codelineno-9-78" href="#__codelineno-9-78"></a>            <span class="n">x_out</span> <span class="o">=</span> <span class="mi">1</span><span class="o">/</span><span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="n">x_out11</span> <span class="o">+</span> <span class="n">x_out21</span><span class="p">)</span>
</span><span id="__span-9-79"><a id="__codelineno-9-79" name="__codelineno-9-79" href="#__codelineno-9-79"></a>        <span class="k">return</span> <span class="n">x_out</span>
</span><span id="__span-9-80"><a id="__codelineno-9-80" name="__codelineno-9-80" href="#__codelineno-9-80"></a>
</span><span id="__span-9-81"><a id="__codelineno-9-81" name="__codelineno-9-81" href="#__codelineno-9-81"></a><span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
</span><span id="__span-9-82"><a id="__codelineno-9-82" name="__codelineno-9-82" href="#__codelineno-9-82"></a>    <span class="c1"># (B, C, H, W)</span>
</span><span id="__span-9-83"><a id="__codelineno-9-83" name="__codelineno-9-83" href="#__codelineno-9-83"></a>    <span class="nb">input</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">512</span><span class="p">,</span><span class="mi">7</span><span class="p">,</span><span class="mi">7</span><span class="p">)</span>
</span><span id="__span-9-84"><a id="__codelineno-9-84" name="__codelineno-9-84" href="#__codelineno-9-84"></a>    <span class="n">Model</span> <span class="o">=</span> <span class="n">TripletAttention</span><span class="p">()</span>
</span><span id="__span-9-85"><a id="__codelineno-9-85" name="__codelineno-9-85" href="#__codelineno-9-85"></a>    <span class="n">output</span><span class="o">=</span><span class="n">Model</span><span class="p">(</span><span class="nb">input</span><span class="p">)</span>
</span><span id="__span-9-86"><a id="__codelineno-9-86" name="__codelineno-9-86" href="#__codelineno-9-86"></a>    <span class="nb">print</span><span class="p">(</span><span class="n">output</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
</span></code></pre></div>
<p>Ê≥®Èáä</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-10-1"><a id="__codelineno-10-1" name="__codelineno-10-1" href="#__codelineno-10-1"></a><span class="kn">import</span><span class="w"> </span><span class="nn">torch</span>
</span><span id="__span-10-2"><a id="__codelineno-10-2" name="__codelineno-10-2" href="#__codelineno-10-2"></a><span class="kn">import</span><span class="w"> </span><span class="nn">torch.nn</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">nn</span>
</span><span id="__span-10-3"><a id="__codelineno-10-3" name="__codelineno-10-3" href="#__codelineno-10-3"></a>
</span><span id="__span-10-4"><a id="__codelineno-10-4" name="__codelineno-10-4" href="#__codelineno-10-4"></a><span class="c1"># ÂÆö‰πâ‰∏Ä‰∏™Âü∫Êú¨ÁöÑÂç∑ÁßØÊ®°ÂùóÔºåÂåÖÊã¨Âç∑ÁßØ„ÄÅÊâπÂΩí‰∏ÄÂåñÂíåReLUÊøÄÊ¥ª</span>
</span><span id="__span-10-5"><a id="__codelineno-10-5" name="__codelineno-10-5" href="#__codelineno-10-5"></a><span class="k">class</span><span class="w"> </span><span class="nc">BasicConv</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
</span><span id="__span-10-6"><a id="__codelineno-10-6" name="__codelineno-10-6" href="#__codelineno-10-6"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">in_planes</span><span class="p">,</span> <span class="n">out_planes</span><span class="p">,</span> <span class="n">kernel_size</span><span class="p">,</span> <span class="n">stride</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">padding</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">dilation</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">groups</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">relu</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">bn</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">bias</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
</span><span id="__span-10-7"><a id="__codelineno-10-7" name="__codelineno-10-7" href="#__codelineno-10-7"></a>        <span class="nb">super</span><span class="p">(</span><span class="n">BasicConv</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
</span><span id="__span-10-8"><a id="__codelineno-10-8" name="__codelineno-10-8" href="#__codelineno-10-8"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">out_channels</span> <span class="o">=</span> <span class="n">out_planes</span>
</span><span id="__span-10-9"><a id="__codelineno-10-9" name="__codelineno-10-9" href="#__codelineno-10-9"></a>        <span class="c1"># ÂÆö‰πâÂç∑ÁßØÂ±Ç</span>
</span><span id="__span-10-10"><a id="__codelineno-10-10" name="__codelineno-10-10" href="#__codelineno-10-10"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">conv</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Conv2d</span><span class="p">(</span><span class="n">in_planes</span><span class="p">,</span> <span class="n">out_planes</span><span class="p">,</span> <span class="n">kernel_size</span><span class="o">=</span><span class="n">kernel_size</span><span class="p">,</span> <span class="n">stride</span><span class="o">=</span><span class="n">stride</span><span class="p">,</span> <span class="n">padding</span><span class="o">=</span><span class="n">padding</span><span class="p">,</span> <span class="n">dilation</span><span class="o">=</span><span class="n">dilation</span><span class="p">,</span> <span class="n">groups</span><span class="o">=</span><span class="n">groups</span><span class="p">,</span> <span class="n">bias</span><span class="o">=</span><span class="n">bias</span><span class="p">)</span>
</span><span id="__span-10-11"><a id="__codelineno-10-11" name="__codelineno-10-11" href="#__codelineno-10-11"></a>        <span class="c1"># Êù°‰ª∂ÊÄßÂú∞Ê∑ªÂä†ÊâπÂΩí‰∏ÄÂåñÂ±Ç</span>
</span><span id="__span-10-12"><a id="__codelineno-10-12" name="__codelineno-10-12" href="#__codelineno-10-12"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">bn</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">BatchNorm2d</span><span class="p">(</span><span class="n">out_planes</span><span class="p">,</span> <span class="n">eps</span><span class="o">=</span><span class="mf">1e-5</span><span class="p">,</span> <span class="n">momentum</span><span class="o">=</span><span class="mf">0.01</span><span class="p">,</span> <span class="n">affine</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="k">if</span> <span class="n">bn</span> <span class="k">else</span> <span class="kc">None</span>
</span><span id="__span-10-13"><a id="__codelineno-10-13" name="__codelineno-10-13" href="#__codelineno-10-13"></a>        <span class="c1"># Êù°‰ª∂ÊÄßÂú∞Ê∑ªÂä†ReLUÊøÄÊ¥ªÂáΩÊï∞</span>
</span><span id="__span-10-14"><a id="__codelineno-10-14" name="__codelineno-10-14" href="#__codelineno-10-14"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">relu</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">ReLU</span><span class="p">()</span> <span class="k">if</span> <span class="n">relu</span> <span class="k">else</span> <span class="kc">None</span>
</span><span id="__span-10-15"><a id="__codelineno-10-15" name="__codelineno-10-15" href="#__codelineno-10-15"></a>
</span><span id="__span-10-16"><a id="__codelineno-10-16" name="__codelineno-10-16" href="#__codelineno-10-16"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
</span><span id="__span-10-17"><a id="__codelineno-10-17" name="__codelineno-10-17" href="#__codelineno-10-17"></a>        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">conv</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>  <span class="c1"># Â∫îÁî®Âç∑ÁßØ</span>
</span><span id="__span-10-18"><a id="__codelineno-10-18" name="__codelineno-10-18" href="#__codelineno-10-18"></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">bn</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="__span-10-19"><a id="__codelineno-10-19" name="__codelineno-10-19" href="#__codelineno-10-19"></a>            <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bn</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>  <span class="c1"># Â∫îÁî®ÊâπÂΩí‰∏ÄÂåñ</span>
</span><span id="__span-10-20"><a id="__codelineno-10-20" name="__codelineno-10-20" href="#__codelineno-10-20"></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">relu</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="__span-10-21"><a id="__codelineno-10-21" name="__codelineno-10-21" href="#__codelineno-10-21"></a>            <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">relu</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>  <span class="c1"># Â∫îÁî®ReLU</span>
</span><span id="__span-10-22"><a id="__codelineno-10-22" name="__codelineno-10-22" href="#__codelineno-10-22"></a>        <span class="k">return</span> <span class="n">x</span>
</span><span id="__span-10-23"><a id="__codelineno-10-23" name="__codelineno-10-23" href="#__codelineno-10-23"></a>
</span><span id="__span-10-24"><a id="__codelineno-10-24" name="__codelineno-10-24" href="#__codelineno-10-24"></a><span class="c1"># ÂÆö‰πâZPoolÊ®°ÂùóÔºåÁªìÂêàÊúÄÂ§ßÊ±†ÂåñÂíåÂπ≥ÂùáÊ±†ÂåñÁªìÊûú</span>
</span><span id="__span-10-25"><a id="__codelineno-10-25" name="__codelineno-10-25" href="#__codelineno-10-25"></a><span class="k">class</span><span class="w"> </span><span class="nc">ZPool</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
</span><span id="__span-10-26"><a id="__codelineno-10-26" name="__codelineno-10-26" href="#__codelineno-10-26"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
</span><span id="__span-10-27"><a id="__codelineno-10-27" name="__codelineno-10-27" href="#__codelineno-10-27"></a>        <span class="c1"># ÁªìÂêàÊúÄÂ§ßÂÄºÂíåÂπ≥ÂùáÂÄº</span>
</span><span id="__span-10-28"><a id="__codelineno-10-28" name="__codelineno-10-28" href="#__codelineno-10-28"></a>        <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">((</span><span class="n">torch</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="n">torch</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">1</span><span class="p">)),</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</span><span id="__span-10-29"><a id="__codelineno-10-29" name="__codelineno-10-29" href="#__codelineno-10-29"></a>
</span><span id="__span-10-30"><a id="__codelineno-10-30" name="__codelineno-10-30" href="#__codelineno-10-30"></a><span class="c1"># ÂÆö‰πâÊ≥®ÊÑèÂäõÈó®ÔºåÁî®‰∫éÊ†πÊçÆËæìÂÖ•ÁâπÂæÅÁîüÊàêÊ≥®ÊÑèÂäõÊùÉÈáç</span>
</span><span id="__span-10-31"><a id="__codelineno-10-31" name="__codelineno-10-31" href="#__codelineno-10-31"></a><span class="k">class</span><span class="w"> </span><span class="nc">AttentionGate</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
</span><span id="__span-10-32"><a id="__codelineno-10-32" name="__codelineno-10-32" href="#__codelineno-10-32"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="__span-10-33"><a id="__codelineno-10-33" name="__codelineno-10-33" href="#__codelineno-10-33"></a>        <span class="nb">super</span><span class="p">(</span><span class="n">AttentionGate</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
</span><span id="__span-10-34"><a id="__codelineno-10-34" name="__codelineno-10-34" href="#__codelineno-10-34"></a>        <span class="n">kernel_size</span> <span class="o">=</span> <span class="mi">7</span>  <span class="c1"># ËÆæÂÆöÂç∑ÁßØÊ†∏Â§ßÂ∞è</span>
</span><span id="__span-10-35"><a id="__codelineno-10-35" name="__codelineno-10-35" href="#__codelineno-10-35"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">compress</span> <span class="o">=</span> <span class="n">ZPool</span><span class="p">()</span>  <span class="c1"># ‰ΩøÁî®ZPoolÊ®°Âùó</span>
</span><span id="__span-10-36"><a id="__codelineno-10-36" name="__codelineno-10-36" href="#__codelineno-10-36"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">conv</span> <span class="o">=</span> <span class="n">BasicConv</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">kernel_size</span><span class="p">,</span> <span class="n">stride</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">padding</span><span class="o">=</span><span class="p">(</span><span class="n">kernel_size</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">//</span> <span class="mi">2</span><span class="p">,</span> <span class="n">relu</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>  <span class="c1"># ÈÄöËøáÂç∑ÁßØË∞ÉÊï¥ÈÄöÈÅìÊï∞</span>
</span><span id="__span-10-37"><a id="__codelineno-10-37" name="__codelineno-10-37" href="#__codelineno-10-37"></a>
</span><span id="__span-10-38"><a id="__codelineno-10-38" name="__codelineno-10-38" href="#__codelineno-10-38"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
</span><span id="__span-10-39"><a id="__codelineno-10-39" name="__codelineno-10-39" href="#__codelineno-10-39"></a>        <span class="n">x_compress</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compress</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>  <span class="c1"># Â∫îÁî®ZPool</span>
</span><span id="__span-10-40"><a id="__codelineno-10-40" name="__codelineno-10-40" href="#__codelineno-10-40"></a>        <span class="n">x_out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">conv</span><span class="p">(</span><span class="n">x_compress</span><span class="p">)</span>  <span class="c1"># ÈÄöËøáÂç∑ÁßØÁîüÊàêÊ≥®ÊÑèÂäõÊùÉÈáç</span>
</span><span id="__span-10-41"><a id="__codelineno-10-41" name="__codelineno-10-41" href="#__codelineno-10-41"></a>        <span class="n">scale</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">sigmoid_</span><span class="p">(</span><span class="n">x_out</span><span class="p">)</span>  <span class="c1"># Â∫îÁî®SigmoidÊøÄÊ¥ª</span>
</span><span id="__span-10-42"><a id="__codelineno-10-42" name="__codelineno-10-42" href="#__codelineno-10-42"></a>        <span class="k">return</span> <span class="n">x</span> <span class="o">*</span> <span class="n">scale</span>  <span class="c1"># Â∞ÜÊ≥®ÊÑèÂäõÊùÉÈáç‰πò‰ª•ÂéüÂßãÁâπÂæÅ</span>
</span><span id="__span-10-43"><a id="__codelineno-10-43" name="__codelineno-10-43" href="#__codelineno-10-43"></a>
</span><span id="__span-10-44"><a id="__codelineno-10-44" name="__codelineno-10-44" href="#__codelineno-10-44"></a><span class="c1"># ÂÆö‰πâTripletAttentionÊ®°ÂùóÔºåÁªìÂêà‰∫Ü‰∏âÁßç‰∏çÂêåÊñπÂêëÁöÑÊ≥®ÊÑèÂäõÈó®</span>
</span><span id="__span-10-45"><a id="__codelineno-10-45" name="__codelineno-10-45" href="#__codelineno-10-45"></a><span class="k">class</span><span class="w"> </span><span class="nc">TripletAttention</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
</span><span id="__span-10-46"><a id="__codelineno-10-46" name="__codelineno-10-46" href="#__codelineno-10-46"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">no_spatial</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
</span><span id="__span-10-47"><a id="__codelineno-10-47" name="__codelineno-10-47" href="#__codelineno-10-47"></a>        <span class="nb">super</span><span class="p">(</span><span class="n">TripletAttention</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
</span><span id="__span-10-48"><a id="__codelineno-10-48" name="__codelineno-10-48" href="#__codelineno-10-48"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">cw</span> <span class="o">=</span> <span class="n">AttentionGate</span><span class="p">()</span>  <span class="c1"># ÂÆö‰πâÂÆΩÂ∫¶ÊñπÂêëÁöÑÊ≥®ÊÑèÂäõÈó®</span>
</span><span id="__span-10-49"><a id="__codelineno-10-49" name="__codelineno-10-49" href="#__codelineno-10-49"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">hc</span> <span class="o">=</span> <span class="n">AttentionGate</span><span class="p">()</span>  <span class="c1"># ÂÆö‰πâÈ´òÂ∫¶ÊñπÂêëÁöÑÊ≥®ÊÑèÂäõÈó®</span>
</span><span id="__span-10-50"><a id="__codelineno-10-50" name="__codelineno-10-50" href="#__codelineno-10-50"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">no_spatial</span> <span class="o">=</span> <span class="n">no_spatial</span>  <span class="c1"># ÊòØÂê¶ÂøΩÁï•Á©∫Èó¥Ê≥®ÊÑèÂäõ</span>
</span><span id="__span-10-51"><a id="__codelineno-10-51" name="__codelineno-10-51" href="#__codelineno-10-51"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">no_spatial</span><span class="p">:</span>
</span><span id="__span-10-52"><a id="__codelineno-10-52" name="__codelineno-10-52" href="#__codelineno-10-52"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">hw</span> <span class="o">=</span> <span class="n">AttentionGate</span><span class="p">()</span>  <span class="c1"># ÂÆö‰πâÁ©∫Èó¥ÊñπÂêëÁöÑÊ≥®ÊÑèÂäõÈó®</span>
</span><span id="__span-10-53"><a id="__codelineno-10-53" name="__codelineno-10-53" href="#__codelineno-10-53"></a>
</span><span id="__span-10-54"><a id="__codelineno-10-54" name="__codelineno-10-54" href="#__codelineno-10-54"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
</span><span id="__span-10-55"><a id="__codelineno-10-55" name="__codelineno-10-55" href="#__codelineno-10-55"></a>        <span class="c1"># Â∫îÁî®Ê≥®ÊÑèÂäõÈó®Âπ∂ÁªìÂêàÁªìÊûú</span>
</span><span id="__span-10-56"><a id="__codelineno-10-56" name="__codelineno-10-56" href="#__codelineno-10-56"></a>        <span class="n">x_perm1</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">permute</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span><span class="o">.</span><span class="n">contiguous</span><span class="p">()</span>  <span class="c1"># ËΩ¨ÁΩÆ‰ª•Â∫îÁî®ÂÆΩÂ∫¶ÊñπÂêëÁöÑÊ≥®ÊÑèÂäõ</span>
</span><span id="__span-10-57"><a id="__codelineno-10-57" name="__codelineno-10-57" href="#__codelineno-10-57"></a>        <span class="n">x_out1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cw</span><span class="p">(</span><span class="n">x_perm1</span><span class="p">)</span>
</span><span id="__span-10-58"><a id="__codelineno-10-58" name="__codelineno-10-58" href="#__codelineno-10-58"></a>        <span class="n">x_out11</span> <span class="o">=</span> <span class="n">x_out1</span><span class="o">.</span><span class="n">permute</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span><span class="o">.</span><span class="n">contiguous</span><span class="p">()</span>  <span class="c1"># ËøòÂéüËΩ¨ÁΩÆ</span>
</span><span id="__span-10-59"><a id="__codelineno-10-59" name="__codelineno-10-59" href="#__codelineno-10-59"></a>        <span class="n">x_perm2</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">permute</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">contiguous</span><span class="p">()</span>  <span class="c1"># ËΩ¨ÁΩÆ‰ª•Â∫îÁî®È´òÂ∫¶ÊñπÂêëÁöÑÊ≥®ÊÑèÂäõ</span>
</span><span id="__span-10-60"><a id="__codelineno-10-60" name="__codelineno-10-60" href="#__codelineno-10-60"></a>        <span class="n">x_out2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">hc</span><span class="p">(</span><span class="n">x_perm2</span><span class="p">)</span>
</span><span id="__span-10-61"><a id="__codelineno-10-61" name="__codelineno-10-61" href="#__codelineno-10-61"></a>        <span class="n">x_out21</span> <span class="o">=</span> <span class="n">x_out2</span><span class="o">.</span><span class="n">permute</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">contiguous</span><span class="p">()</span>  <span class="c1"># ËøòÂéüËΩ¨ÁΩÆ</span>
</span><span id="__span-10-62"><a id="__codelineno-10-62" name="__codelineno-10-62" href="#__codelineno-10-62"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">no_spatial</span><span class="p">:</span>
</span><span id="__span-10-63"><a id="__codelineno-10-63" name="__codelineno-10-63" href="#__codelineno-10-63"></a>            <span class="n">x_out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">hw</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>  <span class="c1"># Â∫îÁî®Á©∫Èó¥Ê≥®ÊÑèÂäõ</span>
</span><span id="__span-10-64"><a id="__codelineno-10-64" name="__codelineno-10-64" href="#__codelineno-10-64"></a>            <span class="n">x_out</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="mi">3</span> <span class="o">*</span> <span class="p">(</span><span class="n">x_out</span> <span class="o">+</span> <span class="n">x_out11</span> <span class="o">+</span> <span class="n">x_out21</span><span class="p">)</span>  <span class="c1"># ÁªìÂêà‰∏â‰∏™ÊñπÂêëÁöÑÁªìÊûú</span>
</span><span id="__span-10-65"><a id="__codelineno-10-65" name="__codelineno-10-65" href="#__codelineno-10-65"></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="__span-10-66"><a id="__codelineno-10-66" name="__codelineno-10-66" href="#__codelineno-10-66"></a>            <span class="n">x_out</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="n">x_out11</span> <span class="o">+</span> <span class="n">x_out21</span><span class="p">)</span>  <span class="c1"># ÁªìÂêà‰∏§‰∏™ÊñπÂêëÁöÑÁªìÊûúÔºàÂ¶ÇÊûúno_spatial‰∏∫TrueÔºâ</span>
</span><span id="__span-10-67"><a id="__codelineno-10-67" name="__codelineno-10-67" href="#__codelineno-10-67"></a>        <span class="k">return</span> <span class="n">x_out</span>
</span><span id="__span-10-68"><a id="__codelineno-10-68" name="__codelineno-10-68" href="#__codelineno-10-68"></a>
</span><span id="__span-10-69"><a id="__codelineno-10-69" name="__codelineno-10-69" href="#__codelineno-10-69"></a><span class="c1"># Á§∫‰æã‰ª£Á†Å</span>
</span><span id="__span-10-70"><a id="__codelineno-10-70" name="__codelineno-10-70" href="#__codelineno-10-70"></a><span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
</span><span id="__span-10-71"><a id="__codelineno-10-71" name="__codelineno-10-71" href="#__codelineno-10-71"></a>    <span class="nb">input</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="mi">50</span><span class="p">,</span> <span class="mi">512</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">7</span><span class="p">)</span>  <span class="c1"># ÁîüÊàêÈöèÊú∫ËæìÂÖ•</span>
</span><span id="__span-10-72"><a id="__codelineno-10-72" name="__codelineno-10-72" href="#__codelineno-10-72"></a>    <span class="n">triplet</span> <span class="o">=</span> <span class="n">TripletAttention</span><span class="p">()</span>  <span class="c1"># ÂÆû‰æãÂåñTripletAttention</span>
</span><span id="__span-10-73"><a id="__codelineno-10-73" name="__codelineno-10-73" href="#__codelineno-10-73"></a>    <span class="n">output</span> <span class="o">=</span> <span class="n">triplet</span><span class="p">(</span><span class="nb">input</span><span class="p">)</span>  <span class="c1"># Â∫îÁî®TripletAttention</span>
</span><span id="__span-10-74"><a id="__codelineno-10-74" name="__codelineno-10-74" href="#__codelineno-10-74"></a>    <span class="nb">print</span><span class="p">(</span><span class="n">output</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>  <span class="c1"># ÊâìÂç∞ËæìÂá∫ÂΩ¢Áä∂</span>
</span></code></pre></div>
<h2 id="danet">‚àöDANet<a class="headerlink" href="#danet" title="Permanent link">&para;</a></h2>
<p>Ê†áÈ¢òÔºöDual Attention Network for Scene Segmentation</p>
<p>ÂèåÈáçÊ≥®ÊÑèÂäõÁΩëÁªú</p>
<p><img alt="image-20250222124748077" src="../images/image-20250222124748077.png" /></p>
<p><img alt="image-20250222124830648" src="../images/image-20250222124830648.png" /></p>
<p><img alt="image-20250222124841327" src="../images/image-20250222124841327.png" /></p>
<p>ÊàëÂ∫îËØ•‰πüÂ≠¶‰∏Ä‰∏ã Ëá™Â∑±ÁªòÂà∂ ËÆ°ÁÆóÊµÅÁ®ãÂõæ</p>
<p><img alt="image-20250222124930464" src="../images/image-20250222124930464.png" /></p>
<p><img alt="image-20250222124949328" src="../images/image-20250222124949328.png" /></p>
<p><img alt="image-20250222125003225" src="../images/image-20250222125003225.png" /></p>
<p><img alt="image-20250222125024697" src="../images/image-20250222125024697.png" /></p>
<p>‰ºòË¥®Ê≥®Èáä</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-11-1"><a id="__codelineno-11-1" name="__codelineno-11-1" href="#__codelineno-11-1"></a><span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
</span><span id="__span-11-2"><a id="__codelineno-11-2" name="__codelineno-11-2" href="#__codelineno-11-2"></a><span class="kn">import</span><span class="w"> </span><span class="nn">torch</span>
</span><span id="__span-11-3"><a id="__codelineno-11-3" name="__codelineno-11-3" href="#__codelineno-11-3"></a><span class="kn">from</span><span class="w"> </span><span class="nn">torch</span><span class="w"> </span><span class="kn">import</span> <span class="n">nn</span>
</span><span id="__span-11-4"><a id="__codelineno-11-4" name="__codelineno-11-4" href="#__codelineno-11-4"></a><span class="kn">from</span><span class="w"> </span><span class="nn">torch.nn</span><span class="w"> </span><span class="kn">import</span> <span class="n">init</span>
</span><span id="__span-11-5"><a id="__codelineno-11-5" name="__codelineno-11-5" href="#__codelineno-11-5"></a>
</span><span id="__span-11-6"><a id="__codelineno-11-6" name="__codelineno-11-6" href="#__codelineno-11-6"></a><span class="s2">&quot;Dual Attention Network for Scene Segmentation&quot;</span>
</span><span id="__span-11-7"><a id="__codelineno-11-7" name="__codelineno-11-7" href="#__codelineno-11-7"></a>
</span><span id="__span-11-8"><a id="__codelineno-11-8" name="__codelineno-11-8" href="#__codelineno-11-8"></a>
</span><span id="__span-11-9"><a id="__codelineno-11-9" name="__codelineno-11-9" href="#__codelineno-11-9"></a><span class="k">class</span><span class="w"> </span><span class="nc">ScaledDotProductAttention</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
</span><span id="__span-11-10"><a id="__codelineno-11-10" name="__codelineno-11-10" href="#__codelineno-11-10"></a><span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
</span><span id="__span-11-11"><a id="__codelineno-11-11" name="__codelineno-11-11" href="#__codelineno-11-11"></a><span class="sd">    Scaled dot-product attention</span>
</span><span id="__span-11-12"><a id="__codelineno-11-12" name="__codelineno-11-12" href="#__codelineno-11-12"></a><span class="sd">    &#39;&#39;&#39;</span>
</span><span id="__span-11-13"><a id="__codelineno-11-13" name="__codelineno-11-13" href="#__codelineno-11-13"></a>
</span><span id="__span-11-14"><a id="__codelineno-11-14" name="__codelineno-11-14" href="#__codelineno-11-14"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">d_model</span><span class="p">,</span> <span class="n">d_k</span><span class="p">,</span> <span class="n">d_v</span><span class="p">,</span> <span class="n">h</span><span class="p">,</span><span class="n">dropout</span><span class="o">=</span><span class="mf">.1</span><span class="p">):</span>
</span><span id="__span-11-15"><a id="__codelineno-11-15" name="__codelineno-11-15" href="#__codelineno-11-15"></a><span class="w">        </span><span class="sd">&#39;&#39;&#39; Ë∞ÉÁî®initÔºöself.pa=ScaledDotProductAttention(d_model,d_k=d_model,d_v=d_model,h=1)</span>
</span><span id="__span-11-16"><a id="__codelineno-11-16" name="__codelineno-11-16" href="#__codelineno-11-16"></a><span class="sd">        :param d_model: Output dimensionality of the model</span>
</span><span id="__span-11-17"><a id="__codelineno-11-17" name="__codelineno-11-17" href="#__codelineno-11-17"></a><span class="sd">        :param d_k: Dimensionality of queries and keys</span>
</span><span id="__span-11-18"><a id="__codelineno-11-18" name="__codelineno-11-18" href="#__codelineno-11-18"></a><span class="sd">        :param d_v: Dimensionality of values</span>
</span><span id="__span-11-19"><a id="__codelineno-11-19" name="__codelineno-11-19" href="#__codelineno-11-19"></a><span class="sd">        :param h: Number of heads  ‰πüËÆ∏ÊàëÂÖ≥‰∫é QKV ÁöÑÁêÜËß£ÊúâËØØÔºönd ///  n_q√ód_q . d_q √ó n_k . n_k √ó d_v</span>
</span><span id="__span-11-20"><a id="__codelineno-11-20" name="__codelineno-11-20" href="#__codelineno-11-20"></a><span class="sd">        &#39;&#39;&#39;</span>
</span><span id="__span-11-21"><a id="__codelineno-11-21" name="__codelineno-11-21" href="#__codelineno-11-21"></a>        <span class="nb">super</span><span class="p">(</span><span class="n">ScaledDotProductAttention</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
</span><span id="__span-11-22"><a id="__codelineno-11-22" name="__codelineno-11-22" href="#__codelineno-11-22"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">fc_q</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="n">d_model</span><span class="p">,</span> <span class="n">h</span> <span class="o">*</span> <span class="n">d_k</span><span class="p">)</span>
</span><span id="__span-11-23"><a id="__codelineno-11-23" name="__codelineno-11-23" href="#__codelineno-11-23"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">fc_k</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="n">d_model</span><span class="p">,</span> <span class="n">h</span> <span class="o">*</span> <span class="n">d_k</span><span class="p">)</span>
</span><span id="__span-11-24"><a id="__codelineno-11-24" name="__codelineno-11-24" href="#__codelineno-11-24"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">fc_v</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="n">d_model</span><span class="p">,</span> <span class="n">h</span> <span class="o">*</span> <span class="n">d_v</span><span class="p">)</span>
</span><span id="__span-11-25"><a id="__codelineno-11-25" name="__codelineno-11-25" href="#__codelineno-11-25"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">fc_o</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="n">h</span> <span class="o">*</span> <span class="n">d_v</span><span class="p">,</span> <span class="n">d_model</span><span class="p">)</span>
</span><span id="__span-11-26"><a id="__codelineno-11-26" name="__codelineno-11-26" href="#__codelineno-11-26"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">dropout</span><span class="o">=</span><span class="n">nn</span><span class="o">.</span><span class="n">Dropout</span><span class="p">(</span><span class="n">dropout</span><span class="p">)</span>
</span><span id="__span-11-27"><a id="__codelineno-11-27" name="__codelineno-11-27" href="#__codelineno-11-27"></a>
</span><span id="__span-11-28"><a id="__codelineno-11-28" name="__codelineno-11-28" href="#__codelineno-11-28"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">d_model</span> <span class="o">=</span> <span class="n">d_model</span>
</span><span id="__span-11-29"><a id="__codelineno-11-29" name="__codelineno-11-29" href="#__codelineno-11-29"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">d_k</span> <span class="o">=</span> <span class="n">d_k</span>
</span><span id="__span-11-30"><a id="__codelineno-11-30" name="__codelineno-11-30" href="#__codelineno-11-30"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">d_v</span> <span class="o">=</span> <span class="n">d_v</span>
</span><span id="__span-11-31"><a id="__codelineno-11-31" name="__codelineno-11-31" href="#__codelineno-11-31"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">h</span> <span class="o">=</span> <span class="n">h</span>
</span><span id="__span-11-32"><a id="__codelineno-11-32" name="__codelineno-11-32" href="#__codelineno-11-32"></a>
</span><span id="__span-11-33"><a id="__codelineno-11-33" name="__codelineno-11-33" href="#__codelineno-11-33"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">init_weights</span><span class="p">()</span>
</span><span id="__span-11-34"><a id="__codelineno-11-34" name="__codelineno-11-34" href="#__codelineno-11-34"></a>
</span><span id="__span-11-35"><a id="__codelineno-11-35" name="__codelineno-11-35" href="#__codelineno-11-35"></a>
</span><span id="__span-11-36"><a id="__codelineno-11-36" name="__codelineno-11-36" href="#__codelineno-11-36"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">init_weights</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="__span-11-37"><a id="__codelineno-11-37" name="__codelineno-11-37" href="#__codelineno-11-37"></a>        <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">modules</span><span class="p">():</span>
</span><span id="__span-11-38"><a id="__codelineno-11-38" name="__codelineno-11-38" href="#__codelineno-11-38"></a>            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">nn</span><span class="o">.</span><span class="n">Conv2d</span><span class="p">):</span>
</span><span id="__span-11-39"><a id="__codelineno-11-39" name="__codelineno-11-39" href="#__codelineno-11-39"></a>                <span class="n">init</span><span class="o">.</span><span class="n">kaiming_normal_</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">weight</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;fan_out&#39;</span><span class="p">)</span>
</span><span id="__span-11-40"><a id="__codelineno-11-40" name="__codelineno-11-40" href="#__codelineno-11-40"></a>                <span class="k">if</span> <span class="n">m</span><span class="o">.</span><span class="n">bias</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="__span-11-41"><a id="__codelineno-11-41" name="__codelineno-11-41" href="#__codelineno-11-41"></a>                    <span class="n">init</span><span class="o">.</span><span class="n">constant_</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">bias</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
</span><span id="__span-11-42"><a id="__codelineno-11-42" name="__codelineno-11-42" href="#__codelineno-11-42"></a>            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">nn</span><span class="o">.</span><span class="n">BatchNorm2d</span><span class="p">):</span>
</span><span id="__span-11-43"><a id="__codelineno-11-43" name="__codelineno-11-43" href="#__codelineno-11-43"></a>                <span class="n">init</span><span class="o">.</span><span class="n">constant_</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">weight</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
</span><span id="__span-11-44"><a id="__codelineno-11-44" name="__codelineno-11-44" href="#__codelineno-11-44"></a>                <span class="n">init</span><span class="o">.</span><span class="n">constant_</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">bias</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
</span><span id="__span-11-45"><a id="__codelineno-11-45" name="__codelineno-11-45" href="#__codelineno-11-45"></a>            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">):</span>
</span><span id="__span-11-46"><a id="__codelineno-11-46" name="__codelineno-11-46" href="#__codelineno-11-46"></a>                <span class="n">init</span><span class="o">.</span><span class="n">normal_</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">weight</span><span class="p">,</span> <span class="n">std</span><span class="o">=</span><span class="mf">0.001</span><span class="p">)</span>
</span><span id="__span-11-47"><a id="__codelineno-11-47" name="__codelineno-11-47" href="#__codelineno-11-47"></a>                <span class="k">if</span> <span class="n">m</span><span class="o">.</span><span class="n">bias</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="__span-11-48"><a id="__codelineno-11-48" name="__codelineno-11-48" href="#__codelineno-11-48"></a>                    <span class="n">init</span><span class="o">.</span><span class="n">constant_</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">bias</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
</span><span id="__span-11-49"><a id="__codelineno-11-49" name="__codelineno-11-49" href="#__codelineno-11-49"></a>
</span><span id="__span-11-50"><a id="__codelineno-11-50" name="__codelineno-11-50" href="#__codelineno-11-50"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">queries</span><span class="p">,</span> <span class="n">keys</span><span class="p">,</span> <span class="n">values</span><span class="p">,</span> <span class="n">attention_mask</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">attention_weights</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
</span><span id="__span-11-51"><a id="__codelineno-11-51" name="__codelineno-11-51" href="#__codelineno-11-51"></a><span class="w">        </span><span class="sd">&#39;&#39;&#39;ËøôÈáåÁöÑË∞ÉÁî® y=B,N(HW),C ‚Üí y=self.pa(y,y,y) ‚Üí self.pa=ScaledDotProductAttention(d_model,d_k=d_model,d_v=d_model,h=1)</span>
</span><span id="__span-11-52"><a id="__codelineno-11-52" name="__codelineno-11-52" href="#__codelineno-11-52"></a><span class="sd">        Computes</span>
</span><span id="__span-11-53"><a id="__codelineno-11-53" name="__codelineno-11-53" href="#__codelineno-11-53"></a><span class="sd">        :param queries: Queries (b_s, nq, d_model) == (B,N,C)</span>
</span><span id="__span-11-54"><a id="__codelineno-11-54" name="__codelineno-11-54" href="#__codelineno-11-54"></a><span class="sd">        :param keys: Keys (b_s, nk, d_model) == (B,N,C)</span>
</span><span id="__span-11-55"><a id="__codelineno-11-55" name="__codelineno-11-55" href="#__codelineno-11-55"></a><span class="sd">        :param values: Values (b_s, nk, d_model) == (B,N,C)</span>
</span><span id="__span-11-56"><a id="__codelineno-11-56" name="__codelineno-11-56" href="#__codelineno-11-56"></a><span class="sd">        :param attention_mask: Mask over attention values (b_s, h, nq, nk); C=h*nk. True indicates masking.</span>
</span><span id="__span-11-57"><a id="__codelineno-11-57" name="__codelineno-11-57" href="#__codelineno-11-57"></a><span class="sd">        :param attention_weights: Multiplicative weights for attention values (b_s, h, nq, nk).</span>
</span><span id="__span-11-58"><a id="__codelineno-11-58" name="__codelineno-11-58" href="#__codelineno-11-58"></a><span class="sd">        :return:</span>
</span><span id="__span-11-59"><a id="__codelineno-11-59" name="__codelineno-11-59" href="#__codelineno-11-59"></a><span class="sd">        &#39;&#39;&#39;</span>
</span><span id="__span-11-60"><a id="__codelineno-11-60" name="__codelineno-11-60" href="#__codelineno-11-60"></a>        <span class="n">b_s</span><span class="p">,</span> <span class="n">nq</span> <span class="o">=</span> <span class="n">queries</span><span class="o">.</span><span class="n">shape</span><span class="p">[:</span><span class="mi">2</span><span class="p">]</span> <span class="c1"># n_q ÊòØ query ÁöÑÂ∫èÂàóÈïøÂ∫¶</span>
</span><span id="__span-11-61"><a id="__codelineno-11-61" name="__codelineno-11-61" href="#__codelineno-11-61"></a>        <span class="n">nk</span> <span class="o">=</span> <span class="n">keys</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="c1"># n_k key Âíå value ÁöÑÂ∫èÂàóÈïøÂ∫¶=ÂÉèÁ¥†‰∏™Êï∞=HWÔºõÂÜçÊ¨°Âº∫Ë∞ÉÔºåQKV ÂµåÂÖ•Áª¥Â∫¶Áõ∏ÂêåÔºåÂ∫èÂàóÈïøÂ∫¶ÂèØ‰ª•‰∏çÂêå</span>
</span><span id="__span-11-62"><a id="__codelineno-11-62" name="__codelineno-11-62" href="#__codelineno-11-62"></a>
</span><span id="__span-11-63"><a id="__codelineno-11-63" name="__codelineno-11-63" href="#__codelineno-11-63"></a>        <span class="c1"># Ê≥®ÊÑèÂäõ‰∏éÂç∑ÁßØÁõ∏ÁªìÂêàÊòØÊàëÁöÑ‰∏çÊòéÁôΩ</span>
</span><span id="__span-11-64"><a id="__codelineno-11-64" name="__codelineno-11-64" href="#__codelineno-11-64"></a>        <span class="c1"># QK^TV Q n1√ód K=V n2√ód </span>
</span><span id="__span-11-65"><a id="__codelineno-11-65" name="__codelineno-11-65" href="#__codelineno-11-65"></a>        <span class="c1"># QÁöÑÊù•Ê∫êÂèØ‰ª•Âíå KV ‰∏çÂêåÔºåKV ÁöÑÊù•Ê∫ê shape ÂøÖÈ°ª‰∏ÄÊ†∑Ôºå‰ΩÜÊòØÂµåÂÖ•Á©∫Èó¥ÂøÖÈ°ª‰∏ÄËá¥</span>
</span><span id="__span-11-66"><a id="__codelineno-11-66" name="__codelineno-11-66" href="#__codelineno-11-66"></a>        <span class="c1"># n1√ód . d√ón2 . n2√ód = n1√ód</span>
</span><span id="__span-11-67"><a id="__codelineno-11-67" name="__codelineno-11-67" href="#__codelineno-11-67"></a>
</span><span id="__span-11-68"><a id="__codelineno-11-68" name="__codelineno-11-68" href="#__codelineno-11-68"></a>        <span class="n">q</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fc_q</span><span class="p">(</span><span class="n">queries</span><span class="p">)</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="n">b_s</span><span class="p">,</span> <span class="n">nq</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">h</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">d_k</span><span class="p">)</span><span class="o">.</span><span class="n">permute</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>  <span class="c1"># (b_s, h, nq, d_k) ÂÖ∂ÂÆûËøôÈáåÁöÑd_k ÂµåÂÖ•Áª¥Â∫¶ Â∫îËØ•ÊòØ embedding_dim//h Âõ†‰∏∫ head=1ÔºåÊâÄ‰ª•ËøôÈáåÁöÑ  d_k = embedding_dim // ‚Üí self.fc_q = nn.Linear(d_model, h * d_k) ‚Üí self.pa=ScaledDotProductAttention(d_model,d_k=d_model,d_v=d_model,h=1) </span>
</span><span id="__span-11-69"><a id="__codelineno-11-69" name="__codelineno-11-69" href="#__codelineno-11-69"></a>        <span class="n">k</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fc_k</span><span class="p">(</span><span class="n">keys</span><span class="p">)</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="n">b_s</span><span class="p">,</span> <span class="n">nk</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">h</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">d_k</span><span class="p">)</span><span class="o">.</span><span class="n">permute</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>  <span class="c1"># (b_s, h, d_k, nk)</span>
</span><span id="__span-11-70"><a id="__codelineno-11-70" name="__codelineno-11-70" href="#__codelineno-11-70"></a>        <span class="n">v</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fc_v</span><span class="p">(</span><span class="n">values</span><span class="p">)</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="n">b_s</span><span class="p">,</span> <span class="n">nk</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">h</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">d_v</span><span class="p">)</span><span class="o">.</span><span class="n">permute</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>  <span class="c1"># (b_s, h, nk, d_v) ËøôÂá†‰∏™ÂΩ¢Áä∂ÁöÑÊ≥®ÈáäÂæàÂáÜÁ°ÆÔºåÁîöËá≥ËøáÂàÜÂáÜÁ°Æ‰∫Ü</span>
</span><span id="__span-11-71"><a id="__codelineno-11-71" name="__codelineno-11-71" href="#__codelineno-11-71"></a>
</span><span id="__span-11-72"><a id="__codelineno-11-72" name="__codelineno-11-72" href="#__codelineno-11-72"></a>        <span class="n">att</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">matmul</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">d_k</span><span class="p">)</span>  <span class="c1"># (b_s, h, nq, nk)</span>
</span><span id="__span-11-73"><a id="__codelineno-11-73" name="__codelineno-11-73" href="#__codelineno-11-73"></a>        <span class="k">if</span> <span class="n">attention_weights</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="__span-11-74"><a id="__codelineno-11-74" name="__codelineno-11-74" href="#__codelineno-11-74"></a>            <span class="n">att</span> <span class="o">=</span> <span class="n">att</span> <span class="o">*</span> <span class="n">attention_weights</span>
</span><span id="__span-11-75"><a id="__codelineno-11-75" name="__codelineno-11-75" href="#__codelineno-11-75"></a>        <span class="k">if</span> <span class="n">attention_mask</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="__span-11-76"><a id="__codelineno-11-76" name="__codelineno-11-76" href="#__codelineno-11-76"></a>            <span class="n">att</span> <span class="o">=</span> <span class="n">att</span><span class="o">.</span><span class="n">masked_fill</span><span class="p">(</span><span class="n">attention_mask</span><span class="p">,</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">)</span>
</span><span id="__span-11-77"><a id="__codelineno-11-77" name="__codelineno-11-77" href="#__codelineno-11-77"></a>        <span class="n">att</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">softmax</span><span class="p">(</span><span class="n">att</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
</span><span id="__span-11-78"><a id="__codelineno-11-78" name="__codelineno-11-78" href="#__codelineno-11-78"></a>        <span class="n">att</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dropout</span><span class="p">(</span><span class="n">att</span><span class="p">)</span>
</span><span id="__span-11-79"><a id="__codelineno-11-79" name="__codelineno-11-79" href="#__codelineno-11-79"></a>
</span><span id="__span-11-80"><a id="__codelineno-11-80" name="__codelineno-11-80" href="#__codelineno-11-80"></a>        <span class="n">out</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">matmul</span><span class="p">(</span><span class="n">att</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span><span class="o">.</span><span class="n">permute</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span><span class="o">.</span><span class="n">contiguous</span><span class="p">()</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="n">b_s</span><span class="p">,</span> <span class="n">nq</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">h</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">d_v</span><span class="p">)</span>  <span class="c1"># (b_s, nq, h*d_v)</span>
</span><span id="__span-11-81"><a id="__codelineno-11-81" name="__codelineno-11-81" href="#__codelineno-11-81"></a>        <span class="n">out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fc_o</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>  <span class="c1"># (b_s, nq, d_model) ÂÜçÊääÂµåÂÖ•Áª¥Â∫¶ÈôçÂõûÂéª ÊÅ¢Â§çÂéüÊù•ÁöÑÂµåÂÖ•Áª¥Â∫¶</span>
</span><span id="__span-11-82"><a id="__codelineno-11-82" name="__codelineno-11-82" href="#__codelineno-11-82"></a>        <span class="k">return</span> <span class="n">out</span>
</span><span id="__span-11-83"><a id="__codelineno-11-83" name="__codelineno-11-83" href="#__codelineno-11-83"></a>
</span><span id="__span-11-84"><a id="__codelineno-11-84" name="__codelineno-11-84" href="#__codelineno-11-84"></a>
</span><span id="__span-11-85"><a id="__codelineno-11-85" name="__codelineno-11-85" href="#__codelineno-11-85"></a><span class="k">class</span><span class="w"> </span><span class="nc">SimplifiedScaledDotProductAttention</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
</span><span id="__span-11-86"><a id="__codelineno-11-86" name="__codelineno-11-86" href="#__codelineno-11-86"></a><span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
</span><span id="__span-11-87"><a id="__codelineno-11-87" name="__codelineno-11-87" href="#__codelineno-11-87"></a><span class="sd">    Scaled dot-product attention</span>
</span><span id="__span-11-88"><a id="__codelineno-11-88" name="__codelineno-11-88" href="#__codelineno-11-88"></a><span class="sd">    &#39;&#39;&#39;</span>
</span><span id="__span-11-89"><a id="__codelineno-11-89" name="__codelineno-11-89" href="#__codelineno-11-89"></a>
</span><span id="__span-11-90"><a id="__codelineno-11-90" name="__codelineno-11-90" href="#__codelineno-11-90"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">d_model</span><span class="p">,</span> <span class="n">h</span><span class="p">,</span><span class="n">dropout</span><span class="o">=</span><span class="mf">.1</span><span class="p">):</span>
</span><span id="__span-11-91"><a id="__codelineno-11-91" name="__codelineno-11-91" href="#__codelineno-11-91"></a><span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
</span><span id="__span-11-92"><a id="__codelineno-11-92" name="__codelineno-11-92" href="#__codelineno-11-92"></a><span class="sd">        :param d_model: Output dimensionality of the model</span>
</span><span id="__span-11-93"><a id="__codelineno-11-93" name="__codelineno-11-93" href="#__codelineno-11-93"></a><span class="sd">        :param d_k: Dimensionality of queries and keys</span>
</span><span id="__span-11-94"><a id="__codelineno-11-94" name="__codelineno-11-94" href="#__codelineno-11-94"></a><span class="sd">        :param d_v: Dimensionality of values</span>
</span><span id="__span-11-95"><a id="__codelineno-11-95" name="__codelineno-11-95" href="#__codelineno-11-95"></a><span class="sd">        :param h: Number of heads</span>
</span><span id="__span-11-96"><a id="__codelineno-11-96" name="__codelineno-11-96" href="#__codelineno-11-96"></a><span class="sd">        &#39;&#39;&#39;</span>
</span><span id="__span-11-97"><a id="__codelineno-11-97" name="__codelineno-11-97" href="#__codelineno-11-97"></a>        <span class="nb">super</span><span class="p">(</span><span class="n">SimplifiedScaledDotProductAttention</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
</span><span id="__span-11-98"><a id="__codelineno-11-98" name="__codelineno-11-98" href="#__codelineno-11-98"></a>
</span><span id="__span-11-99"><a id="__codelineno-11-99" name="__codelineno-11-99" href="#__codelineno-11-99"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">d_model</span> <span class="o">=</span> <span class="n">d_model</span>
</span><span id="__span-11-100"><a id="__codelineno-11-100" name="__codelineno-11-100" href="#__codelineno-11-100"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">d_k</span> <span class="o">=</span> <span class="n">d_model</span><span class="o">//</span><span class="n">h</span>
</span><span id="__span-11-101"><a id="__codelineno-11-101" name="__codelineno-11-101" href="#__codelineno-11-101"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">d_v</span> <span class="o">=</span> <span class="n">d_model</span><span class="o">//</span><span class="n">h</span>
</span><span id="__span-11-102"><a id="__codelineno-11-102" name="__codelineno-11-102" href="#__codelineno-11-102"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">h</span> <span class="o">=</span> <span class="n">h</span>
</span><span id="__span-11-103"><a id="__codelineno-11-103" name="__codelineno-11-103" href="#__codelineno-11-103"></a>
</span><span id="__span-11-104"><a id="__codelineno-11-104" name="__codelineno-11-104" href="#__codelineno-11-104"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">fc_o</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="n">h</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">d_v</span><span class="p">,</span> <span class="n">d_model</span><span class="p">)</span>
</span><span id="__span-11-105"><a id="__codelineno-11-105" name="__codelineno-11-105" href="#__codelineno-11-105"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">dropout</span><span class="o">=</span><span class="n">nn</span><span class="o">.</span><span class="n">Dropout</span><span class="p">(</span><span class="n">dropout</span><span class="p">)</span>
</span><span id="__span-11-106"><a id="__codelineno-11-106" name="__codelineno-11-106" href="#__codelineno-11-106"></a>
</span><span id="__span-11-107"><a id="__codelineno-11-107" name="__codelineno-11-107" href="#__codelineno-11-107"></a>
</span><span id="__span-11-108"><a id="__codelineno-11-108" name="__codelineno-11-108" href="#__codelineno-11-108"></a>
</span><span id="__span-11-109"><a id="__codelineno-11-109" name="__codelineno-11-109" href="#__codelineno-11-109"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">init_weights</span><span class="p">()</span>
</span><span id="__span-11-110"><a id="__codelineno-11-110" name="__codelineno-11-110" href="#__codelineno-11-110"></a>
</span><span id="__span-11-111"><a id="__codelineno-11-111" name="__codelineno-11-111" href="#__codelineno-11-111"></a>
</span><span id="__span-11-112"><a id="__codelineno-11-112" name="__codelineno-11-112" href="#__codelineno-11-112"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">init_weights</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="__span-11-113"><a id="__codelineno-11-113" name="__codelineno-11-113" href="#__codelineno-11-113"></a>        <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">modules</span><span class="p">():</span>
</span><span id="__span-11-114"><a id="__codelineno-11-114" name="__codelineno-11-114" href="#__codelineno-11-114"></a>            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">nn</span><span class="o">.</span><span class="n">Conv2d</span><span class="p">):</span>
</span><span id="__span-11-115"><a id="__codelineno-11-115" name="__codelineno-11-115" href="#__codelineno-11-115"></a>                <span class="n">init</span><span class="o">.</span><span class="n">kaiming_normal_</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">weight</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;fan_out&#39;</span><span class="p">)</span>
</span><span id="__span-11-116"><a id="__codelineno-11-116" name="__codelineno-11-116" href="#__codelineno-11-116"></a>                <span class="k">if</span> <span class="n">m</span><span class="o">.</span><span class="n">bias</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="__span-11-117"><a id="__codelineno-11-117" name="__codelineno-11-117" href="#__codelineno-11-117"></a>                    <span class="n">init</span><span class="o">.</span><span class="n">constant_</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">bias</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
</span><span id="__span-11-118"><a id="__codelineno-11-118" name="__codelineno-11-118" href="#__codelineno-11-118"></a>            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">nn</span><span class="o">.</span><span class="n">BatchNorm2d</span><span class="p">):</span>
</span><span id="__span-11-119"><a id="__codelineno-11-119" name="__codelineno-11-119" href="#__codelineno-11-119"></a>                <span class="n">init</span><span class="o">.</span><span class="n">constant_</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">weight</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
</span><span id="__span-11-120"><a id="__codelineno-11-120" name="__codelineno-11-120" href="#__codelineno-11-120"></a>                <span class="n">init</span><span class="o">.</span><span class="n">constant_</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">bias</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
</span><span id="__span-11-121"><a id="__codelineno-11-121" name="__codelineno-11-121" href="#__codelineno-11-121"></a>            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">):</span>
</span><span id="__span-11-122"><a id="__codelineno-11-122" name="__codelineno-11-122" href="#__codelineno-11-122"></a>                <span class="n">init</span><span class="o">.</span><span class="n">normal_</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">weight</span><span class="p">,</span> <span class="n">std</span><span class="o">=</span><span class="mf">0.001</span><span class="p">)</span>
</span><span id="__span-11-123"><a id="__codelineno-11-123" name="__codelineno-11-123" href="#__codelineno-11-123"></a>                <span class="k">if</span> <span class="n">m</span><span class="o">.</span><span class="n">bias</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="__span-11-124"><a id="__codelineno-11-124" name="__codelineno-11-124" href="#__codelineno-11-124"></a>                    <span class="n">init</span><span class="o">.</span><span class="n">constant_</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">bias</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
</span><span id="__span-11-125"><a id="__codelineno-11-125" name="__codelineno-11-125" href="#__codelineno-11-125"></a>
</span><span id="__span-11-126"><a id="__codelineno-11-126" name="__codelineno-11-126" href="#__codelineno-11-126"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">queries</span><span class="p">,</span> <span class="n">keys</span><span class="p">,</span> <span class="n">values</span><span class="p">,</span> <span class="n">attention_mask</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">attention_weights</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
</span><span id="__span-11-127"><a id="__codelineno-11-127" name="__codelineno-11-127" href="#__codelineno-11-127"></a><span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
</span><span id="__span-11-128"><a id="__codelineno-11-128" name="__codelineno-11-128" href="#__codelineno-11-128"></a><span class="sd">        Computes</span>
</span><span id="__span-11-129"><a id="__codelineno-11-129" name="__codelineno-11-129" href="#__codelineno-11-129"></a><span class="sd">        :param queries: Queries (b_s, nq, d_model)</span>
</span><span id="__span-11-130"><a id="__codelineno-11-130" name="__codelineno-11-130" href="#__codelineno-11-130"></a><span class="sd">        :param keys: Keys (b_s, nk, d_model)</span>
</span><span id="__span-11-131"><a id="__codelineno-11-131" name="__codelineno-11-131" href="#__codelineno-11-131"></a><span class="sd">        :param values: Values (b_s, nk, d_model)</span>
</span><span id="__span-11-132"><a id="__codelineno-11-132" name="__codelineno-11-132" href="#__codelineno-11-132"></a><span class="sd">        :param attention_mask: Mask over attention values (b_s, h, nq, nk). True indicates masking.</span>
</span><span id="__span-11-133"><a id="__codelineno-11-133" name="__codelineno-11-133" href="#__codelineno-11-133"></a><span class="sd">        :param attention_weights: Multiplicative weights for attention values (b_s, h, nq, nk).</span>
</span><span id="__span-11-134"><a id="__codelineno-11-134" name="__codelineno-11-134" href="#__codelineno-11-134"></a><span class="sd">        :return:</span>
</span><span id="__span-11-135"><a id="__codelineno-11-135" name="__codelineno-11-135" href="#__codelineno-11-135"></a><span class="sd">        &#39;&#39;&#39;</span>
</span><span id="__span-11-136"><a id="__codelineno-11-136" name="__codelineno-11-136" href="#__codelineno-11-136"></a>        <span class="n">b_s</span><span class="p">,</span> <span class="n">nq</span> <span class="o">=</span> <span class="n">queries</span><span class="o">.</span><span class="n">shape</span><span class="p">[:</span><span class="mi">2</span><span class="p">]</span>
</span><span id="__span-11-137"><a id="__codelineno-11-137" name="__codelineno-11-137" href="#__codelineno-11-137"></a>        <span class="n">nk</span> <span class="o">=</span> <span class="n">keys</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</span><span id="__span-11-138"><a id="__codelineno-11-138" name="__codelineno-11-138" href="#__codelineno-11-138"></a>
</span><span id="__span-11-139"><a id="__codelineno-11-139" name="__codelineno-11-139" href="#__codelineno-11-139"></a>        <span class="n">q</span> <span class="o">=</span> <span class="n">queries</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="n">b_s</span><span class="p">,</span> <span class="n">nq</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">h</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">d_k</span><span class="p">)</span><span class="o">.</span><span class="n">permute</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>  <span class="c1"># (b_s, h, nq, d_k)</span>
</span><span id="__span-11-140"><a id="__codelineno-11-140" name="__codelineno-11-140" href="#__codelineno-11-140"></a>        <span class="n">k</span> <span class="o">=</span> <span class="n">keys</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="n">b_s</span><span class="p">,</span> <span class="n">nk</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">h</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">d_k</span><span class="p">)</span><span class="o">.</span><span class="n">permute</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>  <span class="c1"># (b_s, h, d_k, nk)</span>
</span><span id="__span-11-141"><a id="__codelineno-11-141" name="__codelineno-11-141" href="#__codelineno-11-141"></a>        <span class="n">v</span> <span class="o">=</span> <span class="n">values</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="n">b_s</span><span class="p">,</span> <span class="n">nk</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">h</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">d_v</span><span class="p">)</span><span class="o">.</span><span class="n">permute</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>  <span class="c1"># (b_s, h, nk, d_v)</span>
</span><span id="__span-11-142"><a id="__codelineno-11-142" name="__codelineno-11-142" href="#__codelineno-11-142"></a>
</span><span id="__span-11-143"><a id="__codelineno-11-143" name="__codelineno-11-143" href="#__codelineno-11-143"></a>        <span class="n">att</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">matmul</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">d_k</span><span class="p">)</span>  <span class="c1"># (b_s, h, nq, nk)</span>
</span><span id="__span-11-144"><a id="__codelineno-11-144" name="__codelineno-11-144" href="#__codelineno-11-144"></a>        <span class="k">if</span> <span class="n">attention_weights</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="__span-11-145"><a id="__codelineno-11-145" name="__codelineno-11-145" href="#__codelineno-11-145"></a>            <span class="n">att</span> <span class="o">=</span> <span class="n">att</span> <span class="o">*</span> <span class="n">attention_weights</span>
</span><span id="__span-11-146"><a id="__codelineno-11-146" name="__codelineno-11-146" href="#__codelineno-11-146"></a>        <span class="k">if</span> <span class="n">attention_mask</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="__span-11-147"><a id="__codelineno-11-147" name="__codelineno-11-147" href="#__codelineno-11-147"></a>            <span class="n">att</span> <span class="o">=</span> <span class="n">att</span><span class="o">.</span><span class="n">masked_fill</span><span class="p">(</span><span class="n">attention_mask</span><span class="p">,</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">)</span>
</span><span id="__span-11-148"><a id="__codelineno-11-148" name="__codelineno-11-148" href="#__codelineno-11-148"></a>        <span class="n">att</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">softmax</span><span class="p">(</span><span class="n">att</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
</span><span id="__span-11-149"><a id="__codelineno-11-149" name="__codelineno-11-149" href="#__codelineno-11-149"></a>        <span class="n">att</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dropout</span><span class="p">(</span><span class="n">att</span><span class="p">)</span>
</span><span id="__span-11-150"><a id="__codelineno-11-150" name="__codelineno-11-150" href="#__codelineno-11-150"></a>
</span><span id="__span-11-151"><a id="__codelineno-11-151" name="__codelineno-11-151" href="#__codelineno-11-151"></a>        <span class="n">out</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">matmul</span><span class="p">(</span><span class="n">att</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span><span class="o">.</span><span class="n">permute</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span><span class="o">.</span><span class="n">contiguous</span><span class="p">()</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="n">b_s</span><span class="p">,</span> <span class="n">nq</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">h</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">d_v</span><span class="p">)</span>  <span class="c1"># (b_s, nq, h*d_v)</span>
</span><span id="__span-11-152"><a id="__codelineno-11-152" name="__codelineno-11-152" href="#__codelineno-11-152"></a>        <span class="n">out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fc_o</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>  <span class="c1"># (b_s, nq, d_model)</span>
</span><span id="__span-11-153"><a id="__codelineno-11-153" name="__codelineno-11-153" href="#__codelineno-11-153"></a>        <span class="k">return</span> <span class="n">out</span>
</span><span id="__span-11-154"><a id="__codelineno-11-154" name="__codelineno-11-154" href="#__codelineno-11-154"></a>
</span><span id="__span-11-155"><a id="__codelineno-11-155" name="__codelineno-11-155" href="#__codelineno-11-155"></a>
</span><span id="__span-11-156"><a id="__codelineno-11-156" name="__codelineno-11-156" href="#__codelineno-11-156"></a><span class="k">class</span><span class="w"> </span><span class="nc">PositionAttentionModule</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
</span><span id="__span-11-157"><a id="__codelineno-11-157" name="__codelineno-11-157" href="#__codelineno-11-157"></a>
</span><span id="__span-11-158"><a id="__codelineno-11-158" name="__codelineno-11-158" href="#__codelineno-11-158"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">d_model</span><span class="o">=</span><span class="mi">512</span><span class="p">,</span><span class="n">kernel_size</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span><span class="n">H</span><span class="o">=</span><span class="mi">7</span><span class="p">,</span><span class="n">W</span><span class="o">=</span><span class="mi">7</span><span class="p">):</span>
</span><span id="__span-11-159"><a id="__codelineno-11-159" name="__codelineno-11-159" href="#__codelineno-11-159"></a>        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
</span><span id="__span-11-160"><a id="__codelineno-11-160" name="__codelineno-11-160" href="#__codelineno-11-160"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">cnn</span><span class="o">=</span><span class="n">nn</span><span class="o">.</span><span class="n">Conv2d</span><span class="p">(</span><span class="n">d_model</span><span class="p">,</span><span class="n">d_model</span><span class="p">,</span><span class="n">kernel_size</span><span class="o">=</span><span class="n">kernel_size</span><span class="p">,</span><span class="n">padding</span><span class="o">=</span><span class="p">(</span><span class="n">kernel_size</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">//</span><span class="mi">2</span><span class="p">)</span> <span class="c1"># ‰∏çÂèòÂç∑ÁßØÔºåÈÄöÈÅìÊï∞Áõ∏ÂΩì‰∫éÂµåÂÖ•Áª¥Â∫¶ 512Ôºõin_channel=d_modle out_channel=d_model;Ëøô‰∏ÄÊ≠•Â∞±ÊòØËÅöÂêà‰∏Ä‰∏ãÂ±ÄÈÉ®ÁâπÂæÅ</span>
</span><span id="__span-11-161"><a id="__codelineno-11-161" name="__codelineno-11-161" href="#__codelineno-11-161"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">pa</span><span class="o">=</span><span class="n">ScaledDotProductAttention</span><span class="p">(</span><span class="n">d_model</span><span class="p">,</span><span class="n">d_k</span><span class="o">=</span><span class="n">d_model</span><span class="p">,</span><span class="n">d_v</span><span class="o">=</span><span class="n">d_model</span><span class="p">,</span><span class="n">h</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</span><span id="__span-11-162"><a id="__codelineno-11-162" name="__codelineno-11-162" href="#__codelineno-11-162"></a>
</span><span id="__span-11-163"><a id="__codelineno-11-163" name="__codelineno-11-163" href="#__codelineno-11-163"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">x</span><span class="p">):</span>
</span><span id="__span-11-164"><a id="__codelineno-11-164" name="__codelineno-11-164" href="#__codelineno-11-164"></a>        <span class="c1"># (B, C, H, W)</span>
</span><span id="__span-11-165"><a id="__codelineno-11-165" name="__codelineno-11-165" href="#__codelineno-11-165"></a>        <span class="n">B</span><span class="p">,</span> <span class="n">C</span><span class="p">,</span> <span class="n">H</span><span class="p">,</span> <span class="n">W</span><span class="o">=</span><span class="n">x</span><span class="o">.</span><span class="n">shape</span> <span class="c1"># (B, C, H, W)</span>
</span><span id="__span-11-166"><a id="__codelineno-11-166" name="__codelineno-11-166" href="#__codelineno-11-166"></a>        <span class="n">y</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cnn</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="c1"># (B, C, H, W) --&gt; (B, C, H, W)</span>
</span><span id="__span-11-167"><a id="__codelineno-11-167" name="__codelineno-11-167" href="#__codelineno-11-167"></a>        <span class="n">y</span><span class="o">=</span><span class="n">y</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="n">B</span><span class="p">,</span><span class="n">C</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">permute</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span> <span class="c1"># (B, C, H, W) --&gt; (B,C,N)--&gt;(B,N,C)   N=H*W Â∫èÂàóÈïøÂ∫¶Â∞±ÊòØ H*W</span>
</span><span id="__span-11-168"><a id="__codelineno-11-168" name="__codelineno-11-168" href="#__codelineno-11-168"></a>        <span class="n">y</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">pa</span><span class="p">(</span><span class="n">y</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">y</span><span class="p">)</span> <span class="c1">#(B,N,C)</span>
</span><span id="__span-11-169"><a id="__codelineno-11-169" name="__codelineno-11-169" href="#__codelineno-11-169"></a>        <span class="k">return</span> <span class="n">y</span>
</span><span id="__span-11-170"><a id="__codelineno-11-170" name="__codelineno-11-170" href="#__codelineno-11-170"></a>
</span><span id="__span-11-171"><a id="__codelineno-11-171" name="__codelineno-11-171" href="#__codelineno-11-171"></a>
</span><span id="__span-11-172"><a id="__codelineno-11-172" name="__codelineno-11-172" href="#__codelineno-11-172"></a><span class="k">class</span><span class="w"> </span><span class="nc">ChannelAttentionModule</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
</span><span id="__span-11-173"><a id="__codelineno-11-173" name="__codelineno-11-173" href="#__codelineno-11-173"></a>
</span><span id="__span-11-174"><a id="__codelineno-11-174" name="__codelineno-11-174" href="#__codelineno-11-174"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">d_model</span><span class="o">=</span><span class="mi">512</span><span class="p">,</span><span class="n">kernel_size</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span><span class="n">H</span><span class="o">=</span><span class="mi">7</span><span class="p">,</span><span class="n">W</span><span class="o">=</span><span class="mi">7</span><span class="p">):</span>
</span><span id="__span-11-175"><a id="__codelineno-11-175" name="__codelineno-11-175" href="#__codelineno-11-175"></a>        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
</span><span id="__span-11-176"><a id="__codelineno-11-176" name="__codelineno-11-176" href="#__codelineno-11-176"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">cnn</span><span class="o">=</span><span class="n">nn</span><span class="o">.</span><span class="n">Conv2d</span><span class="p">(</span><span class="n">d_model</span><span class="p">,</span><span class="n">d_model</span><span class="p">,</span><span class="n">kernel_size</span><span class="o">=</span><span class="n">kernel_size</span><span class="p">,</span><span class="n">padding</span><span class="o">=</span><span class="p">(</span><span class="n">kernel_size</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">//</span><span class="mi">2</span><span class="p">)</span>
</span><span id="__span-11-177"><a id="__codelineno-11-177" name="__codelineno-11-177" href="#__codelineno-11-177"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">pa</span><span class="o">=</span><span class="n">SimplifiedScaledDotProductAttention</span><span class="p">(</span><span class="n">H</span><span class="o">*</span><span class="n">W</span><span class="p">,</span><span class="n">h</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="c1"># Âå∫Âà´Âú®Âì™ÂÑøÔºü‰∏∫‰ªÄ‰πàÊ≤°ÊúâÂ§çÁî®</span>
</span><span id="__span-11-178"><a id="__codelineno-11-178" name="__codelineno-11-178" href="#__codelineno-11-178"></a>
</span><span id="__span-11-179"><a id="__codelineno-11-179" name="__codelineno-11-179" href="#__codelineno-11-179"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">x</span><span class="p">):</span>
</span><span id="__span-11-180"><a id="__codelineno-11-180" name="__codelineno-11-180" href="#__codelineno-11-180"></a>        <span class="c1"># (B, C, H, W)</span>
</span><span id="__span-11-181"><a id="__codelineno-11-181" name="__codelineno-11-181" href="#__codelineno-11-181"></a>        <span class="n">B</span><span class="p">,</span><span class="n">C</span><span class="p">,</span><span class="n">H</span><span class="p">,</span><span class="n">W</span><span class="o">=</span><span class="n">x</span><span class="o">.</span><span class="n">shape</span>
</span><span id="__span-11-182"><a id="__codelineno-11-182" name="__codelineno-11-182" href="#__codelineno-11-182"></a>        <span class="n">y</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cnn</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="c1"># (B, C, H, W) --&gt; (B, C, H, W)</span>
</span><span id="__span-11-183"><a id="__codelineno-11-183" name="__codelineno-11-183" href="#__codelineno-11-183"></a>        <span class="n">y</span><span class="o">=</span><span class="n">y</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="n">B</span><span class="p">,</span><span class="n">C</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>  <span class="c1"># (B, C, H, W)--&gt;(B, C, N)  N=H*W</span>
</span><span id="__span-11-184"><a id="__codelineno-11-184" name="__codelineno-11-184" href="#__codelineno-11-184"></a>        <span class="n">y</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">pa</span><span class="p">(</span><span class="n">y</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">y</span><span class="p">)</span>  <span class="c1"># (B, C, N) ÂõæÂÉèÊï∞ÊçÆÂú®ËøõÂÖ•Âà∞Ê≥®ÊÑèÂäõËÆ°ÁÆó‰πãÂâçÂ∞±Â∑≤ÁªèÂ±ïÂπ≥Áª¥Â∫¶‰∫Ü„ÄÇ</span>
</span><span id="__span-11-185"><a id="__codelineno-11-185" name="__codelineno-11-185" href="#__codelineno-11-185"></a>        <span class="k">return</span> <span class="n">y</span>
</span><span id="__span-11-186"><a id="__codelineno-11-186" name="__codelineno-11-186" href="#__codelineno-11-186"></a>
</span><span id="__span-11-187"><a id="__codelineno-11-187" name="__codelineno-11-187" href="#__codelineno-11-187"></a>
</span><span id="__span-11-188"><a id="__codelineno-11-188" name="__codelineno-11-188" href="#__codelineno-11-188"></a>
</span><span id="__span-11-189"><a id="__codelineno-11-189" name="__codelineno-11-189" href="#__codelineno-11-189"></a>
</span><span id="__span-11-190"><a id="__codelineno-11-190" name="__codelineno-11-190" href="#__codelineno-11-190"></a><span class="k">class</span><span class="w"> </span><span class="nc">DAModule</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
</span><span id="__span-11-191"><a id="__codelineno-11-191" name="__codelineno-11-191" href="#__codelineno-11-191"></a>
</span><span id="__span-11-192"><a id="__codelineno-11-192" name="__codelineno-11-192" href="#__codelineno-11-192"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">d_model</span><span class="o">=</span><span class="mi">512</span><span class="p">,</span><span class="n">kernel_size</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span><span class="n">H</span><span class="o">=</span><span class="mi">7</span><span class="p">,</span><span class="n">W</span><span class="o">=</span><span class="mi">7</span><span class="p">):</span>
</span><span id="__span-11-193"><a id="__codelineno-11-193" name="__codelineno-11-193" href="#__codelineno-11-193"></a>        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
</span><span id="__span-11-194"><a id="__codelineno-11-194" name="__codelineno-11-194" href="#__codelineno-11-194"></a>        <span class="c1"># ‰ΩçÁΩÆÊ≥®ÊÑèÂäõÂíåÈÄöÈÅìÊ≥®ÊÑèÂäõÁöÑÂå∫Âà´Â∞±ÊòØÔºöÈÄöÈÅìÊ≥®ÊÑèÂäõÊ≤°ÊúâÈÄöËøáÂç∑ÁßØÊìç‰ΩúÁîüÊàêqkv</span>
</span><span id="__span-11-195"><a id="__codelineno-11-195" name="__codelineno-11-195" href="#__codelineno-11-195"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">position_attention_module</span><span class="o">=</span><span class="n">PositionAttentionModule</span><span class="p">(</span><span class="n">d_model</span><span class="o">=</span><span class="mi">512</span><span class="p">,</span><span class="n">kernel_size</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span><span class="n">H</span><span class="o">=</span><span class="mi">7</span><span class="p">,</span><span class="n">W</span><span class="o">=</span><span class="mi">7</span><span class="p">)</span>
</span><span id="__span-11-196"><a id="__codelineno-11-196" name="__codelineno-11-196" href="#__codelineno-11-196"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">channel_attention_module</span><span class="o">=</span><span class="n">ChannelAttentionModule</span><span class="p">(</span><span class="n">d_model</span><span class="o">=</span><span class="mi">512</span><span class="p">,</span><span class="n">kernel_size</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span><span class="n">H</span><span class="o">=</span><span class="mi">7</span><span class="p">,</span><span class="n">W</span><span class="o">=</span><span class="mi">7</span><span class="p">)</span>
</span><span id="__span-11-197"><a id="__codelineno-11-197" name="__codelineno-11-197" href="#__codelineno-11-197"></a>
</span><span id="__span-11-198"><a id="__codelineno-11-198" name="__codelineno-11-198" href="#__codelineno-11-198"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="nb">input</span><span class="p">):</span>
</span><span id="__span-11-199"><a id="__codelineno-11-199" name="__codelineno-11-199" href="#__codelineno-11-199"></a>        <span class="c1"># (B, C, H, W)</span>
</span><span id="__span-11-200"><a id="__codelineno-11-200" name="__codelineno-11-200" href="#__codelineno-11-200"></a>        <span class="n">B</span><span class="p">,</span><span class="n">C</span><span class="p">,</span><span class="n">H</span><span class="p">,</span><span class="n">W</span><span class="o">=</span><span class="nb">input</span><span class="o">.</span><span class="n">shape</span> <span class="c1"># (B, C, H, W)</span>
</span><span id="__span-11-201"><a id="__codelineno-11-201" name="__codelineno-11-201" href="#__codelineno-11-201"></a>        <span class="n">p_out</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">position_attention_module</span><span class="p">(</span><span class="nb">input</span><span class="p">)</span> <span class="c1"># ÊâßË°å‰ΩçÁΩÆÊ≥®ÊÑèÂäõ: (B, C, H, W)--&gt;(B,N,C) ‰ΩçÁΩÆÊ≥®ÊÑèÂäõÂíåÁ©∫Èó¥Ê≥®ÊÑèÂäõÂæàÂÉè</span>
</span><span id="__span-11-202"><a id="__codelineno-11-202" name="__codelineno-11-202" href="#__codelineno-11-202"></a>        <span class="n">c_out</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">channel_attention_module</span><span class="p">(</span><span class="nb">input</span><span class="p">)</span>  <span class="c1"># ÊâßË°åÈÄöÈÅìÊ≥®ÊÑèÂäõ:(B, C, H, W)--&gt; (B, C, N)</span>
</span><span id="__span-11-203"><a id="__codelineno-11-203" name="__codelineno-11-203" href="#__codelineno-11-203"></a>        <span class="n">p_out</span><span class="o">=</span><span class="n">p_out</span><span class="o">.</span><span class="n">permute</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="n">B</span><span class="p">,</span><span class="n">C</span><span class="p">,</span><span class="n">H</span><span class="p">,</span><span class="n">W</span><span class="p">)</span> <span class="c1">#(B,N,C)--&gt;(B,C,N)--&gt;(B,C,H,W)</span>
</span><span id="__span-11-204"><a id="__codelineno-11-204" name="__codelineno-11-204" href="#__codelineno-11-204"></a>        <span class="n">c_out</span><span class="o">=</span><span class="n">c_out</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="n">B</span><span class="p">,</span><span class="n">C</span><span class="p">,</span><span class="n">H</span><span class="p">,</span><span class="n">W</span><span class="p">)</span> <span class="c1"># (B,C,N)--&gt;(B,C,H,W)</span>
</span><span id="__span-11-205"><a id="__codelineno-11-205" name="__codelineno-11-205" href="#__codelineno-11-205"></a>
</span><span id="__span-11-206"><a id="__codelineno-11-206" name="__codelineno-11-206" href="#__codelineno-11-206"></a>        <span class="n">p_out</span> <span class="o">=</span> <span class="nb">input</span> <span class="o">+</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">p_out</span>
</span><span id="__span-11-207"><a id="__codelineno-11-207" name="__codelineno-11-207" href="#__codelineno-11-207"></a>        <span class="n">c_out</span> <span class="o">=</span> <span class="nb">input</span> <span class="o">+</span> <span class="mf">0.2</span> <span class="o">*</span> <span class="n">c_out</span>
</span><span id="__span-11-208"><a id="__codelineno-11-208" name="__codelineno-11-208" href="#__codelineno-11-208"></a>
</span><span id="__span-11-209"><a id="__codelineno-11-209" name="__codelineno-11-209" href="#__codelineno-11-209"></a>        <span class="k">return</span> <span class="n">p_out</span><span class="o">+</span><span class="n">c_out</span>
</span><span id="__span-11-210"><a id="__codelineno-11-210" name="__codelineno-11-210" href="#__codelineno-11-210"></a>
</span><span id="__span-11-211"><a id="__codelineno-11-211" name="__codelineno-11-211" href="#__codelineno-11-211"></a>
</span><span id="__span-11-212"><a id="__codelineno-11-212" name="__codelineno-11-212" href="#__codelineno-11-212"></a><span class="c1"># ‰∏§‰∏™Ê≥®ÊÑèÂäõÊú∫Âà∂Â∞±‰∏çÁªÜËÆ≤‰∫ÜÂì¶, Âü∫Êú¨‰∏ÄÊ®°‰∏ÄÊ†∑,Âè™‰∏çËøáÈÄöÈÅìÊ≥®ÊÑèÂäõÊ≤°ÊúâÈÄöËøáÂç∑ÁßØÁîüÊàêÊñ∞ÁöÑqkv,‰ΩúËÄÖËØ¥‰ºöÁ†¥ÂùèÂéüÊúâÈÄöÈÅì‰πãÈó¥ÁöÑÁõ∏ÂÖ≥ÊÄß„ÄÇ</span>
</span><span id="__span-11-213"><a id="__codelineno-11-213" name="__codelineno-11-213" href="#__codelineno-11-213"></a><span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
</span><span id="__span-11-214"><a id="__codelineno-11-214" name="__codelineno-11-214" href="#__codelineno-11-214"></a>    <span class="c1"># (B, C, H, W)</span>
</span><span id="__span-11-215"><a id="__codelineno-11-215" name="__codelineno-11-215" href="#__codelineno-11-215"></a>    <span class="nb">input</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">512</span><span class="p">,</span><span class="mi">7</span><span class="p">,</span><span class="mi">7</span><span class="p">)</span>
</span><span id="__span-11-216"><a id="__codelineno-11-216" name="__codelineno-11-216" href="#__codelineno-11-216"></a>    <span class="n">Model</span><span class="o">=</span><span class="n">DAModule</span><span class="p">(</span><span class="n">d_model</span><span class="o">=</span><span class="mi">512</span><span class="p">,</span><span class="n">kernel_size</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span><span class="n">H</span><span class="o">=</span><span class="mi">7</span><span class="p">,</span><span class="n">W</span><span class="o">=</span><span class="mi">7</span><span class="p">)</span>
</span><span id="__span-11-217"><a id="__codelineno-11-217" name="__codelineno-11-217" href="#__codelineno-11-217"></a>    <span class="n">output</span> <span class="o">=</span> <span class="n">Model</span><span class="p">(</span><span class="nb">input</span><span class="p">)</span>
</span><span id="__span-11-218"><a id="__codelineno-11-218" name="__codelineno-11-218" href="#__codelineno-11-218"></a>    <span class="nb">print</span><span class="p">(</span><span class="n">output</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
</span></code></pre></div>
<h2 id="_3">ÁâπÂæÅËûçÂêà<a class="headerlink" href="#_3" title="Permanent link">&para;</a></h2>
<h2 id="asff">‚àö‚≠êASFF ‰∏çÂêåÂ∞∫Â∫¶ÁâπÂæÅËûçÂêà<a class="headerlink" href="#asff" title="Permanent link">&para;</a></h2>
<p>ËÆ∫Êñá„ÄäLearning Spatial Fusion for Single-Shot Object Detection„Äã</p>
<p>Ëá™ÈÄÇÂ∫îÁ©∫Èó¥ÁâπÂæÅËûçÂêà</p>
<p><a href="https://mp.weixin.qq.com/s/LzAFyaH5Pj42uGHS8_0DWQ">ASFF</a></p>
<p><img alt="image-20250223122423399" src="../images/image-20250223122423399.png" /></p>
<p><img alt="image-20250223122919658" src="../images/image-20250223122919658.png" /></p>
<p><img alt="image-20250223122932770" src="../images/image-20250223122932770.png" /></p>
<p><strong>‰∏ªË¶ÅËß£ÂÜ≥Ôºö‰∏çÂêåÁâπÂæÅÂ∞∫Â∫¶‰∏ç‰∏ÄËá¥ÁöÑÈóÆÈ¢ò</strong> </p>
<p>softmaxÔºö</p>
<p><img alt="image-20250223122755770" src="../images/image-20250223122755770.png" /></p>
<p><img alt="image-20250223122819398" src="../images/image-20250223122819398.png" /></p>
<p>ÔºàÂÆûË∑µÂá∫ÁúüÁü•Ôºâ</p>
<p><strong>‰ºòË¥®Ê≥®Èáä</strong></p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-12-1"><a id="__codelineno-12-1" name="__codelineno-12-1" href="#__codelineno-12-1"></a><span class="kn">import</span><span class="w"> </span><span class="nn">torch</span>
</span><span id="__span-12-2"><a id="__codelineno-12-2" name="__codelineno-12-2" href="#__codelineno-12-2"></a><span class="kn">import</span><span class="w"> </span><span class="nn">torch.nn</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">nn</span>
</span><span id="__span-12-3"><a id="__codelineno-12-3" name="__codelineno-12-3" href="#__codelineno-12-3"></a><span class="kn">import</span><span class="w"> </span><span class="nn">torch.nn.functional</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">F</span>
</span><span id="__span-12-4"><a id="__codelineno-12-4" name="__codelineno-12-4" href="#__codelineno-12-4"></a>
</span><span id="__span-12-5"><a id="__codelineno-12-5" name="__codelineno-12-5" href="#__codelineno-12-5"></a>
</span><span id="__span-12-6"><a id="__codelineno-12-6" name="__codelineno-12-6" href="#__codelineno-12-6"></a><span class="k">def</span><span class="w"> </span><span class="nf">autopad</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">p</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>  <span class="c1"># kernel, padding</span>
</span><span id="__span-12-7"><a id="__codelineno-12-7" name="__codelineno-12-7" href="#__codelineno-12-7"></a>    <span class="c1"># Pad to &#39;same&#39;</span>
</span><span id="__span-12-8"><a id="__codelineno-12-8" name="__codelineno-12-8" href="#__codelineno-12-8"></a>    <span class="k">if</span> <span class="n">p</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="__span-12-9"><a id="__codelineno-12-9" name="__codelineno-12-9" href="#__codelineno-12-9"></a>        <span class="n">p</span> <span class="o">=</span> <span class="n">k</span> <span class="o">//</span> <span class="mi">2</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="nb">int</span><span class="p">)</span> <span class="k">else</span> <span class="p">[</span><span class="n">x</span> <span class="o">//</span> <span class="mi">2</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">k</span><span class="p">]</span>  <span class="c1"># auto-pad</span>
</span><span id="__span-12-10"><a id="__codelineno-12-10" name="__codelineno-12-10" href="#__codelineno-12-10"></a>    <span class="k">return</span> <span class="n">p</span>
</span><span id="__span-12-11"><a id="__codelineno-12-11" name="__codelineno-12-11" href="#__codelineno-12-11"></a>
</span><span id="__span-12-12"><a id="__codelineno-12-12" name="__codelineno-12-12" href="#__codelineno-12-12"></a>
</span><span id="__span-12-13"><a id="__codelineno-12-13" name="__codelineno-12-13" href="#__codelineno-12-13"></a><span class="k">class</span><span class="w"> </span><span class="nc">Conv</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
</span><span id="__span-12-14"><a id="__codelineno-12-14" name="__codelineno-12-14" href="#__codelineno-12-14"></a>    <span class="c1"># Standard convolution</span>
</span><span id="__span-12-15"><a id="__codelineno-12-15" name="__codelineno-12-15" href="#__codelineno-12-15"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">c1</span><span class="p">,</span> <span class="n">c2</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">p</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">g</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">act</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>  <span class="c1"># ch_in, ch_out, kernel, stride, padding, groups</span>
</span><span id="__span-12-16"><a id="__codelineno-12-16" name="__codelineno-12-16" href="#__codelineno-12-16"></a>        <span class="nb">super</span><span class="p">(</span><span class="n">Conv</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
</span><span id="__span-12-17"><a id="__codelineno-12-17" name="__codelineno-12-17" href="#__codelineno-12-17"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">conv</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Conv2d</span><span class="p">(</span><span class="n">c1</span><span class="p">,</span> <span class="n">c2</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">autopad</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">p</span><span class="p">),</span> <span class="n">groups</span><span class="o">=</span><span class="n">g</span><span class="p">,</span> <span class="n">bias</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="__span-12-18"><a id="__codelineno-12-18" name="__codelineno-12-18" href="#__codelineno-12-18"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">bn</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">BatchNorm2d</span><span class="p">(</span><span class="n">c2</span><span class="p">)</span>
</span><span id="__span-12-19"><a id="__codelineno-12-19" name="__codelineno-12-19" href="#__codelineno-12-19"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">act</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">SiLU</span><span class="p">()</span> <span class="k">if</span> <span class="n">act</span> <span class="ow">is</span> <span class="kc">True</span> <span class="k">else</span> <span class="p">(</span><span class="n">act</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">act</span><span class="p">,</span> <span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">)</span> <span class="k">else</span> <span class="n">nn</span><span class="o">.</span><span class="n">Identity</span><span class="p">())</span>
</span><span id="__span-12-20"><a id="__codelineno-12-20" name="__codelineno-12-20" href="#__codelineno-12-20"></a>
</span><span id="__span-12-21"><a id="__codelineno-12-21" name="__codelineno-12-21" href="#__codelineno-12-21"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
</span><span id="__span-12-22"><a id="__codelineno-12-22" name="__codelineno-12-22" href="#__codelineno-12-22"></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">act</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bn</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">conv</span><span class="p">(</span><span class="n">x</span><span class="p">)))</span>
</span><span id="__span-12-23"><a id="__codelineno-12-23" name="__codelineno-12-23" href="#__codelineno-12-23"></a>
</span><span id="__span-12-24"><a id="__codelineno-12-24" name="__codelineno-12-24" href="#__codelineno-12-24"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">forward_fuse</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
</span><span id="__span-12-25"><a id="__codelineno-12-25" name="__codelineno-12-25" href="#__codelineno-12-25"></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">act</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">conv</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>
</span><span id="__span-12-26"><a id="__codelineno-12-26" name="__codelineno-12-26" href="#__codelineno-12-26"></a>
</span><span id="__span-12-27"><a id="__codelineno-12-27" name="__codelineno-12-27" href="#__codelineno-12-27"></a>
</span><span id="__span-12-28"><a id="__codelineno-12-28" name="__codelineno-12-28" href="#__codelineno-12-28"></a><span class="k">class</span><span class="w"> </span><span class="nc">ASFF</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
</span><span id="__span-12-29"><a id="__codelineno-12-29" name="__codelineno-12-29" href="#__codelineno-12-29"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">level</span><span class="p">,</span> <span class="n">multiplier</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">rfb</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">vis</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">act_cfg</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
</span><span id="__span-12-30"><a id="__codelineno-12-30" name="__codelineno-12-30" href="#__codelineno-12-30"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="__span-12-31"><a id="__codelineno-12-31" name="__codelineno-12-31" href="#__codelineno-12-31"></a><span class="sd">        multiplier should be 1, 0.5</span>
</span><span id="__span-12-32"><a id="__codelineno-12-32" name="__codelineno-12-32" href="#__codelineno-12-32"></a><span class="sd">        which means, the channel of ASFF can be</span>
</span><span id="__span-12-33"><a id="__codelineno-12-33" name="__codelineno-12-33" href="#__codelineno-12-33"></a><span class="sd">        512, 256, 128 -&gt; multiplier=0.5</span>
</span><span id="__span-12-34"><a id="__codelineno-12-34" name="__codelineno-12-34" href="#__codelineno-12-34"></a><span class="sd">        1024, 512, 256 -&gt; multiplier=1</span>
</span><span id="__span-12-35"><a id="__codelineno-12-35" name="__codelineno-12-35" href="#__codelineno-12-35"></a><span class="sd">        For even smaller, you need change code manually.</span>
</span><span id="__span-12-36"><a id="__codelineno-12-36" name="__codelineno-12-36" href="#__codelineno-12-36"></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="__span-12-37"><a id="__codelineno-12-37" name="__codelineno-12-37" href="#__codelineno-12-37"></a>        <span class="c1"># init asff_module = ASFF(level=1, multiplier=1, rfb=False, vis=False)</span>
</span><span id="__span-12-38"><a id="__codelineno-12-38" name="__codelineno-12-38" href="#__codelineno-12-38"></a>        <span class="nb">super</span><span class="p">(</span><span class="n">ASFF</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
</span><span id="__span-12-39"><a id="__codelineno-12-39" name="__codelineno-12-39" href="#__codelineno-12-39"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">level</span> <span class="o">=</span> <span class="n">level</span>
</span><span id="__span-12-40"><a id="__codelineno-12-40" name="__codelineno-12-40" href="#__codelineno-12-40"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">dim</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="mi">1024</span> <span class="o">*</span> <span class="n">multiplier</span><span class="p">),</span> <span class="nb">int</span><span class="p">(</span><span class="mi">512</span> <span class="o">*</span> <span class="n">multiplier</span><span class="p">),</span>
</span><span id="__span-12-41"><a id="__codelineno-12-41" name="__codelineno-12-41" href="#__codelineno-12-41"></a>                    <span class="nb">int</span><span class="p">(</span><span class="mi">256</span> <span class="o">*</span> <span class="n">multiplier</span><span class="p">)]</span>
</span><span id="__span-12-42"><a id="__codelineno-12-42" name="__codelineno-12-42" href="#__codelineno-12-42"></a>        <span class="c1"># print(self.dim)</span>
</span><span id="__span-12-43"><a id="__codelineno-12-43" name="__codelineno-12-43" href="#__codelineno-12-43"></a>
</span><span id="__span-12-44"><a id="__codelineno-12-44" name="__codelineno-12-44" href="#__codelineno-12-44"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">inter_dim</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dim</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">level</span><span class="p">]</span>
</span><span id="__span-12-45"><a id="__codelineno-12-45" name="__codelineno-12-45" href="#__codelineno-12-45"></a>        <span class="k">if</span> <span class="n">level</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="__span-12-46"><a id="__codelineno-12-46" name="__codelineno-12-46" href="#__codelineno-12-46"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">stride_level_1</span> <span class="o">=</span> <span class="n">Conv</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="mi">512</span> <span class="o">*</span> <span class="n">multiplier</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">inter_dim</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
</span><span id="__span-12-47"><a id="__codelineno-12-47" name="__codelineno-12-47" href="#__codelineno-12-47"></a>
</span><span id="__span-12-48"><a id="__codelineno-12-48" name="__codelineno-12-48" href="#__codelineno-12-48"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">stride_level_2</span> <span class="o">=</span> <span class="n">Conv</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="mi">256</span> <span class="o">*</span> <span class="n">multiplier</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">inter_dim</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
</span><span id="__span-12-49"><a id="__codelineno-12-49" name="__codelineno-12-49" href="#__codelineno-12-49"></a>
</span><span id="__span-12-50"><a id="__codelineno-12-50" name="__codelineno-12-50" href="#__codelineno-12-50"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">expand</span> <span class="o">=</span> <span class="n">Conv</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">inter_dim</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span>
</span><span id="__span-12-51"><a id="__codelineno-12-51" name="__codelineno-12-51" href="#__codelineno-12-51"></a>                <span class="mi">1024</span> <span class="o">*</span> <span class="n">multiplier</span><span class="p">),</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
</span><span id="__span-12-52"><a id="__codelineno-12-52" name="__codelineno-12-52" href="#__codelineno-12-52"></a>        <span class="k">elif</span> <span class="n">level</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="__span-12-53"><a id="__codelineno-12-53" name="__codelineno-12-53" href="#__codelineno-12-53"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">compress_level_0</span> <span class="o">=</span> <span class="n">Conv</span><span class="p">(</span>
</span><span id="__span-12-54"><a id="__codelineno-12-54" name="__codelineno-12-54" href="#__codelineno-12-54"></a>                <span class="nb">int</span><span class="p">(</span><span class="mi">1024</span> <span class="o">*</span> <span class="n">multiplier</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">inter_dim</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
</span><span id="__span-12-55"><a id="__codelineno-12-55" name="__codelineno-12-55" href="#__codelineno-12-55"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">stride_level_2</span> <span class="o">=</span> <span class="n">Conv</span><span class="p">(</span>
</span><span id="__span-12-56"><a id="__codelineno-12-56" name="__codelineno-12-56" href="#__codelineno-12-56"></a>                <span class="nb">int</span><span class="p">(</span><span class="mi">256</span> <span class="o">*</span> <span class="n">multiplier</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">inter_dim</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
</span><span id="__span-12-57"><a id="__codelineno-12-57" name="__codelineno-12-57" href="#__codelineno-12-57"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">expand</span> <span class="o">=</span> <span class="n">Conv</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">inter_dim</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="mi">512</span> <span class="o">*</span> <span class="n">multiplier</span><span class="p">),</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
</span><span id="__span-12-58"><a id="__codelineno-12-58" name="__codelineno-12-58" href="#__codelineno-12-58"></a>        <span class="k">elif</span> <span class="n">level</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
</span><span id="__span-12-59"><a id="__codelineno-12-59" name="__codelineno-12-59" href="#__codelineno-12-59"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">compress_level_0</span> <span class="o">=</span> <span class="n">Conv</span><span class="p">(</span>
</span><span id="__span-12-60"><a id="__codelineno-12-60" name="__codelineno-12-60" href="#__codelineno-12-60"></a>                <span class="nb">int</span><span class="p">(</span><span class="mi">1024</span> <span class="o">*</span> <span class="n">multiplier</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">inter_dim</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
</span><span id="__span-12-61"><a id="__codelineno-12-61" name="__codelineno-12-61" href="#__codelineno-12-61"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">compress_level_1</span> <span class="o">=</span> <span class="n">Conv</span><span class="p">(</span>
</span><span id="__span-12-62"><a id="__codelineno-12-62" name="__codelineno-12-62" href="#__codelineno-12-62"></a>                <span class="nb">int</span><span class="p">(</span><span class="mi">512</span> <span class="o">*</span> <span class="n">multiplier</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">inter_dim</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
</span><span id="__span-12-63"><a id="__codelineno-12-63" name="__codelineno-12-63" href="#__codelineno-12-63"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">expand</span> <span class="o">=</span> <span class="n">Conv</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">inter_dim</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span>
</span><span id="__span-12-64"><a id="__codelineno-12-64" name="__codelineno-12-64" href="#__codelineno-12-64"></a>                <span class="mi">256</span> <span class="o">*</span> <span class="n">multiplier</span><span class="p">),</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
</span><span id="__span-12-65"><a id="__codelineno-12-65" name="__codelineno-12-65" href="#__codelineno-12-65"></a>
</span><span id="__span-12-66"><a id="__codelineno-12-66" name="__codelineno-12-66" href="#__codelineno-12-66"></a>        <span class="c1"># when adding rfb, we use half number of channels to save memory</span>
</span><span id="__span-12-67"><a id="__codelineno-12-67" name="__codelineno-12-67" href="#__codelineno-12-67"></a>        <span class="n">compress_c</span> <span class="o">=</span> <span class="mi">8</span> <span class="k">if</span> <span class="n">rfb</span> <span class="k">else</span> <span class="mi">16</span>
</span><span id="__span-12-68"><a id="__codelineno-12-68" name="__codelineno-12-68" href="#__codelineno-12-68"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">weight_level_0</span> <span class="o">=</span> <span class="n">Conv</span><span class="p">(</span>
</span><span id="__span-12-69"><a id="__codelineno-12-69" name="__codelineno-12-69" href="#__codelineno-12-69"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">inter_dim</span><span class="p">,</span> <span class="n">compress_c</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
</span><span id="__span-12-70"><a id="__codelineno-12-70" name="__codelineno-12-70" href="#__codelineno-12-70"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">weight_level_1</span> <span class="o">=</span> <span class="n">Conv</span><span class="p">(</span>
</span><span id="__span-12-71"><a id="__codelineno-12-71" name="__codelineno-12-71" href="#__codelineno-12-71"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">inter_dim</span><span class="p">,</span> <span class="n">compress_c</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
</span><span id="__span-12-72"><a id="__codelineno-12-72" name="__codelineno-12-72" href="#__codelineno-12-72"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">weight_level_2</span> <span class="o">=</span> <span class="n">Conv</span><span class="p">(</span>
</span><span id="__span-12-73"><a id="__codelineno-12-73" name="__codelineno-12-73" href="#__codelineno-12-73"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">inter_dim</span><span class="p">,</span> <span class="n">compress_c</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
</span><span id="__span-12-74"><a id="__codelineno-12-74" name="__codelineno-12-74" href="#__codelineno-12-74"></a>
</span><span id="__span-12-75"><a id="__codelineno-12-75" name="__codelineno-12-75" href="#__codelineno-12-75"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">weight_levels</span> <span class="o">=</span> <span class="n">Conv</span><span class="p">(</span>
</span><span id="__span-12-76"><a id="__codelineno-12-76" name="__codelineno-12-76" href="#__codelineno-12-76"></a>            <span class="n">compress_c</span> <span class="o">*</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
</span><span id="__span-12-77"><a id="__codelineno-12-77" name="__codelineno-12-77" href="#__codelineno-12-77"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">vis</span> <span class="o">=</span> <span class="n">vis</span>
</span><span id="__span-12-78"><a id="__codelineno-12-78" name="__codelineno-12-78" href="#__codelineno-12-78"></a>
</span><span id="__span-12-79"><a id="__codelineno-12-79" name="__codelineno-12-79" href="#__codelineno-12-79"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>  <span class="c1"># l,m,s</span>
</span><span id="__span-12-80"><a id="__codelineno-12-80" name="__codelineno-12-80" href="#__codelineno-12-80"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="__span-12-81"><a id="__codelineno-12-81" name="__codelineno-12-81" href="#__codelineno-12-81"></a><span class="sd">        #</span>
</span><span id="__span-12-82"><a id="__codelineno-12-82" name="__codelineno-12-82" href="#__codelineno-12-82"></a><span class="sd">        256, 512, 1024</span>
</span><span id="__span-12-83"><a id="__codelineno-12-83" name="__codelineno-12-83" href="#__codelineno-12-83"></a><span class="sd">        from small -&gt; large</span>
</span><span id="__span-12-84"><a id="__codelineno-12-84" name="__codelineno-12-84" href="#__codelineno-12-84"></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="__span-12-85"><a id="__codelineno-12-85" name="__codelineno-12-85" href="#__codelineno-12-85"></a>        <span class="c1"># forward output_feature = asff_module([level_2_feature, level_1_feature, level_0_feature])</span>
</span><span id="__span-12-86"><a id="__codelineno-12-86" name="__codelineno-12-86" href="#__codelineno-12-86"></a>        <span class="n">x_level_0</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>  <span class="c1"># ÊúÄÂ§ßÁâπÂæÅÂ±Ç level_0_feature = (1, 1024, 20, 20)  # Â§ßÂ∞∫ÂØ∏ÁâπÂæÅÂõæ Â∞∫ÂØ∏Â∞èÈÄöÈÅìÂ§ö</span>
</span><span id="__span-12-87"><a id="__codelineno-12-87" name="__codelineno-12-87" href="#__codelineno-12-87"></a>        <span class="n">x_level_1</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>  <span class="c1"># ‰∏≠Èó¥ÁâπÂæÅÂ±Ç level_1_feature = (1, 512, 40, 40)   # ‰∏≠Â∞∫ÂØ∏ÁâπÂæÅÂõæ</span>
</span><span id="__span-12-88"><a id="__codelineno-12-88" name="__codelineno-12-88" href="#__codelineno-12-88"></a>        <span class="n">x_level_2</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>  <span class="c1"># ÊúÄÂ∞èÁâπÂæÅÂ±Ç level_2_feature = (1, 256, 80, 80)   # Â∞èÂ∞∫ÂØ∏ÁâπÂæÅÂõæ</span>
</span><span id="__span-12-89"><a id="__codelineno-12-89" name="__codelineno-12-89" href="#__codelineno-12-89"></a>
</span><span id="__span-12-90"><a id="__codelineno-12-90" name="__codelineno-12-90" href="#__codelineno-12-90"></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">level</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="__span-12-91"><a id="__codelineno-12-91" name="__codelineno-12-91" href="#__codelineno-12-91"></a>            <span class="n">level_0_resized</span> <span class="o">=</span> <span class="n">x_level_0</span>
</span><span id="__span-12-92"><a id="__codelineno-12-92" name="__codelineno-12-92" href="#__codelineno-12-92"></a>            <span class="n">level_1_resized</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stride_level_1</span><span class="p">(</span><span class="n">x_level_1</span><span class="p">)</span>
</span><span id="__span-12-93"><a id="__codelineno-12-93" name="__codelineno-12-93" href="#__codelineno-12-93"></a>            <span class="n">level_2_downsampled_inter</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">max_pool2d</span><span class="p">(</span>
</span><span id="__span-12-94"><a id="__codelineno-12-94" name="__codelineno-12-94" href="#__codelineno-12-94"></a>                <span class="n">x_level_2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">stride</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">padding</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</span><span id="__span-12-95"><a id="__codelineno-12-95" name="__codelineno-12-95" href="#__codelineno-12-95"></a>            <span class="n">level_2_resized</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stride_level_2</span><span class="p">(</span><span class="n">level_2_downsampled_inter</span><span class="p">)</span>
</span><span id="__span-12-96"><a id="__codelineno-12-96" name="__codelineno-12-96" href="#__codelineno-12-96"></a>        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">level</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="__span-12-97"><a id="__codelineno-12-97" name="__codelineno-12-97" href="#__codelineno-12-97"></a>            <span class="n">level_0_compressed</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compress_level_0</span><span class="p">(</span><span class="n">x_level_0</span><span class="p">)</span> <span class="c1"># (1, 1024, 20, 20) ‚Üí self.compress_level_0 =  Conv2d(1024, 512, kernel_size=(1, 1), stride=(1, 1), bias=False) ‚Üí (1, 512, 20, 20)</span>
</span><span id="__span-12-98"><a id="__codelineno-12-98" name="__codelineno-12-98" href="#__codelineno-12-98"></a>
</span><span id="__span-12-99"><a id="__codelineno-12-99" name="__codelineno-12-99" href="#__codelineno-12-99"></a>            <span class="n">level_0_resized</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">interpolate</span><span class="p">(</span>
</span><span id="__span-12-100"><a id="__codelineno-12-100" name="__codelineno-12-100" href="#__codelineno-12-100"></a>                <span class="n">level_0_compressed</span><span class="p">,</span> <span class="n">scale_factor</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;nearest&#39;</span><span class="p">)</span> <span class="c1"># (1, 512, 20, 20) ‚Üí F.interpolate‚Üí [1, 512, 40, 40]</span>
</span><span id="__span-12-101"><a id="__codelineno-12-101" name="__codelineno-12-101" href="#__codelineno-12-101"></a>            <span class="n">level_1_resized</span> <span class="o">=</span> <span class="n">x_level_1</span> <span class="c1">#  [1, 512, 40, 40] ‚Üí = ‚Üí [1, 512, 40, 40]</span>
</span><span id="__span-12-102"><a id="__codelineno-12-102" name="__codelineno-12-102" href="#__codelineno-12-102"></a>            <span class="n">level_2_resized</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stride_level_2</span><span class="p">(</span><span class="n">x_level_2</span><span class="p">)</span> <span class="c1"># [1, 256, 80, 80] ‚Üí self.stride_level_2 = Conv2d(256, 512, kernel_size=(3, 3), stride=(2, 2), padding=(1, 1), bias=False) ‚Üí [1, 512, 40, 40]</span>
</span><span id="__span-12-103"><a id="__codelineno-12-103" name="__codelineno-12-103" href="#__codelineno-12-103"></a>        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">level</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
</span><span id="__span-12-104"><a id="__codelineno-12-104" name="__codelineno-12-104" href="#__codelineno-12-104"></a>            <span class="n">level_0_compressed</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compress_level_0</span><span class="p">(</span><span class="n">x_level_0</span><span class="p">)</span>
</span><span id="__span-12-105"><a id="__codelineno-12-105" name="__codelineno-12-105" href="#__codelineno-12-105"></a>            <span class="n">level_0_resized</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">interpolate</span><span class="p">(</span>
</span><span id="__span-12-106"><a id="__codelineno-12-106" name="__codelineno-12-106" href="#__codelineno-12-106"></a>                <span class="n">level_0_compressed</span><span class="p">,</span> <span class="n">scale_factor</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;nearest&#39;</span><span class="p">)</span>
</span><span id="__span-12-107"><a id="__codelineno-12-107" name="__codelineno-12-107" href="#__codelineno-12-107"></a>            <span class="n">x_level_1_compressed</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compress_level_1</span><span class="p">(</span><span class="n">x_level_1</span><span class="p">)</span>
</span><span id="__span-12-108"><a id="__codelineno-12-108" name="__codelineno-12-108" href="#__codelineno-12-108"></a>            <span class="n">level_1_resized</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">interpolate</span><span class="p">(</span>
</span><span id="__span-12-109"><a id="__codelineno-12-109" name="__codelineno-12-109" href="#__codelineno-12-109"></a>                <span class="n">x_level_1_compressed</span><span class="p">,</span> <span class="n">scale_factor</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;nearest&#39;</span><span class="p">)</span>
</span><span id="__span-12-110"><a id="__codelineno-12-110" name="__codelineno-12-110" href="#__codelineno-12-110"></a>            <span class="n">level_2_resized</span> <span class="o">=</span> <span class="n">x_level_2</span>
</span><span id="__span-12-111"><a id="__codelineno-12-111" name="__codelineno-12-111" href="#__codelineno-12-111"></a>
</span><span id="__span-12-112"><a id="__codelineno-12-112" name="__codelineno-12-112" href="#__codelineno-12-112"></a>        <span class="n">level_0_weight_v</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">weight_level_0</span><span class="p">(</span><span class="n">level_0_resized</span><span class="p">)</span> <span class="c1"># [1, 512, 40, 40] ‚Üí self.weight_level_0 = (conv): Conv2d(512, 16, kernel_size=(1, 1), stride=(1, 1), bias=False) ‚Üí [1, 16, 40, 40]</span>
</span><span id="__span-12-113"><a id="__codelineno-12-113" name="__codelineno-12-113" href="#__codelineno-12-113"></a>        <span class="n">level_1_weight_v</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">weight_level_1</span><span class="p">(</span><span class="n">level_1_resized</span><span class="p">)</span> <span class="c1"># [1, 512, 40, 40] ‚Üí self.weight_level_1 = Conv2d(512, 16, kernel_size=(1, 1), stride=(1, 1), bias=False) ‚Üí [1, 16, 40, 40]</span>
</span><span id="__span-12-114"><a id="__codelineno-12-114" name="__codelineno-12-114" href="#__codelineno-12-114"></a>        <span class="n">level_2_weight_v</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">weight_level_2</span><span class="p">(</span><span class="n">level_2_resized</span><span class="p">)</span> <span class="c1"># [1, 512, 40, 40] ‚Üí self.weight_level_2 = Conv2d(512, 16, kernel_size=(1, 1), stride=(1, 1), bias=False) ‚Üí [1, 16, 40, 40]</span>
</span><span id="__span-12-115"><a id="__codelineno-12-115" name="__codelineno-12-115" href="#__codelineno-12-115"></a>
</span><span id="__span-12-116"><a id="__codelineno-12-116" name="__codelineno-12-116" href="#__codelineno-12-116"></a>        <span class="n">levels_weight_v</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">(</span>
</span><span id="__span-12-117"><a id="__codelineno-12-117" name="__codelineno-12-117" href="#__codelineno-12-117"></a>            <span class="p">(</span><span class="n">level_0_weight_v</span><span class="p">,</span> <span class="n">level_1_weight_v</span><span class="p">,</span> <span class="n">level_2_weight_v</span><span class="p">),</span> <span class="mi">1</span><span class="p">)</span> <span class="c1"># [1, 16, 40, 40],[1, 16, 40, 40],[1, 16, 40, 40] ‚Üí cat ‚Üí [1, 48, 40, 40]</span>
</span><span id="__span-12-118"><a id="__codelineno-12-118" name="__codelineno-12-118" href="#__codelineno-12-118"></a>        <span class="n">levels_weight</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">weight_levels</span><span class="p">(</span><span class="n">levels_weight_v</span><span class="p">)</span> <span class="c1"># [1, 48, 40, 40] ‚Üí self.weight_levels = (conv): Conv2d(48, 3, kernel_size=(1, 1), stride=(1, 1), bias=False) ‚Üí [1, 3, 40, 40]</span>
</span><span id="__span-12-119"><a id="__codelineno-12-119" name="__codelineno-12-119" href="#__codelineno-12-119"></a>        <span class="n">levels_weight</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">softmax</span><span class="p">(</span><span class="n">levels_weight</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="c1"># [1, 3, 40, 40] ‚Üí F.softmax ‚Üí [1, 3, 40, 40]</span>
</span><span id="__span-12-120"><a id="__codelineno-12-120" name="__codelineno-12-120" href="#__codelineno-12-120"></a>
</span><span id="__span-12-121"><a id="__codelineno-12-121" name="__codelineno-12-121" href="#__codelineno-12-121"></a>        <span class="n">fused_out_reduced</span> <span class="o">=</span> <span class="n">level_0_resized</span> <span class="o">*</span> <span class="n">levels_weight</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">:</span><span class="mi">1</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span> <span class="o">+</span> \
</span><span id="__span-12-122"><a id="__codelineno-12-122" name="__codelineno-12-122" href="#__codelineno-12-122"></a>                            <span class="n">level_1_resized</span> <span class="o">*</span> <span class="n">levels_weight</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">:</span><span class="mi">2</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span> <span class="o">+</span> \
</span><span id="__span-12-123"><a id="__codelineno-12-123" name="__codelineno-12-123" href="#__codelineno-12-123"></a>                            <span class="n">level_2_resized</span> <span class="o">*</span> <span class="n">levels_weight</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">:,</span> <span class="p">:,</span> <span class="p">:]</span>
</span><span id="__span-12-124"><a id="__codelineno-12-124" name="__codelineno-12-124" href="#__codelineno-12-124"></a>        <span class="c1"># [1, 512, 40, 40] * [1, 1, 40, 40] + [1, 512, 40, 40] * [1, 1, 40, 40] + [1, 512, 40, 40] * [1, 1, 40, 40] ‚Üí  [1, 512, 40, 40]</span>
</span><span id="__span-12-125"><a id="__codelineno-12-125" name="__codelineno-12-125" href="#__codelineno-12-125"></a>        <span class="n">out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">expand</span><span class="p">(</span><span class="n">fused_out_reduced</span><span class="p">)</span> <span class="c1"># [1, 512, 40, 40] ‚Üí self.expand = (conv): Conv2d(512, 512, kernel_size=(3, 3), stride=(1, 1), padding=(1, 1), bias=False) ‚Üí [1, 512, 40, 40]</span>
</span><span id="__span-12-126"><a id="__codelineno-12-126" name="__codelineno-12-126" href="#__codelineno-12-126"></a>
</span><span id="__span-12-127"><a id="__codelineno-12-127" name="__codelineno-12-127" href="#__codelineno-12-127"></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">vis</span><span class="p">:</span><span class="c1"># self.vis = False</span>
</span><span id="__span-12-128"><a id="__codelineno-12-128" name="__codelineno-12-128" href="#__codelineno-12-128"></a>            <span class="k">return</span> <span class="n">out</span><span class="p">,</span> <span class="n">levels_weight</span><span class="p">,</span> <span class="n">fused_out_reduced</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</span><span id="__span-12-129"><a id="__codelineno-12-129" name="__codelineno-12-129" href="#__codelineno-12-129"></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="__span-12-130"><a id="__codelineno-12-130" name="__codelineno-12-130" href="#__codelineno-12-130"></a>            <span class="k">return</span> <span class="n">out</span>
</span><span id="__span-12-131"><a id="__codelineno-12-131" name="__codelineno-12-131" href="#__codelineno-12-131"></a>
</span><span id="__span-12-132"><a id="__codelineno-12-132" name="__codelineno-12-132" href="#__codelineno-12-132"></a>
</span><span id="__span-12-133"><a id="__codelineno-12-133" name="__codelineno-12-133" href="#__codelineno-12-133"></a><span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
</span><span id="__span-12-134"><a id="__codelineno-12-134" name="__codelineno-12-134" href="#__codelineno-12-134"></a>    <span class="c1"># Ê®°ÊãüÁöÑËæìÂÖ•ÁâπÂæÅÂõæÔºåÊ®°Êãü‰∏â‰∏™‰∏çÂêåÂ∞∫Â∫¶ÁöÑÁâπÂæÅÂõæÔºå‰æãÂ¶ÇÊù•Ëá™‰∏Ä‰∏™Â§öÂ∞∫Â∫¶ÁâπÂæÅÊèêÂèñÁΩëÁªúÁöÑËæìÂá∫</span>
</span><span id="__span-12-135"><a id="__codelineno-12-135" name="__codelineno-12-135" href="#__codelineno-12-135"></a>    <span class="n">level_0_feature</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1024</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">20</span><span class="p">)</span>  <span class="c1"># Â§ßÂ∞∫ÂØ∏ÁâπÂæÅÂõæ</span>
</span><span id="__span-12-136"><a id="__codelineno-12-136" name="__codelineno-12-136" href="#__codelineno-12-136"></a>    <span class="n">level_1_feature</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">512</span><span class="p">,</span> <span class="mi">40</span><span class="p">,</span> <span class="mi">40</span><span class="p">)</span>   <span class="c1"># ‰∏≠Â∞∫ÂØ∏ÁâπÂæÅÂõæ</span>
</span><span id="__span-12-137"><a id="__codelineno-12-137" name="__codelineno-12-137" href="#__codelineno-12-137"></a>    <span class="n">level_2_feature</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">256</span><span class="p">,</span> <span class="mi">80</span><span class="p">,</span> <span class="mi">80</span><span class="p">)</span>   <span class="c1"># Â∞èÂ∞∫ÂØ∏ÁâπÂæÅÂõæ</span>
</span><span id="__span-12-138"><a id="__codelineno-12-138" name="__codelineno-12-138" href="#__codelineno-12-138"></a>
</span><span id="__span-12-139"><a id="__codelineno-12-139" name="__codelineno-12-139" href="#__codelineno-12-139"></a>    <span class="c1"># ÂàùÂßãÂåñASFFÊ®°ÂùóÔºålevelË°®Á§∫ÂΩìÂâçASFFÊ®°ÂùóÂ§ÑÁêÜÁöÑÊòØÂì™‰∏™Â∞∫Â∫¶ÁöÑÁâπÂæÅÂ±ÇÔºåËøôÈáå‰ª•Â§ÑÁêÜ‰∏≠Â∞∫ÂØ∏ÁâπÂæÅÂ±Ç‰∏∫‰æã</span>
</span><span id="__span-12-140"><a id="__codelineno-12-140" name="__codelineno-12-140" href="#__codelineno-12-140"></a>    <span class="c1"># multiplierÁî®‰∫éË∞ÉÊï¥ÈÄöÈÅìÊï∞ÔºårfbÂíåvisÂàÜÂà´Ë°®Á§∫ÊòØÂê¶‰ΩøÁî®Êõ¥‰∏∞ÂØåÁöÑÁâπÂæÅË°®Á§∫ÂíåÊòØÂê¶ÂèØËßÜÂåñ</span>
</span><span id="__span-12-141"><a id="__codelineno-12-141" name="__codelineno-12-141" href="#__codelineno-12-141"></a>    <span class="n">asff_module</span> <span class="o">=</span> <span class="n">ASFF</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">multiplier</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">rfb</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">vis</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="__span-12-142"><a id="__codelineno-12-142" name="__codelineno-12-142" href="#__codelineno-12-142"></a>
</span><span id="__span-12-143"><a id="__codelineno-12-143" name="__codelineno-12-143" href="#__codelineno-12-143"></a>    <span class="c1"># ÈÄöËøáASFFÊ®°Âùó‰º†ÈÄíÁâπÂæÅÂõæ</span>
</span><span id="__span-12-144"><a id="__codelineno-12-144" name="__codelineno-12-144" href="#__codelineno-12-144"></a>    <span class="n">output_feature</span> <span class="o">=</span> <span class="n">asff_module</span><span class="p">([</span><span class="n">level_2_feature</span><span class="p">,</span> <span class="n">level_1_feature</span><span class="p">,</span> <span class="n">level_0_feature</span><span class="p">])</span>
</span><span id="__span-12-145"><a id="__codelineno-12-145" name="__codelineno-12-145" href="#__codelineno-12-145"></a>
</span><span id="__span-12-146"><a id="__codelineno-12-146" name="__codelineno-12-146" href="#__codelineno-12-146"></a>    <span class="c1"># ÊâìÂç∞ËæìÂá∫ÁâπÂæÅÂõæÁöÑÂΩ¢Áä∂ÔºåÁ°Æ‰øùASFFÊ®°ÂùóÊ≠£Â∏∏Â∑•‰Ωú</span>
</span><span id="__span-12-147"><a id="__codelineno-12-147" name="__codelineno-12-147" href="#__codelineno-12-147"></a>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Output feature shape: </span><span class="si">{</span><span class="n">output_feature</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="__span-12-148"><a id="__codelineno-12-148" name="__codelineno-12-148" href="#__codelineno-12-148"></a>
</span><span id="__span-12-149"><a id="__codelineno-12-149" name="__codelineno-12-149" href="#__codelineno-12-149"></a><span class="c1"># TODO ËÆ°ÁÆóÊµÅÁ®ãÂõæ„ÄÅÂéüÊñáÊ°ÜÊû∂Âõæ„ÄÅÂÖ¨ÂºèË°®Á§∫</span>
</span></code></pre></div>
<h2 id="fpn">‚àö <a href="https://arxiv.org/pdf/1612.03144">FPN</a> ÁâπÂæÅÈáëÂ≠óÂ°îÁΩëÁªú<a class="headerlink" href="#fpn" title="Permanent link">&para;</a></h2>
<p><img alt="IMG_0295" src="../images/IMG_0295.jpg" /></p>
<p><strong><a href="https://mp.weixin.qq.com/s?__biz=MzkzODQ0Nzk5Nw==&amp;mid=2247484987&amp;idx=1&amp;sn=e7fea22826dbda623f23e1a2f00f5552&amp;chksm=c2814329f5f6ca3f0c5cb6bab48a6cc719bf2f83f774c941c4960b30fba8d2c2b2c58e3dd618&amp;cur_album_id=3010807818071064579&amp;scene=190#rd">Feature Pyramid NetworkÔºàFPNÔºâ</a></strong></p>
<p><img alt="image-20250223135703949" src="../images/image-20250223135703949.png" /></p>
<p><img alt="image-20250223160541609" src="../images/image-20250223160541609.png" /></p>
<p><img alt="image-20250223160600857" src="../images/image-20250223160600857.png" /></p>
<p><a href="https://www.bilibili.com/video/BV1dh411U7D9/?spm_id_from=333.337.search-card.all.click&amp;vd_source=ddd7d236ab3e9b123c4086c415f4939e">ËÆ≤Ëß£</a></p>
<p><img alt="image-20250223135758297" src="../images/image-20250223135758297.png" /></p>
<p>2016 Âπ¥ËÆ∫Êñá</p>
<p><img alt="image-20250223160755182" src="../images/image-20250223160755182.png" /></p>
<p><img alt="image-20250223160922542" src="../images/image-20250223160922542.png" /></p>
<p><img alt="image-20250223160954522" src="../images/image-20250223160954522.png" /></p>
<p><img alt="image-20250223161125762" src="../images/image-20250223161125762.png" /></p>
<p><img alt="image-20250223161229485" src="../images/image-20250223161229485.png" /></p>
<p><a href="https://blog.csdn.net/weixin_41552975/article/details/135530473">‰ª£Á†Å</a>ÔºàÂ∑≤Ê≥®ÈáäÔºâÔºö</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-13-1"><a id="__codelineno-13-1" name="__codelineno-13-1" href="#__codelineno-13-1"></a><span class="kn">import</span><span class="w"> </span><span class="nn">torch.nn</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">nn</span>
</span><span id="__span-13-2"><a id="__codelineno-13-2" name="__codelineno-13-2" href="#__codelineno-13-2"></a><span class="kn">import</span><span class="w"> </span><span class="nn">torch</span>
</span><span id="__span-13-3"><a id="__codelineno-13-3" name="__codelineno-13-3" href="#__codelineno-13-3"></a><span class="kn">import</span><span class="w"> </span><span class="nn">math</span>
</span><span id="__span-13-4"><a id="__codelineno-13-4" name="__codelineno-13-4" href="#__codelineno-13-4"></a><span class="kn">import</span><span class="w"> </span><span class="nn">torch.utils.model_zoo</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">model_zoo</span>
</span><span id="__span-13-5"><a id="__codelineno-13-5" name="__codelineno-13-5" href="#__codelineno-13-5"></a><span class="kn">from</span><span class="w"> </span><span class="nn">torchvision.ops</span><span class="w"> </span><span class="kn">import</span> <span class="n">nms</span>
</span><span id="__span-13-6"><a id="__codelineno-13-6" name="__codelineno-13-6" href="#__codelineno-13-6"></a><span class="c1"># from retinanet.utils import BasicBlock, Bottleneck, BBoxTransform, ClipBoxes</span>
</span><span id="__span-13-7"><a id="__codelineno-13-7" name="__codelineno-13-7" href="#__codelineno-13-7"></a><span class="c1"># from retinanet.anchors import Anchors</span>
</span><span id="__span-13-8"><a id="__codelineno-13-8" name="__codelineno-13-8" href="#__codelineno-13-8"></a><span class="c1"># from retinanet import losses</span>
</span><span id="__span-13-9"><a id="__codelineno-13-9" name="__codelineno-13-9" href="#__codelineno-13-9"></a>
</span><span id="__span-13-10"><a id="__codelineno-13-10" name="__codelineno-13-10" href="#__codelineno-13-10"></a><span class="k">class</span><span class="w"> </span><span class="nc">PyramidFeatures</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
</span><span id="__span-13-11"><a id="__codelineno-13-11" name="__codelineno-13-11" href="#__codelineno-13-11"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">C3_size</span><span class="p">,</span> <span class="n">C4_size</span><span class="p">,</span> <span class="n">C5_size</span><span class="p">,</span> <span class="n">feature_size</span><span class="o">=</span><span class="mi">256</span><span class="p">):</span>
</span><span id="__span-13-12"><a id="__codelineno-13-12" name="__codelineno-13-12" href="#__codelineno-13-12"></a>        <span class="nb">super</span><span class="p">(</span><span class="n">PyramidFeatures</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
</span><span id="__span-13-13"><a id="__codelineno-13-13" name="__codelineno-13-13" href="#__codelineno-13-13"></a>
</span><span id="__span-13-14"><a id="__codelineno-13-14" name="__codelineno-13-14" href="#__codelineno-13-14"></a>        <span class="c1"># upsample C5 to get P5 from the FPN paper</span>
</span><span id="__span-13-15"><a id="__codelineno-13-15" name="__codelineno-13-15" href="#__codelineno-13-15"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">P5_1</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Conv2d</span><span class="p">(</span><span class="n">C5_size</span><span class="p">,</span> <span class="n">feature_size</span><span class="p">,</span> <span class="n">kernel_size</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">stride</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">padding</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</span><span id="__span-13-16"><a id="__codelineno-13-16" name="__codelineno-13-16" href="#__codelineno-13-16"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">P5_upsampled</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Upsample</span><span class="p">(</span><span class="n">scale_factor</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;nearest&#39;</span><span class="p">)</span>
</span><span id="__span-13-17"><a id="__codelineno-13-17" name="__codelineno-13-17" href="#__codelineno-13-17"></a>        <span class="c1">#Â∞ÜC5ÁöÑÁâπÂæÅÂõæÂ∞∫ÂØ∏ÊîæÂ§ß2ÂÄçÁî®‰∫éË∑üC4Áõ∏Âä†</span>
</span><span id="__span-13-18"><a id="__codelineno-13-18" name="__codelineno-13-18" href="#__codelineno-13-18"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">P5_2</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Conv2d</span><span class="p">(</span><span class="n">feature_size</span><span class="p">,</span> <span class="n">feature_size</span><span class="p">,</span> <span class="n">kernel_size</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">stride</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">padding</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</span><span id="__span-13-19"><a id="__codelineno-13-19" name="__codelineno-13-19" href="#__codelineno-13-19"></a>
</span><span id="__span-13-20"><a id="__codelineno-13-20" name="__codelineno-13-20" href="#__codelineno-13-20"></a>        <span class="c1"># add P5 elementwise to C4</span>
</span><span id="__span-13-21"><a id="__codelineno-13-21" name="__codelineno-13-21" href="#__codelineno-13-21"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">P4_1</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Conv2d</span><span class="p">(</span><span class="n">C4_size</span><span class="p">,</span> <span class="n">feature_size</span><span class="p">,</span> <span class="n">kernel_size</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">stride</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">padding</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</span><span id="__span-13-22"><a id="__codelineno-13-22" name="__codelineno-13-22" href="#__codelineno-13-22"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">P4_upsampled</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Upsample</span><span class="p">(</span><span class="n">scale_factor</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;nearest&#39;</span><span class="p">)</span>
</span><span id="__span-13-23"><a id="__codelineno-13-23" name="__codelineno-13-23" href="#__codelineno-13-23"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">P4_2</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Conv2d</span><span class="p">(</span><span class="n">feature_size</span><span class="p">,</span> <span class="n">feature_size</span><span class="p">,</span> <span class="n">kernel_size</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">stride</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">padding</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</span><span id="__span-13-24"><a id="__codelineno-13-24" name="__codelineno-13-24" href="#__codelineno-13-24"></a>
</span><span id="__span-13-25"><a id="__codelineno-13-25" name="__codelineno-13-25" href="#__codelineno-13-25"></a>        <span class="c1"># add P4 elementwise to C3</span>
</span><span id="__span-13-26"><a id="__codelineno-13-26" name="__codelineno-13-26" href="#__codelineno-13-26"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">P3_1</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Conv2d</span><span class="p">(</span><span class="n">C3_size</span><span class="p">,</span> <span class="n">feature_size</span><span class="p">,</span> <span class="n">kernel_size</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">stride</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">padding</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</span><span id="__span-13-27"><a id="__codelineno-13-27" name="__codelineno-13-27" href="#__codelineno-13-27"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">P3_2</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Conv2d</span><span class="p">(</span><span class="n">feature_size</span><span class="p">,</span> <span class="n">feature_size</span><span class="p">,</span> <span class="n">kernel_size</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">stride</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">padding</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</span><span id="__span-13-28"><a id="__codelineno-13-28" name="__codelineno-13-28" href="#__codelineno-13-28"></a>
</span><span id="__span-13-29"><a id="__codelineno-13-29" name="__codelineno-13-29" href="#__codelineno-13-29"></a>        <span class="c1"># &quot;P6 is obtained via a 3x3 stride-2 conv on C5&quot;</span>
</span><span id="__span-13-30"><a id="__codelineno-13-30" name="__codelineno-13-30" href="#__codelineno-13-30"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">P6</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Conv2d</span><span class="p">(</span><span class="n">C5_size</span><span class="p">,</span> <span class="n">feature_size</span><span class="p">,</span> <span class="n">kernel_size</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">stride</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">padding</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</span><span id="__span-13-31"><a id="__codelineno-13-31" name="__codelineno-13-31" href="#__codelineno-13-31"></a>
</span><span id="__span-13-32"><a id="__codelineno-13-32" name="__codelineno-13-32" href="#__codelineno-13-32"></a>        <span class="c1"># &quot;P7 is computed by applying ReLU followed by a 3x3 stride-2 conv on P6&quot;</span>
</span><span id="__span-13-33"><a id="__codelineno-13-33" name="__codelineno-13-33" href="#__codelineno-13-33"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">P7_1</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">ReLU</span><span class="p">()</span>
</span><span id="__span-13-34"><a id="__codelineno-13-34" name="__codelineno-13-34" href="#__codelineno-13-34"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">P7_2</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Conv2d</span><span class="p">(</span><span class="n">feature_size</span><span class="p">,</span> <span class="n">feature_size</span><span class="p">,</span> <span class="n">kernel_size</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">stride</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">padding</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</span><span id="__span-13-35"><a id="__codelineno-13-35" name="__codelineno-13-35" href="#__codelineno-13-35"></a>
</span><span id="__span-13-36"><a id="__codelineno-13-36" name="__codelineno-13-36" href="#__codelineno-13-36"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">inputs</span><span class="p">):</span>
</span><span id="__span-13-37"><a id="__codelineno-13-37" name="__codelineno-13-37" href="#__codelineno-13-37"></a>        <span class="c1">#Ê≥®ÊÑèÁêÜËß£ËøôÈáåÁöÑinputsÔºåÂÖ∂Ë°®Á§∫ÁöÑÊòØ‰∏Ä‰∏™ÂàóË°®</span>
</span><span id="__span-13-38"><a id="__codelineno-13-38" name="__codelineno-13-38" href="#__codelineno-13-38"></a>        <span class="n">C3</span><span class="p">,</span> <span class="n">C4</span><span class="p">,</span> <span class="n">C5</span> <span class="o">=</span> <span class="n">inputs</span>
</span><span id="__span-13-39"><a id="__codelineno-13-39" name="__codelineno-13-39" href="#__codelineno-13-39"></a>        <span class="c1"># input = [torch.randn(1, 32, 640, 640), torch.randn(1, 64, 320, 320), torch.randn(1, 96, 160, 160)]</span>
</span><span id="__span-13-40"><a id="__codelineno-13-40" name="__codelineno-13-40" href="#__codelineno-13-40"></a>        <span class="c1"># ÁâπÁÇπÔºöchannelÔºö32‚Üí64‚Üí96ÔºàÊó†ÊòéÊòæËßÑÂæãÔºâÔºåfeature_sizwÔºö640*640‚Üí320*320‚Üí160*160</span>
</span><span id="__span-13-41"><a id="__codelineno-13-41" name="__codelineno-13-41" href="#__codelineno-13-41"></a>
</span><span id="__span-13-42"><a id="__codelineno-13-42" name="__codelineno-13-42" href="#__codelineno-13-42"></a>        <span class="n">P5_x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">P5_1</span><span class="p">(</span><span class="n">C5</span><span class="p">)</span> <span class="c1">#  conv ÂçáÁª¥ÔºåÂ∞∫ÂØ∏‰∏çÂèò torch.Size([1, 96, 160, 160])‚Üí Conv2d ‚Üítorch.Size([1, 256, 160, 160]) /// (96, 256, kernel_size=(1, 1), stride=(1, 1))</span>
</span><span id="__span-13-43"><a id="__codelineno-13-43" name="__codelineno-13-43" href="#__codelineno-13-43"></a>        <span class="n">P5_upsampled_x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">P5_upsampled</span><span class="p">(</span><span class="n">P5_x</span><span class="p">)</span> <span class="c1"># ‰∏äÈááÊ†∑ÔºåÁª¥Â∫¶‰∏çÂèòÔºåÂ∞∫ÂØ∏ÁøªÂÄç [1, 256, 160, 160] ‚Üí [1, 256, 320, 320] // Upsample(scale_factor=2.0, mode=&#39;nearest&#39;)</span>
</span><span id="__span-13-44"><a id="__codelineno-13-44" name="__codelineno-13-44" href="#__codelineno-13-44"></a>        <span class="n">P5_x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">P5_2</span><span class="p">(</span><span class="n">P5_x</span><span class="p">)</span> <span class="c1"># 311conv Áª¥Â∫¶‰∏çÂèòÔºåÂ∞∫ÂØ∏‰∏çÂèò [1, 256, 160, 160] ‚Üí Conv2d(256, 256, kernel_size=(3, 3), stride=(1, 1), padding=(1, 1))Â∞∫ÂØ∏‰∏çÂèòÂç∑ÁßØ ‚Üí [1, 256, 160, 160]</span>
</span><span id="__span-13-45"><a id="__codelineno-13-45" name="__codelineno-13-45" href="#__codelineno-13-45"></a>
</span><span id="__span-13-46"><a id="__codelineno-13-46" name="__codelineno-13-46" href="#__codelineno-13-46"></a>        <span class="n">P4_x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">P4_1</span><span class="p">(</span><span class="n">C4</span><span class="p">)</span> <span class="c1">#1x1conv ÂçáÁª¥ Â∞∫ÂØ∏‰∏çÂèò  [1, 64, 320, 320] ‚Üí Conv2d(64, 256, kernel_size=(1, 1), stride=(1, 1)) ‚Üí [1, 256, 320, 320]</span>
</span><span id="__span-13-47"><a id="__codelineno-13-47" name="__codelineno-13-47" href="#__codelineno-13-47"></a>        <span class="n">P4_x</span> <span class="o">=</span> <span class="n">P5_upsampled_x</span> <span class="o">+</span> <span class="n">P4_x</span> <span class="c1"># [1, 256, 320, 320] + [1, 256, 320, 320] ‚Üí [1, 256, 320, 320]</span>
</span><span id="__span-13-48"><a id="__codelineno-13-48" name="__codelineno-13-48" href="#__codelineno-13-48"></a>        <span class="n">P4_upsampled_x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">P4_upsampled</span><span class="p">(</span><span class="n">P4_x</span><span class="p">)</span> <span class="c1"># ‰∏äÈááÊ†∑ÔºåÁª¥Â∫¶‰∏çÂèòÔºåÂ∞∫ÂØ∏ÁøªÂÄç [1, 256, 320, 320] ‚Üí Upsample(scale_factor=2.0, mode=&#39;nearest&#39;) ‚Üí [1, 256, 640, 640]</span>
</span><span id="__span-13-49"><a id="__codelineno-13-49" name="__codelineno-13-49" href="#__codelineno-13-49"></a>        <span class="n">P4_x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">P4_2</span><span class="p">(</span><span class="n">P4_x</span><span class="p">)</span> <span class="c1"># 3x3 311conv Âç∑ÁßØÊìç‰ΩúÔºåÁª¥Â∫¶‰∏çÂèòÔºåÂ∞∫ÂØ∏‰∏çÂèò„ÄÇ[1, 256, 320, 320] ‚Üí Conv2d(256, 256, kernel_size=(3, 3), stride=(1, 1), padding=(1, 1)) ‚Üí torch.Size([1, 256, 320, 320]) ksp 311Âç∑ÁßØÊ†∏‰∏∫ 3 ÁöÑ‰∏çÂèòÂç∑ÁßØ</span>
</span><span id="__span-13-50"><a id="__codelineno-13-50" name="__codelineno-13-50" href="#__codelineno-13-50"></a>
</span><span id="__span-13-51"><a id="__codelineno-13-51" name="__codelineno-13-51" href="#__codelineno-13-51"></a>        <span class="n">P3_x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">P3_1</span><span class="p">(</span><span class="n">C3</span><span class="p">)</span> <span class="c1"># Âç∑ÁßØÂçáÁª¥ÔºåÂ∞∫ÂØ∏‰∏çÂèò [1, 32, 640, 640] Conv2d(32, 256, kernel_size=(1, 1), stride=(1, 1)) [1, 256, 640, 640]</span>
</span><span id="__span-13-52"><a id="__codelineno-13-52" name="__codelineno-13-52" href="#__codelineno-13-52"></a>        <span class="n">P3_x</span> <span class="o">=</span> <span class="n">P3_x</span> <span class="o">+</span> <span class="n">P4_upsampled_x</span> <span class="c1"># add Ê∑∑Âêà [1, 256, 640, 640] + [1, 256, 640, 640] --&gt; [1, 256, 640, 640]</span>
</span><span id="__span-13-53"><a id="__codelineno-13-53" name="__codelineno-13-53" href="#__codelineno-13-53"></a>        <span class="n">P3_x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">P3_2</span><span class="p">(</span><span class="n">P3_x</span><span class="p">)</span> <span class="c1"># 3x3conv  Áª¥Â∫¶‰∏çÂèòÔºåÂ∞∫ÂØ∏‰∏çÂèò [1, 256, 640, 640] Conv2d(256, 256, kernel_size=(3, 3), stride=(1, 1), padding=(1, 1)) [1, 256, 640, 640]</span>
</span><span id="__span-13-54"><a id="__codelineno-13-54" name="__codelineno-13-54" href="#__codelineno-13-54"></a>
</span><span id="__span-13-55"><a id="__codelineno-13-55" name="__codelineno-13-55" href="#__codelineno-13-55"></a>        <span class="n">P6_x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">P6</span><span class="p">(</span><span class="n">C5</span><span class="p">)</span> <span class="c1"># 3x3 conv(ksp=321) ÂçáÁª¥ÔºåÁâπÂæÅÂõæÂ∞∫ÂØ∏ÂáèÂçä [1, 96, 160, 160] Conv2d(96, 256, kernel_size=(3, 3), stride=(2, 2), padding=(1, 1)) [1, 256, 80, 80]</span>
</span><span id="__span-13-56"><a id="__codelineno-13-56" name="__codelineno-13-56" href="#__codelineno-13-56"></a>
</span><span id="__span-13-57"><a id="__codelineno-13-57" name="__codelineno-13-57" href="#__codelineno-13-57"></a>        <span class="n">P7_x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">P7_1</span><span class="p">(</span><span class="n">P6_x</span><span class="p">)</span> <span class="c1"># ÈùûÁ∫øÊÄßÂèòÊç¢ ReLUÊøÄÊ¥ªÂ±Ç  [1, 256, 80, 80] ReLU() [1, 256, 80, 80]</span>
</span><span id="__span-13-58"><a id="__codelineno-13-58" name="__codelineno-13-58" href="#__codelineno-13-58"></a>        <span class="n">P7_x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">P7_2</span><span class="p">(</span><span class="n">P7_x</span><span class="p">)</span> <span class="c1"># 3x3conv(ksp=321)Áª¥Â∫¶‰∏çÂèòÔºåÁâπÂæÅÂõæÂ∞∫ÂØ∏ÂáèÂçä [1, 256, 80, 80] Conv2d(256, 256, kernel_size=(3, 3), stride=(2, 2), padding=(1, 1)) [1, 256, 40, 40]</span>
</span><span id="__span-13-59"><a id="__codelineno-13-59" name="__codelineno-13-59" href="#__codelineno-13-59"></a>
</span><span id="__span-13-60"><a id="__codelineno-13-60" name="__codelineno-13-60" href="#__codelineno-13-60"></a>        <span class="k">return</span> <span class="p">[</span><span class="n">P3_x</span><span class="p">,</span> <span class="n">P4_x</span><span class="p">,</span> <span class="n">P5_x</span><span class="p">,</span> <span class="n">P6_x</span><span class="p">,</span> <span class="n">P7_x</span><span class="p">]</span> <span class="c1"># [P3_x [1, 256, 640, 640],P4_x [1, 256, 320, 320],P5_x [1, 256, 160, 160],P6_x [1, 256, 80, 80],P7_x [1, 256, 40, 40]]</span>
</span><span id="__span-13-61"><a id="__codelineno-13-61" name="__codelineno-13-61" href="#__codelineno-13-61"></a>
</span><span id="__span-13-62"><a id="__codelineno-13-62" name="__codelineno-13-62" href="#__codelineno-13-62"></a>
</span><span id="__span-13-63"><a id="__codelineno-13-63" name="__codelineno-13-63" href="#__codelineno-13-63"></a><span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
</span><span id="__span-13-64"><a id="__codelineno-13-64" name="__codelineno-13-64" href="#__codelineno-13-64"></a>    <span class="n">model</span> <span class="o">=</span> <span class="n">PyramidFeatures</span><span class="p">(</span><span class="mi">32</span><span class="p">,</span> <span class="mi">64</span><span class="p">,</span> <span class="mi">96</span><span class="p">)</span>
</span><span id="__span-13-65"><a id="__codelineno-13-65" name="__codelineno-13-65" href="#__codelineno-13-65"></a>    <span class="c1"># print(model)</span>
</span><span id="__span-13-66"><a id="__codelineno-13-66" name="__codelineno-13-66" href="#__codelineno-13-66"></a>    <span class="c1">##ËøôÈáåÂÅáËÆæËæìÂÖ•ÊòØ‰∏âÂ±Ç‰∏çÂêåÂ∞∫ÂØ∏ÁöÑÁâπÂæÅÂõæÔºåËæìÂÖ•ÁöÑÂΩ¢Áä∂ÊòØ[batch_size, 256, height, width]</span>
</span><span id="__span-13-67"><a id="__codelineno-13-67" name="__codelineno-13-67" href="#__codelineno-13-67"></a>    <span class="nb">input</span> <span class="o">=</span> <span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span> <span class="mi">640</span><span class="p">,</span> <span class="mi">640</span><span class="p">),</span> <span class="n">torch</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">64</span><span class="p">,</span> <span class="mi">320</span><span class="p">,</span> <span class="mi">320</span><span class="p">),</span> <span class="n">torch</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">96</span><span class="p">,</span> <span class="mi">160</span><span class="p">,</span> <span class="mi">160</span><span class="p">)]</span>
</span><span id="__span-13-68"><a id="__codelineno-13-68" name="__codelineno-13-68" href="#__codelineno-13-68"></a>    <span class="n">out</span> <span class="o">=</span> <span class="n">model</span><span class="p">(</span><span class="nb">input</span><span class="p">)</span>
</span><span id="__span-13-69"><a id="__codelineno-13-69" name="__codelineno-13-69" href="#__codelineno-13-69"></a>    <span class="nb">print</span><span class="p">(</span><span class="n">out</span><span class="p">)</span> <span class="c1"># ËøîÂõûÁöÑÊòØ‰∏Ä‰∏™ÂàóË°®</span>
</span></code></pre></div>
<h2 id="panet">PANet<a class="headerlink" href="#panet" title="Permanent link">&para;</a></h2>
<p><strong>PANetÔºàPath Aggregation NetworkÔºâ</strong></p>
<p>ICCV 2019</p>
<p>Â∞èÊ†∑Êú¨ÂõæÂÉèÂàÜÂâ≤</p>
<p><a href="https://openaccess.thecvf.com/content_ICCV_2019/papers/Wang_PANet_Few-Shot_Image_Semantic_Segmentation_With_Prototype_Alignment_ICCV_2019_paper.pdf">PANet: Few-Shot Image Semantic Segmentation with Prototype Alignment</a></p>
<h2 id="_4">Á©∫Èó¥Ê≥®ÊÑèÂäõÂèäÂèò‰Ωì<a class="headerlink" href="#_4" title="Permanent link">&para;</a></h2>
<h2 id="attention">‚àöAttention<a class="headerlink" href="#attention" title="Permanent link">&para;</a></h2>
<p><img alt="image-20250223172648964" src="../images/image-20250223172648964.png" /></p>
<p><img alt="image-20250223172826491" src="../images/image-20250223172826491.png" /></p>
<p>QKV ÊòØ X Âú®‰∏âÁßç‰∏çÂêåÂêëÈáèÁ©∫Èó¥ÁöÑË°®Á§∫ÔºåÂ¢ûÂº∫‰∫ÜÊ®°ÂûãÁöÑË°®ËææËÉΩÂäõ</p>
<p><img alt="image-20250223172907126" src="../images/image-20250223172907126.png" /></p>
<p><mark>‰∏∫‰ªÄ‰πà QK ‰πãÈó¥ÂÅö‰πòÊ≥ïÔºü</mark></p>
<ul>
<li>ÂêëÈáè‰πòÊ≥ïÂèØ‰ª•Áî®Êù•Ë°°ÈáèÂêëÈáè‰πãÈó¥ÁöÑÁõ∏‰ººÂ∫¶</li>
<li>ÂêëÈáèAÂíåÂêëÈáèBÁöÑÁÇπÁßØÁ≠â‰∫éÂêëÈáèAÁöÑÊ®°‰πò‰∏äÂêëÈáèBÁöÑÊ®°‰πò‰∏äÂ§πËßíÁöÑ‰ΩôÂº¶ÂÄº</li>
<li>ÂΩìÁªôÂÆö‰∏§‰∏™Á°ÆÂÆöÂêëÈáèÁöÑÊó∂ÂÄôÔºå‰πüÂ∞±ÊòØÂΩìÁªôÂÆö‰∏Ä‰∏™AÂêëÈáèÂíåBÂêëÈáèÁöÑÊó∂ÂÄôÔºö</li>
</ul>
<p>Â¶ÇÊûúÂÆÉ‰ª¨‰πãÈó¥ÁöÑÂ§πËßíË∂äÂ∞èÔºåÈÇ£ <span class="arithmatex">\(cos\theta\)</span> Â∞±Ë∂äÂ§ßÔºåÈÇ£‰πàÁõ∏Â∫îÁöÑËøô‰∏™ÁÇπÁßØÁöÑÂÄºÂ∞±Ë∂äÂ§ß</p>
<p>ÈÇ£‰πàÂ¶ÇÊûúÂÆÉ‰ª¨ÁöÑÂ§πËßíË∂äÂ§ßÔºåËøô‰∏™ <span class="arithmatex">\(cos\theta\)</span> Ë∂äÂ∞èÔºåÁõ∏Â∫îÁöÑÁÇπÂáªÂÄºÂ∞±Ë∂äÂ∞è</p>
<ul>
<li>‰ªéÊï¥‰Ωì‰∏äÊù•ÁúãÂëÄÔºåÁÇπÁßØÊìç‰ΩúÔºåÊó¢ÊúâÈïøÂ∫¶‰ø°ÊÅØÔºå‰πüÂ∞±ÊòØÊ®°ÈïøÔºå‰πüÊúâÊñπÂêë‰ø°ÊÅØÔºåÂ∞±ÊòØ <span class="arithmatex">\(cos\theta\)</span></li>
</ul>
<p><strong>ÊâÄ‰ª•ÔºåÁî®ÂêëÈáèÁÇπÁßØÊù•Ë°°ÈáèÂêëÈáè‰πãÈó¥ÁöÑÁõ∏‰ººÂ∫¶</strong></p>
<p><mark>‰∏∫‰ªÄ‰πà‰∏çÁî®‰ΩôÂº¶Áõ∏‰ººÂ∫¶Âë¢Ôºü</mark> </p>
<p>Ë¶ÅËÆ°ÁÆó‰ΩôÂº¶Áõ∏‰ººÂ∫¶ÔºåÂæóÊ±ÇÂêëÈáèAÂíåÂêëÈáèBÁöÑÊ®°ÔºåËÆ°ÁÆóÊòØÈùûÂ∏∏ËÄóÊó∂ËÄóÂäõÁöÑ</p>
<p>ÁÇπÁßØÁöÑËØùÂ∞±ÈùûÂ∏∏ÁöÑÈ´òÊïàÔºåÂè™ÈúÄË¶ÅÂØπÂ∫îÂÖÉÁ¥†Áõ∏‰πòÂπ∂Ê±ÇÂíåÂç≥ÂèØ</p>
<p><mark>‰∏∫‰ªÄ‰πàË¶ÅÊâßË°åÁº©ÊîæÊìç‰Ωú</mark></p>
<p>ÊääÂêëÈáèÁöÑÁª¥Â∫¶ËÆæÁΩÆ‰∏∫64ÂíåËÆæÁΩÆ‰∏∫512</p>
<p>Âú®ËÆ°ÁÆóÁÇπÁßØÁöÑÊó∂ÂÄôÔºåÁª¥Â∫¶Ë∂äÂ§ßÁÇπÁßØÁöÑÊï∞ÂÄºË∂äÂ§ßÔºåÊ≠§Êó∂Âú®ËÆ°ÁÆó softmax ‰πüÂ∞±ÊòØ e ÁöÑ x Ê¨°ÊñπÁöÑÊó∂ÂÄôÔºåÊåáÊï∞ÂáΩÊï∞ÁöÑÊï∞ÂÄº‰ºöÂèòÂ§ßÔºå‰ºöÈÄ†ÊàêÊ¢ØÂ∫¶‰∏çÁ®≥ÂÆöÔºåÊâÄ‰ª•Èô§‰ª•‰∏Ä‰∏™Áº©ÊîæÂõ†Â≠êÔºå‰πüÂ∞±ÊòØÊ†πÂè∑‰∏ã<span class="arithmatex">\(D_k\)</span>ÔºåÊó¢ÂèØ‰ª•‰øùÊåÅÊï∞ÂÄº‰∏äÁöÑÁ®≥ÂÆöÊÄßÔºå‰πüÂèØ‰ª•‰øùÊåÅÊ¢ØÂ∫¶‰∏äÁöÑÁ®≥ÂÆöÊÄß„ÄÇ</p>
<p><mark>Â§öÂ§¥Ê≥®ÊÑèÂäõÊú∫Âà∂</mark></p>
<p><img alt="image-20250223173913249" src="../images/image-20250223173913249.png" /></p>
<p>Â§öÂ§¥Ëá™Ê≥®ÊÑèÂäõÊú∫Âà∂ÊòØÁî±Â§ö‰∏™Ëá™Ê≥®ÊÑè„ÄÅÂ§ö‰∏™Áº©ÊîæÁÇπÂáªÊ≥®ÊÑèÂäõÊûÑÊàêÁöÑÔºåÂ§ßÂÆ∂ÂêÑËÆ°ÁÆóÂêÑÁöÑ‰∫í‰∏çÁõ∏Âπ≤ÔºåÊúÄÂêéÂè™Ë¶ÅÂ∞ÜÊØè‰∏™Ëá™Ê≥®ÊÑèÂäõÊú∫Âà∂ÁöÑ‰∏Ä‰∏™ËæìÂá∫ËøõË°å‰∏Ä‰∏™ÊãºÊé•ÔºåÂÜçÈÄöËøá‰∏Ä‰∏™Á∫øÊÄßÂ±ÇËûçÂêàÂ∞±ÂèØ‰ª•‰∫Ü</p>
<p><mark>Á¨¨‰∏Ä‰∏™ÁÇπÔºåÂ¶Ç‰ΩïÂàíÂàÜÂ§öÂ§¥Ôºü</mark></p>
<p>ÊúÄÁÆÄÂçïÁöÑÊñπÂºèÔºåÂΩìÁªôÂÆö‰∏Ä‰∏™BCHWÁü©ÈòµÁöÑÊó∂ÂÄôÔºåÂú®Ëøô‰∏™ÈÄöÈÅìC‰∏äÂπ≥ÂùáÂàíÂàÜ‰∏∫MÁªÑÔºåÊØèÁªÑÈÄöÈÅìÊï∞ÈáèÊòØKÔºåM‰πòKÁ≠â‰∫éC</p>
<p>‰∏∫‰∫Ü‰æø‰∫éËÆ°ÁÆóÔºåÈÄöÂ∏∏‰ºöÂ∞ÜMÔºåËøÅÁßªÂà∞Á¨¨‰∏Ä‰∏™Áª¥Â∫¶‰∏äÈù¢ÔºåÁÑ∂ÂêéËÆ©ÂÆÉÈáçÊñ∞Âèò‰∏∫‰∏Ä‰∏™ÂõõÁª¥Áü©ÈòµÔºåÊØè‰∏ÄÁªÑÁöÑËÆ°ÁÆóÔºåÈÉΩÊòØÁã¨Á´ãÁöÑ</p>
<p><mark>Á¨¨‰∫å‰∏™ÁÇπÂú®ËæìÂá∫ÁöÑÊó∂ÂÄôÔºåconcatÂíå LinearÔºü</mark></p>
<p>Âú®Ëøô‰∏™ËæìÂá∫ÁöÑÊó∂ÂÄôÔºåÈ¶ñÂÖà Â§ö‰∏™Â§¥ÁöÑËæìÂá∫ÔºåÂú®ÈÄöÈÅì‰∏äËøõË°å‰∏Ä‰∏™ÊãºÊé•ÔºåÂπ∂‰∏îÊÅ¢Â§çÂíåËæìÂÖ•Áõ∏ÂêåÁöÑshapeÔºåÁÑ∂ÂêéÂÜçÈÄöËøá‰∏Ä‰∏™Á∫øÊÄßÂ±Ç</p>
<p><strong>ÂÖ≥‰∫é ÊãºÊé•ÂíåÁ∫øÊÄßÂ±Ç</strong> </p>
<p>Â§öÂ§¥Ëá™Ê≥®ÊÑèÂäõÊú∫Âà∂ÔºåÊØè‰∏Ä‰∏™Â§¥ÈÉΩÂú®‰∏çÂêåÁöÑÂêëÈáèÁ©∫Èó¥ËøõË°åËÆ°ÁÆóÔºåÂú®‰∏çÂêåÁöÑÂêëÈáèÁ©∫Èó¥ÊèêÂèñÊúâÁî®ÁöÑÁâπÂæÅ„ÄÇ</p>
<p>‰æãÂ¶ÇË¶ÅÊèêÂèñ‰∏Ä‰∏™‰∫∫ÁöÑÁâπÂæÅÔºåÂ§öÂ§¥Ëá™Ê≥®ÊÑèÂäõÊú∫Âà∂ÔºåÂèØ‰ª•Áúã‰ΩúÊòØÂú®‰∏çÂêåÁöÑÂ§¥ÔºåÂàÜÂà´ÂÖ≥Ê≥®Ë∫´È´òÂπ¥ÈæÑÈïøÁõ∏Â∑•‰ΩúÁ≠âÁâπÂæÅÔºåÊúÄÂêéÔºåÂ∞ÜËøô‰∫õ‰∏çÂêåÂêëÈáèÁ©∫Èó¥ÁöÑÁâπÂæÅËøõË°åÊãºÊé•ÔºåÁÑ∂ÂêéÂÜçÈÄöËøá‰∏Ä‰∏™Á∫øÊÄßÂ±ÇËøõË°åËûçÂêàÔºåÂæóÂà∞Êõ¥Êñ∞ÂêéÁöÑÁâπÂæÅ„ÄÇ</p>
<p>‰ª£Á†Å</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-14-1"><a id="__codelineno-14-1" name="__codelineno-14-1" href="#__codelineno-14-1"></a><span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
</span><span id="__span-14-2"><a id="__codelineno-14-2" name="__codelineno-14-2" href="#__codelineno-14-2"></a><span class="kn">import</span><span class="w"> </span><span class="nn">torch</span>
</span><span id="__span-14-3"><a id="__codelineno-14-3" name="__codelineno-14-3" href="#__codelineno-14-3"></a><span class="kn">from</span><span class="w"> </span><span class="nn">torch</span><span class="w"> </span><span class="kn">import</span> <span class="n">nn</span>
</span><span id="__span-14-4"><a id="__codelineno-14-4" name="__codelineno-14-4" href="#__codelineno-14-4"></a><span class="kn">from</span><span class="w"> </span><span class="nn">torch.nn</span><span class="w"> </span><span class="kn">import</span> <span class="n">init</span>
</span><span id="__span-14-5"><a id="__codelineno-14-5" name="__codelineno-14-5" href="#__codelineno-14-5"></a>
</span><span id="__span-14-6"><a id="__codelineno-14-6" name="__codelineno-14-6" href="#__codelineno-14-6"></a><span class="s2">&quot;Attention Is All You Need&quot;</span>
</span><span id="__span-14-7"><a id="__codelineno-14-7" name="__codelineno-14-7" href="#__codelineno-14-7"></a>
</span><span id="__span-14-8"><a id="__codelineno-14-8" name="__codelineno-14-8" href="#__codelineno-14-8"></a><span class="k">class</span><span class="w"> </span><span class="nc">ScaledDotProductAttention</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
</span><span id="__span-14-9"><a id="__codelineno-14-9" name="__codelineno-14-9" href="#__codelineno-14-9"></a><span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
</span><span id="__span-14-10"><a id="__codelineno-14-10" name="__codelineno-14-10" href="#__codelineno-14-10"></a><span class="sd">    Scaled dot-product attention</span>
</span><span id="__span-14-11"><a id="__codelineno-14-11" name="__codelineno-14-11" href="#__codelineno-14-11"></a><span class="sd">    &#39;&#39;&#39;</span>
</span><span id="__span-14-12"><a id="__codelineno-14-12" name="__codelineno-14-12" href="#__codelineno-14-12"></a>
</span><span id="__span-14-13"><a id="__codelineno-14-13" name="__codelineno-14-13" href="#__codelineno-14-13"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">d_model</span><span class="p">,</span> <span class="n">d_k</span><span class="p">,</span> <span class="n">d_v</span><span class="p">,</span> <span class="n">h</span><span class="p">,</span><span class="n">dropout</span><span class="o">=</span><span class="mf">.1</span><span class="p">):</span>
</span><span id="__span-14-14"><a id="__codelineno-14-14" name="__codelineno-14-14" href="#__codelineno-14-14"></a><span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
</span><span id="__span-14-15"><a id="__codelineno-14-15" name="__codelineno-14-15" href="#__codelineno-14-15"></a><span class="sd">        :param d_model: Output dimensionality of the model</span>
</span><span id="__span-14-16"><a id="__codelineno-14-16" name="__codelineno-14-16" href="#__codelineno-14-16"></a><span class="sd">        :param d_k: Dimensionality of queries and keys</span>
</span><span id="__span-14-17"><a id="__codelineno-14-17" name="__codelineno-14-17" href="#__codelineno-14-17"></a><span class="sd">        :param d_v: Dimensionality of values</span>
</span><span id="__span-14-18"><a id="__codelineno-14-18" name="__codelineno-14-18" href="#__codelineno-14-18"></a><span class="sd">        :param h: Number of heads</span>
</span><span id="__span-14-19"><a id="__codelineno-14-19" name="__codelineno-14-19" href="#__codelineno-14-19"></a><span class="sd">        &#39;&#39;&#39;</span>
</span><span id="__span-14-20"><a id="__codelineno-14-20" name="__codelineno-14-20" href="#__codelineno-14-20"></a>        <span class="nb">super</span><span class="p">(</span><span class="n">ScaledDotProductAttention</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
</span><span id="__span-14-21"><a id="__codelineno-14-21" name="__codelineno-14-21" href="#__codelineno-14-21"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">fc_q</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="n">d_model</span><span class="p">,</span> <span class="n">h</span> <span class="o">*</span> <span class="n">d_k</span><span class="p">)</span>
</span><span id="__span-14-22"><a id="__codelineno-14-22" name="__codelineno-14-22" href="#__codelineno-14-22"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">fc_k</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="n">d_model</span><span class="p">,</span> <span class="n">h</span> <span class="o">*</span> <span class="n">d_k</span><span class="p">)</span>
</span><span id="__span-14-23"><a id="__codelineno-14-23" name="__codelineno-14-23" href="#__codelineno-14-23"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">fc_v</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="n">d_model</span><span class="p">,</span> <span class="n">h</span> <span class="o">*</span> <span class="n">d_v</span><span class="p">)</span>
</span><span id="__span-14-24"><a id="__codelineno-14-24" name="__codelineno-14-24" href="#__codelineno-14-24"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">fc_o</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="n">h</span> <span class="o">*</span> <span class="n">d_v</span><span class="p">,</span> <span class="n">d_model</span><span class="p">)</span>
</span><span id="__span-14-25"><a id="__codelineno-14-25" name="__codelineno-14-25" href="#__codelineno-14-25"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">dropout</span><span class="o">=</span><span class="n">nn</span><span class="o">.</span><span class="n">Dropout</span><span class="p">(</span><span class="n">dropout</span><span class="p">)</span>
</span><span id="__span-14-26"><a id="__codelineno-14-26" name="__codelineno-14-26" href="#__codelineno-14-26"></a>
</span><span id="__span-14-27"><a id="__codelineno-14-27" name="__codelineno-14-27" href="#__codelineno-14-27"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">d_model</span> <span class="o">=</span> <span class="n">d_model</span>
</span><span id="__span-14-28"><a id="__codelineno-14-28" name="__codelineno-14-28" href="#__codelineno-14-28"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">d_k</span> <span class="o">=</span> <span class="n">d_k</span>
</span><span id="__span-14-29"><a id="__codelineno-14-29" name="__codelineno-14-29" href="#__codelineno-14-29"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">d_v</span> <span class="o">=</span> <span class="n">d_v</span>
</span><span id="__span-14-30"><a id="__codelineno-14-30" name="__codelineno-14-30" href="#__codelineno-14-30"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">h</span> <span class="o">=</span> <span class="n">h</span>
</span><span id="__span-14-31"><a id="__codelineno-14-31" name="__codelineno-14-31" href="#__codelineno-14-31"></a>
</span><span id="__span-14-32"><a id="__codelineno-14-32" name="__codelineno-14-32" href="#__codelineno-14-32"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">init_weights</span><span class="p">()</span>
</span><span id="__span-14-33"><a id="__codelineno-14-33" name="__codelineno-14-33" href="#__codelineno-14-33"></a>
</span><span id="__span-14-34"><a id="__codelineno-14-34" name="__codelineno-14-34" href="#__codelineno-14-34"></a>
</span><span id="__span-14-35"><a id="__codelineno-14-35" name="__codelineno-14-35" href="#__codelineno-14-35"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">init_weights</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="__span-14-36"><a id="__codelineno-14-36" name="__codelineno-14-36" href="#__codelineno-14-36"></a>        <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">modules</span><span class="p">():</span>
</span><span id="__span-14-37"><a id="__codelineno-14-37" name="__codelineno-14-37" href="#__codelineno-14-37"></a>            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">nn</span><span class="o">.</span><span class="n">Conv2d</span><span class="p">):</span>
</span><span id="__span-14-38"><a id="__codelineno-14-38" name="__codelineno-14-38" href="#__codelineno-14-38"></a>                <span class="n">init</span><span class="o">.</span><span class="n">kaiming_normal_</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">weight</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;fan_out&#39;</span><span class="p">)</span>
</span><span id="__span-14-39"><a id="__codelineno-14-39" name="__codelineno-14-39" href="#__codelineno-14-39"></a>                <span class="k">if</span> <span class="n">m</span><span class="o">.</span><span class="n">bias</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="__span-14-40"><a id="__codelineno-14-40" name="__codelineno-14-40" href="#__codelineno-14-40"></a>                    <span class="n">init</span><span class="o">.</span><span class="n">constant_</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">bias</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
</span><span id="__span-14-41"><a id="__codelineno-14-41" name="__codelineno-14-41" href="#__codelineno-14-41"></a>            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">nn</span><span class="o">.</span><span class="n">BatchNorm2d</span><span class="p">):</span>
</span><span id="__span-14-42"><a id="__codelineno-14-42" name="__codelineno-14-42" href="#__codelineno-14-42"></a>                <span class="n">init</span><span class="o">.</span><span class="n">constant_</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">weight</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
</span><span id="__span-14-43"><a id="__codelineno-14-43" name="__codelineno-14-43" href="#__codelineno-14-43"></a>                <span class="n">init</span><span class="o">.</span><span class="n">constant_</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">bias</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
</span><span id="__span-14-44"><a id="__codelineno-14-44" name="__codelineno-14-44" href="#__codelineno-14-44"></a>            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">):</span>
</span><span id="__span-14-45"><a id="__codelineno-14-45" name="__codelineno-14-45" href="#__codelineno-14-45"></a>                <span class="n">init</span><span class="o">.</span><span class="n">normal_</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">weight</span><span class="p">,</span> <span class="n">std</span><span class="o">=</span><span class="mf">0.001</span><span class="p">)</span>
</span><span id="__span-14-46"><a id="__codelineno-14-46" name="__codelineno-14-46" href="#__codelineno-14-46"></a>                <span class="k">if</span> <span class="n">m</span><span class="o">.</span><span class="n">bias</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="__span-14-47"><a id="__codelineno-14-47" name="__codelineno-14-47" href="#__codelineno-14-47"></a>                    <span class="n">init</span><span class="o">.</span><span class="n">constant_</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">bias</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
</span><span id="__span-14-48"><a id="__codelineno-14-48" name="__codelineno-14-48" href="#__codelineno-14-48"></a>
</span><span id="__span-14-49"><a id="__codelineno-14-49" name="__codelineno-14-49" href="#__codelineno-14-49"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">queries</span><span class="p">,</span> <span class="n">keys</span><span class="p">,</span> <span class="n">values</span><span class="p">,</span> <span class="n">attention_mask</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">attention_weights</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
</span><span id="__span-14-50"><a id="__codelineno-14-50" name="__codelineno-14-50" href="#__codelineno-14-50"></a><span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
</span><span id="__span-14-51"><a id="__codelineno-14-51" name="__codelineno-14-51" href="#__codelineno-14-51"></a><span class="sd">        Computes</span>
</span><span id="__span-14-52"><a id="__codelineno-14-52" name="__codelineno-14-52" href="#__codelineno-14-52"></a><span class="sd">        :param queries: Queries (b_s, nq, d_model)</span>
</span><span id="__span-14-53"><a id="__codelineno-14-53" name="__codelineno-14-53" href="#__codelineno-14-53"></a><span class="sd">        :param keys: Keys (b_s, nk, d_model)</span>
</span><span id="__span-14-54"><a id="__codelineno-14-54" name="__codelineno-14-54" href="#__codelineno-14-54"></a><span class="sd">        :param values: Values (b_s, nk, d_model)</span>
</span><span id="__span-14-55"><a id="__codelineno-14-55" name="__codelineno-14-55" href="#__codelineno-14-55"></a><span class="sd">        :param attention_mask: Mask over attention values (b_s, h, nq, nk). True indicates masking.</span>
</span><span id="__span-14-56"><a id="__codelineno-14-56" name="__codelineno-14-56" href="#__codelineno-14-56"></a><span class="sd">        :param attention_weights: Multiplicative weights for attention values (b_s, h, nq, nk).</span>
</span><span id="__span-14-57"><a id="__codelineno-14-57" name="__codelineno-14-57" href="#__codelineno-14-57"></a><span class="sd">        :return:</span>
</span><span id="__span-14-58"><a id="__codelineno-14-58" name="__codelineno-14-58" href="#__codelineno-14-58"></a><span class="sd">        &#39;&#39;&#39;</span>
</span><span id="__span-14-59"><a id="__codelineno-14-59" name="__codelineno-14-59" href="#__codelineno-14-59"></a>        <span class="c1"># (B, N, C), N=nq</span>
</span><span id="__span-14-60"><a id="__codelineno-14-60" name="__codelineno-14-60" href="#__codelineno-14-60"></a>        <span class="n">B</span><span class="p">,</span> <span class="n">nq</span> <span class="o">=</span> <span class="n">queries</span><span class="o">.</span><span class="n">shape</span><span class="p">[:</span><span class="mi">2</span><span class="p">]</span> <span class="c1"># B=2Ôºånq=50</span>
</span><span id="__span-14-61"><a id="__codelineno-14-61" name="__codelineno-14-61" href="#__codelineno-14-61"></a>        <span class="n">nk</span> <span class="o">=</span> <span class="n">keys</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="c1"># nk=50</span>
</span><span id="__span-14-62"><a id="__codelineno-14-62" name="__codelineno-14-62" href="#__codelineno-14-62"></a>
</span><span id="__span-14-63"><a id="__codelineno-14-63" name="__codelineno-14-63" href="#__codelineno-14-63"></a>        <span class="n">q</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fc_q</span><span class="p">(</span><span class="n">queries</span><span class="p">)</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="n">B</span><span class="p">,</span> <span class="n">nq</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">h</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">d_k</span><span class="p">)</span><span class="o">.</span><span class="n">permute</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>  
</span><span id="__span-14-64"><a id="__codelineno-14-64" name="__codelineno-14-64" href="#__codelineno-14-64"></a>        <span class="c1"># (B,N,C)--&gt;(B,nq,h*d_k)--&gt;(B,nq,h,d_k)--&gt;(B,h,nq,d_k)  h:Ê≥®ÊÑèÂäõÂ§¥ÁöÑ‰∏™Êï∞, d_k:QKÊØè‰∏Ä‰∏™Ê≥®ÊÑèÂäõÂ§¥ÁöÑÈÄöÈÅìÊï∞</span>
</span><span id="__span-14-65"><a id="__codelineno-14-65" name="__codelineno-14-65" href="#__codelineno-14-65"></a>        <span class="c1"># [2, 50, 64]-&gt; self.fc_q=Linear(in_features=64, out_features=512, bias=True)-&gt;[2,50,512]-&gt;view-&gt;(2,50,8,64)-&gt;premute-&gt;(2,8,50,64)</span>
</span><span id="__span-14-66"><a id="__codelineno-14-66" name="__codelineno-14-66" href="#__codelineno-14-66"></a>
</span><span id="__span-14-67"><a id="__codelineno-14-67" name="__codelineno-14-67" href="#__codelineno-14-67"></a>        <span class="n">k</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fc_k</span><span class="p">(</span><span class="n">keys</span><span class="p">)</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="n">B</span><span class="p">,</span> <span class="n">nk</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">h</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">d_k</span><span class="p">)</span><span class="o">.</span><span class="n">permute</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>  
</span><span id="__span-14-68"><a id="__codelineno-14-68" name="__codelineno-14-68" href="#__codelineno-14-68"></a>        <span class="c1">#  (B,N,C)--&gt;(B,nq,h*d_k)--&gt;(B,nk,h,d_k)--&gt;(B,h,d_k,nk)</span>
</span><span id="__span-14-69"><a id="__codelineno-14-69" name="__codelineno-14-69" href="#__codelineno-14-69"></a>        <span class="c1"># [2, 50, 64]-&gt;Linear(in_features=64, out_features=512, bias=True)-&gt;[2,50,512]-&gt;view-&gt;[2,50,8,64]-&gt;permute-&gt;[2,8,64,50]</span>
</span><span id="__span-14-70"><a id="__codelineno-14-70" name="__codelineno-14-70" href="#__codelineno-14-70"></a>
</span><span id="__span-14-71"><a id="__codelineno-14-71" name="__codelineno-14-71" href="#__codelineno-14-71"></a>        <span class="n">v</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fc_v</span><span class="p">(</span><span class="n">values</span><span class="p">)</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="n">B</span><span class="p">,</span> <span class="n">nk</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">h</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">d_v</span><span class="p">)</span><span class="o">.</span><span class="n">permute</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>  
</span><span id="__span-14-72"><a id="__codelineno-14-72" name="__codelineno-14-72" href="#__codelineno-14-72"></a>        <span class="c1"># (B,N,C)--&gt;(B,nk,h*d_v)--&gt;(B,nk,h,d_v)--&gt;(B,h,nk,d_v)      </span>
</span><span id="__span-14-73"><a id="__codelineno-14-73" name="__codelineno-14-73" href="#__codelineno-14-73"></a>        <span class="c1"># [2, 50, 64]-&gt;Linear(in_features=64, out_features=512, bias=True)-&gt;[2,50,512]-&gt;view-&gt;[2,50,8,64]-&gt;[2,8,50,64]</span>
</span><span id="__span-14-74"><a id="__codelineno-14-74" name="__codelineno-14-74" href="#__codelineno-14-74"></a>
</span><span id="__span-14-75"><a id="__codelineno-14-75" name="__codelineno-14-75" href="#__codelineno-14-75"></a>        <span class="n">att</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">matmul</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">d_k</span><span class="p">)</span>  <span class="c1"># (B, h, nq, nk)</span>
</span><span id="__span-14-76"><a id="__codelineno-14-76" name="__codelineno-14-76" href="#__codelineno-14-76"></a>        <span class="c1"># q (2,8,50,64) k [2,8,64,50] -&gt; torch.matmul -&gt; [2, 8, 50, 50]</span>
</span><span id="__span-14-77"><a id="__codelineno-14-77" name="__codelineno-14-77" href="#__codelineno-14-77"></a>
</span><span id="__span-14-78"><a id="__codelineno-14-78" name="__codelineno-14-78" href="#__codelineno-14-78"></a>        <span class="c1"># Â¶ÇÊûúÈúÄË¶Å‰∏∫Ê≥®ÊÑèÂäõÁü©ÈòµÈ¢ùÂ§ñÊ∑ªÂä†‰∏Ä‰∏™ÂèÇÊï∞Áü©Èòµ,ÈÇ£‰πàÊâßË°åÈÄêÁÇπÁõ∏‰πòÂç≥ÂèØ</span>
</span><span id="__span-14-79"><a id="__codelineno-14-79" name="__codelineno-14-79" href="#__codelineno-14-79"></a>        <span class="k">if</span> <span class="n">attention_weights</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span> <span class="c1"># attention_weights = None</span>
</span><span id="__span-14-80"><a id="__codelineno-14-80" name="__codelineno-14-80" href="#__codelineno-14-80"></a>            <span class="n">att</span> <span class="o">=</span> <span class="n">att</span> <span class="o">*</span> <span class="n">attention_weights</span>
</span><span id="__span-14-81"><a id="__codelineno-14-81" name="__codelineno-14-81" href="#__codelineno-14-81"></a>        <span class="c1"># Â¶ÇÊûúÈúÄË¶Å‰∏∫Ê≥®ÊÑèÂäõÁü©ÈòµÊ∑ªÂä†mask,ÈÇ£‰πàÂú®ÂØπÂ∫îÈúÄË¶ÅmaskÁöÑÂú∞ÊñπÂ°´ÂÖÖ‰∏∫Ë¥üÊó†Á©∑Êï∞ÂÄº,ËøôÊ†∑Âú®ËÆ°ÁÆósoftmaxÁöÑÊó∂ÂÄô,Ë¥üÊó†Á©∑ÁöÑÂΩí‰∏ÄÂåñÂæóÂàÜÂ∞ÜË∂ãËøë‰∫é0</span>
</span><span id="__span-14-82"><a id="__codelineno-14-82" name="__codelineno-14-82" href="#__codelineno-14-82"></a>        <span class="k">if</span> <span class="n">attention_mask</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span> <span class="c1"># attention_mask = None</span>
</span><span id="__span-14-83"><a id="__codelineno-14-83" name="__codelineno-14-83" href="#__codelineno-14-83"></a>            <span class="n">att</span> <span class="o">=</span> <span class="n">att</span><span class="o">.</span><span class="n">masked_fill</span><span class="p">(</span><span class="n">attention_mask</span><span class="p">,</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">)</span>
</span><span id="__span-14-84"><a id="__codelineno-14-84" name="__codelineno-14-84" href="#__codelineno-14-84"></a>        <span class="n">att</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">softmax</span><span class="p">(</span><span class="n">att</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> 
</span><span id="__span-14-85"><a id="__codelineno-14-85" name="__codelineno-14-85" href="#__codelineno-14-85"></a>        <span class="c1"># [2, 8, 50, 50] -&gt; torch.softmax -&gt; [2, 8, 50, 50]</span>
</span><span id="__span-14-86"><a id="__codelineno-14-86" name="__codelineno-14-86" href="#__codelineno-14-86"></a>        <span class="c1"># attn n_q d_q √ó d_k n_k = n_q √ó n_k Âú® n_k ÂàóËøõË°åsoftmax</span>
</span><span id="__span-14-87"><a id="__codelineno-14-87" name="__codelineno-14-87" href="#__codelineno-14-87"></a>
</span><span id="__span-14-88"><a id="__codelineno-14-88" name="__codelineno-14-88" href="#__codelineno-14-88"></a>        <span class="n">att</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dropout</span><span class="p">(</span><span class="n">att</span><span class="p">)</span>
</span><span id="__span-14-89"><a id="__codelineno-14-89" name="__codelineno-14-89" href="#__codelineno-14-89"></a>
</span><span id="__span-14-90"><a id="__codelineno-14-90" name="__codelineno-14-90" href="#__codelineno-14-90"></a>
</span><span id="__span-14-91"><a id="__codelineno-14-91" name="__codelineno-14-91" href="#__codelineno-14-91"></a>        <span class="n">out</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">matmul</span><span class="p">(</span><span class="n">att</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span><span class="o">.</span><span class="n">permute</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span><span class="o">.</span><span class="n">contiguous</span><span class="p">()</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="n">B</span><span class="p">,</span> <span class="n">nq</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">h</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">d_v</span><span class="p">)</span>  
</span><span id="__span-14-92"><a id="__codelineno-14-92" name="__codelineno-14-92" href="#__codelineno-14-92"></a>        <span class="c1"># (B,h,nq,nk)@(B,h,nk,d_v)=(B,h,nq,d_v)--&gt;(B,nq,h,d_v)--&gt;(B,nq,h*d_v)</span>
</span><span id="__span-14-93"><a id="__codelineno-14-93" name="__codelineno-14-93" href="#__codelineno-14-93"></a>        <span class="c1"># [2, 8, 50, 50] @ [2, 8, 50, 64] -&gt; [2, 8, 50, 64] -&gt; permute -&gt; [2,50,8,64] -&gt; contiguous -&gt; view -&gt; [2,50,512]</span>
</span><span id="__span-14-94"><a id="__codelineno-14-94" name="__codelineno-14-94" href="#__codelineno-14-94"></a>        <span class="c1"># ËøôÈáåÊúâÂ§öÂ§¥Ê≥®ÊÑèÂäõÈúÄË¶ÅÊ≥®ÊÑèÁöÑÁÇπÔºö‰∏∫‰ªÄ‰πàË¶ÅËøõË°å concat Âíå Linear Âõ†‰∏∫ÊØè‰∏™Â§¥ÂàÜÂà´Â≠¶‰π†‰∫∫ÁöÑ‰∏Ä‰∏™ÁâπÂæÅÔºåÊúÄÂêéÁöÑÊ≥®ÊÑèÂäõÊòØÈúÄË¶Å‰∫§‰∫íÁöÑ</span>
</span><span id="__span-14-95"><a id="__codelineno-14-95" name="__codelineno-14-95" href="#__codelineno-14-95"></a>
</span><span id="__span-14-96"><a id="__codelineno-14-96" name="__codelineno-14-96" href="#__codelineno-14-96"></a>        <span class="n">out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fc_o</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>  <span class="c1"># (B,nq,C) [2, 50, 512]-&gt;Linear(in_features=512, out_features=64, bias=True) -&gt; [2, 50, 64]</span>
</span><span id="__span-14-97"><a id="__codelineno-14-97" name="__codelineno-14-97" href="#__codelineno-14-97"></a>        <span class="k">return</span> <span class="n">out</span>
</span><span id="__span-14-98"><a id="__codelineno-14-98" name="__codelineno-14-98" href="#__codelineno-14-98"></a>
</span><span id="__span-14-99"><a id="__codelineno-14-99" name="__codelineno-14-99" href="#__codelineno-14-99"></a>
</span><span id="__span-14-100"><a id="__codelineno-14-100" name="__codelineno-14-100" href="#__codelineno-14-100"></a><span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
</span><span id="__span-14-101"><a id="__codelineno-14-101" name="__codelineno-14-101" href="#__codelineno-14-101"></a>    <span class="c1"># (B, N, C)</span>
</span><span id="__span-14-102"><a id="__codelineno-14-102" name="__codelineno-14-102" href="#__codelineno-14-102"></a>    <span class="nb">input</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">50</span><span class="p">,</span><span class="mi">64</span><span class="p">)</span>
</span><span id="__span-14-103"><a id="__codelineno-14-103" name="__codelineno-14-103" href="#__codelineno-14-103"></a>    <span class="n">Model</span> <span class="o">=</span> <span class="n">ScaledDotProductAttention</span><span class="p">(</span><span class="n">d_model</span><span class="o">=</span><span class="mi">64</span><span class="p">,</span> <span class="n">d_k</span><span class="o">=</span><span class="mi">64</span><span class="p">,</span> <span class="n">d_v</span><span class="o">=</span><span class="mi">64</span><span class="p">,</span> <span class="n">h</span><span class="o">=</span><span class="mi">8</span><span class="p">)</span>
</span><span id="__span-14-104"><a id="__codelineno-14-104" name="__codelineno-14-104" href="#__codelineno-14-104"></a>    <span class="n">output</span><span class="o">=</span><span class="n">Model</span><span class="p">(</span><span class="nb">input</span><span class="p">,</span><span class="nb">input</span><span class="p">,</span><span class="nb">input</span><span class="p">)</span>
</span><span id="__span-14-105"><a id="__codelineno-14-105" name="__codelineno-14-105" href="#__codelineno-14-105"></a>    <span class="nb">print</span><span class="p">(</span><span class="n">output</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
</span></code></pre></div>
<h2 id="attention_1">Attention ÊãìÂ±ï<a class="headerlink" href="#attention_1" title="Permanent link">&para;</a></h2>
<p><img alt="image-20250223213343729" src="../images/image-20250223213343729.png" /></p>
<p><img alt="image-20250223213743962" src="../images/image-20250223213743962.png" /></p>
<p><img alt="image-20250223214012716" src="../images/image-20250223214012716.png" /></p>
<h2 id="cot">‰∏ä‰∏ãÊñá CoT<a class="headerlink" href="#cot" title="Permanent link">&para;</a></h2>
<ul>
<li>È¶ñÂÖà query Âπ∂Ê≤°ÊúâÁªèËøá 1x1 ÁöÑ conv ÂèòÊç¢Ôºà‰πüÂ∞±ÊòØÂØπÂ∫îÂ∫èÂàóÁöÑ linearÔºâÔºåËÄåÊòØÁõ¥Êé• x = query</li>
<li>key ÊòØËÅöÂêà‰∫Ü 3 x 3 Á™óÂè£ËåÉÂõ¥ÂÜÖÁöÑ‰∏ä‰∏ãÊñá‰ø°ÊÅØ</li>
<li>query Âíå key Âú®ÈÄöÈÅì‰∏äËøõË°åÊãºÊé•ÔºåÁªèËøá‰∏§‰∏™ 1x1 ÁöÑÂç∑ÁßØÔºåÂæóÂà∞ÊùÉÈáçÁü©Èòµ</li>
</ul>
<p><img alt="image-20250223223714588" src="../images/image-20250223223714588.png" /></p>
<p>ÈöæÁÇπÔºö<mark>ÊÄé‰πàÁêÜËß£ query Âíå key Âú®ÈÄöÈÅì‰∏äËøõË°åÊãºÊé•ÔºåÁªèËøá‰∏§‰∏™ 1x1 ÁöÑÂç∑ÁßØÔºåÂæóÂà∞ÊùÉÈáçÁü©ÈòµÔºü</mark>  </p>
<p><mark>‰∏Ä‰∏™ÊãºÊé•ÂêéÁöÑÂêëÈáèÔºåÂÆÉÊÄé‰πàÂ∞±ËÉΩÂèòÊàêÊ≥®ÊÑèÂäõÊùÉÈáçÁü©ÈòµÔºü</mark></p>
<p><img alt="image-20250223223642221" src="../images/image-20250223223642221.png" /></p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-15-1"><a id="__codelineno-15-1" name="__codelineno-15-1" href="#__codelineno-15-1"></a><span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
</span><span id="__span-15-2"><a id="__codelineno-15-2" name="__codelineno-15-2" href="#__codelineno-15-2"></a><span class="kn">import</span><span class="w"> </span><span class="nn">torch</span>
</span><span id="__span-15-3"><a id="__codelineno-15-3" name="__codelineno-15-3" href="#__codelineno-15-3"></a><span class="kn">from</span><span class="w"> </span><span class="nn">torch</span><span class="w"> </span><span class="kn">import</span> <span class="n">flatten</span><span class="p">,</span> <span class="n">nn</span>
</span><span id="__span-15-4"><a id="__codelineno-15-4" name="__codelineno-15-4" href="#__codelineno-15-4"></a><span class="kn">from</span><span class="w"> </span><span class="nn">torch.nn</span><span class="w"> </span><span class="kn">import</span> <span class="n">init</span>
</span><span id="__span-15-5"><a id="__codelineno-15-5" name="__codelineno-15-5" href="#__codelineno-15-5"></a><span class="kn">from</span><span class="w"> </span><span class="nn">torch.nn.modules.activation</span><span class="w"> </span><span class="kn">import</span> <span class="n">ReLU</span>
</span><span id="__span-15-6"><a id="__codelineno-15-6" name="__codelineno-15-6" href="#__codelineno-15-6"></a><span class="kn">from</span><span class="w"> </span><span class="nn">torch.nn.modules.batchnorm</span><span class="w"> </span><span class="kn">import</span> <span class="n">BatchNorm2d</span>
</span><span id="__span-15-7"><a id="__codelineno-15-7" name="__codelineno-15-7" href="#__codelineno-15-7"></a><span class="kn">from</span><span class="w"> </span><span class="nn">torch.nn</span><span class="w"> </span><span class="kn">import</span> <span class="n">functional</span> <span class="k">as</span> <span class="n">F</span>
</span><span id="__span-15-8"><a id="__codelineno-15-8" name="__codelineno-15-8" href="#__codelineno-15-8"></a>
</span><span id="__span-15-9"><a id="__codelineno-15-9" name="__codelineno-15-9" href="#__codelineno-15-9"></a><span class="s2">&quot;Contextual Transformer Networks for Visual Recognition&quot;</span>
</span><span id="__span-15-10"><a id="__codelineno-15-10" name="__codelineno-15-10" href="#__codelineno-15-10"></a>
</span><span id="__span-15-11"><a id="__codelineno-15-11" name="__codelineno-15-11" href="#__codelineno-15-11"></a><span class="k">class</span><span class="w"> </span><span class="nc">CoTAttention</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
</span><span id="__span-15-12"><a id="__codelineno-15-12" name="__codelineno-15-12" href="#__codelineno-15-12"></a>
</span><span id="__span-15-13"><a id="__codelineno-15-13" name="__codelineno-15-13" href="#__codelineno-15-13"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">512</span><span class="p">,</span><span class="n">kernel_size</span><span class="o">=</span><span class="mi">3</span><span class="p">):</span>
</span><span id="__span-15-14"><a id="__codelineno-15-14" name="__codelineno-15-14" href="#__codelineno-15-14"></a>        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
</span><span id="__span-15-15"><a id="__codelineno-15-15" name="__codelineno-15-15" href="#__codelineno-15-15"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">dim</span><span class="o">=</span><span class="n">dim</span>
</span><span id="__span-15-16"><a id="__codelineno-15-16" name="__codelineno-15-16" href="#__codelineno-15-16"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">kernel_size</span><span class="o">=</span><span class="n">kernel_size</span>
</span><span id="__span-15-17"><a id="__codelineno-15-17" name="__codelineno-15-17" href="#__codelineno-15-17"></a>
</span><span id="__span-15-18"><a id="__codelineno-15-18" name="__codelineno-15-18" href="#__codelineno-15-18"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">key_embed</span><span class="o">=</span><span class="n">nn</span><span class="o">.</span><span class="n">Sequential</span><span class="p">(</span>
</span><span id="__span-15-19"><a id="__codelineno-15-19" name="__codelineno-15-19" href="#__codelineno-15-19"></a>            <span class="n">nn</span><span class="o">.</span><span class="n">Conv2d</span><span class="p">(</span><span class="n">dim</span><span class="p">,</span><span class="n">dim</span><span class="p">,</span><span class="n">kernel_size</span><span class="o">=</span><span class="n">kernel_size</span><span class="p">,</span><span class="n">padding</span><span class="o">=</span><span class="n">kernel_size</span><span class="o">//</span><span class="mi">2</span><span class="p">,</span><span class="n">groups</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span><span class="n">bias</span><span class="o">=</span><span class="kc">False</span><span class="p">),</span>
</span><span id="__span-15-20"><a id="__codelineno-15-20" name="__codelineno-15-20" href="#__codelineno-15-20"></a>            <span class="n">nn</span><span class="o">.</span><span class="n">BatchNorm2d</span><span class="p">(</span><span class="n">dim</span><span class="p">),</span>
</span><span id="__span-15-21"><a id="__codelineno-15-21" name="__codelineno-15-21" href="#__codelineno-15-21"></a>            <span class="n">nn</span><span class="o">.</span><span class="n">ReLU</span><span class="p">()</span>
</span><span id="__span-15-22"><a id="__codelineno-15-22" name="__codelineno-15-22" href="#__codelineno-15-22"></a>        <span class="p">)</span>
</span><span id="__span-15-23"><a id="__codelineno-15-23" name="__codelineno-15-23" href="#__codelineno-15-23"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">value_embed</span><span class="o">=</span><span class="n">nn</span><span class="o">.</span><span class="n">Sequential</span><span class="p">(</span>
</span><span id="__span-15-24"><a id="__codelineno-15-24" name="__codelineno-15-24" href="#__codelineno-15-24"></a>            <span class="n">nn</span><span class="o">.</span><span class="n">Conv2d</span><span class="p">(</span><span class="n">dim</span><span class="p">,</span><span class="n">dim</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">bias</span><span class="o">=</span><span class="kc">False</span><span class="p">),</span>
</span><span id="__span-15-25"><a id="__codelineno-15-25" name="__codelineno-15-25" href="#__codelineno-15-25"></a>            <span class="n">nn</span><span class="o">.</span><span class="n">BatchNorm2d</span><span class="p">(</span><span class="n">dim</span><span class="p">)</span>
</span><span id="__span-15-26"><a id="__codelineno-15-26" name="__codelineno-15-26" href="#__codelineno-15-26"></a>        <span class="p">)</span>
</span><span id="__span-15-27"><a id="__codelineno-15-27" name="__codelineno-15-27" href="#__codelineno-15-27"></a>
</span><span id="__span-15-28"><a id="__codelineno-15-28" name="__codelineno-15-28" href="#__codelineno-15-28"></a>        <span class="n">factor</span><span class="o">=</span><span class="mi">4</span>
</span><span id="__span-15-29"><a id="__codelineno-15-29" name="__codelineno-15-29" href="#__codelineno-15-29"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">attention_embed</span><span class="o">=</span><span class="n">nn</span><span class="o">.</span><span class="n">Sequential</span><span class="p">(</span>
</span><span id="__span-15-30"><a id="__codelineno-15-30" name="__codelineno-15-30" href="#__codelineno-15-30"></a>            <span class="n">nn</span><span class="o">.</span><span class="n">Conv2d</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">dim</span><span class="p">,</span><span class="mi">2</span><span class="o">*</span><span class="n">dim</span><span class="o">//</span><span class="n">factor</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">bias</span><span class="o">=</span><span class="kc">False</span><span class="p">),</span>
</span><span id="__span-15-31"><a id="__codelineno-15-31" name="__codelineno-15-31" href="#__codelineno-15-31"></a>            <span class="n">nn</span><span class="o">.</span><span class="n">BatchNorm2d</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">dim</span><span class="o">//</span><span class="n">factor</span><span class="p">),</span>
</span><span id="__span-15-32"><a id="__codelineno-15-32" name="__codelineno-15-32" href="#__codelineno-15-32"></a>            <span class="n">nn</span><span class="o">.</span><span class="n">ReLU</span><span class="p">(),</span>
</span><span id="__span-15-33"><a id="__codelineno-15-33" name="__codelineno-15-33" href="#__codelineno-15-33"></a>            <span class="n">nn</span><span class="o">.</span><span class="n">Conv2d</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">dim</span><span class="o">//</span><span class="n">factor</span><span class="p">,</span><span class="n">kernel_size</span><span class="o">*</span><span class="n">kernel_size</span><span class="o">*</span><span class="n">dim</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
</span><span id="__span-15-34"><a id="__codelineno-15-34" name="__codelineno-15-34" href="#__codelineno-15-34"></a>        <span class="p">)</span>
</span><span id="__span-15-35"><a id="__codelineno-15-35" name="__codelineno-15-35" href="#__codelineno-15-35"></a>
</span><span id="__span-15-36"><a id="__codelineno-15-36" name="__codelineno-15-36" href="#__codelineno-15-36"></a>
</span><span id="__span-15-37"><a id="__codelineno-15-37" name="__codelineno-15-37" href="#__codelineno-15-37"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
</span><span id="__span-15-38"><a id="__codelineno-15-38" name="__codelineno-15-38" href="#__codelineno-15-38"></a>        <span class="c1"># Èô§‰∫ÜË¶ÅÊòéÁôΩÂΩ¢Áä∂ÂèòÂåñÔºåËøòË¶ÅÊòéÁôΩ‰∏∫‰ªÄ‰πàÂÅöËøô‰∏ÄÊ≠•</span>
</span><span id="__span-15-39"><a id="__codelineno-15-39" name="__codelineno-15-39" href="#__codelineno-15-39"></a>        <span class="n">bs</span><span class="p">,</span><span class="n">c</span><span class="p">,</span><span class="n">h</span><span class="p">,</span><span class="n">w</span><span class="o">=</span><span class="n">x</span><span class="o">.</span><span class="n">shape</span> <span class="c1"># [1, 512, 7, 7]</span>
</span><span id="__span-15-40"><a id="__codelineno-15-40" name="__codelineno-15-40" href="#__codelineno-15-40"></a>
</span><span id="__span-15-41"><a id="__codelineno-15-41" name="__codelineno-15-41" href="#__codelineno-15-41"></a>        <span class="n">k1</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">key_embed</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>  
</span><span id="__span-15-42"><a id="__codelineno-15-42" name="__codelineno-15-42" href="#__codelineno-15-42"></a>        <span class="c1"># 311ÂàÜÁªÑÂç∑ÁßØÔºåËÅöÂêà‰∏ä‰∏ãÊñá‰ø°ÊÅØÔºåÂæóÂà∞ÈùôÊÄÅ‰∏ä‰∏ãÊñáË°®Á§∫ [1, 512, 7, 7] Conv2d(512, 512, kernel_size=(3, 3), stride=(1, 1), padding=(1, 1), groups=4, bias=False) [1, 512, 7, 7]</span>
</span><span id="__span-15-43"><a id="__codelineno-15-43" name="__codelineno-15-43" href="#__codelineno-15-43"></a>        <span class="c1"># ÁºñÁ†ÅÈùôÊÄÅ‰∏ä‰∏ãÊñá‰ø°ÊÅØkey,Ë°®Á§∫‰∏∫k1: (B,C,H,W) --&gt; (B,C,H,W)</span>
</span><span id="__span-15-44"><a id="__codelineno-15-44" name="__codelineno-15-44" href="#__codelineno-15-44"></a>
</span><span id="__span-15-45"><a id="__codelineno-15-45" name="__codelineno-15-45" href="#__codelineno-15-45"></a>        <span class="n">v</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">value_embed</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="n">bs</span><span class="p">,</span><span class="n">c</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>  
</span><span id="__span-15-46"><a id="__codelineno-15-46" name="__codelineno-15-46" href="#__codelineno-15-46"></a>        <span class="c1"># 1√ó1 Âç∑ÁßØÂæóÂà∞ value Âπ∂ reshape [1, 512, 7, 7]  Conv2d(512, 512, kernel_size=(1, 1), stride=(1, 1), bias=False) [1, 512, 7, 7] .view(bs,c,-1) [1,512,49]</span>
</span><span id="__span-15-47"><a id="__codelineno-15-47" name="__codelineno-15-47" href="#__codelineno-15-47"></a>        <span class="c1"># ÁºñÁ†ÅvalueÁü©Èòµ: (B,C,H,W) --&gt; (B,C,H,W) --&gt; (B,C,HW)</span>
</span><span id="__span-15-48"><a id="__codelineno-15-48" name="__codelineno-15-48" href="#__codelineno-15-48"></a>
</span><span id="__span-15-49"><a id="__codelineno-15-49" name="__codelineno-15-49" href="#__codelineno-15-49"></a>        <span class="n">y</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">([</span><span class="n">k1</span><span class="p">,</span><span class="n">x</span><span class="p">],</span><span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>  
</span><span id="__span-15-50"><a id="__codelineno-15-50" name="__codelineno-15-50" href="#__codelineno-15-50"></a>        <span class="c1"># [1, 512, 7, 7] [1, 512, 7, 7] torch.cat [1,1024,7,7]</span>
</span><span id="__span-15-51"><a id="__codelineno-15-51" name="__codelineno-15-51" href="#__codelineno-15-51"></a>        <span class="c1"># Â∞Ü‰∏ä‰∏ãÊñá‰ø°ÊÅØkeyÂíåqueryÂú®ÈÄöÈÅì‰∏äËøõË°åÊãºÊé•: (B,2C,H,W) [‰∫∫ÂÆ∂ÁöÑÊ≥®ÈáäÁúüÁöÑÂÜôÂæóÂ•Ω] x=query ËÄåÊ≤°ÊúâËøõË°åÂèòÊç¢</span>
</span><span id="__span-15-52"><a id="__codelineno-15-52" name="__codelineno-15-52" href="#__codelineno-15-52"></a>
</span><span id="__span-15-53"><a id="__codelineno-15-53" name="__codelineno-15-53" href="#__codelineno-15-53"></a>        <span class="n">att</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">attention_embed</span><span class="p">(</span><span class="n">y</span><span class="p">)</span> 
</span><span id="__span-15-54"><a id="__codelineno-15-54" name="__codelineno-15-54" href="#__codelineno-15-54"></a>        <span class="c1"># ‰∏§‰∏™ËøûÁª≠ÁöÑ 1x1 Âç∑ÁßØÔºåÂæóÂà∞ ÊØè‰∏™ ÂØπ‰∫éÂùêÊ†á(i,j) ÁöÑ‰ΩçÁΩÆÔºåÂÆÉÁöÑÁ¨¨ Ch ‰∏™Ê≥®ÊÑè‚ºíÂ§¥ÁöÑÁöÑÂ±ÄÈÉ®Ê≥®ÊÑè‚ºíÁü©Èòµ‰∏∫ 3x3</span>
</span><span id="__span-15-55"><a id="__codelineno-15-55" name="__codelineno-15-55" href="#__codelineno-15-55"></a>        <span class="c1"># [1,1024,7,7]-&gt; 1x1conv-&gt;[1,256,7,7]-&gt;1x1conv-&gt;[1,4608=512ÔºàÂ§¥ÁöÑ‰∏™Êï∞Ôºâ*3*3,7,7]</span>
</span><span id="__span-15-56"><a id="__codelineno-15-56" name="__codelineno-15-56" href="#__codelineno-15-56"></a>        <span class="c1"># ÈÄöËøá‰∏§‰∏™ËøûÁª≠ÁöÑ1√ó1Âç∑ÁßØÊìç‰Ωú: (B,2C,H,W)--&gt;(B,D,H,W)--&gt;(B,C√ók√ók,H,W)   4608/512 = 9</span>
</span><span id="__span-15-57"><a id="__codelineno-15-57" name="__codelineno-15-57" href="#__codelineno-15-57"></a>        <span class="c1"># ËøôÈáåÁöÑC:ÊääÂÆÉÁúã‰ΩúÊòØÊ≥®ÊÑèÂäõÂ§¥ÁöÑ‰∏™Êï∞</span>
</span><span id="__span-15-58"><a id="__codelineno-15-58" name="__codelineno-15-58" href="#__codelineno-15-58"></a>        <span class="c1"># ‰∏çÁÆ°ÊÄé‰πàÊÉ≥ ËøôÈáåÊää C√ók√ókÂÖ®ÈÉ®ÊîæÂà∞ Á¨¨ 1 Áª¥ÈÉΩÊòØÊÉ≥‰∏çÈÄöÁöÑÔºåHW ÂÉèÁ¥†ÁöÑËØ≠‰πâ‰ø°ÊÅØË¢´ÂµåÂÖ•‰∫Ü 512*3*3 ÁöÑËøô‰πàÂ§öÁª¥‰∏ä...(9‰∏™ 512 Ëøô‰πàÁêÜËß£Ôºå‰ººÊáÇÈùûÊáÇ)</span>
</span><span id="__span-15-59"><a id="__codelineno-15-59" name="__codelineno-15-59" href="#__codelineno-15-59"></a>
</span><span id="__span-15-60"><a id="__codelineno-15-60" name="__codelineno-15-60" href="#__codelineno-15-60"></a>        <span class="n">att</span><span class="o">=</span><span class="n">att</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">bs</span><span class="p">,</span><span class="n">c</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">kernel_size</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">kernel_size</span><span class="p">,</span><span class="n">h</span><span class="p">,</span><span class="n">w</span><span class="p">)</span> 
</span><span id="__span-15-61"><a id="__codelineno-15-61" name="__codelineno-15-61" href="#__codelineno-15-61"></a>        <span class="c1"># ‰∏≠ÊñáËØ¥ÊòéÁõÆÁöÑ?ÔºàÊØè‰∏™Â§¥ÈÉΩÂ≠¶Âà∞‰∫Ü 3x3 Â∞èÊ†ºÂ≠êÁöÑÂ±ÄÈÉ®Ê≥®ÊÑèÂäõÔºå‰∏∫ÂêéÈù¢ÂèñÂπ≥ÂùáËÅöÂêà Ê≥®ÊÑèÂäõÂÄºÂÅöÂáÜÂ§áÔºâ</span>
</span><span id="__span-15-62"><a id="__codelineno-15-62" name="__codelineno-15-62" href="#__codelineno-15-62"></a>        <span class="c1">#  [1,4608,7,7] -&gt; reshape -&gt; [1,512,9,7,7] </span>
</span><span id="__span-15-63"><a id="__codelineno-15-63" name="__codelineno-15-63" href="#__codelineno-15-63"></a>        <span class="c1"># (B,C√ók√ók,H,W) --&gt; (B,C,k√ók,H,W)</span>
</span><span id="__span-15-64"><a id="__codelineno-15-64" name="__codelineno-15-64" href="#__codelineno-15-64"></a>
</span><span id="__span-15-65"><a id="__codelineno-15-65" name="__codelineno-15-65" href="#__codelineno-15-65"></a>        <span class="c1"># (B,C,k√ók,H,W) --&gt; (B,C,H,W) --&gt; (B,C,HW)   </span>
</span><span id="__span-15-66"><a id="__codelineno-15-66" name="__codelineno-15-66" href="#__codelineno-15-66"></a>        <span class="c1"># ÊØè‰∏™ÂùêÊ†áÁÇπÂú®ÊØè‰∏™Ê≥®ÊÑèÂäõÂ§¥ÁöÑÁöÑÊ≥®ÊÑèÂäõÁü©Èòµ‰∏∫Ôºök√ók, ÁÑ∂ÂêéÂØπÁ™óÂè£ÂÜÖÁöÑÂÄºÂèñÂπ≥Âùá, Âõ†Ê≠§: (k√ók,HW)-&gt; (1,HW), ÊØè‰∏™ÂùêÊ†áÁÇπÂè™Êúâ‰∏Ä‰∏™ÂÄº ÔºàÂøΩÁï•BCÁª¥Â∫¶Ôºâ</span>
</span><span id="__span-15-67"><a id="__codelineno-15-67" name="__codelineno-15-67" href="#__codelineno-15-67"></a>        <span class="c1"># [1,512,9,7,7] -&gt; mean -&gt; [1,512,7,7]-&gt; view -&gt; [1,512,49]</span>
</span><span id="__span-15-68"><a id="__codelineno-15-68" name="__codelineno-15-68" href="#__codelineno-15-68"></a>        <span class="n">att</span><span class="o">=</span><span class="n">att</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="n">keepdim</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="n">bs</span><span class="p">,</span><span class="n">c</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
</span><span id="__span-15-69"><a id="__codelineno-15-69" name="__codelineno-15-69" href="#__codelineno-15-69"></a>
</span><span id="__span-15-70"><a id="__codelineno-15-70" name="__codelineno-15-70" href="#__codelineno-15-70"></a>        <span class="c1"># ÂØπN=HW‰∏™ÂùêÊ†áÁÇπ(ËôΩÁÑ∂ÊØè‰∏™ÂùêÊ†áÁÇπÁé∞Âú®Âè™Êúâ‰∏Ä‰∏™ÂÄº,‰ΩÜÊòØÊòØÈÄöËøák√ókÁ™óÂè£ÂÜÖÁöÑÂÄºÂÖ±ÂêåËé∑ÂæóÁöÑ,Âà©Áî®‰∫Ü‰∏ä‰∏ãÊñá‰ø°ÊÅØ),‰ΩøÁî®softmaxÊ±ÇÊùÉÈáç, ÁÑ∂Âêé‰ΩøÁî®ÊùÉÈáç‰∏éValueÁõ∏‰πòÔºåÁîüÊàêÂä®ÊÄÅ‰∏ä‰∏ãÊñáË°®Á§∫</span>
</span><span id="__span-15-71"><a id="__codelineno-15-71" name="__codelineno-15-71" href="#__codelineno-15-71"></a>        <span class="n">k2</span><span class="o">=</span><span class="n">F</span><span class="o">.</span><span class="n">softmax</span><span class="p">(</span><span class="n">att</span><span class="p">,</span><span class="n">dim</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">v</span>  <span class="c1"># [1, 512, 49] * [1, 512, 49] -&gt; [1, 512, 49]</span>
</span><span id="__span-15-72"><a id="__codelineno-15-72" name="__codelineno-15-72" href="#__codelineno-15-72"></a>        <span class="c1"># ÂæóÂà∞Âä®ÊÄÅ‰∏ä‰∏ãÊñáË°®Á§∫k2: (B,C,HW) * (B,C,HW) =  (B,C,HW)    ÊùÉÈáç*Value ËøôÈáåÁöÑ * Ë°®Á§∫ element-wise ÈÄêÂÖÉÁ¥†Áõ∏‰πò</span>
</span><span id="__span-15-73"><a id="__codelineno-15-73" name="__codelineno-15-73" href="#__codelineno-15-73"></a>        <span class="n">k2</span><span class="o">=</span><span class="n">k2</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="n">bs</span><span class="p">,</span><span class="n">c</span><span class="p">,</span><span class="n">h</span><span class="p">,</span><span class="n">w</span><span class="p">)</span> <span class="c1"># [1, 512, 49] -&gt; [1,512,7,7]</span>
</span><span id="__span-15-74"><a id="__codelineno-15-74" name="__codelineno-15-74" href="#__codelineno-15-74"></a>
</span><span id="__span-15-75"><a id="__codelineno-15-75" name="__codelineno-15-75" href="#__codelineno-15-75"></a>        <span class="k">return</span> <span class="n">k1</span><span class="o">+</span><span class="n">k2</span> <span class="c1"># ËûçÂêàÈùôÊÄÅ‰∏ä‰∏ãÊñá‰ø°ÊÅØk1 Âíå Âä®ÊÄÅ‰∏ä‰∏ãÊñá‰ø°ÊÅØk2 [1, 512, 7, 7] + [1, 512, 7, 7]</span>
</span><span id="__span-15-76"><a id="__codelineno-15-76" name="__codelineno-15-76" href="#__codelineno-15-76"></a>
</span><span id="__span-15-77"><a id="__codelineno-15-77" name="__codelineno-15-77" href="#__codelineno-15-77"></a>
</span><span id="__span-15-78"><a id="__codelineno-15-78" name="__codelineno-15-78" href="#__codelineno-15-78"></a><span class="c1"># ÁÆÄÂçïÊù•ËÆ≤, 43-49Ë°å‰ª£Á†ÅÁöÑÂê´‰πâÂ∞±ÊòØ: ËûçÂêàÈùôÊÄÅ‰∏ä‰∏ãÊñá‰ø°ÊÅØk1Âíåquery‰ø°ÊÅØ,Êù•ÁîüÊàêÊØè‰∏™ÂÉèÁ¥†ÁÇπÁöÑÊùÉÈáç„ÄÇ Ëøô‰∏™ÊùÉÈáçÊòØÂü∫‰∫é‰∏ä‰∏ãÊñá‰ø°ÊÅØËé∑ÂæóÁöÑ,ÊâÄ‰ª•ÊòØÊúâÊïàÁöÑ„ÄÇ</span>
</span><span id="__span-15-79"><a id="__codelineno-15-79" name="__codelineno-15-79" href="#__codelineno-15-79"></a><span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
</span><span id="__span-15-80"><a id="__codelineno-15-80" name="__codelineno-15-80" href="#__codelineno-15-80"></a>    <span class="c1"># (B,C,H,W)</span>
</span><span id="__span-15-81"><a id="__codelineno-15-81" name="__codelineno-15-81" href="#__codelineno-15-81"></a>    <span class="nb">input</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">512</span><span class="p">,</span><span class="mi">7</span><span class="p">,</span><span class="mi">7</span><span class="p">)</span>
</span><span id="__span-15-82"><a id="__codelineno-15-82" name="__codelineno-15-82" href="#__codelineno-15-82"></a>    <span class="n">Model</span> <span class="o">=</span> <span class="n">CoTAttention</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="mi">512</span><span class="p">,</span><span class="n">kernel_size</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
</span><span id="__span-15-83"><a id="__codelineno-15-83" name="__codelineno-15-83" href="#__codelineno-15-83"></a>    <span class="n">output</span><span class="o">=</span><span class="n">Model</span><span class="p">(</span><span class="nb">input</span><span class="p">)</span>
</span><span id="__span-15-84"><a id="__codelineno-15-84" name="__codelineno-15-84" href="#__codelineno-15-84"></a>    <span class="nb">print</span><span class="p">(</span><span class="n">output</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="c1"># [1, 512, 7, 7]</span>
</span></code></pre></div>
<h2 id="_5"><a class="headerlink" href="#_5" title="Permanent link">&para;</a></h2>







  
    
  
  
    
  


  <aside class="md-source-file">
    
      
  <span class="md-source-file__fact">
    <span class="md-icon" title="Last update">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M21 13.1c-.1 0-.3.1-.4.2l-1 1 2.1 2.1 1-1c.2-.2.2-.6 0-.8l-1.3-1.3c-.1-.1-.2-.2-.4-.2m-1.9 1.8-6.1 6V23h2.1l6.1-6.1zM12.5 7v5.2l4 2.4-1 1L11 13V7zM11 21.9c-5.1-.5-9-4.8-9-9.9C2 6.5 6.5 2 12 2c5.3 0 9.6 4.1 10 9.3-.3-.1-.6-.2-1-.2s-.7.1-1 .2C19.6 7.2 16.2 4 12 4c-4.4 0-8 3.6-8 8 0 4.1 3.1 7.5 7.1 7.9l-.1.2z"/></svg>
    </span>
    <span class="git-revision-date-localized-plugin git-revision-date-localized-plugin-timeago" title="2025Âπ¥3Êúà19Êó• 12:59:29"><span class="timeago" datetime="2025-03-19T12:59:29+00:00" locale="zh"></span></span><span class="git-revision-date-localized-plugin git-revision-date-localized-plugin-iso_date" title="2025Âπ¥3Êúà19Êó• 12:59:29">2025-03-19</span>
  </span>

    
    
      
  <span class="md-source-file__fact">
    <span class="md-icon" title="Created">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M14.47 15.08 11 13V7h1.5v5.25l3.08 1.83c-.41.28-.79.62-1.11 1m-1.39 4.84c-.36.05-.71.08-1.08.08-4.42 0-8-3.58-8-8s3.58-8 8-8 8 3.58 8 8c0 .37-.03.72-.08 1.08.69.1 1.33.32 1.92.64.1-.56.16-1.13.16-1.72 0-5.5-4.5-10-10-10S2 6.5 2 12s4.47 10 10 10c.59 0 1.16-.06 1.72-.16-.32-.59-.54-1.23-.64-1.92M18 15v3h-3v2h3v3h2v-3h3v-2h-3v-3z"/></svg>
    </span>
    <span class="git-revision-date-localized-plugin git-revision-date-localized-plugin-timeago" title="2025Âπ¥2Êúà20Êó• 14:28:38"><span class="timeago" datetime="2025-02-20T14:28:38+00:00" locale="zh"></span></span><span class="git-revision-date-localized-plugin git-revision-date-localized-plugin-iso_date" title="2025Âπ¥2Êúà20Êó• 14:28:38">2025-02-20</span>
  </span>

    
    
    
  </aside>





                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
          <button type="button" class="md-top md-icon" data-md-component="top" hidden>
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8z"/></svg>
  Back to top
</button>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    <script id="__config" type="application/json">{"base": "../..", "features": ["toc.follow", "navigation.top", "search.suggest", "search.highlight", "content.code.copy", "navigation.tabs", "navigation.tabs.sticky", "navigation.sections", "navigation.expand", "navigation.indexes"], "search": "../../assets/javascripts/workers/search.f8cc74c7.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}}</script>
    
    
      <script src="../../assets/javascripts/bundle.c8b220af.min.js"></script>
      
        <script src="../../js/timeago.min.js"></script>
      
        <script src="../../js/timeago_mkdocs_material.js"></script>
      
        <script src="../../mkdocs/javascripts/katex.js"></script>
      
        <script src="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.7/katex.min.js"></script>
      
        <script src="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.7/contrib/auto-render.min.js"></script>
      
    
  </body>
</html>